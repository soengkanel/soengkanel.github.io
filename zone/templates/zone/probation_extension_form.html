{% extends 'base/base.html' %}
{% load static %}

{% block title %}TESTING - {{ title|default:"Extend Probation Period" }} - Zone Management{% endblock %}

{% block extra_css %}
<style>
/* Compact Form Styling */
.form-container {
    max-width: 700px;
    margin: 0 auto;
}

.page-header {
    background: linear-gradient(135deg, #ffc107 0%, #fd7e14 100%);
    color: white;
    border-radius: 10px;
    padding: 1.5rem;
    margin-bottom: 2rem;
    text-align: center;
}

.business-rule-card {
    background: #fff3cd;
    border: 1px solid #ffc107;
    border-radius: 8px;
    padding: 1rem;
    margin-bottom: 1.5rem;
}

.worker-info-card {
    background: white;
    border-radius: 8px;
    padding: 1.5rem;
    margin-bottom: 1.5rem;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.probation-status-card {
    background: #f8f9fa;
    border-radius: 8px;
    padding: 1rem;
    margin-bottom: 1.5rem;
    border-left: 4px solid #17a2b8;
}

.form-card {
    background: white;
    border-radius: 8px;
    padding: 2rem;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    margin-bottom: 1.5rem;
}

.worker-avatar {
    width: 80px;
    height: 80px;
    border-radius: 50%;
    object-fit: cover;
    border: 3px solid #e9ecef;
}

.worker-avatar-placeholder {
    width: 80px;
    height: 80px;
    border-radius: 50%;
    background: #6c757d;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 1.5rem;
    font-weight: bold;
    border: 3px solid #e9ecef;
}

.status-badge {
    font-size: 0.75rem;
    padding: 0.25rem 0.5rem;
    border-radius: 12px;
    font-weight: 500;
}

.progress-bar-container {
    background: #e9ecef;
    border-radius: 10px;
    height: 10px;
    overflow: hidden;
    margin: 0.5rem 0;
}

.progress-bar {
    height: 100%;
    border-radius: 10px;
    transition: width 0.3s ease;
}

.info-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.5rem 0;
    border-bottom: 1px solid #f1f3f4;
}

.info-item:last-child {
    border-bottom: none;
}

.info-label {
    font-weight: 500;
    color: #495057;
    font-size: 0.9rem;
}

.info-value {
    font-weight: 600;
    color: #212529;
    text-align: right;
}

.extension-calculator {
    background: #e3f2fd;
    border: 1px solid #2196f3;
    border-radius: 8px;
    padding: 1rem;
    margin: 1rem 0;
}

.form-group {
    margin-bottom: 1.5rem;
}

.form-label {
    font-weight: 600;
    color: #374151;
    margin-bottom: 0.5rem;
    font-size: 0.9rem;
}

.form-control, .form-select {
    border: 1px solid #d1d5db;
    border-radius: 6px;
    padding: 0.75rem;
    font-size: 0.9rem;
    transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
}

.form-control:focus, .form-select:focus {
    border-color: #ffc107;
    box-shadow: 0 0 0 0.2rem rgba(255, 193, 7, 0.25);
}

.btn-container {
    display: flex;
    gap: 1rem;
    justify-content: center;
    padding-top: 1rem;
    border-top: 1px solid #e9ecef;
    margin-top: 2rem;
}

.alert-info {
    background-color: #d1ecf1;
    border-color: #b6d4ea;
    color: #0c5460;
}

.text-warning { color: #856404 !important; }
.text-success { color: #155724 !important; }
.text-danger { color: #721c24 !important; }

.urgency-indicator {
    display: inline-block;
    width: 8px;
    height: 8px;
    border-radius: 50%;
    margin-right: 0.5rem;
}

.urgency-critical { background: #dc3545; }
.urgency-high { background: #fd7e14; }
.urgency-medium { background: #ffc107; }
.urgency-low { background: #28a745; }
.urgency-overdue { background: #6f42c1; }

@media (max-width: 768px) {
    .form-container {
        margin: 0 1rem;
    }
    
    .worker-info-card {
        padding: 1rem;
    }
    
    .form-card {
        padding: 1.5rem;
    }
    
    .btn-container {
        flex-direction: column;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid mt-3">
    <div class="form-container">
        <!-- Application Header -->
        <div class="bg-white px-2 flex items-center justify-between pt-3">
            <div>
            <a href="{% url 'zone:worker_list' %}" class="button-min-default flex items-center space-x-1">
                <span>
                    <i class="fa fa-arrow-left"></i>
                </span>
                <span>Back</span>
            </a>
            </div>
            <div class="border-b-2 border-blue-500 px-2 pb-1">
            <h1 class="text-lg font-bold text-blue-500">
                {% if user_is_manager %}
                    Extend Probation Period
                {% else %}
                    Request Probation Extension
                {% endif %}
            </h1>
            <p class="text-xs text-gray-500 fon-semibold">
                {% if user_is_manager %}
                    Direct extension for worker probation period
                {% else %}
                    Request extension for manager approval
                {% endif %}
            </p>
            </div>
        </div>

        <!-- Debug Info -->
        <div class="alert alert-secondary" style="font-size: 12px; padding: 0.5rem;">
            <strong>Debug:</strong> user_is_manager = {{ user_is_manager }}, user.is_staff = {{ user.is_staff }}, user.is_superuser = {{ user.is_superuser }}
        </div>

        <!-- Maker-Checker Workflow Info -->
        {% if not user_is_manager %}
            <div class="alert alert-info">
                <div class="d-flex align-items-center mb-2">
                    <i class="bi bi-info-circle text-primary me-2"></i>
                    <strong>Extension Request Process</strong>
                </div>
                <p class="mb-0 small">
                    Your extension request will be submitted for manager approval. You will be notified once it has been reviewed.
                </p>
            </div>
        {% endif %}

        <!-- Business Rule Information -->
        <div class="business-rule-card">
            <div class="d-flex align-items-center mb-2">
                <i class="bi bi-info-circle text-warning me-2"></i>
                <strong>Business Rule: 30-Day Maximum Probation Period</strong>
            </div>
            <p class="mb-2 small">
                The total probation period (default 15 days + extensions) cannot exceed 30 days.
                Maximum extension allowed: <strong>15 days total</strong>.
            </p>
            <div class="row small">
                <div class="col-md-4">
                    <i class="bi bi-calendar-check text-success"></i>
                    Default: 15 days
                </div>
                <div class="col-md-4">
                    <i class="bi bi-plus-circle text-warning"></i>
                    Max Extension: 15 days
                </div>
                <div class="col-md-4">
                    <i class="bi bi-calendar-x text-danger"></i>
                    Total Limit: 30 days
                </div>
            </div>
        </div>

        <!-- Worker Information -->
        <div class="worker-info-card">
            <div class="row align-items-center">
                <div class="col-md-3 text-center">
                    {% if worker.photo %}
                        <img src="{% url "zone:serve_worker_photo" worker.id %}" class="worker-avatar" alt="Worker Photo">
                    {% else %}
                        <div class="worker-avatar-placeholder">
                            {{ worker.first_name|first }}{{ worker.last_name|first }}
                        </div>
                    {% endif %}
                </div>
                <div class="col-md-9">
                    <h5 class="mb-1">{{ worker.first_name }} {{ worker.last_name }}</h5>
                    <p class="text-muted mb-2">{{ worker.worker_id }} â€¢ {{ worker.position.name|default:"No Position" }}</p>
                    <div class="row small">
                        <div class="col-md-6">
                            <i class="bi bi-person-badge text-muted"></i>
                            Zone: {{ worker.zone.name }}
                        </div>
                        <div class="col-md-6">
                            <i class="bi bi-building text-muted"></i>
                            Building: {{ worker.building.name|default:"Not assigned" }}
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Current Probation Status -->
        <div class="probation-status-card">
            <h6 class="mb-3">
                <i class="bi bi-hourglass-split text-info"></i>
                Current Probation Status
            </h6>
            
            <div class="row">
                <div class="col-md-6">
                    <div class="info-item">
                        <span class="info-label">Status:</span>
                        <span class="info-value">
                            <span class="status-badge bg-{{ probation.get_status_color }}">
                                <span class="urgency-indicator urgency-{{ probation.get_urgency_level }}"></span>
                                {{ probation.get_status_display }}
                            </span>
                        </span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Start Date:</span>
                        <span class="info-value">{{ probation.start_date|date:"d/m/Y" }}</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Original End Date:</span>
                        <span class="info-value">{{ probation.original_end_date|date:"d/m/Y" }}</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Current End Date:</span>
                        <span class="info-value">{{ probation.get_end_date|date:"d/m/Y" }}</span>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="info-item">
                        <span class="info-label">Days Completed:</span>
                        <span class="info-value">{{ probation.get_days_completed }} days</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Days Remaining:</span>
                        <span class="info-value {% if probation.get_days_remaining <= 3 %}text-danger{% elif probation.get_days_remaining <= 7 %}text-warning{% else %}text-success{% endif %}">
                            {{ probation.get_days_remaining }} days
                        </span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Current Extensions:</span>
                        <span class="info-value">{{ probation.extensions.count }} ({{ probation.get_total_extension_days }} days)</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Extension Available:</span>
                        <span class="info-value text-{% if probation.get_max_allowed_extension_days > 0 %}success{% else %}danger{% endif %}">
                            {{ probation.get_max_allowed_extension_days }} days
                        </span>
                    </div>
                </div>
            </div>

            <!-- Progress Bar -->
            <div class="mt-3">
                <div class="d-flex justify-content-between small mb-1">
                    <span>Progress</span>
                    <span>{{ probation.get_progress_percentage }}%</span>
                </div>
                <div class="progress-bar-container">
                    <div class="progress-bar bg-{{ probation.get_status_color }}" 
                         style="width: {{ probation.get_progress_percentage }}%"></div>
                </div>
            </div>
        </div>

        <!-- Extension Form -->
        <div class="form-card">
            <h6 class="mb-3">
                <i class="bi bi-plus-circle text-warning"></i>
                Extension Request Details
            </h6>

            {% if probation.get_max_allowed_extension_days <= 0 %}
                <div class="alert alert-danger">
                    <i class="bi bi-exclamation-triangle"></i>
                    <strong>Cannot Extend</strong>
                    <br>This probation period has reached the maximum limit of 30 days total. No further extensions are allowed.
                </div>
                

            {% else %}
                <form method="post" novalidate>
                    {% csrf_token %}
                    
                    <!-- Extension Calculator -->
                    <div class="extension-calculator">
                        <h6 class="text-primary mb-2">
                            <i class="bi bi-calculator"></i>
                            Extension Calculator
                        </h6>
                        <div class="row small">
                            <div class="col-md-3">
                                <strong>Current Total:</strong><br>
                                {{ probation.get_total_duration_days }} days
                            </div>
                            <div class="col-md-3">
                                <strong>Used Extensions:</strong><br>
                                {{ probation.get_total_extension_days }} days
                            </div>
                            <div class="col-md-3">
                                <strong>Available:</strong><br>
                                <span class="text-success">{{ probation.get_max_allowed_extension_days }} days</span>
                            </div>
                            <div class="col-md-3">
                                <strong>Max Total:</strong><br>
                                <span class="text-danger">30 days</span>
                            </div>
                        </div>
                    </div>

                    <!-- Debug Form Info -->
                    <div class="alert alert-secondary" style="font-size: 12px; padding: 0.5rem;">
                        <strong>Form Debug:</strong> Form type: {{ form|class_name }}, Has approved_by: {% if form.approved_by %}Yes{% else %}No{% endif %}
                    </div>

                    <!-- Form Fields -->
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="{{ form.extension_duration_days.id_for_label }}" class="form-label">
                                    Extension Duration (Days) <span class="text-danger">*</span>
                                </label>
                                {{ form.extension_duration_days }}
                                <div class="form-text">
                                    Maximum allowed: {{ probation.get_max_allowed_extension_days }} days
                                </div>
                                {% if form.extension_duration_days.errors %}
                                    <div class="text-danger small mt-1">
                                        {% for error in form.extension_duration_days.errors %}
                                            <i class="bi bi-exclamation-circle"></i> {{ error }}
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                        {% if user_is_manager %}
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="{{ form.approved_by.id_for_label }}" class="form-label">
                                        Approved By <span class="text-danger">*</span>
                                    </label>
                                    {{ form.approved_by }}
                                    {% if form.approved_by.errors %}
                                        <div class="text-danger small mt-1">
                                            {% for error in form.approved_by.errors %}
                                                <i class="bi bi-exclamation-circle"></i> {{ error }}
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                        {% endif %}
                    </div>

                    <div class="form-group">
                        <label for="{{ form.reason.id_for_label }}" class="form-label">
                            Reason for Extension <span class="text-danger">*</span>
                        </label>
                        {{ form.reason }}
                        <div class="form-text">
                            Please provide a clear justification for the probation extension.
                        </div>
                        {% if form.reason.errors %}
                            <div class="text-danger small mt-1">
                                {% for error in form.reason.errors %}
                                    <i class="bi bi-exclamation-circle"></i> {{ error }}
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>

                    <!-- Form Errors -->
                    {% if form.non_field_errors %}
                        <div class="alert alert-danger">
                            {% for error in form.non_field_errors %}
                                <i class="bi bi-exclamation-triangle"></i> {{ error }}
                            {% endfor %}
                        </div>
                    {% endif %}

                    <!-- Form Buttons -->
                    <div class="btn-container">
                        <a href="{% url 'zone:probation_detail' probation.id %}" class="btn btn-secondary">
                            <i class="bi bi-x-circle"></i> Cancel
                        </a>
                        <button type="submit" class="btn btn-warning">
                            {% if user_is_manager %}
                                <i class="bi bi-plus-circle"></i> {{ submit_text|default:"Create Extension" }}
                            {% else %}
                                <i class="bi bi-send"></i> Submit Extension Request
                            {% endif %}
                        </button>
                    </div>
                </form>
            {% endif %}
        </div>

        <!-- Help Information -->
        <div class="alert alert-info">
            <h6><i class="bi bi-lightbulb"></i> Extension Guidelines</h6>
            <ul class="mb-0 small">
                <li>Extensions should only be granted when additional time is needed for proper evaluation</li>
                <li>The total probation period cannot exceed 30 days as per company policy</li>
                <li>All extensions require approval from a supervisor or HR representative</li>
                <li>Document the specific reasons for the extension in the reason field</li>
            </ul>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const extensionInput = document.getElementById('{{ form.extension_duration_days.id_for_label }}');
    const maxAllowed = {{ probation.get_max_allowed_extension_days }};
    
    if (extensionInput) {
        extensionInput.addEventListener('input', function() {
            const value = parseInt(this.value) || 0;
            const currentTotal = {{ probation.get_total_duration_days }};
            const newTotal = currentTotal + value;
            
            // Update visual feedback
            if (value > maxAllowed) {
                this.classList.add('is-invalid');
                this.classList.remove('is-valid');
            } else if (value > 0) {
                this.classList.add('is-valid');
                this.classList.remove('is-invalid');
            } else {
                this.classList.remove('is-valid', 'is-invalid');
            }
        });
        
        // Set default value if empty
        if (!extensionInput.value && maxAllowed > 0) {
            extensionInput.value = Math.min(15, maxAllowed);
        }
    }
});
</script>
{% endblock %} 