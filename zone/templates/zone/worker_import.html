{% extends 'base/base.html' %}
{% load static %}

{% block title %}Import Workers - Zone Management{% endblock %}

{% block main_class %}col-md-10 ms-sm-auto col-lg-10{% endblock %}

{% block extra_css %}
<style>
    .page-header {
        padding: 8px 0;
        margin-bottom: 12px;
    }
    .page-header h2 {
        font-size: 18px;
        font-weight: 600;
        margin: 0;
        color: #1a1a1a;
    }
    .page-header p {
        font-size: 11px;
        color: #666;
        margin: 0;
    }

    .import-form {
        background: #ffffff;
        border: 1px solid #e2e8f0;
        border-radius: 8px;
        padding: 24px;
        margin-bottom: 24px;
    }

    .template-section {
        background: #f8fafb;
        border: 1px solid #e2e8f0;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 24px;
    }

    .instructions-section {
        background: #fff7ed;
        border: 1px solid #fed7aa;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 24px;
    }

    .form-group {
        margin-bottom: 16px;
    }

    .form-label {
        font-size: 12px;
        font-weight: 500;
        color: #374151;
        margin-bottom: 6px;
        display: block;
    }

    .form-control {
        font-size: 12px;
        padding: 8px 12px;
        border: 1px solid #d1d5db;
        border-radius: 6px;
    }

    .form-check-input {
        margin-right: 8px;
    }

    .help-text {
        font-size: 10px;
        color: #6b7280;
        margin-top: 4px;
    }

    .btn-primary {
        background: #3b82f6;
        border-color: #3b82f6;
        color: white;
        font-size: 12px;
        padding: 8px 16px;
        border-radius: 6px;
    }

    .btn-secondary {
        background: #6b7280;
        border-color: #6b7280;
        color: white;
        font-size: 12px;
        padding: 8px 16px;
        border-radius: 6px;
    }

    .btn-success {
        background: #10b981;
        border-color: #10b981;
        color: white;
        font-size: 12px;
        padding: 8px 16px;
        border-radius: 6px;
        text-decoration: none;
        display: inline-block;
    }

    .alert {
        font-size: 12px;
        padding: 12px 16px;
        border-radius: 6px;
        margin-bottom: 16px;
    }

    .requirement-list {
        list-style: none;
        padding: 0;
    }

    .requirement-list li {
        font-size: 11px;
        padding: 4px 0;
        border-bottom: 1px solid #e5e7eb;
    }

    .requirement-list li:last-child {
        border-bottom: none;
    }

    .step-number {
        background: #3b82f6;
        color: white;
        border-radius: 50%;
        width: 20px;
        height: 20px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        font-size: 11px;
        font-weight: bold;
        margin-right: 8px;
    }

    .feature-badge {
        background: #dbeafe;
        color: #1e40af;
        padding: 2px 8px;
        border-radius: 12px;
        font-size: 10px;
        font-weight: 500;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid px-3">
    <!-- Page Header -->
    <div class="page-header d-flex justify-content-between align-items-center pb-3">
        <div>
            <h2>Import Workers from Excel</h2>
            <p>Upload Excel file to batch import worker records with SinoSecu API integration</p>
        </div>
        <div>
            <a href="{% url 'zone:worker_list' %}" class="btn btn-secondary">
                <i class="bi bi-arrow-left"></i> Back to Workers
            </a>
        </div>
    </div>

    <!-- Template Download Section -->
    <div class="template-section">
        <h5><i class="bi bi-download"></i> Step 1: Download Excel Template</h5>
        <p>Download the official Excel template with all required fields and sample data.</p>
        <a href="{{ template_url }}" class="btn btn-success" download="worker_eform.xlsx">
            <i class="bi bi-file-earmark-excel"></i> Download Template (worker_eform.xlsx)
        </a>
        <div class="mt-3">
            <small class="text-muted">
                <span class="feature-badge">NEW</span>
                Template includes photo filename fields and SinoSecu API integration support
            </small>
        </div>
    </div>

    <!-- Instructions Section -->
    <div class="instructions-section">
        <h5><i class="bi bi-info-circle"></i> Step 2: Prepare Your Data</h5>
        <div class="row">
            <div class="col-md-6">
                <h6>Required Fields:</h6>
                <ul class="requirement-list">
                    <li><strong>NAME</strong> - Full name (will be split into first/last)</li>
                    <li><strong>SEX</strong> - M, F, or O</li>
                    <li><strong>DOB</strong> - Date of Birth (YYYY-MM-DD)</li>
                    <li><strong>NATIONALITY</strong> - Country code (KH, TH, VN, etc.)</li>
                    <li><strong>PHONE_NUMBER</strong> - Contact number (+855 format)</li>
                    <li><strong>ZONE_NAME</strong> - Must match existing zone</li>
                    <li><strong>BUILDINGNAME</strong> - Must match existing building</li>
                </ul>
            </div>
            <div class="col-md-6">
                <h6>Photo Fields (Images or Paths):</h6>
                <ul class="requirement-list">
                    <li><strong>PHOTO</strong> - Worker portrait</li>
                    <li><strong>IDKH/PASSPORT</strong> - ID/Passport photo</li>
                    <li><strong>WORKINGPERMIT</strong> - Work permit photo</li>
                    <li><strong>VISA</strong> - Visa photo</li>
                </ul>
                <div class="mt-2">
                    <small class="text-success">
                        <i class="bi bi-image"></i> 
                        <strong>Two options:</strong> 
                        1) Insert images directly into cells, or 
                        2) Enter file paths
                    </small>
                </div>
                <div class="mt-2">
                    <small class="text-info">
                        <i class="bi bi-robot"></i> 
                        <strong>SinoSecu OCR:</strong> Extracts document numbers, issue/expiry dates, names, and verification data automatically
                    </small>
                </div>
            </div>
        </div>
    </div>

    <!-- Import Form -->
    <div class="import-form">
        <h5><i class="bi bi-upload"></i> Step 3: Upload and Import</h5>
        
        <form method="post" enctype="multipart/form-data">
            {% csrf_token %}
            
            <div class="row">
                <div class="col-md-6">
                    <div class="form-group">
                        <label class="form-label" for="{{ form.excel_file.id_for_label }}">
                            {{ form.excel_file.label }} <span class="text-danger">*</span>
                        </label>
                        {{ form.excel_file }}
                        {% if form.excel_file.help_text %}
                            <div class="help-text">{{ form.excel_file.help_text }}</div>
                        {% endif %}
                        {% if form.excel_file.errors %}
                            <div class="text-danger">
                                {% for error in form.excel_file.errors %}
                                    <small>{{ error }}</small>
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="{{ form.photos_folder.id_for_label }}">
                            {{ form.photos_folder.label }}
                        </label>
                        {{ form.photos_folder }}
                        {% if form.photos_folder.help_text %}
                            <div class="help-text">{{ form.photos_folder.help_text }}</div>
                        {% endif %}
                        {% if form.photos_folder.errors %}
                            <div class="text-danger">
                                {% for error in form.photos_folder.errors %}
                                    <small>{{ error }}</small>
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>
                </div>

                <div class="col-md-6">
                    <div class="form-group">
                        <div class="form-check">
                            {{ form.process_photos }}
                            <label class="form-check-label" for="{{ form.process_photos.id_for_label }}">
                                {{ form.process_photos.label }}
                                <span class="feature-badge">OCR</span>
                            </label>
                        </div>
                        {% if form.process_photos.help_text %}
                            <div class="help-text">{{ form.process_photos.help_text }}</div>
                        {% endif %}
                        <div class="help-text">
                            <i class="bi bi-robot"></i> 
                            <strong>SinoSecu OCR:</strong> Automatically extracts document numbers, dates, and personal information from photos
                        </div>
                    </div>

                    <div class="form-group">
                        <div class="form-check">
                            {{ form.skip_duplicates }}
                            <label class="form-check-label" for="{{ form.skip_duplicates.id_for_label }}">
                                {{ form.skip_duplicates.label }}
                            </label>
                        </div>
                        {% if form.skip_duplicates.help_text %}
                            <div class="help-text">{{ form.skip_duplicates.help_text }}</div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <hr>

            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <small class="text-muted">
                        <i class="bi bi-shield-check"></i>
                        Files are processed securely and temporarily stored during import
                    </small>
                </div>
                <div>
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-upload"></i> Import Workers
                    </button>
                </div>
            </div>
        </form>
    </div>

    <!-- Import Process Information -->
    <div class="row">
        <div class="col-md-4">
            <div class="card">
                <div class="card-body">
                    <h6><span class="step-number">1</span>Excel Validation</h6>
                    <small class="text-muted">
                        Validates file format, required columns, and data integrity before processing.
                    </small>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card">
                <div class="card-body">
                    <h6><span class="step-number">2</span>Worker Creation</h6>
                    <small class="text-muted">
                        Creates worker records with duplicate checking and data validation.
                    </small>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card">
                <div class="card-body">
                    <h6><span class="step-number">3</span>OCR Processing</h6>
                    <small class="text-muted">
                        <span class="feature-badge">SinoSecu OCR</span>
                        Automatically extracts document data, verifies information, and enriches worker records.
                    </small>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Form validation feedback
    const form = document.querySelector('form');
    const fileInput = document.getElementById('{{ form.excel_file.id_for_label }}');
    
    if (fileInput) {
        fileInput.addEventListener('change', function() {
            const file = this.files[0];
            if (file) {
                const fileName = file.name.toLowerCase();
                if (!fileName.endsWith('.xlsx') && !fileName.endsWith('.xls')) {
                    alert('Please select an Excel file (.xlsx or .xls)');
                    this.value = '';
                    return;
                }
                
                if (file.size > 10 * 1024 * 1024) {
                    alert('File size too large. Maximum size is 10MB.');
                    this.value = '';
                    return;
                }
            }
        });
    }

    // Form submission with loading state
    if (form) {
        form.addEventListener('submit', function() {
            const submitBtn = form.querySelector('button[type="submit"]');
            if (submitBtn) {
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<i class="bi bi-hourglass-split"></i> Processing...';
            }
        });
    }
});
</script>
{% endblock %}