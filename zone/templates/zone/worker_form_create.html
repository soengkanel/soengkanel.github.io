<!--New UI-->
{% extends 'base/base.html' %}
{% load static %}

{% block title %}{{ title }} - Zone Management{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'ui/css/app.css' %}">
<link rel="stylesheet" href="{% static 'css/inline-validation.css' %}">
<link rel="stylesheet" href="{% static 'css/document-preview.css' %}">
{% endblock %}

{% block content %}
<main class="min-h-screen h-auto">
     <!--header title end-->
     <!--content-->
       <div class="px-5 py-3">
        <!--scanner extract data-->
        {% if not worker %}
            {% include 'zone/components/worker_scanner_extract_data.html' %}
        {% endif %}
        <!--end scanner extract data-->
         <!--form-->
         <form method="post" action="{% if is_edit == 'edit' %}{% url 'zone:worker_edit' worker.id %}{% else %}{% url 'zone:worker_create' %}{% endif %}" enctype="multipart/form-data" novalidate id="workerForm">
            {% csrf_token %}
            <!--set form submit-->
            <input id="form-action" type="hidden" value="{{form_action}}"/>
            <input id="is_edit" type="hidden" value="{{is_edit}}"/>
            <!-- Hidden status field set to active for new workers -->
            <input type="hidden" name="status" value="active"/>
            <!--set form submit end-->
            <!--VIP Option start-->
            {% include 'zone/components/worker_option_vip.html' %}
            <!--VIP Option end-->
            <div class="grid grid-cols-3 gap-4 w-full">
                <!-- Personal Information start -->
                {% include 'zone/components/worker_personal_info.html' %}
                <!-- Personal Information end -->
                <!--worker photo start-->
                {% include 'zone/components/worker_camera.html' %}
                <!--worker photo end-->
            </div>
            
            <!--Contact Info start-->
             {% include 'zone/components/workder_contact_info.html' %}
            <!--Contact Info end-->

            <!--Identification start -->
             {% include 'zone/components/worker_identification.html' %}
            <!-- Identification end -->

            <!--worker information start -->
            {% include 'zone/components/worker_information.html' %}
            <!-- worker information end -->

            <!--documents start -->
            {% include 'zone/components/worker_document.html' %}
            <!-- documents end -->

            <!--button save start-->
            {% include 'zone/components/worker_button_save.html' %}
            <!--button save start-->
            
        </form>
        <!--end form-->
       </div>
     <!--end content-->

<!-- Zone and Building data for JavaScript -->
{{ zones_data|json_script:"zones-data" }}
{{ buildings_data|json_script:"buildings-data" }}

<!-- Worker data for edit mode -->
<script id="worker-data" type="application/json">
{
  "is_edit": "{{ is_edit|default:'' }}",
  "worker_zone_id": {% if worker and worker.zone %}"{{ worker.zone.id }}"{% else %}null{% endif %},
  "worker_building_id": {% if worker and worker.building %}"{{ worker.building.id }}"{% else %}null{% endif %},
  "worker_building_name": {% if worker and worker.building %}"{{ worker.building.name }}"{% else %}null{% endif %},
  "worker_floor_id": {% if worker and worker.floor %}"{{ worker.floor.id }}"{% else %}null{% endif %},
  "worker_floor_name": {% if worker and worker.floor %}"{{ worker.floor.name }}"{% else %}null{% endif %}
}
</script>

</main>

<script src="{% static 'js/worker_form_create.js' %}"> </script>
<script src="{% static 'js/worker_form_validate.js' %}"> </script>
<script src="{% static 'js/worker_doc_form.js' %}"> </script>
<script src="{% static 'js/worker_status_fix.js' %}"> </script>
<script src="{% static 'sinosecu/js/worker_scanner.js' %}"> </script>

<!-- Success message handling -->
{% if messages %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    {% for message in messages %}
        {% if message.tags == 'success' %}
            if (typeof toast !== 'undefined') {
                toast.success('{{ message|escapejs }}');
            } else {
                alert('{{ message|escapejs }}');
            }
        {% elif message.tags == 'error' %}
            if (typeof toast !== 'undefined') {
                toast.error('{{ message|escapejs }}');
            } else {
                alert('Error: {{ message|escapejs }}');
            }
        {% endif %}
    {% endfor %}
});
</script>
{% endif %}

<!-- Document deletion styling -->
<style>
.btn-delete-document {
    transition: all 0.3s ease;
}

.btn-delete-document:hover {
    transform: scale(1.05);
}

.document-form.marked-for-deletion {
    opacity: 0.5;
    background-color: #fff5f5;
    border: 2px solid #fecaca;
    transition: all 0.3s ease;
}

.document-form.marked-for-deletion .document-header {
    background-color: #fee2e2;
}

.deletion-notice {
    background-color: #fef2f2;
    border: 1px solid #fecaca;
    color: #991b1b;
    padding: 8px 12px;
    border-radius: 4px;
    margin: 8px 0;
    font-size: 12px;
    display: flex;
    align-items: center;
    gap: 8px;
}

.undo-deletion-btn {
    background-color: #f59e0b;
    color: white;
    border: none;
    padding: 4px 8px;
    border-radius: 3px;
    font-size: 11px;
    cursor: pointer;
    transition: background-color 0.2s ease;
}

.undo-deletion-btn:hover {
    background-color: #d97706;
}
</style>


<!-- Delete Confirmation Modal -->
<div id="deleteConfirmModal1" class="fixed inset-0 w-full bg-black bg-opacity-50 flex items-center justify-center z-50" style="display: none;">
    <div class="bg-white rounded-lg shadow-xl max-w-md w-full mx-4">
        <div class="p-6">
            <div class="flex items-center mb-4">
                <div class="flex-shrink-0">
                    <i class="bi bi-exclamation-triangle text-red-500 text-2xl"></i>
                </div>
                <div class="ml-3">
                    <h3 class="text-lg font-medium text-gray-900">Confirm Document Deletion</h3>
                </div>
            </div>
            <div class="mb-4">
                <p class="text-sm text-gray-600" id="deleteConfirmMessage">
                    Are you sure you want to delete this document? This action cannot be undone and the document file will be permanently removed.
                </p>
            </div>
            <div class="flex justify-end space-x-3">
                <button type="button" class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-200 border border-gray-300 rounded-md hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500" onclick="closeDeleteModal()">
                    Cancel
                </button>
                <button type="button" class="px-4 py-2 text-sm font-medium text-white bg-red-600 border border-transparent rounded-md hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500" id="confirmDeleteBtn1">
                    Delete Document
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Enhanced form handling script -->
<script>
// Enhanced form submission handling for worker updates
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('workerForm');
    if (!form) {
        return;
    }
    
    // Track if form has been modified for better UX
    let formModified = false;
    let originalFormData = {};
    
    // Capture original form values for change detection
    function captureOriginalValues() {
        const formData = new FormData(form);
        for (let [key, value] of formData.entries()) {
            if (!key.includes('TOTAL_FORMS') && !key.includes('INITIAL_FORMS') && key !== 'csrfmiddlewaretoken') {
                originalFormData[key] = value;
            }
        }
    }
    
    // Detect form changes
    function markFormAsModified() {
        if (!formModified) {
            formModified = true;
        }
    }
    
    // Check if form has actual changes
    function hasFormChanges() {
        const currentFormData = new FormData(form);
        let changes = [];
        
        for (let [key, value] of currentFormData.entries()) {
            if (!key.includes('TOTAL_FORMS') && !key.includes('INITIAL_FORMS') && key !== 'csrfmiddlewaretoken') {
                if (originalFormData[key] !== value) {
                    changes.push(`${key}: "${originalFormData[key]}" → "${value}"`);
                }
            }
        }
        
        return changes.length > 0;
    }
    
    // Initialize form
    captureOriginalValues();
    
    // Track form changes with visual feedback
    form.addEventListener('input', function() {
        markFormAsModified();
        updateChangeIndicator();
    });
    
    form.addEventListener('change', function() {
        markFormAsModified();
        updateChangeIndicator();
    });
    
    // Update change indicator
    function updateChangeIndicator() {
        const indicator = document.getElementById('changeIndicator');
        if (indicator) {
            if (hasFormChanges()) {
                indicator.style.display = 'block';
                indicator.innerHTML = '<i class="fa fa-info-circle me-1 text-blue-500"></i><span class="text-blue-600">Changes detected - ready to save</span>';
            } else {
                indicator.style.display = 'none';
            }
        }
    }
   
    // Handle loading states after validation passes (from worker_form_validate.js)
    form.addEventListener('submit', function(e) {
        const isEditMode = document.getElementById('is_edit') && document.getElementById('is_edit').value === 'edit';
        
        if (isEditMode) {
                // Check if there are actual changes to save
                if (!hasFormChanges()) {
                    e.preventDefault();
                    if (typeof toast !== 'undefined') {
                        toast.info('ℹ️ No changes detected to save');
                    } else {
                        alert('No changes detected to save');
                    }
                    return;
                }
        }
        
        // Reset form modification flag
        formModified = false;
        
        // Note: Loading states are handled by worker_form_validate.js after validation
    });
    
    // Simple navigation warning for unsaved changes
    window.addEventListener('beforeunload', function(e) {
        if (formModified && hasFormChanges()) {
            const message = 'You have unsaved changes. Are you sure you want to leave?';
            e.preventDefault();
            e.returnValue = message;
            return message;
        }
    });
    
    // Add visual feedback for form state
    const statusField = document.querySelector('[name="status"]');
    if (statusField) {
        statusField.addEventListener('change', function() {
            // Add subtle visual feedback
            this.style.borderColor = '#059669';
            this.style.borderWidth = '2px';
            
            // Reset border after 2 seconds
            setTimeout(() => {
                this.style.borderColor = '';
                this.style.borderWidth = '';
            }, 2000);
        });
    }
    
    // Modal event listeners for delete confirmation
    const deleteModal = document.getElementById('deleteConfirmModal');
    if (deleteModal) {
        // Close modal when clicking outside
        deleteModal.addEventListener('click', function(e) {
            if (e.target === this) {
                closeDeleteModal();
            }
        });
        
        // Close modal with Escape key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape' && deleteModal.style.display === 'flex') {
                closeDeleteModal();
            }
        });
    }

});
</script>
{% endblock %} 

<!--New UI-->