{% extends 'base/base.html' %}
{% load static %}

{% block title %}Import Workers - Direct Excel Import{% endblock %}

{% block main_class %}col-md-10 ms-sm-auto col-lg-10{% endblock %}

{% block extra_css %}
<style>
    .import-container {
        max-width: 600px;
        margin: 0 auto;
        padding: 15px;
    }

    .import-card {
        background: white;
        border: 1px solid #e5e7eb;
        border-radius: 6px;
        padding: 20px;
    }

    .upload-area {
        border: 2px dashed #d1d5db;
        border-radius: 8px;
        padding: 40px 20px;
        text-align: center;
        cursor: pointer;
        transition: all 0.2s ease;
        background: #f9fafb;
    }

    .upload-area:hover {
        border-color: #4f46e5;
        background: #f8faff;
    }

    .upload-area.dragover {
        border-color: #4f46e5;
        background: #f0f4ff;
    }

    .upload-icon {
        font-size: 48px;
        color: #9ca3af;
        margin-bottom: 12px;
    }

    .btn-import {
        background: #4f46e5;
        color: white;
        border: none;
        padding: 10px 24px;
        border-radius: 6px;
        font-weight: 500;
        cursor: pointer;
        transition: background 0.2s ease;
    }

    .btn-import:hover:not(:disabled) {
        background: #4338ca;
    }

    .btn-import:disabled {
        background: #9ca3af;
        cursor: not-allowed;
    }

    .file-info {
        background: #f3f4f6;
        border-radius: 4px;
        padding: 12px;
        margin-top: 12px;
        display: none;
    }

    .result-message {
        margin-top: 16px;
        padding: 12px;
        border-radius: 6px;
        display: none;
    }

    .result-success {
        background: #d1fae5;
        color: #065f46;
        border: 1px solid #6ee7b7;
    }

    .result-error {
        background: #fee2e2;
        color: #991b1b;
        border: 1px solid #fca5a5;
    }

    .loading {
        display: none;
        text-align: center;
        margin-top: 16px;
    }

    .spinner {
        border: 3px solid #f3f4f6;
        border-top: 3px solid #4f46e5;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
        margin: 0 auto;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
</style>
{% endblock %}

{% block content %}
<div class="import-container">
    <h2 class="mb-4">Direct Excel Import</h2>
    
    <div class="import-card">
        <h5 class="mb-3">Upload Excel File</h5>
        <p class="text-muted small mb-3">Select your Excel file containing worker data. The file will be imported directly without preview.</p>
        
        <form id="importForm" enctype="multipart/form-data">
            {% csrf_token %}
            
            <div class="upload-area" id="uploadArea">
                <div class="upload-icon">üìÅ</div>
                <p class="mb-2"><strong>Click to select Excel file</strong></p>
                <p class="text-muted small">or drag and drop here</p>
                <p class="text-muted small mt-2">Supported formats: .xlsx, .xls</p>
                <input type="file" id="fileInput" name="excel_file" accept=".xlsx,.xls" style="display: none;">
            </div>
            
            <div class="file-info" id="fileInfo">
                <strong>Selected file:</strong> <span id="fileName"></span> 
                (<span id="fileSize"></span>)
            </div>
            
            <div class="loading" id="loading">
                <div class="spinner"></div>
                <p class="mt-2">Importing workers...</p>
            </div>
            
            <div class="result-message result-success" id="successMessage"></div>
            <div class="result-message result-error" id="errorMessage"></div>
            
            <div class="text-center mt-4">
                <button type="submit" class="btn-import" id="importBtn" disabled>
                    Import Workers
                </button>
            </div>
        </form>
    </div>
    
    <div class="mt-3 text-center">
        <a href="{% url 'zone:worker_list' %}" class="text-muted">‚Üê Back to Workers List</a>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('importForm');
    const fileInput = document.getElementById('fileInput');
    const uploadArea = document.getElementById('uploadArea');
    const importBtn = document.getElementById('importBtn');
    const fileInfo = document.getElementById('fileInfo');
    const fileName = document.getElementById('fileName');
    const fileSize = document.getElementById('fileSize');
    const loading = document.getElementById('loading');
    const successMessage = document.getElementById('successMessage');
    const errorMessage = document.getElementById('errorMessage');
    
    // File selection
    uploadArea.addEventListener('click', () => fileInput.click());
    
    fileInput.addEventListener('change', function() {
        if (this.files && this.files[0]) {
            const file = this.files[0];
            fileName.textContent = file.name;
            fileSize.textContent = formatFileSize(file.size);
            fileInfo.style.display = 'block';
            importBtn.disabled = false;
            hideMessages();
        }
    });
    
    // Drag and drop
    uploadArea.addEventListener('dragover', function(e) {
        e.preventDefault();
        this.classList.add('dragover');
    });
    
    uploadArea.addEventListener('dragleave', function() {
        this.classList.remove('dragover');
    });
    
    uploadArea.addEventListener('drop', function(e) {
        e.preventDefault();
        this.classList.remove('dragover');
        
        const files = e.dataTransfer.files;
        if (files.length > 0) {
            fileInput.files = files;
            const event = new Event('change', { bubbles: true });
            fileInput.dispatchEvent(event);
        }
    });
    
    // Form submission
    form.addEventListener('submit', async function(e) {
        e.preventDefault();
        
        if (!fileInput.files || fileInput.files.length === 0) {
            showError('Please select an Excel file');
            return;
        }
        
        hideMessages();
        loading.style.display = 'block';
        importBtn.disabled = true;
        
        try {
            const formData = new FormData(form);
            
            const response = await fetch('{% url "zone:simple_excel_import" %}', {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                },
                credentials: 'same-origin'  // Include cookies for authentication
            });
            
            // Check if response is JSON
            const contentType = response.headers.get("content-type");
            if (!contentType || !contentType.includes("application/json")) {
                throw new Error("Server returned non-JSON response. You may need to login again.");
            }
            
            const data = await response.json();
            
            if (data.success) {
                showSuccess(data.message || `Successfully imported ${data.success_count} workers`);
                
                // Reset form after success
                setTimeout(() => {
                    form.reset();
                    fileInfo.style.display = 'none';
                    importBtn.disabled = true;
                }, 2000);
                
                // Optional: Redirect to workers list after a delay
                setTimeout(() => {
                    window.location.href = '{% url "zone:worker_list" %}';
                }, 3000);
                
            } else {
                let errorMsg = data.error || 'Import failed';
                if (data.errors && data.errors.length > 0) {
                    errorMsg += '\n\nErrors:\n' + data.errors.join('\n');
                }
                showError(errorMsg);
            }
            
        } catch (error) {
            console.error('Import error:', error);
            showError('An error occurred during import: ' + error.message);
        } finally {
            loading.style.display = 'none';
            importBtn.disabled = false;
        }
    });
    
    function formatFileSize(bytes) {
        if (bytes < 1024) return bytes + ' bytes';
        else if (bytes < 1048576) return Math.round(bytes / 1024) + ' KB';
        else return Math.round(bytes / 1048576) + ' MB';
    }
    
    function hideMessages() {
        successMessage.style.display = 'none';
        errorMessage.style.display = 'none';
    }
    
    function showSuccess(message) {
        successMessage.textContent = message;
        successMessage.style.display = 'block';
        errorMessage.style.display = 'none';
    }
    
    function showError(message) {
        errorMessage.textContent = message;
        errorMessage.style.display = 'block';
        errorMessage.style.whiteSpace = 'pre-line';
        successMessage.style.display = 'none';
    }
});
</script>
{% endblock %}