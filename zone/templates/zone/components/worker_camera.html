<div class="col-span-1 rounded-lg border border-gray-200 mt-4 h-auto relative">
    <div class="border-b border-gray-200 py-2 px-3 bg-gray-50 rounded-t-lg">
        <h4 class="text-[16px] font-semibold"><i class="fa fa-camera me-2"></i>Photo</h4>
    </div>
    
    <div class="p-2">
        <!--<div class="photo-mode-toggle mx-2">
            <button type="button" class="mode-btn active" id="file-mode-btn">
                <i class="bi bi-upload"></i> File
            </button>
            <button type="button" class="mode-btn" id="camera-mode-btn">
                <i class="bi bi-camera"></i> Camera
            </button>
        </div>-->
    </div>
    <div class="absolute mx-3 top-25 overflow-hidden w-64 px-2 py-2">{{ form.photo }}</div>
    <!-- File Upload Mode -->
    <div class="application-photo-upload mx-3" id="file-upload-area" onclick="document.getElementById('{{ form.photo.id_for_label }}').click();" style="display: flex;">
        
        {% if worker and worker.photo %}
            <div class="current-photo-display">
                <img src="{% url 'zone:serve_worker_photo' worker.id %}" alt="Current photo" class="application-photo-current">
                <div class="photo-overlay">
                    <i class="bi bi-pencil-fill"></i>
                    <small>Click to change</small>
                </div>
            </div>
        {% else %}
            <div class="photo-placeholder" id="photo-placeholder">
                <div class="placeholder-content">
                    <i class="bi bi-person-plus-fill"></i>
                    <span>Upload Photo</span>
                    <small>Click here</small>
                </div>
            </div>
        {% endif %}
        <div class="photo-preview" id="photo-preview" style="display: none;">
            <img id="photo-preview-img" class="application-photo-preview">
            <div class="photo-overlay">
                <i class="bi bi-check-circle-fill text-success"></i>
                <small>Photo selected</small>
            </div>
        </div>
    </div>

    <!-- Camera Mode -->
    <div class="application-photo-upload mx-3" id="camera-upload-area" style="display: none;">
        {% if worker and worker.photo %}
            <!-- Show current photo in camera mode too -->
            <div class="current-photo-display" id="camera-current-photo" style="width:100%;">
                <img src="{% url 'zone:serve_worker_photo' worker.id %}" alt="Current photo" class="application-photo-current flex">
                <div class="photo-overlay">
                    <i class="bi bi-camera-fill"></i>
                    <small>Current photo - Use camera to replace</small>
                </div>
            </div>
        {% endif %}
        
        <div class="camera-container active cols-span-2 mt-2" id="camera-container">
            <video id="camera-video" class="camera-video" autoplay muted playsinline style="display: none;"></video>
            <canvas id="camera-canvas" style="display: none;"></canvas>
            
            <div class="camera-controls" id="camera-controls">
                <button type="button" class="camera-btn-start button-min-primary" id="start-camera-btn" onclick="startCamera()">
                    <div>
                        <i class="fa fa-camera me-2"></i> 
                      {% if worker and worker.photo %}Replace Photo{% else %}Start Camera{% endif %}
                    </div>
                </button>
                <button type="button" class="camera-btn camera-btn-capture" id="capture-btn" onclick="capturePhoto()" style="display: none;">
                    <i class="bi bi-camera"></i> Capture
                </button>
                <button type="button" class="camera-btn camera-btn-stop" id="stop-camera-btn" onclick="stopCamera()" style="display: none;">
                    <i class="bi bi-camera-video-off"></i> Stop
                </button>
                <button type="button" class="camera-btn camera-btn-start" id="retake-camera-btn" onclick="startCamera()" style="display: none;">
                    <i class="bi bi-arrow-clockwise"></i> Retake Photo
                </button>
            </div>
            
            <div class="camera-status" id="camera-status">
                {% if worker and worker.photo %}Click "Replace Photo" to take a new photo{% else %}Click "Start Camera" to begin{% endif %}
            </div>
            <div class="camera-error" id="camera-error" style="display: none;"></div>
            
            <!-- Captured photo preview -->
            <div class="photo-preview" id="camera-photo-preview" style="display: none;">
                <img id="camera-photo-preview-img" class="application-photo-preview">
                <div class="photo-overlay">
                    <i class="bi bi-check-circle-fill text-success"></i>
                    <small>Photo captured</small>
                </div>
            </div>
        </div>
        
    </div>


    
    <!-- Hide the default Django file widget since we have our custom photo display -->
     
    <div class="relative h-full mx-3 mt-2">
        <div class="photo-requirements w-full py-2">
            <small class="text-muted">
                <i class="bi bi-info-circle me-1"></i>
                JPG, PNG, GIF, BMP<br>
                Max size: 5MB<br>
                Professional headshot preferred
            </small>
        </div>
       

       <div id="photo-requirements" class="absolute z-50 w-full hidden">
        <div class="space-y-1 px-2 py-4 text-sm text-red-800 border border-red-300 rounded-lg bg-red-50" role="alert">
            <span class="font-medium w-full">Photo :</span>
            <span id="text-err">
                The field is required
            </span>
        </div>
    </div>
</div>

<div class="w-full py-3 text-center">
    {% if form.photo.errors %}
        <div class="text-danger mt-1">
            {% for error in form.photo.errors %}{{ error }}{% endfor %}
        </div>
    {% endif %}
</div>

</div>
<script>
    //------------- worker photo with camera and file upload-----------------//
//1. declear var

// Update toggle buttons
var btnFileMode = document.getElementById('file-mode-btn');
var btnCameraMode = document.getElementById('camera-mode-btn');
// Show/hide appropriate sections
var fileUplaodArea = document.getElementById('file-upload-area');
var cameraArea= document.getElementById('camera-upload-area');

// Camera and Photo Upload Functionality
var currentStream = null;
var capturedPhotoBlob = null;

// Photo preview functionality
const photoInput = document.getElementById('{{ form.photo.id_for_label }}');

if (photoInput) {
    photoInput.addEventListener('change', function(e) {
        const file = e.target.files[0];
        const placeholder = document.getElementById('photo-placeholder');
        const preview = document.getElementById('photo-preview');
        const previewImg = document.getElementById('photo-preview-img');
        
        if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                previewImg.src = e.target.result;
                if (placeholder) placeholder.style.display = 'none';
                preview.style.display = 'block';
            };
            reader.readAsDataURL(file);
        } else {
            preview.style.display = 'none';
            if (placeholder) placeholder.style.display = 'block';
        }
    });
}

//2. button trigger
// trigger button file mode
btnFileMode.addEventListener('click', switchToFileUpload)
// trigger button camera mode
btnCameraMode.addEventListener('click', switchToCamera)
//3. create function for switching
// function for switch file upload
function switchToFileUpload(){
    //toggle button
    toggleCssClass(this, ["active"], "add")
    toggleCssClass(btnCameraMode, ["active"], "remove")

    //toggle area
    document.getElementById('file-upload-area').style.display = 'flex';
    document.getElementById('camera-upload-area').style.display = 'none';

    // Stop camera if running
    stopCamera();
    
    // Clear captured photo when switching to file mode
    clearCapturedPhoto();
    
    // Show file preview if there was a file selected
    const photoInput = document.getElementById('{{ form.photo.id_for_label }}');
    if (photoInput && photoInput.files && photoInput.files.length > 0) {
        // Trigger the existing file preview functionality
        photoInput.dispatchEvent(new Event('change', { bubbles: true }));
    }

    hideError();

    console.log("Switch to File uplaod")
}
// function for switch camera
function switchToCamera(){
    //toggle button
    toggleCssClass(this, ["active"], "add")
    toggleCssClass(btnFileMode, ["active"], "remove")
    //toggle area
    document.getElementById('file-upload-area').style.display = 'none';
    document.getElementById('camera-upload-area').style.display = 'flex';
    console.log("Switch to Camera")

     // Clear any file input selection from file mode
    const photoInput = document.getElementById('{{ form.photo.id_for_label }}');
    
    if (photoInput && !capturedPhotoBlob) {
        photoInput.value = '';
    }
    
    // Reset camera UI based on whether we have a captured photo
    if (capturedPhotoBlob) {
        document.getElementById('camera-status').textContent = 'Photo captured - Click "Retake Photo" to take a new photo';
        document.getElementById('camera-photo-preview').style.display = 'block';
        document.getElementById('start-camera-btn').style.display = 'none';
        document.getElementById('retake-camera-btn').style.display = 'inline-flex';
    } else {
        document.getElementById('camera-status').textContent = 'Click "Start Camera" to begin';
        document.getElementById('camera-photo-preview').style.display = 'none';
        document.getElementById('start-camera-btn').style.display = 'inline-flex';
        document.getElementById('retake-camera-btn').style.display = 'none';
    }
    
    // Always hide these buttons when switching to camera mode
    document.getElementById('capture-btn').style.display = 'none';
    document.getElementById('stop-camera-btn').style.display = 'none';
    
    hideError();
}

// Clear captured photo
function clearCapturedPhoto() {
    capturedPhotoBlob = null;
    document.getElementById('camera-photo-preview').style.display = 'none';
    
    // Reset button states
    document.getElementById('start-camera-btn').style.display = 'inline-flex';
    document.getElementById('retake-camera-btn').style.display = 'none';
    document.getElementById('capture-btn').style.display = 'none';
    document.getElementById('stop-camera-btn').style.display = 'none';
    
    // Clear the photo input if it contains a captured photo
    const photoInput = document.getElementById('{{ form.photo.id_for_label }}');
    if (photoInput) {
        photoInput.value = '';
    }
}

// Start camera stream
async function startCamera() {
    try {
        hideError();
        
        // Check if mediaDevices API is available (requires secure context)
        if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
            console.log('Current URL:', window.location.href);
            console.log('Protocol:', window.location.protocol);
            console.log('Hostname:', window.location.hostname);
            
            let helpMessage = 'Camera access is blocked. ';
            if (window.location.hostname === 'kk.lyp') {
                helpMessage += 'To use camera, access this page via http://localhost:8000 instead of http://kk.lyp:8000';
            } else {
                helpMessage += 'Camera requires HTTPS or localhost. Please use file upload instead.';
            }
            throw new Error(helpMessage);
        }
        
        updateCameraStatus('Requesting camera access...');
        
        // Hide captured photo preview when starting new session (don't clear the input yet)
        document.getElementById('camera-photo-preview').style.display = 'none';
        
        const constraints = {
            video: {
                width: { ideal: 640 },
                height: { ideal: 480 },
                facingMode: 'user' // Front-facing camera
            }
        };
        
        currentStream = await navigator.mediaDevices.getUserMedia(constraints);
        
        const video = document.getElementById('camera-video');
        video.srcObject = currentStream;
        video.style.display = 'block';
        
        // Update UI
        document.getElementById('start-camera-btn').style.display = 'none';
        document.getElementById('capture-btn').style.display = 'inline-flex';
        document.getElementById('stop-camera-btn').style.display = 'inline-flex';
        
        updateCameraStatus('Camera ready - Click "Capture" to take photo');
        
    } catch (error) {
        console.error('Error accessing camera:', error);
        let errorMessage = '';
        
        if (error.message) {
            errorMessage = error.message;
        } else if (error.name === 'NotAllowedError') {
            errorMessage = 'Camera access denied. Please allow camera access when prompted and try again.';
        } else if (error.name === 'NotFoundError') {
            errorMessage = 'No camera found on this device.';
        } else if (error.name === 'NotSupportedError') {
            errorMessage = 'Camera not supported in this browser.';
        } else if (error.name === 'NotReadableError') {
            errorMessage = 'Camera is being used by another application.';
        } else {
            errorMessage = 'Camera access failed. Please check your camera settings.';
        }
        
        showError(errorMessage);
        updateCameraStatus('Camera unavailable');
    }
}

// Stop camera stream
function stopCamera() {
    if (currentStream) {
        currentStream.getTracks().forEach(track => track.stop());
        currentStream = null;
    }
    
    const video = document.getElementById('camera-video');
    video.style.display = 'none';
    video.srcObject = null;
    
    // Update UI based on whether we have a captured photo
    if (!capturedPhotoBlob) {
        // No photo captured - show start button
        document.getElementById('start-camera-btn').style.display = 'inline-flex';
        document.getElementById('retake-camera-btn').style.display = 'none';
        document.getElementById('camera-photo-preview').style.display = 'none';
        updateCameraStatus('Camera stopped - Click "Start Camera" to begin');
    } else {
        // Photo captured - show retake button
        document.getElementById('start-camera-btn').style.display = 'none';
        document.getElementById('retake-camera-btn').style.display = 'inline-flex';
        updateCameraStatus('Photo captured - Click "Retake Photo" to take a new photo');
    }
    
    // Always hide capture and stop buttons
    document.getElementById('capture-btn').style.display = 'none';
    document.getElementById('stop-camera-btn').style.display = 'none';
    
    hideError();
}

// Capture photo from camera
function capturePhoto() {
    const video = document.getElementById('camera-video');
    const canvas = document.getElementById('camera-canvas');
    const context = canvas.getContext('2d');
    
    // Set canvas dimensions to match video
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    
    // Draw video frame to canvas
    context.drawImage(video, 0, 0, canvas.width, canvas.height);
    
    // Convert canvas to blob
    canvas.toBlob(function(blob) {
        capturedPhotoBlob = blob;
        
        // Show preview
        const preview = document.getElementById('camera-photo-preview');
        const previewImg = document.getElementById('camera-photo-preview-img');
        
        const url = URL.createObjectURL(blob);
        previewImg.src = url;
        preview.style.display = 'block';
        
        // Create a file object and set it to the input
        const file = new File([blob], 'camera-photo.jpg', { type: 'image/jpeg' });
        
        // Create a new FileList with the captured photo
        const dataTransfer = new DataTransfer();
        dataTransfer.items.add(file);
        
        const photoInput = document.getElementById('{{ form.photo.id_for_label }}');
        photoInput.files = dataTransfer.files;
        
        // Trigger change event for form validation
        photoInput.dispatchEvent(new Event('change', { bubbles: true }));
        
        updateCameraStatus('Photo captured successfully!');
        
        // Stop camera after capture but keep the photo visible
        setTimeout(() => {
            stopCamera();
        }, 1500);
        
    }, 'image/jpeg', 0.9);
}

// Helper functions
function updateCameraStatus(message) {
    document.getElementById('camera-status').textContent = message;
}

function showError(message) {
    const errorElement = document.getElementById('camera-error');
    errorElement.textContent = message;
    errorElement.style.display = 'block';
}

function hideError() {
    document.getElementById('camera-error').style.display = 'none';
}

//----------------end camera---------------------//
</script>