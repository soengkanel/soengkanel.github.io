<div class=" rounded-lg border border-gray-200 mt-4">
    <div class="border-b border-gray-200 py-2 px-3">
        <h4 class="text-[16px] font-semibold"><i class="fa fa-file-image me-2"></i>Documents</h4>
    </div>

    <div id="document-formset" class="py-3">
        {{ formset.management_form }}
        <div id="docForm">
        {% for form_doc in formset reversed %}
        
        <div id="doc-form-{{forloop.counter}}" class="document-form border mx-3 rounded my-3" data-form-idx="{{ forloop.counter0 }}">
            <!-- Hidden formset fields (CRITICAL: Required for Django formsets to work properly) -->
            {% if form_doc.instance.pk %}
                <div class="hidden">
                {{ form_doc.id }}
                </div>
            {% endif %}
            {% if formset.can_delete %}
            <div class="hidden">
                {{ form_doc.DELETE }}
            </div>
            {% endif %}
            
            <div class="flex justify-between items-center px-3 bg-gray-100 py-2 border-b rounded-t">
                <h5 class="font-medium text-blue-500 flex items-center space-x-2 mb-0 pb-0">Document #{{ forloop.counter }}</h5>
                <div class="d-flex align-items-center">
                    {% if is_edit and is_edit == 'edit' %}
                    {% if formset.can_delete and form_doc.instance.pk  %}
                        <div class="delete-checkbox me-2" style="display: none !important;">
                            <label for="{{ form_doc.DELETE.id_for_label }}" class="form-check-label text-sm">
                                <input type="checkbox" class="form-check-input hidden" id="{{ form_doc.DELETE.id_for_label }}" name="{{ form_doc.DELETE.html_name }}" style="display: none;">
                                Delete this document
                            </label>
                        </div>
                        <!-- Delete Document Button for Existing Documents -->
                        <button type="button" class="btn-delete-document button-min-danger me-2" 
                                onclick="deleteDocument(this, '{{ form_doc.instance.pk }}', '{{ form_doc.get_document_type_display }}')"
                                title="Delete this document">
                                <div>
                            <i class="bi bi-trash"></i>
                            <span class="d-none d-md-inline ms-1">Delete</span>
                                </div>
                        </button>
                    {% endif %}
                    {% endif %}
                
                    <!-- Remove Form Button for New/Unsaved Documents -->
                    {% comment %} {% if form_doc.instance.pk %} {% endcomment %}
                    <button type="button" class="btn-doc-close button-min-danger me-2" 
                            onclick="removeDocumentForm(this)" 
                            style="display:none;"
                            title="Remove this form">
                       <div>
                        <i class="fa fa-x"></i>
                        <span class="d-none d-md-inline ms-1">Remove</span>
                       </div>
                    </button>
                    {% comment %} {% endif %} {% endcomment %}
                </div>
               
            </div>
           
            <div id="extract-loading-{{ forloop.counter0 }}" style="display: none;" class="mb-3 px-3 py-2 bg-blue-200 text-blue-800 flex items-center gap-2 font-medium text-xs">
                <i class="fa fa-spinner fa-spin text-blue-800"></i>
                <span>Processing OCR from document file ...</span>
            </div>
            <div class="grid grid-cols-2 gap-4 px-3 py-1 mb-2 mt-3">
                <div class="border rounded col-span-1">
                     <div class="border-b border-gray-200 px-3 py-2">
                        <h4 class="text-[16px] font-semibold"><i class="bi bi-image me-2"></i>Document Review</h4>
                    </div>
                    <div class="px-3 py-3 space-y-3">

                        <div class="relative image-preview-card px-2 py-3 border rounded bg-gray-100 flex flex-col items-center justify-center" style="border:2px dotted #999 !important; min-height:200px; position:relative;">
                            
                            <style>
                                .doc-img-preview img {
                                    border-radius: 8px;
                                    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
                                }
                                .document-image-icon {
                                    min-height: 150px;
                                    width: 100%;
                                }
                            </style>
                            
                            {% if is_edit and is_edit == 'edit' %}
                                <!-- Edit mode: Show existing document or placeholder -->
                                {% if form_doc.instance.pk and form_doc.document_file.name %}
                                    <!-- Document has file - show image -->
                                    <div class="relative doc-img-preview">
                                        <img src="{% url 'zone:serve_encrypted_image' form_doc.instance.pk %}" 
                                             alt="document" 
                                             id="document-image-{{ forloop.counter0 }}" 
                                             class="document-image rounded"
                                             style="max-height: 180px; width: auto; display: block; margin: 0 auto;"
                                             onerror="this.style.display='none'; document.getElementById('document-error-{{ forloop.counter0 }}').style.display='flex';">
                                        <div id="document-error-{{ forloop.counter0 }}" class="document-image-icon flex flex-col items-center justify-center" style="display: none;">
                                            <i class="bi bi-exclamation-triangle text-warning" style="font-size:46px;"></i>
                                            <span class="text-xs text-warning text-center">Image failed to load</span>
                                            <span class="text-xs text-muted text-center">{{ form_doc.instance.document_file.name|slice:"17:" }}</span>
                                        </div>
                                        <input type="hidden" id="document-file-{{ forloop.counter0 }}" value="{{form_doc.instance.document_file.name|slice:"17:"}}"/>
                                        <!-- Show file info -->
                                        <div class="text-center mt-2">
                                            <small class="text-muted">{{ form_doc.instance.get_document_type_display }} - {{ form_doc.instance.document_file.name|slice:"17:" }}</small>
                                        </div>
                                    </div>
                                {% elif form_doc.instance.pk %}
                                    <!-- Document record exists but no file -->
                                    <div id="document-image-icon-{{ forloop.counter0 }}" class="document-image-icon flex flex-col items-center justify-center">
                                        <i class="bi bi-image text-muted" style="font-size:46px;"></i>
                                        <span class="text-xs text-muted text-center">Document record exists</span>
                                        <span class="text-xs text-muted text-center">No file uploaded</span>
                                    </div>
                                {% else %}
                                    <!-- New document form in edit mode -->
                                    <div id="document-image-icon-{{ forloop.counter0 }}" class="document-image-icon flex flex-col items-center justify-center">
                                        <i class="bi bi-image text-gray-500" style="font-size:46px;"></i>
                                        <span class="text-xs text-gray-500 text-center">No document uploaded</span>
                                    </div>
                                    <img src="" alt="document" id="document-image-{{ forloop.counter0 }}" class="document-image rounded hidden">
                                {% endif %}

                                {% if form_doc.instance.pk %}
                                    <!-- New document form in edit mode -->
                                    <div id="document-image-icon-{{ forloop.counter0 }}" class="document-image-icon flex flex-col items-center justify-center" style="display:none;">
                                        <i class="bi bi-image text-gray-500" style="font-size:46px;"></i>
                                        <span class="text-xs text-gray-500 text-center">No document uploaded</span>
                                    </div>
                                    <img src="" alt="document" id="document-image-{{ forloop.counter0 }}" class="document-image rounded hidden">
                                {% endif %}
                                
                            {% else %}
                                <!-- Create mode: Show placeholder -->
                             <div id="document-image-icon-{{ forloop.counter0 }}" class="document-image-icon flex flex-col items-center justify-center">
                                <i class="bi bi-image text-gray-500" style="font-size:46px;"></i>
                                <span class="text-xs text-gray-500 text-center">No document uploaded</span>
                            </div>
                                <img src="" alt="document" id="document-image-{{ forloop.counter0 }}" class="document-image rounded shadow-none hidden" style="width:550px;">
                            {% endif %}
                        </div>
                       <div class="flex flex-col gap-2" id="autoScanArea">
                       
                         <label for="{{form_doc.document_file.id_for_label}}" class="text-sm font-medium">
                                <i class="bi bi-cloud-upload me-2"></i> Upload File
                            </label>
                            <div class="rounded" style="border:2px dotted #999 !important;">
                                {{ form_doc.document_file }}
                                <!-- Hidden field to track if file was uploaded -->
                                <input type="hidden" id="file-uploaded-{{ forloop.counter0 }}" name="{{ form_doc.prefix }}-file_uploaded" value="{% if form_doc.instance.pk and form_doc.instance.document_file %}true{% else %}false{% endif %}">
                            </div>
                            <small class="flex justify-center w-full text-muted text-center mt-2">Supported: JPG, PNG, PDF (Max 5MB)</small>
                            
                            <!-- Show upload status for debugging -->
                            {% if form_doc.instance.pk and form_doc.instance.document_file %}
                                <div class="text-success text-xs mt-1 whitespace-wrap overflow-hidden">
                                    <i class="bi bi-check-circle"></i> File exists: {{ form_doc.instance.document_file.name|slice:"17:" }}
                                </div>
                            {% endif %}

                        {% comment %} {% if is_edit and is_edit == 'edit' %}
                            {% if form_doc.instance.pk and form_doc.document_file.name %}
                                <span class="mt-2 text-xs text-gray-500 text-center">{{form_doc.instance.document_file.name|slice:"17:"}}</span>
                            {% endif %}
                        {% else %}
                            <label for="{{form_doc.document_file.id_for_label}}" class="text-sm font-medium">
                                <i class="bi bi-cloud-upload me-2"></i> Upload File
                            </label>
                            <div class="rounded" style="border:2px dotted #999 !important;">
                                {{ form_doc.document_file }}
                                <!-- Hidden field to track if file was uploaded -->
                                <input type="hidden" id="file-uploaded-{{ forloop.counter0 }}" name="{{ form_doc.prefix }}-file_uploaded" value="{% if form_doc.instance.pk and form_doc.instance.document_file %}true{% else %}false{% endif %}">
                            </div>
                            <small class="flex justify-center w-full text-muted text-center mt-2">Supported: JPG, PNG, PDF (Max 5MB)</small>
                            
                            <!-- Show upload status for debugging -->
                            {% if form_doc.instance.pk and form_doc.instance.document_file %}
                                <div class="text-success text-xs mt-1">
                                    <i class="bi bi-check-circle"></i> File exists: {{ form_doc.instance.document_file.name|slice:"17:" }}
                                </div>
                            {% endif %}
                        {% endif %} {% endcomment %}
                        
                        
                        {% if form_doc.document_file.errors %}
                            <div class="text-danger">
                                {% for error in form_doc.document_file.errors %}{{ error }}{% endfor %}
                            </div>
                        {% endif %}
                       </div>
                       
                    </div>
                </div>

                <div class="border rounded col-span-1">
                    <div class="border-b border-gray-200 px-3 py-2">
                        <h4 class="text-[16px] font-semibold"><i class="bi bi-info-circle me-2"></i>Document Info</h4>
                    </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-3 px-3 py-2 relative">
                    <div id="text-loading-{{ forloop.counter0 }}" class="hidden absolute w-full h-full top-0 left-0 backdrop-blur-md bg-gray-100 opacity-75 flex items-center justify-center">
                        <i class="fa fa-spinner fa-spin text-blue-800"></i>
                    </div>
                
                    <div class="flex flex-col gap-1">
                    <label for="{{ form_doc.document_type.id_for_label }}" class="text-xs font-medium">Document Type<span class="text-red-500">*</span></label>
                    {{ form_doc.document_type }}
                    {% if form_doc.document_type.errors %}
                        <div class="text-danger">
                            {% for error in form_doc.document_type.errors %}{{ error }}{% endfor %}
                        </div>
                    {% endif %}
                </div>

                <div class="flex flex-col gap-1">
                    <label for="{{ form_doc.document_number.id_for_label }}" class="text-xs font-medium">Document Number<span class="text-red-500">*</span> <span class="text-danger" id="doc-no-error-{{ forloop.counter0 }}"></span></label>
                    {{ form_doc.document_number }}
                    {% if form_doc.document_number.errors %}
                        <div class="text-danger">
                            {% for error in form_doc.document_number.errors %}{{ error }}{% endfor %}
                        </div>
                    {% endif %}
                </div>

                <div class="flex flex-col gap-1">
                    <label for="{{ form_doc.issue_date.id_for_label }}" class="text-xs font-medium">Issue Date<span class="text-red-500">*</span></label>
                    {{ form_doc.issue_date }}
                    {% if form_doc.issue_date.errors %}
                        <div class="text-danger">
                            {% for error in form_doc.issue_date.errors %}{{ error }}{% endfor %}
                        </div>
                    {% endif %}
                </div>

                <div class="flex flex-col gap-1">
                    <label for="{{ form_doc.expiry_date.id_for_label }}" class="text-xs font-medium">Expiry Date<span class="text-red-500">*</span> <span class="text-danger" id="expiry-date-error-{{ forloop.counter0 }}"></span></label>
                    {{ form_doc.expiry_date }}
                    {% if form_doc.expiry_date.errors %}
                        <div class="text-danger">
                            {% for error in form_doc.expiry_date.errors %}{{ error }}{% endfor %}
                        </div>
                    {% endif %}
                </div>

                <div class="col-span-2 flex flex-col gap-1">
                    <label for="{{ form_doc.issuing_authority.id_for_label }}" class="text-xs font-medium">Issuing Authority</label>
                    {{ form_doc.issuing_authority }}
                    {% if form_doc.issuing_authority.errors %}
                        <div class="text-danger">
                            {% for error in form_doc.issuing_authority.errors %}{{ error }}{% endfor %}
                        </div>
                    {% endif %}
                </div>

                <div class="col-span-2 flex flex-col gap-1">
                    <label for="{{ form_doc.notes.id_for_label }}" class="text-xs font-medium">Note</label>
                    {{ form_doc.notes }}
                    {% if form_doc.notes.errors %}
                        <div class="text-danger">
                            {% for error in form_doc.notes.errors %}{{ error }}{% endfor %}
                        </div>
                    {% endif %}
                </div>
                </div>
                </div>
            </div>
        </div>
    
        {% endfor %}

        <div class="new-doc-form my-3">
        </div>

        <div class="px-3 w-full">
            <button type="button" class="w-full mt-3 button-min-default " id="btnAddDocForm">
                <div>
                    <i class="fa fa-plus me-1"></i> Add Another Document
                </div>
            </button>
        </div>
        </div>
     
    </div>
</div>
