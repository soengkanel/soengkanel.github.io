{% extends 'base/base.html' %}
{% load static %}

{% block title %}Preview Import - Zone Management{% endblock %}

{% block main_class %}col-md-10 ms-sm-auto col-lg-10{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="page-title-box d-flex align-items-center justify-content-between">
                <h4 class="mb-0">Preview Import - Complete Excel View</h4>
                <div class="page-title-right">
                    <ol class="breadcrumb m-0">
                        <li class="breadcrumb-item"><a href="{% url 'zone:worker_list' %}">Workers</a></li>
                        <li class="breadcrumb-item"><a href="{% url 'zone:import_workers' %}">Import</a></li>
                        <li class="breadcrumb-item active">Preview</li>
                    </ol>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <div class="alert alert-info mb-4">
                        <h5 class="alert-heading">
                            <i class="fas fa-info-circle me-2"></i>Import Preview - Complete Excel Layout
                        </h5>
                        <p class="mb-2">
                            Found <strong>{{ import_data.worker_count }}</strong> workers in the Excel file.
                        </p>
                        <hr>
                        <div class="d-flex gap-3">
                            <div>
                                <i class="fas fa-check-circle text-success me-1"></i>
                                Update existing: <strong>{{ import_data.update_existing|yesno:"Yes,No" }}</strong>
                            </div>
                            <div>
                                <i class="fas fa-times-circle text-warning me-1"></i>
                                Skip duplicates: <strong>{{ import_data.skip_duplicates|yesno:"Yes,No" }}</strong>
                            </div>
                        </div>
                    </div>

                    <h5 class="mb-3">Workers to Import - Complete Excel View (First 10 rows)</h5>
                    
                    <div class="table-responsive" style="max-height: 80vh; overflow: auto;">
                        <table class="table table-bordered table-sm excel-table">
                            <thead class="table-light sticky-top">
                                <tr>
                                    <th width="30" class="excel-col">Row</th>
                                    <th width="40" class="excel-col">A<br><small>NO</small></th>
                                    <th width="80" class="excel-col">B<br><small>PHOTO</small></th>
                                    <th width="120" class="excel-col">C<br><small>NAME</small></th>
                                    <th width="50" class="excel-col">D<br><small>SEX</small></th>
                                    <th width="80" class="excel-col">E<br><small>DOB</small></th>
                                    <th width="90" class="excel-col">F<br><small>NATIONALITY</small></th>
                                    <th width="90" class="excel-col">G<br><small>BUILDING</small></th>
                                    <th width="90" class="excel-col">H<br><small>POSITION</small></th>
                                    <th width="80" class="excel-col">I<br><small>JOINEDDATE</small></th>
                                    <th width="80" class="excel-col">J<br><small>RESIGNEDDATE</small></th>
                                    <th width="80" class="excel-col">K<br><small>IDKH/PASSPORT</small></th>
                                    <th width="100" class="excel-col">L<br><small>PASSPORT NO</small></th>
                                    <th width="90" class="excel-col">M<br><small>PASSPORT DATE</small></th>
                                    <th width="80" class="excel-col">N<br><small>WORKINGPERMIT</small></th>
                                    <th width="90" class="excel-col">O<br><small>WORKINGPERMIT DATE</small></th>
                                    <th width="80" class="excel-col">P<br><small>VISA</small></th>
                                    <th width="90" class="excel-col">Q<br><small>VISA DATE</small></th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for worker in import_data.workers %}
                                <tr class="excel-row">
                                    <!-- Row Number -->
                                    <td class="text-center excel-cell"><strong>{{ worker.row }}</strong></td>
                                    
                                    <!-- A - NO -->
                                    <td class="text-center excel-cell">{{ worker.no|default:"" }}</td>
                                    
                                    <!-- B - PHOTO -->
                                    <td class="text-center excel-cell p-1">
                                        {% if worker.images.B %}
                                            <img src="{{ worker.images.B.data_url }}" 
                                                 alt="Photo" 
                                                 class="excel-image"
                                                 onclick="showImageModal(this, '{{ worker.name }}', 'Photo', 'B{{ worker.row }}')"
                                                 title="Click to view full size">
                                        {% else %}
                                            <span class="no-image">—</span>
                                        {% endif %}
                                    </td>
                                    
                                    <!-- C - NAME -->
                                    <td class="excel-cell"><strong>{{ worker.name|default:"" }}</strong></td>
                                    
                                    <!-- D - SEX -->
                                    <td class="text-center excel-cell">{{ worker.sex|default:"" }}</td>
                                    
                                    <!-- E - DOB -->
                                    <td class="text-center excel-cell">{{ worker.dob|default:"" }}</td>
                                    
                                    <!-- F - NATIONALITY -->
                                    <td class="excel-cell">{{ worker.nationality|default:"" }}</td>
                                    
                                    <!-- G - BUILDING -->
                                    <td class="excel-cell">{{ worker.building|default:"" }}</td>
                                    
                                    <!-- H - POSITION -->
                                    <td class="excel-cell">{{ worker.position|default:"" }}</td>
                                    
                                    <!-- I - JOINEDDATE -->
                                    <td class="text-center excel-cell">{{ worker.joined_date|default:"" }}</td>
                                    
                                    <!-- J - RESIGNEDDATE -->
                                    <td class="text-center excel-cell">{{ worker.resigned_date|default:"" }}</td>
                                    
                                    <!-- K - IDKH/PASSPORT (Image) -->
                                    <td class="text-center excel-cell p-1">
                                        {% if worker.images.K %}
                                            <img src="{{ worker.images.K.data_url }}" 
                                                 alt="Passport" 
                                                 class="excel-image"
                                                 onclick="showImageModal(this, '{{ worker.name }}', 'Passport', 'K{{ worker.row }}')"
                                                 title="Click to view full size">
                                        {% else %}
                                            <span class="no-image">—</span>
                                        {% endif %}
                                    </td>
                                    
                                    <!-- L - PASSPORT NO -->
                                    <td class="excel-cell">{{ worker.passport_no|default:"" }}</td>
                                    
                                    <!-- M - PASSPORT DATE -->
                                    <td class="text-center excel-cell">{{ worker.passport_dates|default:"" }}</td>
                                    
                                    <!-- N - WORKINGPERMIT (Image) -->
                                    <td class="text-center excel-cell p-1">
                                        {% if worker.images.N %}
                                            <img src="{{ worker.images.N.data_url }}" 
                                                 alt="Work Permit" 
                                                 class="excel-image"
                                                 onclick="showImageModal(this, '{{ worker.name }}', 'Work Permit', 'N{{ worker.row }}')"
                                                 title="Click to view full size">
                                        {% else %}
                                            <span class="no-image">—</span>
                                        {% endif %}
                                    </td>
                                    
                                    <!-- O - WORKINGPERMIT DATE -->
                                    <td class="text-center excel-cell">{{ worker.workpermit_dates|default:"" }}</td>
                                    
                                    <!-- P - VISA (Image) -->
                                    <td class="text-center excel-cell p-1">
                                        {% if worker.images.P %}
                                            <img src="{{ worker.images.P.data_url }}" 
                                                 alt="Visa" 
                                                 class="excel-image"
                                                 onclick="showImageModal(this, '{{ worker.name }}', 'Visa', 'P{{ worker.row }}')"
                                                 title="Click to view full size">
                                        {% else %}
                                            <span class="no-image">—</span>
                                        {% endif %}
                                    </td>
                                    
                                    <!-- Q - VISA DATE -->
                                    <td class="text-center excel-cell">{{ worker.visa_dates|default:"" }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>

                    {% if import_data.worker_count > 10 %}
                    <div class="alert alert-light mt-3">
                        <i class="fas fa-info-circle me-2"></i>
                        Showing first 10 workers. Total: <strong>{{ import_data.worker_count }}</strong> workers will be imported.
                    </div>
                    {% endif %}

                    <form method="post" class="mt-4">
                        {% csrf_token %}
                        <div class="d-flex gap-2">
                            <button type="submit" name="action" value="confirm" class="btn btn-success">
                                <i class="fas fa-check me-2"></i>Confirm Import
                            </button>
                            <button type="submit" name="action" value="cancel" class="btn btn-secondary">
                                <i class="fas fa-times me-2"></i>Cancel
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Image Modal -->
<div class="modal fade" id="imageModal" tabindex="-1" aria-labelledby="imageModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="imageModalLabel">Document Preview</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-center">
                <img id="modalImage" src="" alt="" class="img-fluid" style="max-height: 70vh;">
                <div class="mt-3">
                    <p class="mb-1"><strong id="modalWorkerName"></strong></p>
                    <p class="text-muted small mb-0">
                        <span id="modalDocType"></span> - Cell <span id="modalCellRef"></span>
                    </p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<style>
/* Excel-like table styling */
.excel-table {
    font-size: 0.8rem;
    border-collapse: separate;
    border-spacing: 0;
}

.excel-col {
    background-color: #f8f9fa;
    font-weight: 600;
    text-align: center;
    vertical-align: middle;
    border: 1px solid #dee2e6;
    padding: 8px 4px;
    font-size: 0.75rem;
    line-height: 1.2;
}

.excel-col small {
    color: #6c757d;
    font-weight: normal;
    font-size: 0.65rem;
}

.excel-cell {
    border: 1px solid #dee2e6;
    padding: 4px 6px;
    font-size: 0.75rem;
    vertical-align: middle;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    max-width: 0;
}

.excel-row:hover {
    background-color: #f5f5f5;
}

.excel-image {
    max-width: 50px;
    max-height: 60px;
    border-radius: 4px;
    cursor: pointer;
    transition: transform 0.2s ease;
    border: 1px solid #ddd;
}

.excel-image:hover {
    transform: scale(1.1);
    box-shadow: 0 2px 8px rgba(0,0,0,0.15);
}

.no-image {
    color: #adb5bd;
    font-size: 0.7rem;
}

.sticky-top {
    position: sticky;
    top: 0;
    z-index: 10;
}

/* Scrollbar styling */
.table-responsive::-webkit-scrollbar {
    width: 12px;
    height: 12px;
}

.table-responsive::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 6px;
}

.table-responsive::-webkit-scrollbar-thumb {
    background: #c1c1c1;
    border-radius: 6px;
}

.table-responsive::-webkit-scrollbar-thumb:hover {
    background: #a8a8a8;
}
</style>

<script>
function showImageModal(imgElement, workerName, docType, cellRef) {
    const modal = new bootstrap.Modal(document.getElementById('imageModal'));
    const modalImage = document.getElementById('modalImage');
    const modalWorkerName = document.getElementById('modalWorkerName');
    const modalDocType = document.getElementById('modalDocType');
    const modalCellRef = document.getElementById('modalCellRef');
    
    modalImage.src = imgElement.src;
    modalImage.alt = imgElement.alt;
    modalWorkerName.textContent = workerName || 'Unknown Worker';
    modalDocType.textContent = docType;
    modalCellRef.textContent = cellRef;
    
    modal.show();
}

// Keyboard navigation
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        const modal = bootstrap.Modal.getInstance(document.getElementById('imageModal'));
        if (modal) modal.hide();
    }
});
</script>
{% endblock %}