{% extends 'base/base.html' %}
{% load static %}

{% block title %}Preview Import - Zone Management{% endblock %}

{% block main_class %}col-md-10 ms-sm-auto col-lg-10{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="page-title-box d-flex align-items-center justify-content-between">
                <h4 class="mb-0">Preview Import</h4>
                <div class="page-title-right">
                    <ol class="breadcrumb m-0">
                        <li class="breadcrumb-item"><a href="{% url 'zone:worker_list' %}">Workers</a></li>
                        <li class="breadcrumb-item"><a href="{% url 'zone:import_workers' %}">Import</a></li>
                        <li class="breadcrumb-item active">Preview</li>
                    </ol>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <div class="alert alert-info mb-4">
                        <h5 class="alert-heading">
                            <i class="fas fa-info-circle me-2"></i>Import Preview
                        </h5>
                        <p class="mb-2">
                            Found <strong>{{ import_data.worker_count }}</strong> workers in the Excel file.
                        </p>
                        <hr>
                        <div class="d-flex gap-3">
                            <div>
                                <i class="fas fa-check-circle text-success me-1"></i>
                                Update existing: <strong>{{ import_data.update_existing|yesno:"Yes,No" }}</strong>
                            </div>
                            <div>
                                <i class="fas fa-times-circle text-warning me-1"></i>
                                Skip duplicates: <strong>{{ import_data.skip_duplicates|yesno:"Yes,No" }}</strong>
                            </div>
                        </div>
                    </div>
                    
                    {% if import_data.validation %}
                    <!-- Validation Summary -->
                    <div class="alert {% if import_data.validation.error_rows > 0 %}alert-danger{% elif import_data.validation.warning_rows > 0 %}alert-warning{% else %}alert-success{% endif %} mb-4">
                        <h5 class="alert-heading mb-3">
                            {% if import_data.validation.error_rows > 0 %}
                                <i class="fas fa-exclamation-circle me-2"></i>Validation Issues Found
                            {% elif import_data.validation.warning_rows > 0 %}
                                <i class="fas fa-exclamation-triangle me-2"></i>Validation Warnings
                            {% else %}
                                <i class="fas fa-check-circle me-2"></i>Validation Passed
                            {% endif %}
                        </h5>
                        
                        <div class="row mb-3">
                            <div class="col-md-3">
                                <div class="text-center">
                                    <h3 class="mb-0">{{ import_data.validation.valid_rows }}</h3>
                                    <small class="text-muted">Valid Rows</small>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="text-center">
                                    <h3 class="mb-0 text-danger">{{ import_data.validation.error_rows }}</h3>
                                    <small class="text-muted">Error Rows</small>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="text-center">
                                    <h3 class="mb-0 text-warning">{{ import_data.validation.warning_rows }}</h3>
                                    <small class="text-muted">Warning Rows</small>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="text-center">
                                    <h3 class="mb-0">{{ import_data.validation.total_rows }}</h3>
                                    <small class="text-muted">Total Rows</small>
                                </div>
                            </div>
                        </div>
                        
                        {% if import_data.validation.summary.critical_issues %}
                        <div class="mb-2">
                            <strong>Critical Issues:</strong>
                            <ul class="mb-0 mt-1">
                                {% for issue in import_data.validation.summary.critical_issues %}
                                <li>{{ issue }}</li>
                                {% endfor %}
                            </ul>
                        </div>
                        {% endif %}
                        
                        {% if import_data.validation.summary.recommendations %}
                        <div>
                            <strong>Recommendations:</strong>
                            <ul class="mb-0 mt-1">
                                {% for rec in import_data.validation.summary.recommendations %}
                                <li>{{ rec }}</li>
                                {% endfor %}
                            </ul>
                        </div>
                        {% endif %}
                    </div>
                    {% endif %}

                    <h5 class="mb-3">Workers to Import (Preview)</h5>
                    
                    <div class="table-responsive">
                        <table class="table table-bordered table-hover">
                            <thead class="table-light">
                                <tr>
                                    <th width="40">Row</th>
                                    <th width="80">Photo<br><small>Col B</small></th>
                                    <th width="150">Name<br><small>Col C</small></th>
                                    <th width="60">Sex<br><small>Col D</small></th>
                                    <th width="100">Nationality<br><small>Col F</small></th>
                                    <th width="120">Building<br><small>Col G</small></th>
                                    <th width="80">Passport<br><small>Col K</small></th>
                                    <th width="80">Work Permit<br><small>Col N</small></th>
                                    <th width="80">Visa<br><small>Col Q</small></th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for worker in import_data.workers %}
                                <tr>
                                    <td class="text-center">{{ worker.row }}</td>
                                    
                                    <!-- Photo Column (B) -->
                                    <td class="text-center p-2">
                                        {% if worker.images.B %}
                                            <img src="{{ worker.images.B.data_url }}" 
                                                 alt="Worker Photo" 
                                                 class="img-thumbnail preview-image"
                                                 style="max-width: 60px; max-height: 80px; cursor: pointer;"
                                                 onclick="showImageModal(this, '{{ worker.name }}', 'Photo', 'B{{ worker.row }}')"
                                                 title="Click to view full size">
                                        {% else %}
                                            <div class="text-muted small">No Photo</div>
                                        {% endif %}
                                    </td>
                                    
                                    <!-- Worker Info -->
                                    <td>
                                        <strong>{{ worker.name|default:"—" }}</strong>
                                    </td>
                                    <td class="text-center">{{ worker.sex|default:"—" }}</td>
                                    <td>{{ worker.nationality|default:"—" }}</td>
                                    <td>{{ worker.building|default:"—" }}</td>
                                    
                                    <!-- Passport Column (K) -->
                                    <td class="text-center p-2">
                                        {% if worker.images.K %}
                                            <img src="{{ worker.images.K.data_url }}" 
                                                 alt="Passport" 
                                                 class="img-thumbnail preview-image"
                                                 style="max-width: 60px; max-height: 80px; cursor: pointer;"
                                                 onclick="showImageModal(this, '{{ worker.name }}', 'Passport', 'K{{ worker.row }}')"
                                                 title="Click to view full size">
                                        {% else %}
                                            <div class="text-muted small">No Passport</div>
                                        {% endif %}
                                    </td>
                                    
                                    <!-- Work Permit Column (N) -->
                                    <td class="text-center p-2">
                                        {% if worker.images.N %}
                                            <img src="{{ worker.images.N.data_url }}" 
                                                 alt="Work Permit" 
                                                 class="img-thumbnail preview-image"
                                                 style="max-width: 60px; max-height: 80px; cursor: pointer;"
                                                 onclick="showImageModal(this, '{{ worker.name }}', 'Work Permit', 'N{{ worker.row }}')"
                                                 title="Click to view full size">
                                        {% else %}
                                            <div class="text-muted small">No Work Permit</div>
                                        {% endif %}
                                    </td>
                                    
                                    <!-- Visa Column (Q) -->
                                    <td class="text-center p-2">
                                        {% if worker.images.Q %}
                                            <img src="{{ worker.images.Q.data_url }}" 
                                                 alt="Visa" 
                                                 class="img-thumbnail preview-image"
                                                 style="max-width: 60px; max-height: 80px; cursor: pointer;"
                                                 onclick="showImageModal(this, '{{ worker.name }}', 'Visa', 'Q{{ worker.row }}')"
                                                 title="Click to view full size">
                                        {% else %}
                                            <div class="text-muted small">No Visa</div>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>

                    {% if import_data.worker_count > 10 %}
                    <div class="alert alert-light">
                        <i class="fas fa-info-circle me-2"></i>
                        Showing first 10 workers. Total: <strong>{{ import_data.worker_count }}</strong> workers will be imported.
                    </div>
                    {% endif %}

                    <form method="post" class="mt-4">
                        {% csrf_token %}
                        <div class="d-flex gap-2">
                            <button type="submit" name="action" value="confirm" class="btn btn-success">
                                <i class="fas fa-check me-2"></i>Confirm Import
                            </button>
                            <button type="submit" name="action" value="cancel" class="btn btn-secondary">
                                <i class="fas fa-times me-2"></i>Cancel
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Image Modal -->
<div class="modal fade" id="imageModal" tabindex="-1" aria-labelledby="imageModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="imageModalLabel">Image Preview</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-center">
                <img id="modalImage" src="" alt="" class="img-fluid" style="max-height: 70vh;">
                <div class="mt-3">
                    <p class="mb-1"><strong id="modalWorkerName"></strong></p>
                    <p class="text-muted small mb-0">
                        <span id="modalDocType"></span> - Cell <span id="modalCellRef"></span>
                    </p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<style>
.preview-image {
    transition: transform 0.2s ease;
    border-radius: 6px;
}

.preview-image:hover {
    transform: scale(1.05);
    box-shadow: 0 4px 8px rgba(0,0,0,0.2);
}

.table th {
    background-color: #f8f9fa;
    font-weight: 600;
    vertical-align: middle;
    text-align: center;
}

.table th small {
    color: #6c757d;
    font-weight: normal;
}

.table td {
    vertical-align: middle;
}

/* Excel-like styling */
.table-bordered th,
.table-bordered td {
    border: 1px solid #dee2e6;
}

.table tbody tr:hover {
    background-color: #f5f5f5;
}

/* Image placeholder styling */
.text-muted.small {
    font-size: 0.75rem;
    line-height: 1.2;
}
</style>

<script>
function showImageModal(imgElement, workerName, docType, cellRef) {
    const modal = new bootstrap.Modal(document.getElementById('imageModal'));
    const modalImage = document.getElementById('modalImage');
    const modalWorkerName = document.getElementById('modalWorkerName');
    const modalDocType = document.getElementById('modalDocType');
    const modalCellRef = document.getElementById('modalCellRef');
    
    modalImage.src = imgElement.src;
    modalImage.alt = imgElement.alt;
    modalWorkerName.textContent = workerName || 'Unknown Worker';
    modalDocType.textContent = docType;
    modalCellRef.textContent = cellRef;
    
    modal.show();
}

// Add keyboard navigation for image modal
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        const modal = bootstrap.Modal.getInstance(document.getElementById('imageModal'));
        if (modal) modal.hide();
    }
});
</script>
{% endblock %}