{% extends 'base/base.html' %}
{% load static %}

{% block title %}{{ title }}{% endblock %}

{% block extra_css %}
<style>
    /* Compact Standard Design System for ID Cards Management */
    :root {
        --primary: #87CEEB;           /* Light Blue */
        --primary-dark: #4682B4;     /* Steel Blue */
        --secondary: #000000;        /* Pure Black */
        --accent: #B0E0E6;           /* Powder Blue */
        --light: #FFFFFF;            /* Pure White */
        --dark: #000000;             /* Pure Black */
        --success: #28a745;
        --warning: #ffc107;
        --danger: #dc3545;
        --info: #17a2b8;
        --muted: #6c757d;
        --gray-50: #f8f9fa;
        --gray-100: #e9ecef;
        --gray-200: #dee2e6;
        --gray-300: #ced4da;
        --border-radius: 4px;
        --border-radius-sm: 3px;
        --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.05);
        --shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }

    /* Page Container */
    .page-container {
        padding: 1rem;
        max-width: 900px;
        margin: 0 auto;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    }

    /* Page Header */
    .page-header {
        background: var(--light);
        border: 1px solid var(--gray-200);
        border-radius: var(--border-radius);
        border-left: 4px solid var(--primary);
        padding: 1rem 1.25rem;
        margin-bottom: 1rem;
        box-shadow: var(--shadow-sm);
    }

    .page-title {
        font-size: 1.5rem;
        font-weight: 600;
        color: var(--dark);
        margin: 0 0 0.25rem 0;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .page-subtitle {
        color: var(--muted);
        font-size: 0.875rem;
        margin: 0;
    }

    /* Form Card */
    .form-card {
        background: var(--light);
        border: 1px solid var(--gray-200);
        border-radius: var(--border-radius);
        overflow: hidden;
        box-shadow: var(--shadow-sm);
        margin-bottom: 1rem;
    }

    .form-header {
        background: var(--gray-50);
        padding: 0.875rem 1rem;
        border-bottom: 1px solid var(--gray-200);
    }

    .form-title {
        font-size: 0.875rem;
        font-weight: 600;
        color: var(--dark);
        margin: 0;
        display: flex;
        align-items: center;
        gap: 0.375rem;
    }

    .form-body {
        padding: 1.25rem;
    }

    /* Form Elements */
    .form-group {
        margin-bottom: 1rem;
    }

    .form-label {
        display: block;
        font-size: 0.75rem;
        font-weight: 500;
        color: var(--dark);
        margin-bottom: 0.375rem;
        text-transform: uppercase;
        letter-spacing: 0.025em;
    }

    .form-control {
        width: 100%;
        padding: 0.5rem 0.75rem;
        border: 1px solid var(--gray-300);
        border-radius: var(--border-radius-sm);
        font-size: 0.875rem;
        font-family: inherit;
        background: var(--light);
    }

    .form-control:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: 0 0 0 2px rgba(135, 206, 235, 0.2);
    }

    .form-text {
        font-size: 0.6875rem;
        color: var(--muted);
        margin-top: 0.25rem;
    }

    /* Employee Search Autocomplete */
    .worker-search-container {
        position: relative;
    }

    .worker-search-results {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: white;
        border: 1px solid #e2e8f0;
        border-top: none;
        border-radius: 0 0 6px 6px;
        max-height: 300px;
        overflow-y: auto;
        z-index: 1000;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        display: none;
    }

    .worker-search-item {
        padding: 12px;
        border-bottom: 1px solid #f1f5f9;
        cursor: pointer;
    }

    .worker-search-item:hover {
        background-color: #f8fafb;
    }

    .worker-search-item:last-child {
        border-bottom: none;
    }

    .worker-search-item.selected {
        background-color: #3b82f6;
        color: white;
    }

    .worker-info-autocomplete {
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .worker-avatar-autocomplete {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        object-fit: cover;
        border: 1px solid #e2e8f0;
    }

    .worker-avatar-placeholder-autocomplete {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
        font-size: 12px;
    }

    .worker-details-autocomplete h6 {
        font-size: 14px;
        font-weight: 600;
        margin: 0;
        color: inherit;
    }

    .worker-details-autocomplete p {
        font-size: 12px;
        margin: 2px 0 0 0;
        opacity: 0.8;
    }

    .worker-selected-display {
        display: none;
        background: #f0f9ff;
        border: 1px solid #3b82f6;
        border-radius: 6px;
        padding: 12px;
        margin-top: 8px;
    }

    .worker-selected-display.active {
        display: block;
    }

    .worker-selected-info {
        display: flex;
        align-items: center;
        justify-content: space-between;
    }

    .btn-change-worker {
        background: none;
        border: none;
        color: #3b82f6;
        font-size: 12px;
        cursor: pointer;
        padding: 0;
        text-decoration: underline;
    }

    .btn-change-worker:hover {
        color: #2563eb;
    }

    .worker-warning {
        background: #fef3c7;
        border: 1px solid #f59e0b;
        border-radius: 6px;
        padding: 8px 12px;
        margin-top: 8px;
        font-size: 12px;
        color: #92400e;
    }

    .worker-warning i {
        margin-right: 4px;
    }

    .search-loading {
        padding: 12px;
        text-align: center;
        color: #6b7280;
        font-size: 12px;
    }

    .search-no-results {
        padding: 12px;
        text-align: center;
        color: #6b7280;
        font-size: 12px;
    }

    .search-error {
        padding: 12px;
        text-align: center;
        color: #ef4444;
        font-size: 12px;
        background: #fef2f2;
        border: 1px solid #fecaca;
        border-radius: 4px;
        margin: 4px;
    }



    /* Modern form styling */
    .card {
        border: 1px solid #e2e8f0;
        border-radius: 6px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
    }

    .card-header {
        background: #f8fafb;
        border-bottom: 1px solid #e2e8f0;
        padding: 12px 16px;
    }

    .card-title {
        font-size: 14px;
        font-weight: 600;
        color: #1a1a1a;
        margin: 0;
    }

    .form-label {
        font-size: 12px;
        font-weight: 500;
        color: #374151;
        margin-bottom: 4px;
    }

    .form-control, .form-select {
        font-size: 12px;
        padding: 8px 12px;
        border: 1px solid #d1d5db;
        border-radius: 4px;
        background: white;
    }

    .form-control:focus, .form-select:focus {
        border-color: #3b82f6;
        box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.1);
        outline: none;
    }

    .btn-modern {
        font-size: 12px;
        font-weight: 500;
        border-radius: 4px;
        padding: 8px 16px;
        border: none;
        cursor: pointer;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 4px;
    }

    .btn-primary-modern {
        background: #3b82f6;
        color: white;
    }

    .btn-primary-modern:hover {
        background: #2563eb;
        color: white;
    }

    .btn-secondary-modern {
        background: #6b7280;
        color: white;
    }

    .btn-secondary-modern:hover {
        background: #4b5563;
        color: white;
    }

    .btn-outline-modern {
        background: white;
        color: #3b82f6;
        border: 1px solid #3b82f6;
    }

    .btn-outline-modern:hover {
        background: #3b82f6;
        color: white;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid px-4">
    <div class="flex justify-between items-center my-3 ">
        <div>
        <h1 class="text-xl font-semibold">{{ title }}</h1>
        <p class="text-gray-500">
            {% if card %}
                    Update Employee ID card information
                {% else %}
                    Create a new worker ID card
                {% endif %}
        </p>
        </div>
    </div>
  

    <!-- Form Card -->
    <form method="post">
        {% csrf_token %}
    <div class="card">
        <div class="card-header">
            <h5 class="card-title uppercase">
                <i class="bi bi-id-badge me-2"></i>
                Card Information
            </h5>
        </div>
        <div class="card-body">
            
              
                        
                        {% if form.non_field_errors %}
                            <div class="alert alert-danger">
                                {{ form.non_field_errors }}
                            </div>
                        {% endif %}

                        <div class="row g-3">
                            <!-- Employee Selection with Autocomplete -->
                            <div class="col-12">
                                {% if card and card.employee %}
                                    <!-- Show employee as read-only when editing -->
                                    <label class="form-label">
                                        Employee
                                    </label>
                                    <div class="form-control bg-light" style="background-color: #f8f9fa !important;">
                                        <strong>{{ card.employee.full_name }}</strong> 
                                        <span class="text-muted ms-2">
                                            (ID: {{ card.employee.employee_id|default:"N/A" }} 
                                            {% if card.employee.department %}• {{ card.employee.department.name }}{% endif %}
                                            {% if card.employee.position %}• {{ card.employee.position.name }}{% endif %})
                                        </span>
                                    </div>
                                    {{ form.employee }}
                                    <div class="form-text">Employee cannot be changed when updating an existing card</div>
                                {% else %}
                                    <!-- Show search field for new cards -->
                                    <label for="{{ form.employee_search.id_for_label }}" class="form-label">
                                        Select Employee <span class="text-danger">*</span>
                                    </label>
                                    
                                    <div class="worker-search-container">
                                        {{ form.employee_search }}
                                        {{ form.employee }}
                                        
                                        <div class="worker-search-results" id="workerSearchResults">
                                            <!-- Search results will be populated here -->
                                        </div>
                                    </div>
                                    
                                    <div class="worker-selected-display" id="workerSelectedDisplay">
                                        <div class="worker-selected-info">
                                            <div class="worker-info-autocomplete" id="selectedEmployeeInfo">
                                                <!-- Selected worker info will be shown here -->
                                            </div>
                                            <button type="button" class="btn-change-worker" onclick="changeEmployee()">
                                                Change Employee
                                            </button>
                                        </div>
                                    </div>

                                    
                                    {% if form.employee.errors %}
                                        <div class="text-danger small mt-1">{{ form.employee.errors.0 }}</div>
                                    {% endif %}
                                    {% if form.employee_search.errors %}
                                        <div class="text-danger small mt-1">{{ form.employee_search.errors.0 }}</div>
                                    {% endif %}
                                    
                                    <div class="form-text">Search by employee name, ID, email, or phone number</div>
                                {% endif %}
                            </div>

                            <!-- Card Number -->
                            <div class="col-12" id="cardNumberSection">
                                <label for="{{ form.card_number.id_for_label }}" class="form-label">
                                    Card Number
                                </label>
                                {{ form.card_number }}
                                {% if form.card_number.errors %}
                                    <div class="text-danger small mt-1">{{ form.card_number.errors.0 }}</div>
                                {% endif %}
                                <div class="form-text">{{ form.card_number.help_text }}</div>
                                <div class="mt-2">
                                    <button type="button" class="btn btn-sm btn-outline-primary" onclick="generateEmployeeCardNumber()">
                                        <i class="bi bi-magic"></i> Auto-Generate Card Number
                                    </button>
                                </div>
                            </div>

                            <!-- Status -->
                            <div class="col-md-6">
                                <label for="{{ form.status.id_for_label }}" class="form-label">
                                    Status <span class="text-danger">*</span>
                                </label>
                                {{ form.status }}
                                {% if form.status.errors %}
                                    <div class="text-danger small mt-1">{{ form.status.errors.0 }}</div>
                                {% endif %}
                            </div>

                            <!-- Issue Date -->
                            <div class="col-md-6">
                                <label for="{{ form.issue_date.id_for_label }}" class="form-label">
                                    Issue Date
                                </label>
                                {{ form.issue_date }}
                                {% if form.issue_date.errors %}
                                    <div class="text-danger small mt-1">{{ form.issue_date.errors.0 }}</div>
                                {% endif %}
                                <div class="form-text">Date when the card was issued</div>
                            </div>

                            <!-- Expiry Date -->
                            <div class="col-md-6">
                                <label for="{{ form.expiry_date.id_for_label }}" class="form-label">
                                    Expiry Date
                                </label>
                                {{ form.expiry_date }}
                                {% if form.expiry_date.errors %}
                                    <div class="text-danger small mt-1">{{ form.expiry_date.errors.0 }}</div>
                                {% endif %}
                                <div class="form-text">When the card expires (defaults to 1 year)</div>
                            </div>

                            <!-- Notes -->
                            <div class="col-12">
                                <label for="{{ form.notes.id_for_label }}" class="form-label">
                                    Notes
                                </label>
                                {{ form.notes }}
                                {% if form.notes.errors %}
                                    <div class="text-danger small mt-1">{{ form.notes.errors.0 }}</div>
                                {% endif %}
                                <div class="form-text">Additional notes about the ID card</div>
                            </div>
                        </div>

                        
                    
                </div>
            </div>
</div>
<div class="d-flex justify-content-end gap-3 my-4 px-4">
    <a href="{% url 'cards:employee_id_card_list' %}" class="button-min-default">
        Cancel
    </a>
    <button type="submit" class="button-min-primary px-4">
         {{ submit_text }}
    </button>
</div>
</form>

<script>
let searchTimeout;
let selectedEmployee = null;
let currentSelectedIndex = -1;

document.addEventListener('DOMContentLoaded', function() {
    {% if card and card.employee %}
    // When editing, we don't need the search functionality
    // Just ensure the card number section is visible
    const cardNumberSection = document.getElementById('cardNumberSection');
    if (cardNumberSection) {
        cardNumberSection.style.display = 'block';
    }
    {% else %}
    // Only initialize search functionality for new cards
    const searchInput = document.getElementById('{{ form.employee_search.id_for_label }}');
    const hiddenEmployeeField = document.getElementById('{{ form.employee.id_for_label }}');
    const resultsContainer = document.getElementById('workerSearchResults');
    const selectedDisplay = document.getElementById('workerSelectedDisplay');
    const selectedEmployeeInfo = document.getElementById('selectedEmployeeInfo');

    // Ensure search input is visible for new cards
    if (searchInput) {
        searchInput.style.display = 'block';
    }
    if (selectedDisplay) {
        selectedDisplay.classList.remove('active');
    }
    
    // Hide card number section initially for new cards
    const cardNumberSection = document.getElementById('cardNumberSection');
    if (cardNumberSection) {
        cardNumberSection.style.display = 'none';
    }

    // Search input handler
    searchInput.addEventListener('input', function() {
        const query = this.value.trim();
        
        if (query.length < 2) {
            hideResults();
            return;
        }

        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => {
            searchEmployees(query);
        }, 300);
    });

    // Keyboard navigation
    searchInput.addEventListener('keydown', function(e) {
        const items = resultsContainer.querySelectorAll('.worker-search-item');
        
        if (e.key === 'ArrowDown') {
            e.preventDefault();
            currentSelectedIndex = Math.min(currentSelectedIndex + 1, items.length - 1);
            updateSelection(items);
        } else if (e.key === 'ArrowUp') {
            e.preventDefault();
            currentSelectedIndex = Math.max(currentSelectedIndex - 1, -1);
            updateSelection(items);
        } else if (e.key === 'Enter') {
            e.preventDefault();
            if (currentSelectedIndex >= 0 && items[currentSelectedIndex] && resultsContainer.employeesData) {
                selectEmployee(resultsContainer.employeesData[currentSelectedIndex]);
            }
        } else if (e.key === 'Escape') {
            hideResults();
        }
    });

    // Hide results when clicking outside
    document.addEventListener('click', function(e) {
        if (!searchInput.contains(e.target) && !resultsContainer.contains(e.target)) {
            hideResults();
        }
    });

    function searchEmployees(query) {
        resultsContainer.innerHTML = '<div class="search-loading"><i class="bi bi-search"></i> Searching...</div>';
        resultsContainer.style.display = 'block';

        const apiUrl = `{% url 'cards:employee_search_api' %}?q=${encodeURIComponent(query)}`;

        fetch(apiUrl)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                return response.json();
            })
            .then(data => {
                displayResults(data.employees || []);
            })
            .catch(error => {
                console.error('Search error:', error);
                resultsContainer.innerHTML = `
                    <div class="search-error">
                        <i class="bi bi-exclamation-triangle"></i> 
                        Search failed: ${error.message}
                        <br><small>Check console for details</small>
                    </div>
                `;
            });
    }

    function displayResults(employees) {
        if (employees.length === 0) {
            resultsContainer.innerHTML = '<div class="search-no-results">No employees found</div>';
            return;
        }

        resultsContainer.innerHTML = employees.map((employee, index) => {
            const avatarHtml = employee.photo_url 
                ? `<img src="${employee.photo_url}" alt="${employee.name}" class="worker-avatar-autocomplete">`
                : `<div class="worker-avatar-placeholder-autocomplete">${getInitials(employee.name)}</div>`;

            const warningHtml = employee.has_active_card 
                ? '<div class="worker-warning"><i class="bi bi-exclamation-triangle"></i> Employee already has an active ID card</div>'
                : '';

            return `
                <div class="worker-search-item" data-worker-index="${index}">
                    <div class="worker-info-autocomplete">
                        ${avatarHtml}
                        <div class="worker-details-autocomplete">
                            <h6>${employee.name}</h6>
                            <p>ID: ${employee.employee_id} ${employee.department ? '• ' + employee.department : ''} ${employee.position ? '• ' + employee.position : ''}</p>
                        </div>
                    </div>
                    ${warningHtml}
                </div>
            `;
        }).join('');

        // Store employees data for later use
        resultsContainer.employeesData = employees;
        
        // Add click event listeners to search items
        const searchItems = resultsContainer.querySelectorAll('.worker-search-item');
        searchItems.forEach((item, index) => {
            item.addEventListener('click', function() {
                selectEmployee(employees[index]);
            });
        });

        currentSelectedIndex = -1;
    }

    function updateSelection(items) {
        items.forEach((item, index) => {
            item.classList.toggle('selected', index === currentSelectedIndex);
        });
    }

    function selectEmployee(employee) {
        selectedEmployee = employee;
        hiddenEmployeeField.value = employee.id;
        searchInput.value = employee.name;
        hideResults();
        showSelectedEmployee(employee);
    }

    function showSelectedEmployee(employee) {
        
        const avatarHtml = employee.photo_url 
            ? `<img src="${employee.photo_url}" alt="${employee.name}" class="worker-avatar-autocomplete">`
            : `<div class="worker-avatar-placeholder-autocomplete">${getInitials(employee.name)}</div>`;

        selectedEmployeeInfo.innerHTML = `
            ${avatarHtml}
            <div class="worker-details-autocomplete">
                <h6>${employee.name}</h6>
                <p>ID: ${employee.employee_id} ${employee.department ? '• ' + employee.department : ''} ${employee.position ? '• ' + employee.position : ''}</p>
                ${employee.card_number ? `<p><strong>Card Number:</strong> ${employee.card_number}</p>` : ''}
            </div>
        `;

        selectedDisplay.classList.add('active');
        searchInput.style.display = 'none';
        
        // Show Card Number section and populate it
        const cardNumberSection = document.getElementById('cardNumberSection');
        const cardNumberInput = document.getElementById('{{ form.card_number.id_for_label }}');
        
        if (cardNumberSection && cardNumberInput) {
            cardNumberSection.style.display = 'block';
            
            // Populate with employee's existing card number if available
            if (employee.card_number) {
                cardNumberInput.value = employee.card_number;
            } else {
                cardNumberInput.value = '';
                cardNumberInput.placeholder = 'Will be auto-generated when status is Printed/Delivered/Active';
            }
        }
    }

    function hideResults() {
        resultsContainer.style.display = 'none';
        currentSelectedIndex = -1;
    }

    function getInitials(name) {
        return name.split(' ').map(n => n[0]).join('').toUpperCase().substring(0, 2);
    }

    // Make functions globally available
    window.changeEmployee = function() {
        selectedDisplay.classList.remove('active');
        searchInput.style.display = 'block';
        searchInput.value = '';
        hiddenEmployeeField.value = '';
        selectedEmployee = null;
        searchInput.focus();
        
        // Hide Card Number section when changing employee
        const cardNumberSection = document.getElementById('cardNumberSection');
        if (cardNumberSection) {
            cardNumberSection.style.display = 'none';
        }
    };

    window.selectEmployee = selectEmployee;
    {% endif %}
    
    // Generate Employee Card Number function - available for both new and edit modes
    window.generateEmployeeCardNumber = function() {
        {% if card and card.employee %}
        // When editing, we already have the employee
        const cardNumberInput = document.getElementById('{{ form.card_number.id_for_label }}');
        if (!cardNumberInput) return;
        
        // Generate a unique employee card number (EID + year + random)
        const year = new Date().getFullYear();
        const random = Math.floor(Math.random() * 10000).toString().padStart(4, '0');
        const cardNumber = `EID${year}${random}`;
        
        cardNumberInput.value = cardNumber;
        
        // Show success message
        const successMsg = document.createElement('div');
        successMsg.className = 'alert alert-success alert-dismissible fade show mt-2';
        successMsg.innerHTML = `
            <i class="bi bi-check-circle"></i> Generated Card Number: <strong>${cardNumber}</strong>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        cardNumberInput.parentNode.appendChild(successMsg);
        
        // Auto-dismiss after 3 seconds
        setTimeout(() => {
            if (successMsg.parentNode) {
                successMsg.remove();
            }
        }, 3000);
        {% else %}
        // For new cards, check if employee is selected
        if (!selectedEmployee) {
            alert('Please select an employee first');
            return;
        }
        
        const cardNumberInput = document.getElementById('{{ form.card_number.id_for_label }}');
        if (!cardNumberInput) return;
        
        // Generate a unique employee card number (EID + year + random)
        const year = new Date().getFullYear();
        const random = Math.floor(Math.random() * 10000).toString().padStart(4, '0');
        const cardNumber = `EID${year}${random}`;
        
        cardNumberInput.value = cardNumber;
        
        // Show success message
        const successMsg = document.createElement('div');
        successMsg.className = 'alert alert-success alert-dismissible fade show mt-2';
        successMsg.innerHTML = `
            <i class="bi bi-check-circle"></i> Generated Card Number: <strong>${cardNumber}</strong>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        cardNumberInput.parentNode.appendChild(successMsg);
        
        // Auto-dismiss after 3 seconds
        setTimeout(() => {
            if (successMsg.parentNode) {
                successMsg.remove();
            }
        }, 3000);
        {% endif %}
    };
});
</script>
{% endblock %} 