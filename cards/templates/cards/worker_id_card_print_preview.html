{% extends 'base/base.html' %}
{% load static %}
{% load card_codes %}
{% load qr_code %}

{% block title %}Print Preview - {{ total_cards }} Cards{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/tailwind.min.css' %}" media="screen">
<link rel="stylesheet" href="{% static 'css/card-print.css' %}" media="screen">
<meta name="csrf-token" content="{{ csrf_token }}">


<style>
    .print-preview-container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
        background: #f8fafc;
        min-height: 100vh;
    }

    .preview-header {
        background: white;
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 20px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        display: flex;
        justify-content: between;
        align-items: center;
        gap: 20px;
    }

    .header-left {
        flex: 1;
    }

    .header-title {
        font-size: 20px;
        font-weight: 600;
        color: #1f2937;
        margin: 0 0 4px 0;
    }

    .header-subtitle {
        font-size: 14px;
        color: #6b7280;
        margin: 0;
    }

    .header-actions {
        display: flex;
        gap: 12px;
        align-items: center;
    }


    .btn {
        padding: 10px 20px;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 500;
        text-decoration: none;
        border: none;
        cursor: pointer;
        transition: all 0.2s ease;
        display: inline-flex;
        align-items: center;
        gap: 8px;
    }

    .btn-primary {
        background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
        color: white;
    }

    .btn-primary:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
    }

    .btn-secondary {
        background: white;
        color: #6b7280;
        border: 1px solid #e5e7eb;
    }

    .btn-secondary:hover {
        background: #f9fafb;
        color: #374151;
    }

    .stats-grid {
        display: flex;
        gap: 12px;
        margin-bottom: 20px;
        justify-content: flex-start;
    }

    .stat-card {
        background: white;
        border-radius: 8px;
        padding: 12px 16px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        display: flex;
        align-items: center;
        gap: 10px;
        min-width: 0;
        flex-shrink: 0;
    }

    .stat-icon {
        width: 32px;
        height: 32px;
        border-radius: 6px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 14px;
        flex-shrink: 0;
    }

    .stat-icon.blue { background: #dbeafe; color: #1d4ed8; }
    .stat-icon.green { background: #dcfce7; color: #16a34a; }
    .stat-icon.orange { background: #fed7aa; color: #ea580c; }
    .stat-icon.purple { background: #e9d5ff; color: #9333ea; }

    .stat-content {
        display: flex;
        flex-direction: column;
        min-width: 0;
    }

    .stat-value {
        font-size: 18px;
        font-weight: 600;
        color: #1f2937;
        line-height: 1;
        margin-bottom: 2px;
    }

    .stat-label {
        font-size: 12px;
        color: #6b7280;
        line-height: 1;
        white-space: nowrap;
    }

    .preview-info {
        background: white;
        border-radius: 10px;
        padding: 16px 20px;
        margin-bottom: 20px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        display: flex;
        justify-content: between;
        align-items: center;
    }

    .info-left {
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .info-icon {
        width: 40px;
        height: 40px;
        background: #f3f4f6;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #6b7280;
    }

    .info-text h3 {
        margin: 0;
        font-size: 16px;
        font-weight: 600;
        color: #1f2937;
    }

    .info-text p {
        margin: 0;
        font-size: 14px;
        color: #6b7280;
    }

    .info-tip {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 13px;
        color: #6b7280;
        background: #f9fafb;
        padding: 8px 12px;
        border-radius: 6px;
        border: 1px solid #e5e7eb;
    }

    .cards-container {
        background: white;
        border-radius: 12px;
        padding: 24px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .cards-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 20px;
        margin-top: 16px;
    }

    .card-wrapper {
        display: flex;
        justify-content: center;
    }

    @media (max-width: 768px) {
        .print-preview-container {
            padding: 12px;
        }
        
        .preview-header {
            flex-direction: column;
            align-items: flex-start;
            gap: 16px;
        }
        
        .header-actions {
            width: 100%;
            justify-content: stretch;
            flex-direction: column;
            align-items: stretch;
        }

   
        
        .stats-grid {
            flex-wrap: wrap;
            gap: 8px;
        }
        
        .stat-card {
            flex: 1;
            min-width: 120px;
        }
    }

    .cards-page{
        /* avoid a single card being split across pages (browsers vary) */
        break-inside: avoid;
        page-break-inside: avoid;
        -webkit-column-break-inside: avoid;
    }
    .id-card:nth-child(9n) {
        /* modern */
        break-after: page;
        /* older / compatibility */
        page-break-after: always;
        -webkit-column-break-after: always;
      }
      
    @page {size: portrait; margin: 0;}

    @media print {
        @page {
            size: A4 portrait;
            margin: 15mm; /* adjust printer margins */
        }

        .id-card {
            break-inside: avoid;
            page-break-inside: avoid;
          }
        
        /* Force page break after every 9th card */
        .id-card:nth-of-type(9n) {
        page-break-after: always;
        break-after: page;
        }
     
    }
</style>

{% endblock %}

{% block content %}
<!-- Hidden form for CSRF token -->
<form style="display: none;">
    {% csrf_token %}
</form>

<div class="print-preview-container">
    <!-- Header Section -->
    <div class="preview-header no-print">
        <div class="header-left">
            <h1 class="header-title">Print Preview</h1>
            <p class="header-subtitle">{{ total_cards }} worker card{{ total_cards|pluralize }} ready for printing</p>
        </div>
        <div class="header-actions">
            <button onclick="printCard('worker_id_card')" class="btn btn-primary">
                <i class="bi bi-printer"></i>
                Print {{ total_cards }} Card{{ total_cards|pluralize }}
            </button>
        </div>
    </div>

    <!-- Statistics Cards -->
    <div class="stats-grid no-print">
        <div class="stat-card">
            <div class="stat-icon blue">
                <i class="bi bi-credit-card"></i>
            </div>
            <div class="stat-content">
                <div class="stat-value">{{ total_cards }}</div>
                <div class="stat-label">Total</div>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon green">
                <i class="bi bi-check-circle"></i>
            </div>
            <div class="stat-content">
                <div class="stat-value">{{ cards|length }}</div>
                <div class="stat-label">Ready</div>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon orange">
                <i class="bi bi-clock"></i>
            </div>
            <div class="stat-content">
                <div class="stat-value">{{ total_cards }}</div>
                <div class="stat-label">Processing</div>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon purple">
                <i class="bi bi-printer"></i>
            </div>
            <div class="stat-content">
                <div class="stat-value">0</div>
                <div class="stat-label">Printed</div>
            </div>
        </div>
    </div>

    <!-- Print Info -->
    <div class="preview-info no-print">
        <div class="info-left">
            <div class="info-icon">
                <i class="bi bi-info-circle"></i>
            </div>
            <div class="info-text">
                <h3>Worker ID Cards</h3>
                <p>{{ total_cards }} card{{ total_cards|pluralize }} • <span id="current-date"></span></p>
            </div>
        </div>
    </div>

    <!-- Cards Container -->
    <div class="cards-container">
        <div id="worker_id_card">
            <div class="flex flex-wrap gap-1">
    
                {% for card in cards %}
                    <div class="card-wrapper id-card basis-1/3">
                        {% if card.worker.is_vip %}
                            <!-- VIP Card -->
                            <div class="flip-card">
                                <div class="flip-card-inner">
                                    <!-- VIP Front -->
                                    <div class="flip-card-front">
                                        <div class="border-2 border-blue-700 idcar-size rounded-xl flex flex-col justify-end items-center overflow-hidden relative px-1">
                                            <div class="absolute left-0 -top-3 z-0">
                                                <img src="{% static 'images/card-bg/vip-bg.jpeg' %}" />
                                            </div>
                                            <div>
                                                <h1 class="vip-title">VIP</h1>
                                            </div>
                                            <div class="text-center space-y-1 mt-2 z-10">
                                                <h3 class="text-sm font-medium uppercase">{{ card.worker.nickname|upper }}</h3>
                                                <h3 class="text-lg font-bold uppercase">No. {{ card.card_number|default:"0000" }}</h3>
                                            </div>
                                            <div class="w-full flex items-end justify-between py-2 px-2 z-10">
                                                <div>
                                                    <p class="vip-text-footer font-medium">Issue: {{ card.issue_date|date:"d/m/Y"|default:"Pending" }}</p>
                                                    <p class="vip-text-footer font-medium">Expiry: {{ card.expiry_date|date:"d/m/Y"|default:"No expiry" }}</p>
                                                </div>
                                                <div>
                                                    <div class="vip-logo-size">
                                                        <img src="{% static 'images/logos/hr-logo-1.jpeg' %}" alt="Logo" class="w-full" />
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <!-- VIP Back -->
                                    <div class="flip-card-back">
                                        <div class="border-2 border-blue-700 rounded-xl idcar-size relative px-3">
                                            <div class="absolute top-0 left-0 py-2.5 w-full px-3">
                                                <h2 class="text-xs uppercase text-center font-semibold border-b border-gray-700 pb-2">VIP Benefits</h2>
                                            </div>
                                            <div class="space-y-2 mt-5" style="font-size:10px;">
                                                <p>✓ Priority service and support</p>
                                                <p>✓ Exclusive member discounts</p>
                                                <p>✓ Special event invitations</p>
                                                <p>✓ Extended warranty coverage</p>
                                                <p>✓ Complimentary services</p>
                                            </div>
                                            <div class="absolute bottom-0 left-0 py-1.5 w-full px-2">
                                                <div class="w-full flex items-center justify-center border-t py-2 border-gray-500">
                                                    <strong style="font-size:8px;">For VIP support: Contact admin</strong>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        {% else %}
                            <!-- Regular Worker Card -->
                            <div class="flip-card ">
                                <div class="flip-card-inner">
                                    <!-- Front -->
                                    <div class="flip-card-front">
                                        <div class="border border-black idcar-size relative p-0.5">
                                            <div class="absolute top-0 left-0 bg-blue-200 py-1.5 w-full"></div>
                                            <div class="w-full pt-4 px-2 flex flex-col justify-start items-center">
                                                <div class="id-image-size bg-gray-100 flex justify-center items-center">
                                                    {% if card.worker.has_photo %}
                                                        <img src="{{ card.worker.photo_url }}" alt="{{ card.worker.get_full_name }}" class="photo-size" />
                                                    {% elif card.photo %}
                                                        <img src="{{ card.photo.url }}" alt="{{ card.worker.get_full_name }}" class="photo-size" />
                                                    {% else %}
                                                        <i class="bi bi-person text-gray-400" style="font-size: 24px;"></i>
                                                    {% endif %}
                                                </div>
                                            </div>
                                            <div class="mt-2 px-2 font-size space-y-1.5">
                                                <div class="flex items-start">
                                                    <span class="w-16 font-semibold uppercase">ID NO:</span>
                                                    <div class="font-bold text-blue-800" style="font-size:9px !important;">{{ card.card_number|default:"" }}</div>
                                                </div>
                                                <div class="flex items-start">
                                                    <span class="w-16 font-semibold uppercase">Name:</span>
                                                    <span class="font-semibold uppercase text-blue-800">{{ card.worker.get_full_name|upper }}</span>
                                                </div>
                                                <div class="flex items-start">
                                                    <span class="w-16 font-semibold uppercase">Position:</span>
                                                    <span class="font-semibold text-blue-800">{{ card.worker.position.name|default:"WORKER"|upper }}</span>
                                                </div>
                                                <div class="flex items-start">
                                                    <span class="w-16 font-semibold uppercase">Building:</span>
                                                    <span class="font-semibold text-red-500">
                                                        {% if card.worker.zone and card.worker.building and card.worker.floor %}
                                                            {{ card.worker.zone.name }}-{{ card.worker.building.code }}-F{{ card.worker.floor.floor_number }}
                                                        {% else %}
                                                            {{ card.worker.building.name|default:"MAIN"|upper }}
                                                        {% endif %}
                                                    </span>
                                                </div>
                                            </div>
                                            <div class="w-full flex justify-center absolute bottom-4 left-0">
                                                <div class="id-qr-size flex justify-center items-center">
                                                    {% worker_qr_code_simple_format card 70 %}
                                                </div>
                                            </div>
                                            <div class="absolute bottom-0 left-0 bg-blue-200 py-1.5 w-full"></div>
                                        </div>
                                    </div>
                                    <!-- Back -->
                                    <div class="flip-card-back">
                                        <div class="border border-gray-400 idcar-size relative px-3">
                                            <div class="absolute top-0 left-0 py-2.5 w-full px-3">
                                                <h2 class="text-xs uppercase text-center font-semibold border-b border-gray-700 pb-2">Terms & Conditions</h2>
                                            </div>
                                            <div class="space-y-2 mt-5" style="font-size:10px;">
                                                <p>• Property of {% if card.worker.zone %}{{ card.worker.zone.name }}{% else %}{{ card.worker.building.name|default:"Company" }}{% endif %}</p>
                                                <p>• Return upon termination</p>
                                                <p>• Report if lost or stolen</p>
                                                <p>• Authorized personnel only</p>
                                            </div>
                                            <div class="absolute bottom-0 left-0 py-1.5 w-full px-2">
                                                <div class="w-full flex items-center justify-between border-t pt-1 border-gray-500">
                                                    <div class="flex justify-center items-center w-10 h-10">
                                                        {% worker_qr_code_simple_format card 40 %}
                                                    </div>
                                                    <div class="flex flex-col items-center" style="font-size:10px;">
                                                        <strong>Emergency:</strong>
                                                        <span>{{ card.worker.emergency_phone|default:"N/A" }}</span>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        {% endif %}
                    </div>
                {% empty %}
                    <div class="col-span-full text-center py-12 text-gray-500">
                        <i class="bi bi-credit-card text-4xl mb-4 block"></i>
                        <p>No cards selected for preview</p>
                    </div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>

{% block extra_js %}

<script src="{% static 'vendor/qrcodejs/qrcode.min.js' %}"></script>
  <script>
    // Generate QR Code
    new QRCode(document.getElementById("qrcode"), {
      text: "B014-F2-0020",
      width: 70,
      height: 70,
      colorDark: "#000000",
      colorLight: "#ffffff",
      correctLevel: QRCode.CorrectLevel.Q
    });
  </script>

<script>
    // Get today's date
    const today = new Date();
    const formattedDate = today.toLocaleDateString('en-US', {
        year: 'numeric',
        month: 'short',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
    });
    document.getElementById("current-date").textContent = formattedDate;
  </script>
  <script>

    function printCard(cardId) {
        // Clear any existing toast messages first
        const toastContainer = document.getElementById('toast-container');
        if (toastContainer) {
            toastContainer.innerHTML = '';
        }

        // First, record the printing event
        recordPrintEvent().then(() => {
            // Then proceed with actual printing
            var printContents = document.getElementById(cardId).innerHTML;
            
            var elm = document.getElementById(cardId);
         
            elm.classList.remove('flip-card', 'flip-card-front');

            // Store the original content of the body
            var originalContents = document.body.innerHTML;

            // Replace the body's content with only the card's content for printing
            //document.body.innerHTML = printContents;
            var html = `
                <html>
                <head>
                    <title>Print</title>
                    <link rel="stylesheet" href="{% static 'css/tailwind.min.css' %}">
                    <link rel="stylesheet" href="{% static "css/card-print.css" %}" media="all">
                    <meta name="csrf-token" content="{{ csrf_token }}">
                    <style>
                        @media print {
                            @page {
                                size: A4 portrait;
                                margin: 15mm; /* adjust printer margins */
                            }

                            .id-card {
                                break-inside: avoid;
                                page-break-inside: avoid;
                            }
                            
                            /* Force page break after every 9th card */
                            .id-card:nth-of-type(9n) {
                            page-break-after: always;
                            break-after: page;
                            }
                        
                        }
                    </style>
                </head>
                <body>${printContents}</body>
                </html>
            `
            document.write(html);

            // Trigger the browser's print dialog
            window.print();

            // Restore the original content of the body after printing

            document.body.innerHTML = originalContents;

            // Reload the page to clear all CSS and toast messages
            window.location.reload();
        }).catch(error => {
            console.error('Error recording print event:', error);
            // Still allow printing even if recording fails
            var printContents = document.getElementById(cardId).innerHTML;
            var elm = document.getElementById(cardId);
         
            elm.classList.remove('flip-card', 'flip-card-front');

            var originalContents = document.body.innerHTML;
            document.body.innerHTML = printContents;
            window.print();
            document.body.innerHTML = originalContents;
            window.location.reload();
        });
    }

    async function recordPrintEvent() {
        // Get card IDs from URL parameters
        const urlParams = new URLSearchParams(window.location.search);
        const cardIds = urlParams.get('cards');
        
        if (!cardIds) {
            throw new Error('No card IDs found');
        }

        // Get CSRF token
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value || 
                         document.querySelector('meta[name=csrf-token]')?.content;

        // Prepare form data
        const formData = new URLSearchParams();
        formData.append('cards', cardIds);

        const response = await fetch('{% url "cards:worker_id_card_print_confirm" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-CSRFToken': csrfToken,
            },
            body: formData.toString()
        });

        if (!response.ok) {
            throw new Error('Failed to record print event');
        }

        // Parse JSON response to get batch information
        const result = await response.json();
        
        if (result.success) {
            // Show batch information to user
            showBatchInfo(result);
        } else {
            throw new Error(result.message || 'Failed to record print event');
        }

        return result;
    }

    function showBatchInfo(batchInfo) {
        // Create and show a notification with batch information
        const notification = document.createElement('div');
        notification.className = 'batch-notification';
        notification.innerHTML = `
            <div class="batch-notification-content">
                <div class="batch-success-icon">
                    <i class="bi bi-check-circle"></i>
                </div>
                <div class="batch-info">
                    <h4>Print Completed</h4>
                    <p>${batchInfo.message}</p>
                    <div class="batch-details">
                        <span class="batch-count">${batchInfo.cards_printed} cards</span>
                        <span class="batch-date">${new Date(batchInfo.print_date).toLocaleString()}</span>
                    </div>
                </div>
                <button type="button" class="batch-close" onclick="this.parentElement.parentElement.remove()">
                    <i class="bi bi-x"></i>
                </button>
            </div>
        `;

        // Add styles for the notification
        const style = document.createElement('style');
        style.textContent = `
            .batch-notification {
                position: fixed;
                top: 20px;
                right: 20px;
                background: #10b981;
                color: white;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                z-index: 10000;
                max-width: 400px;
                animation: slideIn 0.3s ease-out;
            }
            
            .batch-notification-content {
                display: flex;
                align-items: flex-start;
                gap: 12px;
                padding: 16px;
            }
            
            .batch-success-icon {
                font-size: 24px;
                flex-shrink: 0;
                margin-top: 2px;
            }
            
            .batch-info h4 {
                margin: 0 0 4px 0;
                font-size: 16px;
                font-weight: 600;
            }
            
            .batch-info p {
                margin: 0 0 8px 0;
                font-size: 14px;
                opacity: 0.9;
            }
            
            .batch-details {
                display: flex;
                flex-direction: column;
                gap: 4px;
                font-size: 12px;
                opacity: 0.8;
            }
            
            .batch-details span {
                display: block;
            }
            
            .batch-close {
                background: none;
                border: none;
                color: white;
                font-size: 18px;
                cursor: pointer;
                padding: 4px;
                margin: -4px -4px 0 0;
                border-radius: 4px;
                opacity: 0.7;
                transition: opacity 0.2s;
            }
            
            .batch-close:hover {
                opacity: 1;
                background: rgba(255,255,255,0.1);
            }
            
            @keyframes slideIn {
                from {
                    transform: translateX(100%);
                    opacity: 0;
                }
                to {
                    transform: translateX(0);
                    opacity: 1;
                }
            }
        `;
        
        document.head.appendChild(style);
        document.body.appendChild(notification);

        // Auto-remove after 10 seconds
        setTimeout(() => {
            if (notification.parentElement) {
                notification.remove();
            }
        }, 10000);
    }
</script>


{% endblock %}
{% endblock %} 