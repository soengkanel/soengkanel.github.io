{% extends 'base/base.html' %}
{% load static %}

{% block title %}{{ title }}{% endblock %}

{% block extra_css %}
<style>
    /* Simple Compact Design */
    .page-container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 20px;
    }

    .page-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 2px solid #e5e7eb;
    }

    .page-title {
        font-size: 24px;
        font-weight: 600;
        color: #1a1a1a;
        margin: 0;
    }

    .header-actions {
        display: flex;
        gap: 10px;
    }

    /* Simple Form Layout - Vertical Stack */
    .form-layout {
        display: block;
        space-y: 20px;
    }
    
    .form-layout > div {
        margin-bottom: 20px;
    }

    /* Worker Selection Card */
    .selection-card {
        background: white;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        overflow: hidden;
    }

    .card-header {
        background: #f9fafb;
        padding: 12px 16px;
        border-bottom: 1px solid #e5e7eb;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .card-title {
        font-size: 14px;
        font-weight: 600;
        color: #374151;
        margin: 0;
    }

    .selection-count {
        font-size: 12px;
        background: #3b82f6;
        color: white;
        padding: 2px 8px;
        border-radius: 12px;
        font-weight: 500;
    }

    /* Simple Filters */
    .filters {
        padding: 12px 16px;
        background: #f9fafb;
        border-bottom: 1px solid #e5e7eb;
        display: grid;
        grid-template-columns: 1fr 1fr 1fr auto;
        gap: 8px;
        align-items: end;
    }

    .filter-input {
        font-size: 12px;
        padding: 4px 8px;
        border: 1px solid #d1d5db;
        border-radius: 4px;
        background: white;
    }

    .filter-input:focus {
        border-color: #3b82f6;
        outline: none;
    }

    /* Bulk Actions */
    .bulk-actions {
        padding: 8px 16px;
        background: white;
        border-bottom: 1px solid #e5e7eb;
        display: flex;
        gap: 8px;
        align-items: center;
    }

    .btn-simple {
        font-size: 11px;
        padding: 4px 8px;
        border: 1px solid #d1d5db;
        border-radius: 4px;
        background: white;
        color: #374151;
        cursor: pointer;
        transition: all 0.15s ease;
    }

    .btn-simple:hover {
        border-color: #3b82f6;
        color: #3b82f6;
    }

    .btn-simple.active {
        background: #3b82f6;
        color: white;
        border-color: #3b82f6;
    }

    /* Simple Worker Table */
    .worker-list {
        overflow-y: auto;
        max-height: 400px;
        border: 1px solid #e5e7eb;
        border-radius: 4px;
        background: white;
    }

    .worker-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 12px;
        background: white;
    }

    .worker-table th {
        background: #f9fafb;
        padding: 8px;
        text-align: left;
        font-weight: 500;
        color: #374151;
        border-bottom: 1px solid #e5e7eb;
        font-size: 12px;
    }

    .worker-table th:first-child { width: 40px; text-align: center; }
    .worker-table th:nth-child(2) { width: 50px; text-align: center; }

    .worker-table td {
        padding: 8px;
        border-bottom: 1px solid #f3f4f6;
        vertical-align: middle;
        font-size: 12px;
    }

    .worker-table tr {
        cursor: pointer;
    }

    .worker-table tr:hover {
        background: #f8fafc;
    }

    .worker-table tr.selected {
        background: #eff6ff;
    }

    /* Simple Components */
    .worker-checkbox {
        accent-color: #3b82f6;
    }

    .worker-avatar {
        width: 24px;
        height: 24px;
        border-radius: 50%;
        object-fit: cover;
        border: 1px solid #d1d5db;
        display: block;
        margin: 0 auto;
    }

    .worker-avatar-placeholder {
        width: 24px;
        height: 24px;
        border-radius: 50%;
        background: #3b82f6;
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 9px;
        font-weight: 500;
        margin: 0 auto;
    }

    .worker-name {
        font-weight: 500;
        color: #1f2937;
    }

    .worker-id {
        font-family: monospace;
        font-size: 10px;
        color: #6b7280;
        background: #f3f4f6;
        padding: 1px 4px;
        border-radius: 3px;
    }

    .status-badge {
        font-size: 9px;
        font-weight: 500;
        padding: 2px 4px;
        border-radius: 8px;
        text-transform: uppercase;
    }

    .status-active { background: #dcfce7; color: #166534; }
    .status-probation { background: #fef3c7; color: #a16207; }
    .status-passed { background: #dbeafe; color: #1e40af; }
    .status-extended { background: #f3e8ff; color: #7c3aed; }

    .batch-tag {
        background: #dbeafe;
        color: #1e40af;
        font-size: 9px;
        padding: 2px 4px;
        border-radius: 8px;
        font-weight: 500;
    }

    .batch-tag.no-batch {
        background: #f3f4f6;
        color: #6b7280;
        font-style: italic;
    }

    /* Settings Card - Horizontal Layout */
    .settings-card {
        background: white;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        padding: 16px;
    }

    .settings-row-1 {
        display: grid;
        grid-template-columns: 1fr 1fr 1fr auto;
        gap: 16px;
        margin-bottom: 12px;
        align-items: end;
    }

    .settings-row-2 {
        display: grid;
        grid-template-columns: 1fr;
        gap: 16px;
    }

    .form-group {
        margin-bottom: 12px;
    }

    .form-label {
        font-size: 12px;
        font-weight: 500;
        color: #374151;
        margin-bottom: 4px;
        display: block;
    }

    .form-control {
        font-size: 12px;
        padding: 6px 8px;
        border: 1px solid #d1d5db;
        border-radius: 4px;
        width: 100%;
    }

    .form-control:focus {
        border-color: #3b82f6;
        outline: none;
    }

    .form-check {
        display: flex;
        align-items: center;
        gap: 6px;
    }

    .form-check-input {
        accent-color: #3b82f6;
    }

    .form-check-label {
        font-size: 12px;
        color: #374151;
    }

    .form-text {
        font-size: 10px;
        color: #6b7280;
        margin-top: 2px;
    }

    .btn-create {
        width: 100%;
        font-size: 14px;
        font-weight: 500;
        padding: 10px;
        border: none;
        border-radius: 4px;
        background: #3b82f6;
        color: white;
        cursor: pointer;
        margin-top: 16px;
    }

    .btn-create:hover:not(:disabled) {
        background: #2563eb;
    }

    .btn-create:disabled {
        background: #9ca3af;
        cursor: not-allowed;
    }

    /* Selection Summary */
    .selection-summary {
        background: #3b82f6;
        color: white;
        padding: 8px 16px;
        display: none;
        border-top: 1px solid #2563eb;
    }

    .selection-summary.show {
        display: block;
    }

    /* Responsive */
    @media (max-width: 768px) {
        .settings-row-1 {
            grid-template-columns: 1fr;
            gap: 8px;
        }
        
        .filters {
            grid-template-columns: 1fr;
        }
        
        .worker-list {
            max-height: 300px;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="page-container">
    <!-- Simple Header -->
    <div class="page-header">
        <h1 class="page-title">Batch Create ID Cards</h1>
        <div class="header-actions">
            <button type="button" class="button-min-default" onclick="resetFilters()">
                <i class="bi bi-arrow-clockwise"></i> Reset
            </button>
            <a href="{% url 'cards:worker_id_card_list' 'all' %}" class="button-min-default">
                <i class="bi bi-eye"></i> View Cards
            </a>
        </div>
    </div>

    <!-- Simple Form -->
    <form method="post" id="batchCreateForm" class="form-layout">
        {% csrf_token %}
        
        <!-- Settings -->
        <div class="settings-card">
            <h3 class="card-title" style="margin-bottom: 16px;">Card Settings</h3>

            {% if form.non_field_errors %}
                <div class="alert alert-danger" style="margin-bottom: 12px; padding: 8px; background: #fef2f2; border: 1px solid #fecaca; border-radius: 4px; font-size: 12px;">
                    {{ form.non_field_errors }}
                </div>
            {% endif %}

            <!-- First Row: Status, Issue Date, Expiry Date, Create Button -->
            <div class="settings-row-1">
                <div class="form-group" style="margin-bottom: 0;">
                    <label for="{{ form.status.id_for_label }}" class="form-label">
                        {{ form.status.label }} *
                    </label>
                    {{ form.status }}
                    {% if form.status.errors %}
                        <div style="color: #dc2626; font-size: 10px;">{{ form.status.errors.0 }}</div>
                    {% endif %}
                </div>

                <div class="form-group" style="margin-bottom: 0;">
                    <label for="{{ form.issue_date.id_for_label }}" class="form-label">
                        {{ form.issue_date.label }}
                    </label>
                    {{ form.issue_date }}
                    {% if form.issue_date.errors %}
                        <div style="color: #dc2626; font-size: 10px;">{{ form.issue_date.errors.0 }}</div>
                    {% endif %}
                </div>

                <div class="form-group" style="margin-bottom: 0;">
                    <label for="{{ form.expiry_date.id_for_label }}" class="form-label">
                        {{ form.expiry_date.label }} *
                    </label>
                    {{ form.expiry_date }}
                    {% if form.expiry_date.errors %}
                        <div style="color: #dc2626; font-size: 10px;">{{ form.expiry_date.errors.0 }}</div>
                    {% endif %}
                </div>

                <div>
                    <button type="submit" class="btn-create" id="createButton" disabled style="margin-top: 0; min-width: 120px;">
                        Create ID Cards
                    </button>
                </div>
            </div>

            <!-- Second Row: Notes -->
            <div class="settings-row-2">
                <div class="form-group" style="margin-bottom: 0;">
                    <label for="{{ form.notes.id_for_label }}" class="form-label">
                        {{ form.notes.label }}
                    </label>
                    {{ form.notes }}
                    {% if form.notes.errors %}
                        <div style="color: #dc2626; font-size: 10px;">{{ form.notes.errors.0 }}</div>
                    {% endif %}
                </div>
            </div>
            
            <div class="form-text" style="text-align: center; margin-top: 8px;">
                Select workers to enable creation
            </div>
        </div>
        
        <!-- Worker Selection -->
        <div class="selection-card">
            <!-- Header -->
            <div class="card-header">
                <h3 class="card-title">Select Workers</h3>
                <div class="selection-count" id="selectionCount">0 selected</div>
            </div>

            <!-- Filters -->
            <div class="filters">
                <input type="text" id="batch-filter" class="filter-input" placeholder="Filter by batch..." onkeyup="filterByBatch()">
                <select id="zone-filter" class="filter-input" onchange="filterByZone()">
                    <option value="">All Zones</option>
                </select>
                <select id="building-filter" class="filter-input" onchange="filterByBuilding()">
                    <option value="">All Buildings</option>
                </select>
                <button type="button" class="btn-simple" onclick="clearFilters()">Clear</button>
            </div>

            <!-- Quick Actions -->
            <div class="bulk-actions">
                <button type="button" class="btn-simple" onclick="selectAll()">All</button>
                <button type="button" class="btn-simple" onclick="selectNone()">None</button>
                <button type="button" class="btn-simple" onclick="toggleBatchSelector()" id="batch-selector-btn">By Batch</button>
                <div id="batch-selector" style="display: none; margin-left: auto;">
                    <select id="batch-select" class="filter-input" style="min-width: 120px;" onchange="selectByBatch(this.value)">
                        <option value="">Select batch...</option>
                    </select>
                </div>
            </div>

            <!-- Worker Table -->
            <div class="worker-list">
                {% if form.workers.field.queryset %}
                    <table class="worker-table">
                        <thead>
                            <tr>
                                <th>Select</th>
                                <th>Photo</th>
                                <th>Worker Name</th>
                                <th>ID</th>
                                <th>Position</th>
                                <th>Zone</th>
                                <th>Status</th>
                                <th>Batch</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for worker in form.workers.field.queryset %}
                            <tr class="worker-row" 
                                data-has-photo="{% if worker.photo %}true{% else %}false{% endif %}"
                                data-batch-name="{% if worker.current_probation_period and worker.current_probation_period.batch_name %}{{ worker.current_probation_period.batch_name|lower }}{% else %}individual{% endif %}"
                                data-zone="{% if worker.zone %}{{ worker.zone.name|lower }}{% else %}{% endif %}"
                                data-building="{% if worker.building %}{{ worker.building.name|lower }}{% else %}{% endif %}"
                                data-status="{{ worker.status|lower }}"
                                data-worker-name="{{ worker.get_full_name|lower }}"
                                data-worker-id="{{ worker.worker_id|lower }}"
                                onclick="toggleWorkerSelection({{ worker.pk }})">
                                
                                <td style="text-align: center;">
                                    <input type="checkbox" name="workers" value="{{ worker.pk }}" 
                                           id="worker_{{ worker.pk }}" class="worker-checkbox"
                                           onchange="updateSelection()" onclick="event.stopPropagation()">
                                </td>
                                
                                <td style="text-align: center;">
                                    {% if worker.photo %}
                                        <img src="{% url "zone:serve_worker_photo" worker.id %}" alt="{{ worker.get_full_name }}" class="worker-avatar">
                                    {% else %}
                                        <div class="worker-avatar-placeholder">
                                            {{ worker.get_full_name|first|upper }}
                                        </div>
                                    {% endif %}
                                </td>
                                
                                <td>
                                    <div class="worker-name">{{ worker.get_full_name }}</div>
                                    <div style="font-size: 10px; color: #6b7280;">
                                        {% if worker.building %}{{ worker.building.name }}{% endif %}
                                        {% if worker.floor and worker.building %} - {{ worker.floor.name }}{% endif %}
                                    </div>
                                </td>
                                
                                <td>
                                    <span class="worker-id">{{ worker.worker_id|default:"N/A" }}</span>
                                </td>
                                
                                <td>{{ worker.position.name|default:"N/A" }}</td>
                                
                                <td>{{ worker.zone.name|default:"N/A" }}</td>
                                
                                <td>
                                    <span class="status-badge status-{{ worker.status }}">{{ worker.get_status_display }}</span>
                                </td>
                                
                                <td>
                                    {% if worker.current_probation_period and worker.current_probation_period.batch_name %}
                                        <span class="batch-tag">{{ worker.current_probation_period.batch_name }}</span>
                                    {% else %}
                                        <span class="batch-tag no-batch">Individual</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                {% else %}
                    <div class="empty-state border-none shadow-none">
                        <div class="empty-icon">
                            <i class="bi bi-inbox"></i>
                        </div>
                        <div class="empty-title">No Workers Available</div>
                        <div class="empty-text">All eligible workers may already have active ID cards</div>
                    </div>
                {% endif %}

                <!-- Selection Summary -->
                <div class="selection-summary" id="selectionSummary">
                    <div class="summary-text" id="summaryText">0 workers selected</div>
                </div>
            </div>
        </div>
    </form>
</div>

<script>
function updateSelection() {
    const checkboxes = document.querySelectorAll('.worker-checkbox');
    const selectedCount = document.querySelectorAll('.worker-checkbox:checked').length;
    
    // Update selected state
    checkboxes.forEach(cb => {
        if (cb.checked) {
            cb.closest('tr').classList.add('selected');
        } else {
            cb.closest('tr').classList.remove('selected');
        }
    });
    
    // Update UI elements
    document.getElementById('selectionCount').textContent = `${selectedCount} selected`;
    
    // Update summary
    const summary = document.getElementById('selectionSummary');
    const summaryText = document.getElementById('summaryText');
    
    if (selectedCount > 0) {
        summary.classList.add('show');
        summaryText.textContent = `${selectedCount} worker${selectedCount !== 1 ? 's' : ''} selected`;
    } else {
        summary.classList.remove('show');
    }
    
    // Enable/disable create button
    document.getElementById('createButton').disabled = selectedCount === 0;
}

function toggleWorkerSelection(workerId) {
    const checkbox = document.getElementById('worker_' + workerId);
    checkbox.checked = !checkbox.checked;
    updateSelection();
}

function selectAll() {
    document.querySelectorAll('.worker-checkbox').forEach(cb => {
        cb.checked = true;
    });
    updateSelection();
}

function selectNone() {
    document.querySelectorAll('.worker-checkbox').forEach(cb => {
        cb.checked = false;
    });
    updateSelection();
}


function resetFilters() {
    // Clear all worker selections
    selectNone();
    
    // Reset form settings to defaults
    const statusSelect = document.querySelector('#id_status');
    if (statusSelect) statusSelect.value = 'pending';
    
    const copyPhotoCheckbox = document.querySelector('#id_copy_worker_photo');
    if (copyPhotoCheckbox) copyPhotoCheckbox.checked = true;
    
    const notesTextarea = document.querySelector('#id_notes');
    if (notesTextarea) notesTextarea.value = '';
    
    // Apply filters to reload the page with clean state
    applyFilters();
}

// New filtering functions
function filterByBatch() {
    const filterValue = document.getElementById('batch-filter').value.toLowerCase().trim();
    filterWorkers();
}

function filterByZone() {
    filterWorkers();
}

function filterByBuilding() {
    filterWorkers();
}

function filterByStatus() {
    filterWorkers();
}

function filterWorkers() {
    const batchFilter = document.getElementById('batch-filter').value.toLowerCase().trim();
    const zoneFilter = document.getElementById('zone-filter').value.toLowerCase();
    const buildingFilter = document.getElementById('building-filter').value.toLowerCase();
    const statusFilter = document.getElementById('status-filter').value.toLowerCase();
    
    const workerRows = document.querySelectorAll('.worker-row');
    let visibleCount = 0;
    
    workerRows.forEach(row => {
        let showRow = true;
        
        // Batch name filter
        if (batchFilter) {
            const batchName = row.dataset.batchName || '';
            if (!batchName.includes(batchFilter)) {
                showRow = false;
            }
        }
        
        // Zone filter
        if (zoneFilter && row.dataset.zone !== zoneFilter) {
            showRow = false;
        }
        
        // Building filter
        if (buildingFilter && row.dataset.building !== buildingFilter) {
            showRow = false;
        }
        
        // Status filter
        if (statusFilter && row.dataset.status !== statusFilter) {
            showRow = false;
        }
        
        // Show/hide row
        if (showRow) {
            row.style.display = 'table-row';
            visibleCount++;
        } else {
            row.style.display = 'none';
            // Uncheck hidden items
            const checkbox = row.querySelector('.worker-checkbox');
            if (checkbox.checked) {
                checkbox.checked = false;
            }
        }
    });
    
    // Update selection count after filtering
    updateSelection();
    
    // Show message if no results
    const workerTable = document.querySelector('.worker-table');
    let noResultsMsg = workerTable.querySelector('.no-results-message');
    
    if (visibleCount === 0) {
        if (!noResultsMsg) {
            const tbody = workerTable.querySelector('tbody');
            const row = document.createElement('tr');
            row.className = 'no-results-message';
            row.innerHTML = `
                <td colspan="8" class="empty-state" style="text-align: center; padding: 40px;">
                    <div class="empty-icon"><i class="bi bi-search"></i></div>
                    <div class="empty-title">No Workers Found</div>
                    <div class="empty-text">Try adjusting your filters to see more workers</div>
                </td>
            `;
            tbody.appendChild(row);
            noResultsMsg = row;
        }
        noResultsMsg.style.display = 'table-row';
    } else {
        if (noResultsMsg) {
            noResultsMsg.style.display = 'none';
        }
    }
}

function clearFilters() {
    // Clear filter inputs
    document.getElementById('batch-filter').value = '';
    document.getElementById('zone-filter').value = '';
    document.getElementById('building-filter').value = '';
    document.getElementById('status-filter').value = '';
    
    // Show all workers
    document.querySelectorAll('.worker-row').forEach(row => {
        row.style.display = 'table-row';
    });
    
    // Hide no results message
    const noResultsMsg = document.querySelector('.no-results-message');
    if (noResultsMsg) {
        noResultsMsg.style.display = 'none';
    }
    
    updateSelection();
}

function selectByBatch(batchName) {
    if (!batchName) return;
    
    document.querySelectorAll('.worker-row').forEach(row => {
        if (row.style.display !== 'none') { // Only select visible items
            const checkbox = row.querySelector('.worker-checkbox');
            const itemBatch = row.dataset.batchName || 'individual';
            checkbox.checked = itemBatch === batchName.toLowerCase();
        }
    });
    updateSelection();
}

function toggleBatchSelector() {
    const selector = document.getElementById('batch-selector');
    const btn = document.getElementById('batch-selector-btn');
    
    if (selector.style.display === 'none') {
        selector.style.display = 'block';
        btn.classList.add('active');
        populateBatchOptions();
    } else {
        selector.style.display = 'none';
        btn.classList.remove('active');
    }
}

function applyFilters() {
    // Reload the page to refresh the worker list
    window.location.reload();
}

// Enhanced worker item click handling
document.addEventListener('DOMContentLoaded', function() {
    // Make entire worker item clickable
    document.querySelectorAll('.worker-item').forEach(item => {
        item.addEventListener('click', function(e) {
            if (e.target.type !== 'checkbox') {
                const checkbox = this.querySelector('.worker-checkbox');
                checkbox.checked = !checkbox.checked;
                updateSelection();
            }
        });
    });
    
    // Populate filter dropdowns
    populateFilterOptions();
    
    // Initialize
    updateSelection();
    
    // Add form styling
    document.querySelectorAll('select, input[type="text"], input[type="date"], textarea').forEach(el => {
        el.classList.add('form-control');
    });
    
    document.querySelectorAll('select.filter-select').forEach(el => {
        el.classList.remove('form-control');
    });
});

function populateFilterOptions() {
    const workerRows = document.querySelectorAll('.worker-row');
    const zones = new Set();
    const buildings = new Set();
    
    workerRows.forEach(row => {
        const zone = row.dataset.zone;
        const building = row.dataset.building;
        
        if (zone) zones.add(zone);
        if (building) buildings.add(building);
    });
    
    // Populate zone filter
    const zoneFilter = document.getElementById('zone-filter');
    Array.from(zones).sort().forEach(zone => {
        const option = document.createElement('option');
        option.value = zone;
        option.textContent = zone.charAt(0).toUpperCase() + zone.slice(1);
        zoneFilter.appendChild(option);
    });
    
    // Populate building filter
    const buildingFilter = document.getElementById('building-filter');
    Array.from(buildings).sort().forEach(building => {
        const option = document.createElement('option');
        option.value = building;
        option.textContent = building.charAt(0).toUpperCase() + building.slice(1);
        buildingFilter.appendChild(option);
    });
}

function populateBatchOptions() {
    const workerRows = document.querySelectorAll('.worker-row');
    const batches = new Set();
    
    workerRows.forEach(row => {
        const batchName = row.dataset.batchName;
        if (batchName && batchName !== 'individual') {
            batches.add(batchName);
        }
    });
    
    // Add Individual option
    batches.add('individual');
    
    // Populate batch selector
    const batchSelect = document.getElementById('batch-select');
    // Clear existing options except the first one
    batchSelect.innerHTML = '<option value="">Select batch...</option>';
    
    Array.from(batches).sort().forEach(batch => {
        const option = document.createElement('option');
        option.value = batch;
        option.textContent = batch === 'individual' ? 'Individual' : batch.charAt(0).toUpperCase() + batch.slice(1);
        batchSelect.appendChild(option);
    });
}
</script>
{% endblock %} 