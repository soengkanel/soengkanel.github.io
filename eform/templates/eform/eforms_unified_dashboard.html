{% extends 'base/base.html' %}
{% load static %}

{% block title %}E-Forms - One-Click Creation{% endblock %}

{% block main_class %}col-md-10 ms-sm-auto col-lg-10{% endblock %}

{% block extra_css %}
<style>
/* Override base template transition to prevent left-to-right animation */
#main-content {
    transition: none !important;
}

/* ===========================================
   ULTRA-STREAMLINED E-FORMS - ONE PAGE WORKFLOW
   =========================================== */

:root {
    --primary: #2563eb;
    --primary-50: #eff6ff;
    --primary-100: #dbeafe;
    --secondary: #10b981;
    --secondary-50: #f0fdf4;
    --warning: #f59e0b;
    --danger: #ef4444;
    --success: #22c55e;
    --gray-50: #f9fafb;
    --gray-100: #f3f4f6;
    --gray-200: #e5e7eb;
    --gray-300: #d1d5db;
    --gray-500: #6b7280;
    --gray-600: #4b5563;
    --gray-700: #374151;
    --gray-900: #111827;
}

.one-page-container {
    max-width: 1400px;
    margin: 0 auto;
    padding: 1rem;
    min-height: 100vh;
    background: var(--gray-50);
}

/* ===========================================
   STREAMLINED HEADER
   =========================================== */
.hero-section {
    background: linear-gradient(135deg, var(--primary), #3b82f6);
    color: white;
    padding: 2rem 1.5rem;
    border-radius: 1rem;
    margin-bottom: 2rem;
    text-align: center;
    box-shadow: 0 10px 25px -5px rgb(0 0 0 / 0.1);
}

.hero-title {
    font-size: 2.5rem;
    font-weight: 800;
    margin: 0 0 0.5rem 0;
    letter-spacing: -0.025em;
}

.hero-subtitle {
    font-size: 1.2rem;
    opacity: 0.9;
    margin: 0 0 1.5rem 0;
}

.hero-stats {
    display: flex;
    justify-content: center;
    gap: 2rem;
    flex-wrap: wrap;
}

.stat-pill {
    background: rgba(255, 255, 255, 0.15);
    padding: 0.5rem 1rem;
    border-radius: 9999px;
    font-weight: 600;
    backdrop-filter: blur(10px);
}

/* ===========================================
   QUICK ACTION GRID
   =========================================== */
.quick-actions {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
    gap: 1.5rem;
    margin-bottom: 2rem;
}

.action-panel {
    background: white;
    border-radius: 1rem;
    padding: 1.5rem;
    box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
    border: 2px solid transparent;
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
}

.action-panel:hover {
    border-color: var(--primary);
    transform: translateY(-2px);
    box-shadow: 0 20px 25px -5px rgb(0 0 0 / 0.1);
}

.action-panel.extension {
    background: linear-gradient(135deg, var(--primary-50), var(--primary-100));
}

.action-panel.certificate {
    background: linear-gradient(135deg, var(--secondary-50), #dcfce7);
}

.panel-header {
    display: flex;
    align-items: center;
    gap: 1rem;
    margin-bottom: 1rem;
}

.panel-icon {
    width: 60px;
    height: 60px;
    border-radius: 0.75rem;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.5rem;
    color: white;
    background: linear-gradient(135deg, var(--primary), #3b82f6);
}

.panel-icon.certificate {
    background: linear-gradient(135deg, var(--secondary), #059669);
}

.panel-title {
    font-size: 1.5rem;
    font-weight: 700;
    color: var(--gray-900);
    margin: 0;
}

.panel-subtitle {
    font-size: 0.875rem;
    color: var(--gray-600);
    margin: 0.5rem 0 1.5rem 0;
    line-height: 1.5;
}

/* ===========================================
   INLINE WORKER SEARCH
   =========================================== */
.search-section {
    margin-bottom: 1.5rem;
}

.search-input-group {
    position: relative;
    margin-bottom: 1rem;
}

.search-input {
    width: 100%;
    padding: 0.75rem 1rem 0.75rem 3rem;
    border: 2px solid var(--gray-200);
    border-radius: 0.5rem;
    font-size: 1rem;
    transition: all 0.2s ease;
    background: white;
}

.search-input:focus {
    outline: none;
    border-color: var(--primary);
    box-shadow: 0 0 0 3px var(--primary-50);
}

.search-icon {
    position: absolute;
    left: 1rem;
    top: 50%;
    transform: translateY(-50%);
    color: var(--gray-500);
    font-size: 1.2rem;
}

.search-filters {
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
    margin-bottom: 1rem;
}

.filter-tag {
    background: var(--gray-100);
    color: var(--gray-700);
    padding: 0.25rem 0.75rem;
    border-radius: 9999px;
    font-size: 0.75rem;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s ease;
    border: 1px solid transparent;
}

.filter-tag:hover, .filter-tag.active {
    background: var(--primary);
    color: white;
    border-color: var(--primary);
}

/* ===========================================
   WORKER RESULTS GRID
   =========================================== */
.workers-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    gap: 1rem;
    margin-bottom: 1.5rem;
    max-height: 400px;
    overflow-y: auto;
    padding: 0.5rem;
    border: 1px solid var(--gray-200);
    border-radius: 0.5rem;
    background: var(--gray-50);
}

.worker-card {
    background: white;
    border: 2px solid var(--gray-200);
    border-radius: 0.5rem;
    padding: 1rem;
    cursor: pointer;
    transition: all 0.2s ease;
    position: relative;
}

.worker-card:hover {
    border-color: var(--primary);
    transform: translateY(-1px);
}

.worker-card.selected {
    border-color: var(--primary);
    background: var(--primary-50);
}

.worker-card.selected::after {
    content: '✓';
    position: absolute;
    top: 0.5rem;
    right: 0.5rem;
    background: var(--primary);
    color: white;
    width: 20px;
    height: 20px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.75rem;
    font-weight: bold;
}

.worker-avatar {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    background: var(--gray-200);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.2rem;
    color: var(--gray-600);
    margin-bottom: 0.75rem;
}

.worker-name {
    font-size: 1rem;
    font-weight: 600;
    color: var(--gray-900);
    margin: 0 0 0.25rem 0;
}

.worker-details {
    font-size: 0.75rem;
    color: var(--gray-600);
    margin: 0;
}

/* ===========================================
   QUICK GENERATION BUTTONS
   =========================================== */
.action-buttons {
    display: flex;
    gap: 0.75rem;
    flex-wrap: wrap;
}

.btn-instant {
    background: var(--primary);
    color: white;
    border: none;
    padding: 0.75rem 1.5rem;
    border-radius: 0.5rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s ease;
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    text-decoration: none;
    flex: 1;
    justify-content: center;
}

.btn-instant:hover {
    background: #1d4ed8;
    transform: translateY(-1px);
    color: white;
    text-decoration: none;
}

.btn-instant.secondary {
    background: var(--secondary);
}

.btn-instant.secondary:hover {
    background: #047857;
}

.btn-instant:disabled {
    background: var(--gray-300);
    cursor: not-allowed;
    transform: none;
}

.selected-count {
    background: var(--warning);
    color: white;
    padding: 0.25rem 0.5rem;
    border-radius: 9999px;
    font-size: 0.75rem;
    font-weight: 600;
    margin-left: 0.5rem;
}

/* ===========================================
   RECENT QUICK ACCESS
   =========================================== */
.recent-section {
    background: white;
    border-radius: 1rem;
    padding: 1.5rem;
    box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
    margin-top: 2rem;
}

.recent-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 1rem;
}

.recent-title {
    font-size: 1.25rem;
    font-weight: 700;
    color: var(--gray-900);
    margin: 0;
}

.recent-list {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
}

.recent-item {
    display: flex;
    align-items: center;
    gap: 1rem;
    padding: 0.75rem;
    background: var(--gray-50);
    border-radius: 0.5rem;
    cursor: pointer;
    transition: all 0.2s ease;
}

.recent-item:hover {
    background: var(--gray-100);
    transform: translateX(4px);
}

.recent-icon {
    width: 40px;
    height: 40px;
    border-radius: 0.5rem;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 1rem;
    flex-shrink: 0;
}

.recent-icon.extension {
    background: var(--primary);
}

.recent-icon.certificate {
    background: var(--secondary);
}

.recent-info {
    flex: 1;
}

.recent-name {
    font-weight: 600;
    color: var(--gray-900);
    margin: 0 0 0.25rem 0;
}

.recent-meta {
    font-size: 0.75rem;
    color: var(--gray-600);
    margin: 0;
}

.recent-actions {
    display: flex;
    gap: 0.5rem;
}

.btn-mini {
    background: var(--primary);
    color: white;
    border: none;
    padding: 0.25rem 0.5rem;
    border-radius: 0.25rem;
    font-size: 0.75rem;
    cursor: pointer;
    transition: all 0.2s ease;
}

.btn-mini:hover {
    background: #1d4ed8;
}

.btn-mini.secondary {
    background: var(--gray-500);
}

.btn-mini.secondary:hover {
    background: var(--gray-600);
}

/* ===========================================
   RESPONSIVE DESIGN
   =========================================== */
@media (max-width: 768px) {
    .one-page-container {
        padding: 0.5rem;
    }
    
    .hero-section {
        padding: 1.5rem 1rem;
        margin-bottom: 1.5rem;
    }
    
    .hero-title {
        font-size: 1.75rem;
    }
    
    .hero-subtitle {
        font-size: 1rem;
    }
    
    .hero-stats {
        gap: 1rem;
    }
    
    .quick-actions {
        grid-template-columns: 1fr;
        gap: 1rem;
    }
    
    .workers-grid {
        grid-template-columns: 1fr;
        max-height: 300px;
    }
    
    .action-buttons {
        flex-direction: column;
    }
    
    .btn-instant {
        flex: none;
    }
}

/* ===========================================
   SUCCESS ANIMATIONS
   =========================================== */
@keyframes slideIn {
    from {
        opacity: 0;
        transform: translateY(20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.slide-in {
    animation: slideIn 0.3s ease;
}

@keyframes pulse {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.05); }
}

.pulse {
    animation: pulse 0.5s ease;
}

/* Loading states */
.loading-dots::after {
    content: '...';
    animation: dots 1.5s steps(4, end) infinite;
}

@keyframes dots {
    0%, 20% { content: '.'; }
    40% { content: '..'; }
    60% { content: '...'; }
    80%, 100% { content: ''; }
}
</style>
{% endblock %}

{% block content %}
<div class="one-page-container">
    <!-- Hero Section -->
    <section class="hero-section">
        <h1 class="hero-title">E-Forms Hub</h1>
        <p class="hero-subtitle">Create documents instantly - No more clicking through multiple pages</p>
        <div class="hero-stats">
            <div class="stat-pill">
                <i class="bi bi-people"></i> {{ total_workers|default:0 }} Workers
            </div>
            <div class="stat-pill">
                <i class="bi bi-check-circle"></i> {{ active_workers|default:0 }} Active
            </div>
            <div class="stat-pill">
                <i class="bi bi-lightning"></i> Instant Generation
            </div>
        </div>
    </section>

    <!-- Quick Actions Grid -->
    <div class="quick-actions">
        <!-- Extension Application Panel -->
        <div class="action-panel extension">
            <div class="panel-header">
                <div class="panel-icon">
                    <i class="bi bi-file-earmark-text"></i>
                </div>
                <div>
                    <h2 class="panel-title">Extension Application</h2>
                    <p class="panel-subtitle">Create stay extension forms with auto-filled details</p>
                </div>
            </div>
            
            <div class="search-section">
                <div class="search-input-group">
                    <i class="bi bi-search search-icon"></i>
                    <input type="text" class="search-input" placeholder="Search workers by name, ID, or position..." 
                           id="extension-search" oninput="searchWorkers('extension')">
                </div>
                <div class="search-filters">
                    <span class="filter-tag active" onclick="filterWorkers('extension', 'all')">All</span>
                    <span class="filter-tag" onclick="filterWorkers('extension', 'expiring')">Expiring Soon</span>
                    <span class="filter-tag" onclick="filterWorkers('extension', 'expired')">Expired</span>
                </div>
            </div>

            <div class="workers-grid" id="extension-workers">
                <!-- Workers will be loaded here -->
                <div class="worker-card" onclick="selectWorker(this, 123, 'extension')">
                    <div class="worker-avatar">JS</div>
                    <h4 class="worker-name">John Smith</h4>
                    <p class="worker-details">Building A • Security Guard • Expires in 15 days</p>
                </div>
                <div class="worker-card" onclick="selectWorker(this, 124, 'extension')">
                    <div class="worker-avatar">MJ</div>
                    <h4 class="worker-name">Mary Johnson</h4>
                    <p class="worker-details">Building B • Cleaner • Expires in 22 days</p>
                </div>
                <div class="worker-card" onclick="selectWorker(this, 125, 'extension')">
                    <div class="worker-avatar">RB</div>
                    <h4 class="worker-name">Robert Brown</h4>
                    <p class="worker-details">Building C • Maintenance • Expires in 8 days</p>
                </div>
            </div>

            <div class="action-buttons">
                <button class="btn-instant" id="generate-extension" onclick="generateExtension()" disabled>
                    <i class="bi bi-lightning"></i>
                    Generate Extension Form
                    <span class="selected-count" id="extension-count" style="display: none;">0</span>
                </button>
            </div>
        </div>

        <!-- Certificate Panel -->
        <div class="action-panel certificate">
            <div class="panel-header">
                <div class="panel-icon certificate">
                    <i class="bi bi-award"></i>
                </div>
                <div>
                    <h2 class="panel-title">Employment Certificate</h2>
                    <p class="panel-subtitle">Generate certificates for single or multiple workers</p>
                </div>
            </div>
            
            <div class="search-section">
                <div class="search-input-group">
                    <i class="bi bi-search search-icon"></i>
                    <input type="text" class="search-input" placeholder="Search workers for certificates..." 
                           id="certificate-search" oninput="searchWorkers('certificate')">
                </div>
                <div class="search-filters">
                    <span class="filter-tag active" onclick="filterWorkers('certificate', 'all')">All</span>
                    <span class="filter-tag" onclick="filterWorkers('certificate', 'active')">Active Only</span>
                    <span class="filter-tag" onclick="filterWorkers('certificate', 'recent')">Recently Added</span>
                </div>
            </div>

            <div class="workers-grid" id="certificate-workers">
                <!-- Workers will be loaded here -->
                <div class="worker-card" onclick="selectWorker(this, 123, 'certificate')">
                    <div class="worker-avatar">JS</div>
                    <h4 class="worker-name">John Smith</h4>
                    <p class="worker-details">Building A • Security Guard • Active</p>
                </div>
                <div class="worker-card" onclick="selectWorker(this, 124, 'certificate')">
                    <div class="worker-avatar">MJ</div>
                    <h4 class="worker-name">Mary Johnson</h4>
                    <p class="worker-details">Building B • Cleaner • Active</p>
                </div>
                <div class="worker-card" onclick="selectWorker(this, 125, 'certificate')">
                    <div class="worker-avatar">RB</div>
                    <h4 class="worker-name">Robert Brown</h4>
                    <p class="worker-details">Building C • Maintenance • Active</p>
                </div>
            </div>

            <div class="action-buttons">
                <button class="btn-instant secondary" id="generate-certificate" onclick="generateCertificate()" disabled>
                    <i class="bi bi-award"></i>
                    Generate Certificate
                    <span class="selected-count" id="certificate-count" style="display: none;">0</span>
                </button>
                <button class="btn-instant" id="batch-certificate" onclick="generateBatchCertificate()" disabled>
                    <i class="bi bi-collection"></i>
                    Batch Generate
                    <span class="selected-count" id="batch-count" style="display: none;">0</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Recent Activity -->
    <section class="recent-section">
        <div class="recent-header">
            <h2 class="recent-title">Quick Access & Recent Activity</h2>
            <div class="action-buttons">
                <a href="{% url 'eform:extension_requests_list' %}" class="btn-mini">View All Extensions</a>
                <a href="{% url 'eform:certificate_requests_list' %}" class="btn-mini secondary">View All Certificates</a>
            </div>
        </div>
        
        <div class="recent-list">
            <div class="recent-item" onclick="quickAction('extension', 123)">
                <div class="recent-icon extension">
                    <i class="bi bi-file-text"></i>
                </div>
                <div class="recent-info">
                    <h4 class="recent-name">John Smith - Extension</h4>
                    <p class="recent-meta">Building A • Created 2 hours ago • Ready to print</p>
                </div>
                <div class="recent-actions">
                    <button class="btn-mini" onclick="printDocument('extension', 123)">
                        <i class="bi bi-printer"></i> Print
                    </button>
                    <button class="btn-mini secondary" onclick="editDocument('extension', 123)">
                        <i class="bi bi-pencil"></i> Edit
                    </button>
                </div>
            </div>
            
            <div class="recent-item" onclick="quickAction('certificate', 124)">
                <div class="recent-icon certificate">
                    <i class="bi bi-award"></i>
                </div>
                <div class="recent-info">
                    <h4 class="recent-name">Mary Johnson - Certificate</h4>
                    <p class="recent-meta">Building B • Created yesterday • Batch of 3</p>
                </div>
                <div class="recent-actions">
                    <button class="btn-mini" onclick="printDocument('certificate', 124)">
                        <i class="bi bi-printer"></i> Print
                    </button>
                    <button class="btn-mini secondary" onclick="previewDocument('certificate', 124)">
                        <i class="bi bi-eye"></i> Preview
                    </button>
                </div>
            </div>
        </div>
    </section>
</div>

<script>
// Unified E-Forms JavaScript
let selectedWorkers = {
    extension: [],
    certificate: []
};

function selectWorker(element, workerId, type) {
    const isSelected = element.classList.contains('selected');
    
    if (type === 'extension') {
        // Extension only allows single selection
        document.querySelectorAll('#extension-workers .worker-card').forEach(card => {
            card.classList.remove('selected');
        });
        selectedWorkers.extension = [];
        
        if (!isSelected) {
            element.classList.add('selected');
            selectedWorkers.extension = [workerId];
        }
    } else {
        // Certificate allows multiple selection
        if (isSelected) {
            element.classList.remove('selected');
            selectedWorkers.certificate = selectedWorkers.certificate.filter(id => id !== workerId);
        } else {
            element.classList.add('selected');
            selectedWorkers.certificate.push(workerId);
        }
    }
    
    updateActionButtons(type);
}

function updateActionButtons(type) {
    if (type === 'extension') {
        const count = selectedWorkers.extension.length;
        const button = document.getElementById('generate-extension');
        const countElement = document.getElementById('extension-count');
        
        button.disabled = count === 0;
        if (count > 0) {
            countElement.textContent = count;
            countElement.style.display = 'inline';
        } else {
            countElement.style.display = 'none';
        }
    } else {
        const count = selectedWorkers.certificate.length;
        const singleButton = document.getElementById('generate-certificate');
        const batchButton = document.getElementById('batch-certificate');
        const singleCount = document.getElementById('certificate-count');
        const batchCount = document.getElementById('batch-count');
        
        singleButton.disabled = count === 0;
        batchButton.disabled = count < 2;
        
        if (count > 0) {
            singleCount.textContent = count;
            singleCount.style.display = 'inline';
            batchCount.textContent = count;
            batchCount.style.display = count > 1 ? 'inline' : 'none';
        } else {
            singleCount.style.display = 'none';
            batchCount.style.display = 'none';
        }
    }
}

function generateExtension() {
    const workerId = selectedWorkers.extension[0];
    if (workerId) {
        // Add loading state
        const button = document.getElementById('generate-extension');
        button.innerHTML = '<i class="bi bi-hourglass"></i> Generating<span class="loading-dots"></span>';
        button.disabled = true;
        
        // Redirect to print form
        setTimeout(() => {
            window.location.href = `{% url 'eform:print_extension_form' 0 %}`.replace('0', workerId);
        }, 1000);
    }
}

function generateCertificate() {
    const workers = selectedWorkers.certificate;
    if (workers.length > 0) {
        const button = document.getElementById('generate-certificate');
        button.innerHTML = '<i class="bi bi-hourglass"></i> Creating Request<span class="loading-dots"></span>';
        button.disabled = true;
        
        // Redirect to certificate request form
        setTimeout(() => {
            window.location.href = `{% url 'eform:certificate_request_form' %}?workers=${workers.join(',')}`;
        }, 1000);
    }
}

function generateBatchCertificate() {
    const workers = selectedWorkers.certificate;
    if (workers.length > 1) {
        const button = document.getElementById('batch-certificate');
        button.innerHTML = '<i class="bi bi-hourglass"></i> Creating Batch<span class="loading-dots"></span>';
        button.disabled = true;
        
        // Redirect to certificate request form for batch
        setTimeout(() => {
            window.location.href = `{% url 'eform:certificate_request_form' %}?workers=${workers.join(',')}`;
        }, 1000);
    }
}

function searchWorkers(type) {
    const searchInput = document.getElementById(type + '-search');
    const query = searchInput.value.toLowerCase();
    const workers = document.querySelectorAll(`#${type}-workers .worker-card`);
    
    workers.forEach(worker => {
        const name = worker.querySelector('.worker-name').textContent.toLowerCase();
        const details = worker.querySelector('.worker-details').textContent.toLowerCase();
        
        if (name.includes(query) || details.includes(query)) {
            worker.style.display = 'block';
        } else {
            worker.style.display = 'none';
        }
    });
}

function filterWorkers(type, filter) {
    // Update active filter tag
    const filterTags = document.querySelectorAll(`[onclick*="${type}"] .filter-tag`);
    filterTags.forEach(tag => tag.classList.remove('active'));
    event.target.classList.add('active');
    
    // Apply filter logic (placeholder)
    const workers = document.querySelectorAll(`#${type}-workers .worker-card`);
    workers.forEach(worker => {
        if (filter === 'all') {
            worker.style.display = 'block';
        } else {
            // Add specific filter logic based on worker data
            worker.style.display = 'block';
        }
    });
}

function quickAction(type, id) {
    // Quick access to recent documents
    if (type === 'extension') {
        window.location.href = `{% url 'eform:print_extension_form' 0 %}`.replace('0', id);
    } else {
        window.location.href = `{% url 'eform:print_certificate_form' %}?workers=${id}`;
    }
}

function printDocument(type, id) {
    event.stopPropagation();
    if (type === 'extension') {
        window.open(`{% url 'eform:print_extension_form' 0 %}`.replace('0', id), '_blank');
    } else {
        window.open(`{% url 'eform:print_certificate_form' %}?workers=${id}`, '_blank');
    }
}

function editDocument(type, id) {
    event.stopPropagation();
    if (type === 'extension') {
        window.location.href = `{% url 'eform:extension_edit_form' 0 %}`.replace('0', id);
    } else {
        window.location.href = `{% url 'eform:certificate_edit_form' 0 %}`.replace('0', id);
    }
}

function previewDocument(type, id) {
    event.stopPropagation();
    if (type === 'certificate') {
        window.open(`{% url 'eform:print_certificate_form' %}?workers=${id}`, '_blank');
    }
}

// Auto-refresh recent activity
setInterval(() => {
    // Placeholder for AJAX refresh of recent activity
    console.log('Refreshing recent activity...');
}, 30000);

// Initialize
document.addEventListener('DOMContentLoaded', function() {
    console.log('E-Forms Unified Dashboard loaded');
});
</script>
{% endblock %} 