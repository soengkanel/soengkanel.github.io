{% extends 'base/base.html' %}
{% load static %}

{% block title %}Extension Edit Form - {{ worker.get_full_name }}{% endblock %}

{% block extra_css %}
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="{% static 'vendor/fonts/google-fonts.css' %}" rel="stylesheet">
<script src="{% static 'js/tailwindcss.js' %}"></script>
<style>
/* Extension Edit Form - Print Preview Style */
:root {
    --primary: #3b82f6;
    --success: #10b981;
    --gray-50: #f9fafb;
    --gray-100: #f3f4f6;
    --gray-200: #e5e7eb;
    --gray-300: #d1d5db;
    --gray-500: #6b7280;
    --gray-600: #4b5563;
    --gray-700: #374151;
    --gray-800: #1f2937;
    --gray-900: #111827;
    --white: #ffffff;
}

.moul-regular {
    font-family: "Moul", serif;
    font-weight: 400;
    font-style: normal;
}
.time-roman{
    font-family: 'Times New Roman', Times, serif;
    font-style: normal;
}
.noto-sans-sc-500 {
    font-family: "Noto Sans SC", sans-serif;
    font-optical-sizing: auto;
    font-weight: 500;
    font-style: normal;
}
.kh-content-regular {
    font-family: "Content", system-ui;
    font-weight: 400;
    font-style: normal;
}

body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    background: var(--gray-50);
}

.edit-container {
    max-width: 1000px;
    margin: 0 auto;
    padding: 20px;
}

/* Header Section */
.edit-header {
    background: var(--white);
    border: 1px solid var(--gray-200);
    border-radius: 8px;
    margin-bottom: 16px;
    padding: 16px 24px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
}

.edit-title {
    font-size: 18px;
    font-weight: 600;
    color: var(--gray-900);
    margin: 0;
}

.edit-subtitle {
    font-size: 12px;
    color: var(--gray-500);
    margin: 4px 0 0 0;
}

.btn-edit {
    padding: 8px 16px;
    font-size: 12px;
    font-weight: 500;
    border: 1px solid var(--gray-300);
    background: var(--white);
    color: var(--gray-700);
    text-decoration: none;
    border-radius: 6px;
    display: inline-flex;
    align-items: center;
    gap: 6px;
    transition: all 0.15s;
}

.btn-edit:hover {
    background: var(--gray-50);
    border-color: var(--gray-400);
}

.btn-edit.primary {
    background: var(--primary);
    border-color: var(--primary);
    color: var(--white);
}

.btn-edit.success {
    background: var(--success);
    border-color: var(--success);
    color: var(--white);
}

/* Form Container */
.form-container {
    background: var(--white);
    border: 1px solid var(--gray-200);
    border-radius: 8px;
    padding: 32px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
}

/* Official Header Style */
.official-header {
    display: flex;
    justify-content: space-between;
    width: 100%;
    margin-bottom: 32px;
}

.header-section {
    text-align: center;
    flex: 1;
}

.header-section h2 {
    margin: 0;
}

.header-section h3 {
    margin: 4px 0;
}

/* Form Title */
.form-title-section {
    text-align: center;
    margin: 32px 0;
}

.form-title-section h2,
.form-title-section h3 {
    margin: 8px 0;
}

.title-divider {
    width: 100px;
    height: 2px;
    border-bottom: 2px dashed var(--gray-300);
    margin: 16px auto;
}

/* Photo Section */
.photo-section {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin: 24px 0;
    gap: 24px;
}

.photo-instructions {
    flex: 1;
}

.photo-box {
    width: 96px;
    height: 116px;
    border: 1px solid var(--gray-300);
    background: var(--white);
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    text-align: center;
    font-size: 12px;
    color: var(--gray-600);
}

.photo-box img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

/* Form Fields */
.form-field-group {
    margin: 24px 0;
}

.field-header {
    display: flex;
    align-items: center;
    gap: 8px;
    font-weight: 500;
    margin-bottom: 8px;
}

.field-row {
    display: flex;
    align-items: end;
    gap: 8px;
    margin-bottom: 4px;
}

.field-label {
    font-size: 13px;
    font-weight: 500;
    color: var(--gray-700);
    min-width: fit-content;
}

.field-underline {
    flex: 1;
    border-bottom: 1px dashed var(--gray-400);
    height: 24px;
    position: relative;
}

.field-input {
    width: 100%;
    border: 1px solid var(--gray-300);
    border-radius: 4px;
    padding: 8px 12px;
    font-size: 14px;
    background: var(--white);
    color: var(--gray-900);
    transition: all 0.15s;
}

.field-input:focus {
    outline: none;
    border-color: var(--primary);
    box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.1);
}

.field-select {
    width: 100%;
    border: 1px solid var(--gray-300);
    border-radius: 4px;
    padding: 8px 12px;
    font-size: 14px;
    background: var(--white);
    color: var(--gray-900);
}

.field-textarea {
    width: 100%;
    border: 1px solid var(--gray-300);
    border-radius: 4px;
    padding: 8px 12px;
    font-size: 14px;
    background: var(--white);
    color: var(--gray-900);
    min-height: 80px;
}

/* Two Column Layout */
.two-column {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 32px;
}

/* Three Column Layout */
.three-column {
    display: grid;
    grid-template-columns: 1fr 1fr 1fr;
    gap: 24px;
}

/* Checkbox Options */
.checkbox-options {
    display: flex;
    flex-wrap: wrap;
    gap: 24px;
    margin: 16px 0;
}

.checkbox-option {
    display: flex;
    align-items: center;
    gap: 8px;
}

.checkbox-option input[type="checkbox"],
.checkbox-option input[type="radio"] {
    width: 16px;
    height: 16px;
    border: 1px solid var(--gray-400);
}

/* Section Divider */
.section-divider {
    border-bottom: 2px solid var(--gray-300);
    margin: 32px 0;
}

/* Action Bar */
.action-bar {
    background: var(--gray-50);
    border: 1px solid var(--gray-200);
    border-radius: 8px;
    padding: 16px 24px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-top: 24px;
}

.action-left {
    font-size: 12px;
    color: var(--gray-500);
    display: flex;
    align-items: center;
    gap: 8px;
}

.action-right {
    display: flex;
    gap: 12px;
}

.help-text {
    font-size: 11px;
    color: var(--gray-500);
    margin-top: 4px;
}

/* Responsive */
@media (max-width: 768px) {
    .edit-container {
        padding: 12px;
    }
    
    .form-container {
        padding: 16px;
    }
    
    .official-header {
        flex-direction: column;
        gap: 16px;
    }
    
    .photo-section {
        flex-direction: column;
        align-items: center;
    }
    
    .two-column,
    .three-column {
        grid-template-columns: 1fr;
    }
    
    .checkbox-options {
        flex-direction: column;
        gap: 12px;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="edit-container">
    <!-- Edit Header -->
    <div class="edit-header">
        <div>
            <h1 class="edit-title">
                <i class="bi bi-pencil-square"></i>
                Extension of Stay Application Form
            </h1>
            <p class="edit-subtitle">Editing for {{ worker.get_full_name }} • {{ form_date|date:"d/m/Y" }}</p>
        </div>
        <div>
            <a href="{% url 'eform:extension_form' %}" class="btn-edit">
                <i class="bi bi-arrow-left"></i>
                Back
            </a>
            <a href="{% url 'eform:print_extension_form' worker.id %}" class="btn-edit primary" target="_blank">
                <i class="bi bi-eye"></i>
                Preview
            </a>
        </div>
    </div>

    <!-- Form Container -->
    <div class="form-container">
        <!-- Official Header -->
        <div class="official-header">
            <div class="header-section">
                <div>
                    <h2 class="moul-regular text-sm">ក្រសួងមហាផ្ទៃ</h2>
                    <h3 class="time-roman text-sm">Ministry of Interior / 内政部</h3>
                </div>
                <div style="margin-top: 8px;">
                    <h2 class="moul-regular text-sm">អគ្គនាយកដ្ឋានអន្តោប្រវេសន៍</h2>
                    <h3 class="time-roman text-sm">General Department of Immigration / 移民总局</h3>
                </div>
            </div>
            
            <div class="header-section">
                <div>
                    <h2 class="moul-regular text-sm">ព្រះរាជាណាចក្រកម្ពុជា</h2>
                    <h3 class="time-roman text-sm">Kingdom of Cambodia / 柬埔寨王国</h3>
                </div>
                <div style="margin-top: 8px;">
                    <h2 class="moul-regular text-sm">ជាតិ សាសនា ព្រះមហាក្សត្រ</h2>
                    <h3 class="time-roman text-sm">Nation Religion King / 国家 宗教 国王</h3>
                </div>
            </div>
        </div>

        <!-- Form Title -->
        <div class="form-title-section">
            <h2 class="moul-regular text-sm">ពាក្យស្នើសុំបន្តការស្នាក់នៅបណ្ដោះអាសន្ន</h2>
            <h3 class="time-roman text-sm font-semibold">Extension of Stay Application Form</h3>
            <h3 class="noto-sans-sc-500 text-sm">延长逗留期限申请表</h3>
            <div class="title-divider"></div>
        </div>

        <!-- Form -->
        <form method="post" enctype="multipart/form-data" id="extensionForm">
            {% csrf_token %}
            
            <!-- Photo and Instructions -->
            <div class="photo-section">
                <div class="photo-instructions">
                    <h2 class="kh-content-regular text-xs">សូមបំពេញព័ត៌មានខាងក្រោមជាភាសាអង់គ្លេស</h2>
                    <h2 class="time-roman text-sm">Please fill in the following information in English / 请用英文填写以下信息</h2>
                </div>
                <div class="photo-box">
                    {% if worker.professional_photo %}
                        <img src="{{ worker.professional_photo.url }}" alt="Worker Photo" class="extension-new-photo" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';" />
                        <div class="photo-placeholder" style="display: none;">
                            <span class="text-xs">រូបថត</span>
                            <span class="font-semibold">PHOTO</span>
                            <span class="text-xs">4 x 6</span>
                        </div>
                    {% else %}
                        <span class="text-xs">រូបថត</span>
                        <span class="font-semibold">PHOTO</span>
                        <span class="text-xs">4 x 6</span>
                    {% endif %}
                </div>
            </div>

            <!-- Personal Information -->
            <div class="form-field-group">
                <div class="field-header">
                    <span>-</span>
                    <h2 class="kh-content-regular text-sm">នាម</h2>
                </div>
                <div class="field-row">
                    <h3 class="field-label time-roman">Surname / 姓:</h3>
                    <div class="field-underline">
                        <input type="text" class="field-input" name="surname" value="{{ worker.last_name }}" readonly style="background: #f9fafb; border: none; font-weight: 600; font-size: 16px;">
                    </div>
                </div>
            </div>

            <div class="form-field-group">
                <div class="field-header">
                    <span>-</span>
                    <h2 class="kh-content-regular text-sm">គោត្តនាម</h2>
                </div>
                <div class="field-row">
                    <h3 class="field-label time-roman">Given Name / 名:</h3>
                    <div class="field-underline">
                        <input type="text" class="field-input" name="given_name" value="{{ worker.first_name }}" readonly style="background: #f9fafb; border: none; font-weight: 600; font-size: 16px;">
                    </div>
                </div>
            </div>

            <!-- Birth Date and Nationality -->
            <div class="two-column">
                <div class="form-field-group">
                    <div class="field-header">
                        <span>-</span>
                        <h2 class="kh-content-regular text-sm">ថ្ងៃ ខែ ឆ្នាំកំណើត</h2>
                    </div>
                    <div class="field-row">
                        <h3 class="field-label time-roman">Date of birth / 出生日期:</h3>
                        <div class="field-underline">
                            <input type="date" class="field-input" name="date_of_birth" 
                                   value="{{ worker.dob|date:'Y-m-d' }}" readonly style="background: #f9fafb;">
                        </div>
                    </div>
                </div>

                <div class="form-field-group">
                    <div class="field-header">
                        <h2 class="kh-content-regular text-sm">សញ្ជាតិ</h2>
                    </div>
                    <div class="field-row">
                        <h3 class="field-label time-roman">Nationality / 国籍:</h3>
                        <div class="field-underline">
                            <input type="text" class="field-input" name="nationality" 
                                   value="{{ worker.get_nationality_display }}" readonly style="background: #f9fafb;">
                        </div>
                    </div>
                </div>
            </div>

            <!-- Gender -->
            <div class="form-field-group">
                <div class="field-header">
                    <h2 class="kh-content-regular text-sm">ភេទ Sex / 性别:</h2>
                </div>
                <div class="checkbox-options">
                    <div class="checkbox-option">
                        <input type="radio" name="gender" value="M" {% if worker.sex == "M" %}checked{% endif %} disabled>
                        <label>
                            <span class="kh-content-regular">ប្រុស</span> / Male / 男性
                        </label>
                    </div>
                    <div class="checkbox-option">
                        <input type="radio" name="gender" value="F" {% if worker.sex == "F" %}checked{% endif %} disabled>
                        <label>
                            <span class="kh-content-regular">ស្រី</span> / Female / 女性
                        </label>
                    </div>
                </div>
            </div>

            <!-- Passport Information -->
            <div class="three-column">
                <div class="form-field-group">
                    <div class="field-header">
                        <span>-</span>
                        <h2 class="kh-content-regular text-sm">លេខលិខិតឆ្លងដែន</h2>
                    </div>
                    <div class="field-row">
                        <h3 class="field-label time-roman">Passport No / 护照号码:</h3>
                        <div class="field-underline">
                            <input type="text" class="field-input" name="passport_number" 
                                   value="{{ form_data.passport_number }}" required>
                        </div>
                    </div>
                </div>

                <div class="form-field-group">
                    <div class="field-header">
                        <h2 class="kh-content-regular text-sm">ចេញថ្ងៃ</h2>
                    </div>
                    <div class="field-row">
                        <h3 class="field-label time-roman">Issued / 签发:</h3>
                        <div class="field-underline">
                            <input type="date" class="field-input" name="passport_issued_date" 
                                   value="{{ form_data.passport_issued_date|date:'Y-m-d' }}">
                        </div>
                    </div>
                </div>

                <div class="form-field-group">
                    <div class="field-header">
                        <h2 class="kh-content-regular text-sm">ផុតកំណត់ថ្ងៃ</h2>
                    </div>
                    <div class="field-row">
                        <h3 class="field-label time-roman">Expiration / 过期:</h3>
                        <div class="field-underline">
                            <input type="date" class="field-input" name="passport_expiry_date" 
                                   value="{{ form_data.passport_expiry_date|date:'Y-m-d' }}">
                        </div>
                    </div>
                </div>
            </div>

            <div class="section-divider"></div>

            <!-- Current Visa Information -->
            <div class="two-column">
                <div class="form-field-group">
                    <div class="field-header">
                        <span>-</span>
                        <h2 class="kh-content-regular text-sm">លេខទិដ្ឋាការ</h2>
                    </div>
                    <div class="field-row">
                        <h3 class="field-label time-roman">Current Visa No / 签证号码:</h3>
                        <div class="field-underline">
                            <input type="text" class="field-input" name="current_visa_number" 
                                   value="{{ form_data.current_visa_number }}">
                        </div>
                    </div>
                </div>

                <div class="form-field-group">
                    <div class="field-header">
                        <h2 class="kh-content-regular text-sm">ផ្ដល់នៅ</h2>
                    </div>
                    <div class="field-row">
                        <h3 class="field-label time-roman">Issuing Post / 发帖:</h3>
                        <div class="field-underline">
                            <input type="text" class="field-input" name="visa_issuing_post" 
                                   value="PHNOM PENH" readonly style="background: #f9fafb;">
                        </div>
                    </div>
                </div>
            </div>

            <!-- Extension Period Selection -->
            <div class="form-field-group">
                <div class="field-header">
                    <span>-</span>
                    <h2 class="kh-content-regular text-sm">ស្នើសុំបន្តកាស្នាក់នៅរយពេល</h2>
                </div>
                <div class="field-row">
                    <h3 class="field-label time-roman">Apply for Permission of Stay for / 申请居住许可:</h3>
                </div>
                <div class="checkbox-options" style="margin-top: 16px;">
                    <div class="checkbox-option">
                        <input type="radio" name="extension_months" value="1" onchange="updateDurationFromMonths(1)">
                        <label>
                            <span class="kh-content-regular">១ខែ</span><br>
                            <span class="time-roman text-xs">1 month / 个月</span>
                        </label>
                    </div>
                    <div class="checkbox-option">
                        <input type="radio" name="extension_months" value="3" onchange="updateDurationFromMonths(3)">
                        <label>
                            <span class="kh-content-regular">៣ខែ</span><br>
                            <span class="time-roman text-xs">3 months / 个月</span>
                        </label>
                    </div>
                    <div class="checkbox-option">
                        <input type="radio" name="extension_months" value="6" onchange="updateDurationFromMonths(6)">
                        <label>
                            <span class="kh-content-regular">៦ខែ</span><br>
                            <span class="time-roman text-xs">6 months / 个月</span>
                        </label>
                    </div>
                    <div class="checkbox-option">
                        <input type="radio" name="extension_months" value="12" onchange="updateDurationFromMonths(12)" checked>
                        <label>
                            <span class="kh-content-regular">១២ខែ</span><br>
                            <span class="time-roman text-xs">12 months / 个月</span>
                        </label>
                    </div>
                    <div class="checkbox-option">
                        <input type="radio" name="extension_months" value="24" onchange="updateDurationFromMonths(24)">
                        <label>
                            <span class="kh-content-regular">២៤ខែ</span><br>
                            <span class="time-roman text-xs">24 months / 个月</span>
                        </label>
                    </div>
                </div>
            </div>

            <!-- Purpose of Stay -->
            <div class="form-field-group">
                <div class="field-header">
                    <span>-</span>
                    <h2 class="kh-content-regular text-sm">គោលបំណងនៃការស្នាក់នៅ</h2>
                </div>
                <div class="field-row">
                    <h3 class="field-label time-roman">Purpose of Stay / 居住目的:</h3>
                </div>
                <div class="checkbox-options" style="margin-top: 16px;">
                    <div class="checkbox-option">
                        <input type="radio" name="extension_reason" value="investment">
                        <label>
                            <span class="kh-content-regular">ការវិនិយោគ</span><br>
                            <span class="time-roman text-xs">Investment / 投资</span>
                        </label>
                    </div>
                    <div class="checkbox-option">
                        <input type="radio" name="extension_reason" value="business">
                        <label>
                            <span class="kh-content-regular">អាជីវកម្ម</span><br>
                            <span class="time-roman text-xs">Business / 商业</span>
                        </label>
                    </div>
                    <div class="checkbox-option">
                        <input type="radio" name="extension_reason" value="employment" checked>
                        <label>
                            <span class="kh-content-regular">ការងារការិយាល័យ</span><br>
                            <span class="time-roman text-xs">Office Work / 办公室工作</span>
                        </label>
                    </div>
                    <div class="checkbox-option">
                        <input type="radio" name="extension_reason" value="professional">
                        <label>
                            <span class="kh-content-regular">ការងារជំនាញ</span><br>
                            <span class="time-roman text-xs">Professional Work / 专业工作</span>
                        </label>
                    </div>
                    <div class="checkbox-option">
                        <input type="radio" name="extension_reason" value="family">
                        <label>
                            <span class="kh-content-regular">ប្រកបរបរផ្ទាល់ខ្លួន</span><br>
                            <span class="time-roman text-xs">Personal Occupation / 个人职业</span>
                        </label>
                    </div>
                    <div class="checkbox-option">
                        <input type="radio" name="extension_reason" value="tourism">
                        <label>
                            <span class="kh-content-regular">ទេសចរណ៍</span><br>
                            <span class="time-roman text-xs">Tourism / 旅游</span>
                        </label>
                    </div>
                    <div class="checkbox-option" style="flex-direction: column; align-items: flex-start;">
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <input type="radio" name="extension_reason" value="other">
                            <label>
                                <span class="kh-content-regular">ផ្សេងៗ</span> / Other / 其他:
                            </label>
                        </div>
                        <input type="text" class="field-input" name="other_reason_text" 
                               style="margin-top: 8px; width: 200px;" placeholder="Specify other reason">
                    </div>
                </div>
            </div>

            <!-- Organization Information -->
            <div class="form-field-group">
                <div class="field-header">
                    <span>-</span>
                    <h2 class="kh-content-regular text-sm">ឈ្មោះគ្រិះស្ថាន/អង្កការ</h2>
                </div>
                <div class="field-row">
                    <h3 class="field-label time-roman">Institution/Organization Name / 机构/组织名称:</h3>
                    <div class="field-underline">
                        <input type="text" class="field-input" name="organization_name" 
                               value="KOH KONG INTERNATIONAL" readonly style="background: #f9fafb;">
                    </div>
                </div>
            </div>

            <div class="form-field-group">
                <div class="field-row">
                    <h3 class="field-label time-roman" style="text-align: right; min-width: 300px;">
                        <span class="kh-content-regular">តួនាទី</span> Position / 位置:
                    </h3>
                    <div class="field-underline">
                        <input type="text" class="field-input" name="position" 
                               value="{{ worker.position.name|default:'DEALER INSPECTOR' }}" readonly style="background: #f9fafb;">
                    </div>
                </div>
            </div>

            <div class="section-divider"></div>

            <!-- Work Permit Information -->
            <div class="two-column">
                <div class="form-field-group">
                    <div class="field-header">
                        <span>-</span>
                        <h2 class="kh-content-regular text-sm">បណ្ណការងារជនបរទេស លេខ</h2>
                    </div>
                    <div class="field-row">
                        <h3 class="field-label time-roman">Working Permit / 工作许可证:</h3>
                        <div class="field-underline">
                            <input type="text" class="field-input" name="work_permit_number" 
                                   value="{{ form_data.work_permit_number }}">
                        </div>
                    </div>
                </div>

                <div class="form-field-group">
                    <div class="field-header">
                        <h2 class="kh-content-regular text-sm">ថ្ងៃផុតកំណត់</h2>
                    </div>
                    <div class="field-row">
                        <h3 class="field-label time-roman">Expired Date / 失效日期:</h3>
                        <div class="field-underline">
                            <input type="date" class="field-input" name="work_permit_expiry" 
                                   value="{{ form_data.work_permit_expiry|date:'Y-m-d' }}">
                        </div>
                    </div>
                </div>
            </div>

            <!-- Address Information -->
            <div class="form-field-group">
                <div class="field-header">
                    <span>-</span>
                    <h2 class="kh-content-regular text-sm">អាសយដ្ឋានស្នាក់នៅកម្ពុជា ឈ្មោះទីកន្លែងស្នាក់នៅ</h2>
                </div>
                <div class="field-row">
                    <h3 class="field-label time-roman" style="min-width: 350px;">
                        Address in Cambodia / 柬埔寨地址<br>
                        Name of Address / 收件人姓名:
                    </h3>
                    <div class="field-underline">
                        <input type="text" class="field-input" name="address_name" 
                               value="{{ form_data.address_name }}">
                    </div>
                </div>
            </div>

            <!-- Hidden Fields for System Processing -->
            <input type="hidden" name="extension_duration" id="extensionDurationHidden" value="{{ form_data.extension_duration|default:365 }}">
            <input type="hidden" name="extension_type" value="work">
            <input type="hidden" name="extension_start_date" value="{{ form_data.extension_start_date|date:'Y-m-d'|default:'' }}">
            <input type="hidden" name="status" value="{{ form_data.status|default:'requested' }}">
            <input type="hidden" name="current_visa_type" value="work">
            <input type="hidden" name="current_visa_expiry" value="{{ form_data.current_visa_expiry|date:'Y-m-d' }}">
            <input type="hidden" name="entry_date" value="{{ form_data.entry_date|date:'Y-m-d' }}">
            
            <!-- Additional Details -->
            <div class="form-field-group">
                <div class="field-header">
                    <h2 class="time-roman text-sm">Additional Details / Comments</h2>
                </div>
                <textarea class="field-textarea" name="additional_details" 
                          placeholder="Enter any additional information or special requests...">{{ form_data.additional_details }}</textarea>
            </div>

        </form>
    </div>

    <!-- Action Bar -->
    <div class="action-bar">
        <div class="action-left">
            <i class="bi bi-info-circle"></i>
            Form will be saved with auto-generated request number
        </div>
        <div class="action-right">
            <a href="{% url 'eform:extension_form' %}" class="btn-edit">
                <i class="bi bi-x"></i>
                Cancel
            </a>
            <button type="submit" form="extensionForm" class="btn-edit success">
                <i class="bi bi-floppy"></i>
                Save & Print
            </button>
        </div>
    </div>
</div>

<script>
function updateDurationFromMonths(months) {
    const days = months * 30; // Approximate days per month
    document.getElementById('extensionDurationHidden').value = days;
    
    // Update the start date to current date
    const today = new Date().toISOString().split('T')[0];
    document.querySelector('[name="extension_start_date"]').value = today;
}

// Pre-select based on existing data
document.addEventListener('DOMContentLoaded', function() {
    const currentDuration = {{ form_data.extension_duration|default:365 }};
    const approximateMonths = Math.round(currentDuration / 30);
    
    // Select the appropriate radio button
    const monthRadio = document.querySelector(`[name="extension_months"][value="${approximateMonths}"]`);
    if (monthRadio) {
        monthRadio.checked = true;
    } else if (currentDuration >= 365) {
        document.querySelector('[name="extension_months"][value="12"]').checked = true;
    }
    
    // Pre-select reason
    const currentReason = '{{ form_data.extension_reason|default:"employment" }}';
    const reasonRadio = document.querySelector(`[name="extension_reason"][value="${currentReason}"]`);
    if (reasonRadio) {
        reasonRadio.checked = true;
    }
    
    // Add form submission
    const form = document.querySelector('form');
    const submitButton = document.querySelector('.btn-edit.success');
    
    if (submitButton) {
        submitButton.addEventListener('click', function(e) {
            e.preventDefault();
            form.submit();
        });
    }
    
    // Set today's date as default start date if empty
    const startDateField = document.querySelector('[name="extension_start_date"]');
    if (!startDateField.value) {
        const today = new Date().toISOString().split('T')[0];
        startDateField.value = today;
    }

    // Handle image load errors for extension new form photos
    document.querySelectorAll('img.extension-new-photo').forEach(function(img) {
        img.addEventListener('error', function() {
            console.log('Extension new form photo failed to load:', this.src);
            
            // Hide the broken image and show placeholder
            this.style.display = 'none';
            let placeholder = this.nextElementSibling;
            if (placeholder && placeholder.classList.contains('photo-placeholder')) {
                placeholder.style.display = 'flex';
            }
        });
        
        // Check for corrupted images that appear to load but have no dimensions
        img.addEventListener('load', function() {
            if (this.naturalWidth === 0 || this.naturalHeight === 0) {
                this.style.display = 'none';
                let placeholder = this.nextElementSibling;
                if (placeholder && placeholder.classList.contains('photo-placeholder')) {
                    placeholder.style.display = 'flex';
                }
            }
        });
    });
});
</script>
{% endblock %} 