{% extends 'base/base.html' %}
{% load static %}

{% block title %}Edit Salary Component{% endblock %}

{% block extra_css %}
<style>
    /* Form Design Variables */
    :root {
        --primary: #3b82f6;
        --success: #10b981;
        --warning: #f59e0b;
        --danger: #ef4444;
        --border: #e5e7eb;
        --bg-gray: #f9fafb;
    }

    body {
        font-size: 13px;
    }

    /* Compact Page Header */
    .page-header-compact {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 12px 0;
        border-bottom: 1px solid var(--border);
        margin-bottom: 12px;
    }

    .page-header-compact h1 {
        font-size: 16px;
        font-weight: 600;
        color: #111827;
        margin: 0;
        display: flex;
        align-items: center;
        gap: 6px;
    }

    /* Compact Buttons */
    .btn-compact {
        display: inline-flex;
        align-items: center;
        gap: 4px;
        padding: 5px 10px;
        font-size: 12px;
        font-weight: 500;
        border-radius: 4px;
        text-decoration: none;
        transition: all 0.15s;
        border: 1px solid;
        cursor: pointer;
    }

    .btn-primary-compact {
        background: var(--primary);
        color: white;
        border-color: var(--primary);
    }

    .btn-primary-compact:hover {
        background: #2563eb;
        color: white;
    }

    .btn-secondary-compact {
        background: white;
        color: #374151;
        border-color: var(--border);
    }

    .btn-secondary-compact:hover {
        background: var(--bg-gray);
        color: #111827;
    }

    .btn-success-compact {
        background: var(--success);
        color: white;
        border-color: var(--success);
    }

    .btn-success-compact:hover {
        background: #059669;
        color: white;
    }

    /* Form Controls */
    .form-group {
        margin-bottom: 12px;
    }

    .form-label {
        display: block;
        font-size: 12px;
        font-weight: 600;
        color: #374151;
        margin-bottom: 4px;
    }

    .form-control-compact,
    .form-select-compact,
    .form-textarea-compact {
        width: 100%;
        padding: 6px 8px;
        font-size: 12px;
        border: 1px solid var(--border);
        border-radius: 4px;
        background: white;
    }

    .form-control-compact:focus,
    .form-select-compact:focus,
    .form-textarea-compact:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.1);
    }

    .form-help {
        font-size: 11px;
        color: #6b7280;
        margin-top: 2px;
    }

    /* Checkbox Control */
    .form-check-compact {
        display: flex;
        align-items: flex-start;
        gap: 6px;
        margin-bottom: 12px;
    }

    .form-check-compact input[type="checkbox"] {
        width: 16px;
        height: 16px;
        cursor: pointer;
        margin-top: 2px;
    }

    .form-check-compact label {
        font-size: 12px;
        color: #374151;
        cursor: pointer;
        margin: 0;
        flex: 1;
    }

    /* Container Design */
    .container-compact {
        background: white;
        border: 1px solid var(--border);
        border-radius: 6px;
        overflow: hidden;
        margin-bottom: 12px;
    }

    .container-header {
        background: var(--bg-gray);
        padding: 8px 10px;
        border-bottom: 1px solid var(--border);
    }

    .container-title {
        font-size: 13px;
        font-weight: 600;
        color: #111827;
        margin: 0;
    }

    .container-body {
        padding: 12px;
    }

    /* Grid Layout */
    .grid-2col {
        display: grid;
        grid-template-columns: 2fr 1fr;
        gap: 12px;
    }

    /* Responsive */
    @media (max-width: 1024px) {
        .grid-2col {
            grid-template-columns: 1fr;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid px-3 py-3">
    <!-- Header -->
    <div class="page-header-compact">
        <h1>
            <i class="bi bi-pencil-fill"></i>
            Edit Salary Component
        </h1>
        <a href="{% url 'payroll:salary_component_list' %}" class="btn-compact btn-secondary-compact">
            <i class="bi bi-arrow-left"></i>
            Back to List
        </a>
    </div>

    <form method="post" id="componentForm">
        {% csrf_token %}

        <div class="grid-2col">
            <!-- Main Content -->
            <div>
                <!-- Basic Information -->
                <div class="container-compact">
                    <div class="container-header">
                        <h3 class="container-title">Basic Information</h3>
                    </div>
                    <div class="container-body">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                            <div class="form-group">
                                <label for="code" class="form-label">
                                    Component Code <span style="color: var(--danger);">*</span>
                                </label>
                                <input type="text"
                                       class="form-control-compact"
                                       id="code"
                                       name="code"
                                       required
                                       placeholder="e.g., BASIC, HRA"
                                       value="{{ component.code }}">
                                <p class="form-help">Unique identifier (uppercase)</p>
                            </div>
                            <div class="form-group">
                                <label for="abbreviation" class="form-label">Abbreviation</label>
                                <input type="text"
                                       class="form-control-compact"
                                       id="abbreviation"
                                       name="abbreviation"
                                       placeholder="e.g., BS, H/A"
                                       value="{{ component.abbreviation }}">
                                <p class="form-help">Short form for display</p>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="name" class="form-label">
                                Component Name <span style="color: var(--danger);">*</span>
                            </label>
                            <input type="text"
                                   class="form-control-compact"
                                   id="name"
                                   name="name"
                                   required
                                   placeholder="e.g., Basic Salary"
                                   value="{{ component.name }}">
                        </div>
                        <div class="form-group">
                            <label for="description" class="form-label">Description</label>
                            <textarea class="form-textarea-compact"
                                      id="description"
                                      name="description"
                                      rows="2"
                                      placeholder="Brief description">{{ component.description }}</textarea>
                        </div>
                    </div>
                </div>

                <!-- Component Configuration -->
                <div class="container-compact">
                    <div class="container-header">
                        <h3 class="container-title">Component Configuration</h3>
                    </div>
                    <div class="container-body">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                            <div class="form-group">
                                <label for="component_type" class="form-label">
                                    Component Type <span style="color: var(--danger);">*</span>
                                </label>
                                <select class="form-select-compact" id="component_type" name="component_type" required>
                                    <option value="">Select type...</option>
                                    <option value="EARNING" {% if component.component_type == 'EARNING' %}selected{% endif %}>Earning</option>
                                    <option value="DEDUCTION" {% if component.component_type == 'DEDUCTION' %}selected{% endif %}>Deduction</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="calculation_type" class="form-label">
                                    Calculation Type <span style="color: var(--danger);">*</span>
                                </label>
                                <select class="form-select-compact" id="calculation_type" name="calculation_type" required>
                                    <option value="">Select type...</option>
                                    <option value="FIXED" {% if component.calculation_type == 'FIXED' %}selected{% endif %}>Fixed Amount</option>
                                    <option value="PERCENTAGE" {% if component.calculation_type == 'PERCENTAGE' %}selected{% endif %}>Percentage</option>
                                    <option value="FORMULA" {% if component.calculation_type == 'FORMULA' %}selected{% endif %}>Formula Based</option>
                                </select>
                            </div>
                        </div>

                        <div id="percentage_fields" style="display: {% if component.calculation_type == 'PERCENTAGE' %}block{% else %}none{% endif %};">
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                                <div class="form-group">
                                    <label for="percentage_value" class="form-label">Percentage Value</label>
                                    <div style="display: flex; gap: 4px;">
                                        <input type="number"
                                               class="form-control-compact"
                                               id="percentage_value"
                                               name="percentage_value"
                                               step="0.01"
                                               min="0"
                                               max="100"
                                               placeholder="10.00"
                                               style="flex: 1;"
                                               value="{{ component.percentage_value }}">
                                        <span style="padding: 6px 8px; background: var(--bg-gray); border: 1px solid var(--border); border-radius: 4px; font-size: 12px;">%</span>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label for="percentage_of" class="form-label">Percentage Of</label>
                                    <select class="form-select-compact" id="percentage_of" name="percentage_of">
                                        <option value="">Base Salary</option>
                                        {% for comp in components %}
                                            <option value="{{ comp.id }}" {% if component.percentage_of_id == comp.id %}selected{% endif %}>{{ comp.name }} ({{ comp.code }})</option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div id="formula_field" style="display: {% if component.calculation_type == 'FORMULA' %}block{% else %}none{% endif %};">
                            <div class="form-group">
                                <label for="formula" class="form-label">Formula</label>
                                <textarea class="form-textarea-compact"
                                          style="font-family: monospace;"
                                          id="formula"
                                          name="formula"
                                          rows="2"
                                          placeholder="base * 0.1">{{ component.formula }}</textarea>
                                <p class="form-help">Available: base, basic, gross, employee, working_days, payment_days</p>
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="condition" class="form-label">Condition (Optional)</label>
                            <textarea class="form-textarea-compact"
                                      style="font-family: monospace;"
                                      id="condition"
                                      name="condition"
                                      rows="2"
                                      placeholder="employee.grade == 'Manager'">{{ component.condition }}</textarea>
                            <p class="form-help">Python expression to determine when to apply</p>
                        </div>

                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                            <div class="form-group">
                                <label for="display_order" class="form-label">Display Order</label>
                                <input type="number"
                                       class="form-control-compact"
                                       id="display_order"
                                       name="display_order"
                                       value="{{ component.display_order }}"
                                       min="0">
                                <p class="form-help">Order in salary slip</p>
                            </div>
                            <div class="form-group">
                                <label for="round_to_nearest" class="form-label">Round to Nearest</label>
                                <input type="number"
                                       class="form-control-compact"
                                       id="round_to_nearest"
                                       name="round_to_nearest"
                                       value="{{ component.round_to_nearest }}"
                                       min="0">
                                <p class="form-help">0 = no rounding</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Component Options -->
                <div class="container-compact">
                    <div class="container-header">
                        <h3 class="container-title">Component Options</h3>
                    </div>
                    <div class="container-body">
                        <!-- Basic Options -->
                        <div style="margin-bottom: 16px;">
                            <p style="font-size: 12px; font-weight: 600; color: #111827; margin-bottom: 8px;">Basic Settings</p>
                            <div style="display: flex; flex-direction: column; gap: 8px;">
                                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                    <input type="checkbox" id="is_payable" name="is_payable" {% if component.is_payable %}checked{% endif %}>
                                    <span style="font-size: 12px;">Is Payable</span>
                                </label>
                                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                    <input type="checkbox" id="is_tax_applicable" name="is_tax_applicable" {% if component.is_tax_applicable %}checked{% endif %}>
                                    <span style="font-size: 12px;">Include in Tax Calculation</span>
                                </label>
                                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                    <input type="checkbox" id="is_active" name="is_active" {% if component.is_active %}checked{% endif %}>
                                    <span style="font-size: 12px;">Active</span>
                                </label>
                            </div>
                        </div>

                        <!-- Calculation Basis -->
                        <div style="margin-bottom: 16px; padding-top: 12px; border-top: 1px solid var(--border);">
                            <p style="font-size: 12px; font-weight: 600; color: #111827; margin-bottom: 8px;">Calculation Basis</p>
                            <div style="display: flex; flex-direction: column; gap: 8px;">
                                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                    <input type="checkbox" id="depends_on_payment_days" name="depends_on_payment_days" {% if component.depends_on_payment_days %}checked{% endif %}>
                                    <span style="font-size: 12px;">Depends on Attendance Days</span>
                                </label>
                                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                    <input type="checkbox" id="depends_on_timesheet" name="depends_on_timesheet" {% if component.depends_on_timesheet %}checked{% endif %}>
                                    <span style="font-size: 12px;">Depends on Timesheet</span>
                                </label>
                            </div>
                        </div>

                        <!-- Advanced Options -->
                        <div style="padding-top: 12px; border-top: 1px solid var(--border);">
                            <button type="button" onclick="toggleAdvanced()" style="background: none; border: none; padding: 0; font-size: 12px; font-weight: 600; color: var(--primary); cursor: pointer; display: flex; align-items: center; gap: 4px; margin-bottom: 8px;">
                                <i class="bi bi-chevron-{% if component.is_statistical_component or component.is_additional_component or component.variable_based_on_taxable_salary or component.pay_against_benefit_claim %}down{% else %}right{% endif %}" id="advancedIcon"></i>
                                Advanced Options
                            </button>
                            <div id="advancedOptions" style="display: {% if component.is_statistical_component or component.is_additional_component or component.variable_based_on_taxable_salary or component.pay_against_benefit_claim %}block{% else %}none{% endif %};">
                                <div style="display: flex; flex-direction: column; gap: 8px;">
                                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                        <input type="checkbox" id="is_statistical_component" name="is_statistical_component" {% if component.is_statistical_component %}checked{% endif %}>
                                        <span style="font-size: 12px;">Statistical Only (not in totals)</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                        <input type="checkbox" id="is_additional_component" name="is_additional_component" {% if component.is_additional_component %}checked{% endif %}>
                                        <span style="font-size: 12px;">Additional Salary Component</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                        <input type="checkbox" id="variable_based_on_taxable_salary" name="variable_based_on_taxable_salary" {% if component.variable_based_on_taxable_salary %}checked{% endif %}>
                                        <span style="font-size: 12px;">Variable Based on Taxable Salary</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                        <input type="checkbox" id="pay_against_benefit_claim" name="pay_against_benefit_claim" {% if component.pay_against_benefit_claim %}checked{% endif %}>
                                        <span style="font-size: 12px;">Requires Benefit Claim</span>
                                    </label>
                                </div>
                                <div id="max_benefit_field" style="display: {% if component.pay_against_benefit_claim %}block{% else %}none{% endif %}; margin-top: 12px;">
                                    <label for="max_benefit_amount" class="form-label">Max Benefit Amount</label>
                                    <input type="number"
                                           class="form-control-compact"
                                           id="max_benefit_amount"
                                           name="max_benefit_amount"
                                           step="0.01"
                                           min="0"
                                           placeholder="0.00"
                                           value="{{ component.max_benefit_amount }}">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Sidebar -->
            <div>
                <!-- Summary -->
                <div class="container-compact">
                    <div class="container-header">
                        <h3 class="container-title">Summary</h3>
                    </div>
                    <div class="container-body">
                        <div style="display: flex; flex-direction: column; gap: 8px;">
                            <div style="display: flex; justify-content: space-between; padding-bottom: 8px; border-bottom: 1px solid var(--border);">
                                <span style="font-size: 12px; color: #6b7280;">Total Components:</span>
                                <span style="font-size: 12px; font-weight: 600;">{{ components.count }}</span>
                            </div>
                            <div style="display: flex; justify-content: space-between;">
                                <span style="font-size: 12px; color: #6b7280;">Available:</span>
                                <span style="font-size: 12px; font-weight: 600;">{{ components.count }}</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="container-compact">
                    <div class="container-body">
                        <div style="display: flex; flex-direction: column; gap: 8px;">
                            <button type="submit" class="btn-compact btn-success-compact" style="width: 100%; justify-content: center;">
                                <i class="bi bi-check-circle"></i>
                                Update Component
                            </button>
                            <a href="{% url 'payroll:salary_component_list' %}" class="btn-compact btn-secondary-compact" style="width: 100%; justify-content: center; text-decoration: none;">
                                <i class="bi bi-x"></i>
                                Cancel
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>

<script>
function toggleAdvanced() {
    const advancedOptions = document.getElementById('advancedOptions');
    const advancedIcon = document.getElementById('advancedIcon');

    if (advancedOptions.style.display === 'none') {
        advancedOptions.style.display = 'block';
        advancedIcon.className = 'bi bi-chevron-down';
    } else {
        advancedOptions.style.display = 'none';
        advancedIcon.className = 'bi bi-chevron-right';
    }
}

document.addEventListener('DOMContentLoaded', function() {
    const calculationType = document.getElementById('calculation_type');
    const percentageFields = document.getElementById('percentage_fields');
    const formulaField = document.getElementById('formula_field');
    const payAgainstBenefit = document.getElementById('pay_against_benefit_claim');
    const maxBenefitField = document.getElementById('max_benefit_field');

    // Show/hide fields based on calculation type
    calculationType.addEventListener('change', function() {
        percentageFields.style.display = this.value === 'PERCENTAGE' ? 'block' : 'none';
        formulaField.style.display = this.value === 'FORMULA' ? 'block' : 'none';
    });

    // Show/hide max benefit field
    payAgainstBenefit.addEventListener('change', function() {
        maxBenefitField.style.display = this.checked ? 'block' : 'none';
    });

    // Auto-uppercase code field
    document.getElementById('code').addEventListener('input', function() {
        this.value = this.value.toUpperCase().replace(/[^A-Z0-9_]/g, '');
    });
});
</script>
{% endblock %}
