{% extends 'base/base.html' %}
{% load static %}

{% block title %}Create Salary Structure Assignment{% endblock %}

{% block extra_css %}
<style>
    /* Form Design Variables */
    :root {
        --primary: #3b82f6;
        --success: #10b981;
        --warning: #f59e0b;
        --danger: #ef4444;
        --border: #e5e7eb;
        --bg-gray: #f9fafb;
    }

    body {
        font-size: 13px;
    }

    /* Compact Page Header */
    .page-header-compact {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 12px 0;
        border-bottom: 1px solid var(--border);
        margin-bottom: 12px;
    }

    .page-header-compact h1 {
        font-size: 16px;
        font-weight: 600;
        color: #111827;
        margin: 0;
        display: flex;
        align-items: center;
        gap: 6px;
    }

    /* Compact Buttons */
    .btn-compact {
        display: inline-flex;
        align-items: center;
        gap: 4px;
        padding: 5px 10px;
        font-size: 12px;
        font-weight: 500;
        border-radius: 4px;
        text-decoration: none;
        transition: all 0.15s;
        border: 1px solid;
        cursor: pointer;
    }

    .btn-primary-compact {
        background: var(--primary);
        color: white;
        border-color: var(--primary);
    }

    .btn-primary-compact:hover {
        background: #2563eb;
        color: white;
    }

    .btn-secondary-compact {
        background: white;
        color: #374151;
        border-color: var(--border);
    }

    .btn-secondary-compact:hover {
        background: var(--bg-gray);
        color: #111827;
    }

    .btn-success-compact {
        background: var(--success);
        color: white;
        border-color: var(--success);
    }

    .btn-success-compact:hover {
        background: #059669;
        color: white;
    }

    /* Form Controls */
    .form-group {
        margin-bottom: 12px;
    }

    .form-label {
        display: block;
        font-size: 12px;
        font-weight: 600;
        color: #374151;
        margin-bottom: 4px;
    }

    .form-control-compact,
    .form-select-compact,
    .form-textarea-compact {
        width: 100%;
        padding: 6px 8px;
        font-size: 12px;
        border: 1px solid var(--border);
        border-radius: 4px;
        background: white;
    }

    .form-control-compact:focus,
    .form-select-compact:focus,
    .form-textarea-compact:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.1);
    }

    .form-help {
        font-size: 11px;
        color: #6b7280;
        margin-top: 2px;
    }

    .form-error {
        font-size: 11px;
        color: var(--danger);
        margin-top: 2px;
    }

    /* Checkbox Control */
    .form-check-compact {
        display: flex;
        align-items: center;
        gap: 6px;
        margin-bottom: 12px;
    }

    .form-check-compact input[type="checkbox"] {
        width: 16px;
        height: 16px;
        cursor: pointer;
    }

    .form-check-compact label {
        font-size: 12px;
        color: #374151;
        cursor: pointer;
        margin: 0;
    }

    /* Container Design */
    .container-compact {
        background: white;
        border: 1px solid var(--border);
        border-radius: 6px;
        overflow: hidden;
        margin-bottom: 12px;
    }

    .container-header {
        background: var(--bg-gray);
        padding: 8px 10px;
        border-bottom: 1px solid var(--border);
    }

    .container-title {
        font-size: 13px;
        font-weight: 600;
        color: #111827;
        margin: 0;
    }

    .container-body {
        padding: 12px;
    }


    /* Info Box */
    .info-box {
        background: #eff6ff;
        border: 1px solid #bfdbfe;
        border-radius: 4px;
        padding: 8px;
        margin-bottom: 12px;
    }

    .info-box p {
        font-size: 11px;
        color: #1e40af;
        margin: 0;
        line-height: 1.4;
    }

    /* Autocomplete styles */
    .autocomplete-container {
        position: relative;
        width: 100%;
    }

    .autocomplete-input {
        width: 100%;
    }

    .autocomplete-dropdown {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: white;
        border: 1px solid var(--border);
        border-top: none;
        max-height: 250px;
        overflow-y: auto;
        z-index: 1000;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        display: none;
        border-radius: 0 0 4px 4px;
    }

    .autocomplete-dropdown.show {
        display: block;
    }

    .autocomplete-item {
        padding: 8px 10px;
        cursor: pointer;
        border-bottom: 1px solid #f3f4f6;
        transition: background 0.1s;
    }

    .autocomplete-item:last-child {
        border-bottom: none;
    }

    .autocomplete-item:hover,
    .autocomplete-item.selected {
        background: #f9fafb;
    }

    .autocomplete-item-name {
        font-weight: 600;
        font-size: 12px;
        color: #111827;
    }

    .autocomplete-item-id {
        font-size: 11px;
        color: #6b7280;
        margin-top: 2px;
    }

    .autocomplete-no-results {
        padding: 12px;
        text-align: center;
        color: #9ca3af;
        font-size: 11px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid px-3 py-3">
    <!-- Header -->
    <div class="page-header-compact">
        <h1>
            <i class="bi bi-person-plus-fill"></i>
            Create Salary Structure Assignment
        </h1>
        <a href="{% url 'payroll:salary_structure_assignment_list' %}" class="btn-compact btn-secondary-compact">
            <i class="bi bi-arrow-left"></i>
            Back to List
        </a>
    </div>

    <form method="post">
        {% csrf_token %}

        <!-- Assignment Details -->
        <div class="container-compact">
            <div class="container-header">
                <h3 class="container-title">Assignment Details</h3>
            </div>
            <div class="container-body">
                        <!-- Employee Selection -->
                        <div class="form-group">
                            <label for="employee" class="form-label">
                                Employee <span style="color: var(--danger);">*</span>
                            </label>
                            <div class="autocomplete-container">
                                <input type="text"
                                       id="employee-search"
                                       class="form-control-compact autocomplete-input"
                                       placeholder="Search by name or employee ID..."
                                       autocomplete="off">
                                <input type="hidden" name="employee" id="employee" required>
                                <div class="autocomplete-dropdown" id="employee-dropdown"></div>
                            </div>
                            <p class="form-help">Search by employee name or ID (e.g., "John" or "EMP2024001")</p>
                        </div>

                        <!-- Salary Structure Selection -->
                        <div class="form-group">
                            <label for="salary_structure" class="form-label">
                                Salary Structure <span style="color: var(--danger);">*</span>
                            </label>
                            <div class="autocomplete-container">
                                <input type="text"
                                       id="structure-search"
                                       class="form-control-compact autocomplete-input"
                                       placeholder="Search by structure name..."
                                       autocomplete="off">
                                <input type="hidden" name="salary_structure" id="salary_structure" required>
                                <div class="autocomplete-dropdown" id="structure-dropdown"></div>
                            </div>
                            <p class="form-help">Search by salary structure name</p>
                        </div>

                        <!-- Base Salary -->
                        <div class="form-group">
                            <label for="base_salary" class="form-label">
                                Base Salary <span style="color: var(--danger);">*</span>
                            </label>
                            <input type="number"
                                   name="base_salary"
                                   id="base_salary"
                                   class="form-control-compact"
                                   step="0.01"
                                   min="0"
                                   required>
                            <p class="form-help">Base amount used for percentage calculations in the salary structure</p>
                        </div>

                        <!-- Date Range Quick Selector -->
                        <div class="form-group">
                            <label class="form-label">Quick Date Range</label>
                            <div style="display: flex; gap: 6px; flex-wrap: wrap;">
                                <button type="button" class="btn-compact btn-secondary-compact" onclick="setDateRange(3)">
                                    3 Months
                                </button>
                                <button type="button" class="btn-compact btn-secondary-compact" onclick="setDateRange(6)">
                                    6 Months
                                </button>
                                <button type="button" class="btn-compact btn-secondary-compact" onclick="setDateRange(12)">
                                    1 Year
                                </button>
                                <button type="button" class="btn-compact btn-secondary-compact" onclick="setDateRange(36)">
                                    3 Years
                                </button>
                                <button type="button" class="btn-compact btn-secondary-compact" onclick="setDateRange(60)">
                                    5 Years
                                </button>
                                <button type="button" class="btn-compact btn-secondary-compact" onclick="setDateRange(120)">
                                    10 Years
                                </button>
                                <button type="button" class="btn-compact btn-secondary-compact" onclick="setDateRange(0)">
                                    No End Date
                                </button>
                            </div>
                            <p class="form-help">Click to automatically set from/to dates</p>
                        </div>

                        <!-- Date Range -->
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                            <div class="form-group">
                                <label for="from_date" class="form-label">
                                    From Date <span style="color: var(--danger);">*</span>
                                </label>
                                <input type="date"
                                       name="from_date"
                                       id="from_date"
                                       class="form-control-compact"
                                       required>
                                <p class="form-help">Assignment start date</p>
                            </div>
                            <div class="form-group">
                                <label for="to_date" class="form-label">
                                    To Date
                                </label>
                                <input type="date"
                                       name="to_date"
                                       id="to_date"
                                       class="form-control-compact">
                                <p class="form-help">Leave empty for no end date</p>
                            </div>
                        </div>

                <!-- Active Status -->
                <div class="form-check-compact">
                    <input type="checkbox"
                           name="is_active"
                           id="is_active"
                           checked>
                    <label for="is_active">
                        Active (will deactivate other assignments for this employee)
                    </label>
                </div>
            </div>
        </div>

        <!-- Form Actions -->
        <div class="flex gap-2 mt-3 justify-end">
            <a href="{% url 'payroll:salary_structure_assignment_list' %}" class="button-min-danger">
                    <span>Cancel</span>
            </a>
            <button type="submit" class="button-min-primary">
                    <span>Save</span>
            </button>
        </div>
    </form>
</div>

<script>
// Employee autocomplete
const employees = [
    {% for employee in employees %}
    {
        id: {{ employee.id }},
        name: '{{ employee.first_name|escapejs }} {{ employee.last_name|escapejs }}',
        employee_id: '{{ employee.employee_id|escapejs }}'
    }{% if not forloop.last %},{% endif %}
    {% endfor %}
];

const employeeSearchInput = document.getElementById('employee-search');
const employeeHiddenInput = document.getElementById('employee');
const employeeDropdown = document.getElementById('employee-dropdown');
let selectedIndex = -1;

// Show dropdown on focus
employeeSearchInput.addEventListener('focus', function() {
    filterEmployees('');
});

// Filter on input
employeeSearchInput.addEventListener('input', function() {
    const query = this.value;
    employeeHiddenInput.value = ''; // Clear selection when typing
    filterEmployees(query);
});

// Keyboard navigation
employeeSearchInput.addEventListener('keydown', function(e) {
    const items = employeeDropdown.querySelectorAll('.autocomplete-item');

    if (e.key === 'ArrowDown') {
        e.preventDefault();
        selectedIndex = Math.min(selectedIndex + 1, items.length - 1);
        updateSelection(items);
    } else if (e.key === 'ArrowUp') {
        e.preventDefault();
        selectedIndex = Math.max(selectedIndex - 1, -1);
        updateSelection(items);
    } else if (e.key === 'Enter') {
        e.preventDefault();
        if (selectedIndex >= 0 && items[selectedIndex]) {
            items[selectedIndex].click();
        }
    } else if (e.key === 'Escape') {
        employeeDropdown.classList.remove('show');
        selectedIndex = -1;
    }
});

// Close dropdown when clicking outside
document.addEventListener('click', function(e) {
    if (!e.target.closest('.autocomplete-container')) {
        employeeDropdown.classList.remove('show');
        selectedIndex = -1;
    }
});

function filterEmployees(query) {
    query = query.toLowerCase().trim();
    const filtered = employees.filter(emp => {
        const name = (emp.name || '').toLowerCase();
        const empId = (emp.employee_id || '').toLowerCase();
        return name.includes(query) || empId.includes(query);
    });

    if (filtered.length === 0) {
        employeeDropdown.innerHTML = '<div class="autocomplete-no-results">No employees found matching your search</div>';
    } else {
        employeeDropdown.innerHTML = filtered.map((emp, index) => {
            const name = (emp.name || '').trim();
            const empId = (emp.employee_id || '').trim();
            const displayName = name || empId || 'Unnamed Employee';
            const escapedName = displayName.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
            const escapedId = empId.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
            return `
            <div class="autocomplete-item" data-employee-id="${emp.id}" data-index="${index}">
                <div class="autocomplete-item-name">${escapedName}</div>
                ${escapedId ? `<div class="autocomplete-item-id">ID: ${escapedId}</div>` : ''}
            </div>
            `;
        }).join('');

        // Add click handlers
        employeeDropdown.querySelectorAll('.autocomplete-item').forEach(item => {
            item.addEventListener('click', function() {
                const employeeId = parseInt(this.dataset.employeeId);
                const employee = employees.find(e => e.id === employeeId);
                if (employee) {
                    employeeSearchInput.value = employee.name;
                    employeeHiddenInput.value = employeeId;
                    employeeDropdown.classList.remove('show');
                    selectedIndex = -1;
                }
            });
        });
    }

    employeeDropdown.classList.add('show');
    selectedIndex = -1;
}

function updateSelection(items) {
    items.forEach((item, index) => {
        if (index === selectedIndex) {
            item.classList.add('selected');
            item.scrollIntoView({ block: 'nearest' });
        } else {
            item.classList.remove('selected');
        }
    });
}

// Salary Structure autocomplete
const structures = [
    {% for structure in structures %}
    {
        id: {{ structure.id }},
        name: '{{ structure.name|escapejs }}',
        company: '{{ structure.company|escapejs }}'
    }{% if not forloop.last %},{% endif %}
    {% endfor %}
];

const structureSearchInput = document.getElementById('structure-search');
const structureHiddenInput = document.getElementById('salary_structure');
const structureDropdown = document.getElementById('structure-dropdown');
let structureSelectedIndex = -1;

// Show dropdown on focus
structureSearchInput.addEventListener('focus', function() {
    filterStructures('');
});

// Filter on input
structureSearchInput.addEventListener('input', function() {
    const query = this.value;
    structureHiddenInput.value = ''; // Clear selection when typing
    filterStructures(query);
});

// Keyboard navigation
structureSearchInput.addEventListener('keydown', function(e) {
    const items = structureDropdown.querySelectorAll('.autocomplete-item');

    if (e.key === 'ArrowDown') {
        e.preventDefault();
        structureSelectedIndex = Math.min(structureSelectedIndex + 1, items.length - 1);
        updateStructureSelection(items);
    } else if (e.key === 'ArrowUp') {
        e.preventDefault();
        structureSelectedIndex = Math.max(structureSelectedIndex - 1, -1);
        updateStructureSelection(items);
    } else if (e.key === 'Enter') {
        e.preventDefault();
        if (structureSelectedIndex >= 0 && items[structureSelectedIndex]) {
            items[structureSelectedIndex].click();
        }
    } else if (e.key === 'Escape') {
        structureDropdown.classList.remove('show');
        structureSelectedIndex = -1;
    }
});

// Close dropdown when clicking outside (update to handle both dropdowns)
document.addEventListener('click', function(e) {
    if (!e.target.closest('.autocomplete-container')) {
        employeeDropdown.classList.remove('show');
        structureDropdown.classList.remove('show');
        selectedIndex = -1;
        structureSelectedIndex = -1;
    }
});

function filterStructures(query) {
    query = query.toLowerCase().trim();
    const filtered = structures.filter(struct => {
        const name = (struct.name || '').toLowerCase();
        const company = (struct.company || '').toLowerCase();
        return name.includes(query) || company.includes(query);
    });

    if (filtered.length === 0) {
        structureDropdown.innerHTML = '<div class="autocomplete-no-results">No salary structures found matching your search</div>';
    } else {
        structureDropdown.innerHTML = filtered.map((struct, index) => {
            const name = (struct.name || '').trim();
            const company = (struct.company || '').trim();
            const displayName = name || 'Unnamed Structure';
            const escapedName = displayName.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
            const escapedCompany = company.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
            return `
            <div class="autocomplete-item" data-structure-id="${struct.id}" data-index="${index}">
                <div class="autocomplete-item-name">${escapedName}</div>
                ${escapedCompany ? `<div class="autocomplete-item-id">Company: ${escapedCompany}</div>` : ''}
            </div>
            `;
        }).join('');

        // Add click handlers
        structureDropdown.querySelectorAll('.autocomplete-item').forEach(item => {
            item.addEventListener('click', function() {
                const structureId = parseInt(this.dataset.structureId);
                const structure = structures.find(s => s.id === structureId);
                if (structure) {
                    structureSearchInput.value = structure.name;
                    structureHiddenInput.value = structureId;
                    structureDropdown.classList.remove('show');
                    structureSelectedIndex = -1;
                }
            });
        });
    }

    structureDropdown.classList.add('show');
    structureSelectedIndex = -1;
}

function updateStructureSelection(items) {
    items.forEach((item, index) => {
        if (index === structureSelectedIndex) {
            item.classList.add('selected');
            item.scrollIntoView({ block: 'nearest' });
        } else {
            item.classList.remove('selected');
        }
    });
}

// Validate date range
document.getElementById('to_date').addEventListener('change', function() {
    const fromDate = new Date(document.getElementById('from_date').value);
    const toDate = new Date(this.value);

    if (fromDate && toDate && toDate < fromDate) {
        alert('To date cannot be earlier than from date');
        this.value = '';
    }
});

// Set minimum to date based on from date
document.getElementById('from_date').addEventListener('change', function() {
    const toDateInput = document.getElementById('to_date');
    toDateInput.setAttribute('min', this.value);
});

// Date range quick selector function
function setDateRange(months) {
    const today = new Date();
    const fromDateInput = document.getElementById('from_date');
    const toDateInput = document.getElementById('to_date');

    // Set from date to today
    const fromDate = new Date(today);
    fromDateInput.value = fromDate.toISOString().split('T')[0];

    // Calculate to date based on months
    if (months === 0) {
        // No end date
        toDateInput.value = '';
    } else {
        const toDate = new Date(today);
        toDate.setMonth(toDate.getMonth() + months);
        toDateInput.value = toDate.toISOString().split('T')[0];
    }

    // Visual feedback - highlight the dates briefly
    fromDateInput.style.backgroundColor = '#d1fae5';
    toDateInput.style.backgroundColor = '#d1fae5';

    setTimeout(() => {
        fromDateInput.style.backgroundColor = '';
        toDateInput.style.backgroundColor = '';
    }, 500);
}
</script>
{% endblock %}
