{% extends 'base.html' %}
{% load static %}

{% block title %}Edit Employee Loan{% endblock %}

{% block extra_css %}
<style>
    .form-control { 
        font-size: 11px !important; 
        padding: 4px 6px !important; 
        height: auto !important; 
        border-radius: 3px; 
        border: 1px solid #d1d5db; 
        }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Page Header -->
    <div class="mb-4">
        <h1 class="h3 mb-0">Edit Employee Loan</h1>
        <p class="text-muted mb-0">Update loan for {{ loan.employee.get_full_name }}</p>
    </div>

    <div class="row justify-content-center">
        <div class="col-lg-8">
            <form method="post" id="loanForm">
                {% csrf_token %}

                <div class="card shadow-sm">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">Loan Details</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="form-label">Employee</label>
                            <input type="text" class="form-control" value="{{ loan.employee.get_full_name }}" disabled>
                            <small class="form-text text-muted">Employee cannot be changed</small>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Loan Amount (KHR) <span class="text-danger">*</span></label>
                                    <input type="number" name="loan_amount" id="loan_amount" class="form-control" step="0.01" value="{{ loan.loan_amount }}" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Interest Rate (%) <span class="text-danger">*</span></label>
                                    <input type="number" name="interest_rate" id="interest_rate" class="form-control" step="0.01" value="{{ loan.interest_rate }}" required>
                                    <small class="form-text text-muted">Enter 0 for interest-free loans</small>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Loan Term (Months) <span class="text-danger">*</span></label>
                                    <input type="number" name="loan_term_months" id="loan_term_months" class="form-control" min="1" value="{{ loan.loan_term_months }}" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Start Date <span class="text-danger">*</span></label>
                                    <input type="date" name="start_date" class="form-control" value="{{ loan.start_date|date:'Y-m-d' }}" required>
                                </div>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Monthly Installment (Auto-calculated)</label>
                            <input type="text" id="monthly_installment_display" class="form-control" readonly value="KHR {{ loan.monthly_installment|floatformat:0 }}">
                            <small class="form-text text-muted">This will be recalculated based on loan amount, interest rate, and term</small>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Purpose <span class="text-danger">*</span></label>
                            <textarea name="purpose" class="form-control" rows="3" required>{{ loan.purpose }}</textarea>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Remarks</label>
                            <textarea name="remarks" class="form-control" rows="2">{{ loan.remarks }}</textarea>
                        </div>

                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>
                            <strong>Note:</strong> Current status is <strong>{{ loan.get_status_display }}</strong>.
                            To change the status, use the Approve or Activate buttons from the detail view.
                        </div>
                    </div>
                </div>

                <!-- Form Actions -->
                <div class="mt-4">
                    <div class="d-flex justify-end space-x-1">
                        <button type="submit" class="button-min-primary">
                        <div>
                            Save
                        </div>
                        </button>
                        <a href="{% url 'payroll:employee_loan_detail' loan.id %}" class="button-min-danger">
                            Cancel
                        </a>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
function calculateMonthlyInstallment() {
    const loanAmount = parseFloat(document.getElementById('loan_amount').value) || 0;
    const interestRate = parseFloat(document.getElementById('interest_rate').value) || 0;
    const loanTerm = parseInt(document.getElementById('loan_term_months').value) || 0;

    if (loanAmount > 0 && loanTerm > 0) {
        let monthlyInstallment;

        if (interestRate > 0) {
            const monthlyRate = interestRate / 100 / 12;
            monthlyInstallment = (loanAmount * monthlyRate * Math.pow(1 + monthlyRate, loanTerm)) /
                               (Math.pow(1 + monthlyRate, loanTerm) - 1);
        } else {
            monthlyInstallment = loanAmount / loanTerm;
        }

        document.getElementById('monthly_installment_display').value =
            'KHR ' + monthlyInstallment.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ",");
    }
}

document.getElementById('loan_amount').addEventListener('input', calculateMonthlyInstallment);
document.getElementById('interest_rate').addEventListener('input', calculateMonthlyInstallment);
document.getElementById('loan_term_months').addEventListener('input', calculateMonthlyInstallment);
</script>
{% endblock %}
