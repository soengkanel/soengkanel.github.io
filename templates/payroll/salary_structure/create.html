{% extends 'base/base.html' %}
{% load static %}

{% block title %}Create Salary Structure{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'ui/css/app.css' %}">
<style>
    /* Subtable - Excel-like inline editing styles */
    .new-row {
        background-color: #f0fdf4;
    }

    .new-row input,
    .new-row select {
        border: 1px solid #d1d5db !important;
    }

    .component-table {
        font-size: 0.875rem;
    }

    .component-table th {
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
        background: #f8fafb;
        padding: 8px 12px;
        border-bottom: 2px solid #e2e8f0;
    }

    .component-table td {
        padding: 6px 8px;
        vertical-align: middle;
    }

    .component-table input,
    .component-table select {
        font-size: 0.875rem;
        padding: 4px 8px;
        height: 32px;
    }

    .btn-sm-action {
        padding: 4px 8px;
        font-size: 0.75rem;
        line-height: 1;
    }

    .section-title {
        font-size: 0.9rem;
        font-weight: 600;
        color: #1a1a1a;
        margin-bottom: 12px;
        padding-bottom: 8px;
        border-bottom: 2px solid #e2e8f0;
    }

    .section-title.earnings {
        border-bottom-color: #10b981;
    }

    .section-title.deductions {
        border-bottom-color: #ef4444;
    }
</style>
{% endblock %}

{% block content %}
<main class="min-h-screen h-auto">
    <div class="px-5 py-3">
        <form method="post" id="salary-structure-form">
            {% csrf_token %}

            <!-- Basic Information -->
            <div class="grid grid-cols-2 gap-4 mb-4">
                <div class="col-span-2 md:col-span-1">
                    <label class="block text-sm font-medium text-gray-700 mb-1">
                        Structure Name <span class="text-red-500">*</span>
                    </label>
                    <input type="text"
                           name="name"
                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                           placeholder="Enter structure name..."
                           required>
                </div>

                <div class="col-span-2 md:col-span-1">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Company</label>
                    <input type="text"
                           name="company"
                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                           placeholder="Company name (optional)">
                </div>
            </div>

            <!-- Settings -->
            <div class="grid grid-cols-2 gap-4 mb-4">
                <div class="col-span-2 md:col-span-1">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Hour Rate</label>
                    <input type="number"
                           name="hour_rate"
                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                           placeholder="0.00"
                           step="0.01">
                    <p class="text-xs text-gray-500 mt-1">Hourly rate for timesheet-based calculations</p>
                </div>

                <div class="col-span-2 md:col-span-1">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Max Benefits</label>
                    <input type="number"
                           name="max_benefits"
                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                           placeholder="0.00"
                           step="0.01">
                    <p class="text-xs text-gray-500 mt-1">Maximum benefits amount</p>
                </div>
            </div>

            <!-- Checkboxes -->
            <div class="grid grid-cols-3 gap-4 mb-6">
                <div class="flex items-center">
                    <input type="checkbox"
                           name="is_active"
                           id="is_active"
                           class="w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500"
                           checked>
                    <label for="is_active" class="ml-2 text-sm text-gray-700">Active</label>
                </div>

                <div>
                    <div class="flex items-center">
                        <input type="checkbox"
                               name="salary_slip_based_on_timesheet"
                               id="timesheet_based"
                               class="w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                        <label for="timesheet_based" class="ml-2 text-sm text-gray-700">Based on Timesheet</label>
                    </div>
                    <p class="text-xs text-gray-500 ml-6">Enable timesheet-based calculations for this entire structure</p>
                </div>

                <div class="flex items-center">
                    <input type="checkbox"
                           name="leave_encashment"
                           id="leave_encashment"
                           class="w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                    <label for="leave_encashment" class="ml-2 text-sm text-gray-700">Allow Leave Encashment</label>
                </div>
            </div>

            <!-- Earnings Section -->
            <div class="mb-6">
                <div class="flex justify-between items-center mb-3">
                    <h3 class="section-title earnings mb-0">Earnings Components</h3>
                    <button type="button"
                            id="add-earning-btn"
                            class="button-min-success py-1">
                            <div>
                                <i class="bi bi-plus-circle me-1"></i> Add Earning
                            </div>
                    </button>
                </div>

                <div class="overflow-x-auto bg-white border border-gray-200 rounded-md shadow-sm">
                    <table class="table table-hover component-table w-full mb-0">
                        <thead>
                            <tr>
                                <th width="40%">Component</th>
                                <th width="20%">Amount</th>
                                <th width="30%">Formula</th>
                                <th width="10%">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="earnings-tbody">
                            <!-- Rows will be added dynamically -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Deductions Section -->
            <div class="mb-6">
                <div class="flex justify-between items-center mb-3">
                    <h3 class="section-title deductions mb-0">Deduction Components</h3>
                    <button type="button"
                            id="add-deduction-btn"
                            class="button-min-danger py-1">
                            <div>
                                <i class="bi bi-plus-circle me-1"></i> Add Deduction
                            </div>
                    </button>
                </div>

                <div class="overflow-x-auto bg-white border border-gray-200 rounded-md shadow-sm">
                    <table class="table table-hover component-table w-full mb-0">
                        <thead>
                            <tr>
                                <th width="40%">Component</th>
                                <th width="20%">Amount</th>
                                <th width="30%">Formula</th>
                                <th width="10%">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="deductions-tbody">
                            <!-- Rows will be added dynamically -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="flex justify-end items-center mt-3 mb-4 space-x-3">
                <a href="{% url 'payroll:salary_structure_list' %}"
                   class="button-min-danger py-1">
                    Cancel
                </a>
                <button type="submit" class="button-min-primary py-1">Save
                </button>
            </div>
        </form>
    </div>
</main>

<script>
document.addEventListener('DOMContentLoaded', function() {
    let earningRowCounter = 0;
    let deductionRowCounter = 0;

    const earningsTbody = document.getElementById('earnings-tbody');
    const deductionsTbody = document.getElementById('deductions-tbody');
    const addEarningBtn = document.getElementById('add-earning-btn');
    const addDeductionBtn = document.getElementById('add-deduction-btn');

    // Earnings data from Django
    const earnings = [
        {% for comp in earnings %}
        { id: '{{ comp.id }}', name: '{{ comp.name }}', code: '{{ comp.code }}' },
        {% endfor %}
    ];

    // Deductions data from Django
    const deductions = [
        {% for comp in deductions %}
        { id: '{{ comp.id }}', name: '{{ comp.name }}', code: '{{ comp.code }}' },
        {% endfor %}
    ];

    // Create earnings row
    function createEarningRow() {
        const rowId = `earning-row-${++earningRowCounter}`;
        const row = document.createElement('tr');
        row.id = rowId;
        row.className = 'new-row';
        row.setAttribute('data-new-row', 'true');

        let optionsHtml = '<option value="">Select component...</option>';
        earnings.forEach(comp => {
            optionsHtml += `<option value="${comp.id}">${comp.name} (${comp.code})</option>`;
        });

        row.innerHTML = `
            <td>
                <select class="form-select form-select-sm w-full" name="component_id[]" required>
                    ${optionsHtml}
                </select>
            </td>
            <td>
                <input type="number"
                       name="component_amount[]"
                       class="form-control form-control-sm w-full"
                       placeholder="0.00"
                       step="0.01"
                       min="0">
            </td>
            <td>
                <input type="text"
                       name="component_formula[]"
                       class="form-control form-control-sm w-full"
                       placeholder="e.g., base * 0.1">
            </td>
            <td class="text-center">
                <button type="button"
                        class="btn btn-outline-danger btn-sm btn-sm-action"
                        onclick="this.closest('tr').remove()"
                        title="Remove">
                    <i class="bi bi-x-lg"></i>
                </button>
            </td>
        `;

        return row;
    }

    // Create deduction row
    function createDeductionRow() {
        const rowId = `deduction-row-${++deductionRowCounter}`;
        const row = document.createElement('tr');
        row.id = rowId;
        row.className = 'new-row';
        row.setAttribute('data-new-row', 'true');

        let optionsHtml = '<option value="">Select component...</option>';
        deductions.forEach(comp => {
            optionsHtml += `<option value="${comp.id}">${comp.name} (${comp.code})</option>`;
        });

        row.innerHTML = `
            <td>
                <select class="form-select form-select-sm w-full" name="component_id[]" required>
                    ${optionsHtml}
                </select>
            </td>
            <td>
                <input type="number"
                       name="component_amount[]"
                       class="form-control form-control-sm w-full"
                       placeholder="0.00"
                       step="0.01"
                       min="0">
            </td>
            <td>
                <input type="text"
                       name="component_formula[]"
                       class="form-control form-control-sm w-full"
                       placeholder="e.g., gross * 0.05">
            </td>
            <td class="text-center">
                <button type="button"
                        class="btn btn-outline-danger btn-sm btn-sm-action"
                        onclick="this.closest('tr').remove()"
                        title="Remove">
                    <i class="bi bi-x-lg"></i>
                </button>
            </td>
        `;

        return row;
    }

    // Add earning row
    addEarningBtn.addEventListener('click', function() {
        const newRow = createEarningRow();
        earningsTbody.appendChild(newRow);
        newRow.querySelector('select').focus();
    });

    // Add deduction row
    addDeductionBtn.addEventListener('click', function() {
        const newRow = createDeductionRow();
        deductionsTbody.appendChild(newRow);
        newRow.querySelector('select').focus();
    });

    // Form validation
    document.getElementById('salary-structure-form').addEventListener('submit', function(e) {
        const name = document.querySelector('[name="name"]').value.trim();
        if (!name) {
            e.preventDefault();
            alert('Please enter a structure name');
            return false;
        }

        // Check if at least one component is selected
        const selectedComponents = document.querySelectorAll('[name="component_id[]"]');
        let hasComponent = false;
        selectedComponents.forEach(select => {
            if (select.value) hasComponent = true;
        });

        if (!hasComponent) {
            e.preventDefault();
            alert('Please add at least one salary component (earning or deduction)');
            return false;
        }

        return true;
    });

    // Initialize with one empty row for each section
    addEarningBtn.click();
    addDeductionBtn.click();
});
</script>
{% endblock %}
