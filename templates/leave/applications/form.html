{% extends 'base/base.html' %}
{% load static %}

{% block title %}{{ title }}{% endblock %}

{% block main_class %}col-md-10 ms-sm-auto col-lg-10{% endblock %}

{% block extra_css %}
<style>
    /* Compact Container */
    .leave-form-container {
        max-width: 700px;
        margin: 0 auto;
    }

    /* Clean Card */
    .form-card {
        background: white;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        padding: 24px;
        margin-bottom: 16px;
    }

    /* Minimal Section Headers */
    .section-title {
        font-size: 14px;
        font-weight: 600;
        color: #374151;
        margin-bottom: 16px;
        padding-bottom: 8px;
        border-bottom: 1px solid #f3f4f6;
    }

    /* Clean Form Controls */
    .form-control, .form-select {
        font-size: 13px;
        padding: 8px 12px;
        border: 1px solid #d1d5db;
        border-radius: 6px;
        transition: border-color 0.2s;
    }

    .form-control:focus, .form-select:focus {
        border-color: #3b82f6;
        box-shadow: none;
        outline: none;
    }

    .form-label {
        font-size: 12px;
        font-weight: 500;
        color: #6b7280;
        margin-bottom: 4px;
    }

    /* Compact Balance Display */
    .balance-display {
        background: #f9fafb;
        border: 1px solid #e5e7eb;
        border-radius: 6px;
        padding: 12px;
        margin-bottom: 16px;
        display: none;
    }

    .balance-display.show {
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .balance-info {
        font-size: 12px;
        color: #6b7280;
    }

    .balance-number {
        font-size: 24px;
        font-weight: 700;
        color: #059669;
    }

    .balance-number.low {
        color: #dc2626;
    }

    .balance-number.medium {
        color: #ea580c;
    }

    /* Simple Duration Toggle */
    .duration-tabs {
        display: flex;
        gap: 8px;
        margin-bottom: 16px;
    }

    .duration-tab {
        flex: 1;
        padding: 8px;
        border: 1px solid #d1d5db;
        border-radius: 6px;
        background: white;
        font-size: 13px;
        font-weight: 500;
        color: #6b7280;
        cursor: pointer;
        text-align: center;
        transition: all 0.2s;
    }

    .duration-tab:hover {
        border-color: #3b82f6;
    }

    .duration-tab.active {
        border-color: #3b82f6;
        background: #eff6ff;
        color: #3b82f6;
    }

    /* Quick Days Pills */
    .days-pills {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
        margin-bottom: 12px;
    }

    .day-pill {
        padding: 6px 12px;
        border: 1px solid #d1d5db;
        border-radius: 4px;
        background: white;
        font-size: 12px;
        font-weight: 500;
        color: #6b7280;
        cursor: pointer;
        transition: all 0.2s;
    }

    .day-pill:hover {
        border-color: #3b82f6;
    }

    .day-pill.active {
        border-color: #3b82f6;
        background: #3b82f6;
        color: white;
    }

    /* Info Box */
    .info-box {
        background: #f0f9ff;
        border-left: 3px solid #3b82f6;
        padding: 10px 12px;
        margin-bottom: 16px;
        font-size: 12px;
        color: #1e40af;
        border-radius: 4px;
    }

    /* Compact File Input */
    .file-input-wrapper {
        position: relative;
    }

    .file-input-wrapper input[type="file"] {
        font-size: 12px;
    }

    /* Clean Buttons */
    .btn-primary-clean {
        background: #3b82f6;
        border: none;
        color: white;
        padding: 10px 24px;
        border-radius: 6px;
        font-weight: 500;
        font-size: 13px;
        transition: background 0.2s;
    }

    .btn-primary-clean:hover {
        background: #2563eb;
    }

    .btn-secondary-clean {
        background: white;
        border: 1px solid #d1d5db;
        color: #6b7280;
        padding: 10px 24px;
        border-radius: 6px;
        font-weight: 500;
        font-size: 13px;
        transition: all 0.2s;
    }

    .btn-secondary-clean:hover {
        border-color: #9ca3af;
        color: #374151;
    }

    /* Helper Text */
    .help-text {
        font-size: 11px;
        color: #9ca3af;
        margin-top: 2px;
    }

    /* Required */
    .required {
        color: #dc2626;
    }

    /* Compact spacing */
    .mb-compact {
        margin-bottom: 12px;
    }

    /* Responsive */
    @media (max-width: 768px) {
        .form-card {
            padding: 16px;
        }

        .days-pills {
            justify-content: space-between;
        }

        .day-pill {
            flex: 1 1 auto;
            min-width: 60px;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid px-4 py-3">
    <div class="leave-form-container">
        <!-- Simple Header -->
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h5 class="mb-0" style="font-weight: 600; color: #111827;">Apply for Leave</h5>
            <a href="{% url 'leave:application_list' %}" class="button-min-default">
                Back
            </a>
        </div>

        <form method="post" enctype="multipart/form-data">
            {% csrf_token %}

            <!-- Main Form -->
            <div class="form-card">
                <!-- Leave Type -->
                <div class="mb-compact">
                    <label class="form-label">Leave Type <span class="required">*</span></label>
                    {{ form.leave_type }}
                    {% if form.leave_type.errors %}
                    <div class="text-danger small mt-1">{{ form.leave_type.errors.0 }}</div>
                    {% endif %}
                </div>

                <!-- Balance Display -->
                <div class="balance-display" id="balance-display">
                    <div>
                        <div class="balance-info" id="balance-info">Annual Leave</div>
                        <div class="help-text" id="balance-details">Used 0 of 14 days</div>
                    </div>
                    <div class="text-end">
                        <div class="balance-number" id="balance-number">14</div>
                        <div class="help-text">days left</div>
                    </div>
                </div>

                <!-- Duration Type -->
                <div class="mb-compact">
                    <label class="form-label">Duration</label>
                    <div class="duration-tabs">
                        <button type="button" class="duration-tab active" id="full-day-tab">
                            Full Day(s)
                        </button>
                        <button type="button" class="duration-tab" id="half-day-tab">
                            Half Day
                        </button>
                    </div>
                </div>

                <!-- Full Day Section -->
                <div id="full-day-section">
                    <!-- Quick Select -->
                    <div class="mb-compact">
                        <label class="form-label">Quick Select</label>
                        <div class="days-pills">
                            <div class="day-pill active" data-days="1">1 day</div>
                            <div class="day-pill" data-days="2">2 days</div>
                            <div class="day-pill" data-days="3">3 days</div>
                            <div class="day-pill" data-days="5">5 days</div>
                            <div class="day-pill" data-days="7">1 week</div>
                            <div class="day-pill" data-days="custom">Custom</div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-compact">
                            <label class="form-label">Start Date <span class="required">*</span></label>
                            {{ form.from_date }}
                            {% if form.from_date.errors %}
                            <div class="text-danger small mt-1">{{ form.from_date.errors.0 }}</div>
                            {% endif %}
                        </div>
                        <div class="col-md-6 mb-compact">
                            <label class="form-label">End Date <span class="required">*</span></label>
                            {{ form.to_date }}
                            <div class="help-text" id="total-days-text">Auto-calculated</div>
                            {% if form.to_date.errors %}
                            <div class="text-danger small mt-1">{{ form.to_date.errors.0 }}</div>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!-- Half Day Section -->
                <div id="half-day-section" style="display: none;">
                    <div class="row">
                        <div class="col-md-6 mb-compact">
                            <label class="form-label">Date <span class="required">*</span></label>
                            {{ form.half_day_date }}
                        </div>
                        <div class="col-md-6 mb-compact">
                            <label class="form-label">Session <span class="required">*</span></label>
                            {{ form.leave_session }}
                        </div>
                    </div>
                </div>

                <!-- Hidden Fields -->
                <div style="display: none;">
                    {{ form.half_day }}
                    {{ form.employee }}
                </div>

                <!-- Reason -->
                <div class="mb-compact">
                    <label class="form-label">Reason <span class="required">*</span></label>
                    {{ form.reason }}
                    {% if form.reason.errors %}
                    <div class="text-danger small mt-1">{{ form.reason.errors.0 }}</div>
                    {% endif %}
                </div>

                <!-- Documents -->
                <div class="section-title">Documents (Optional)</div>

                <div class="info-box">
                    <i class="bi bi-info-circle me-1"></i> Medical certificate required for sick leave exceeding 3 days
                </div>

                <div class="row">
                    <div class="col-md-6 mb-compact">
                        <label class="form-label">Supporting Document</label>
                        <div class="file-input-wrapper">
                            {{ form.supporting_document }}
                        </div>
                    </div>
                    <div class="col-md-6 mb-compact">
                        <label class="form-label">Medical Certificate</label>
                        <div class="file-input-wrapper">
                            {{ form.medical_certificate }}
                        </div>
                    </div>
                </div>
            </div>

            <!-- Actions -->
            <div class="flex items-center justify-end space-x-3 mb-3">
                <a href="{% url 'leave:application_list' %}" class="button-min-default">
                    Cancel
                </a>
                <button type="submit" class="button-min-primary px-4">
                    Submit Request
                </button>
            </div>
        </form>
    </div>
</div>

<script>
const leaveBalances = {{ leave_balances|safe }};

document.addEventListener('DOMContentLoaded', function() {
    const leaveTypeSelect = document.getElementById('{{ form.leave_type.id_for_label }}');
    const fullDayTab = document.getElementById('full-day-tab');
    const halfDayTab = document.getElementById('half-day-tab');
    const fullDaySection = document.getElementById('full-day-section');
    const halfDaySection = document.getElementById('half-day-section');
    const halfDayCheckbox = document.getElementById('{{ form.half_day.id_for_label }}');
    const fromDateInput = document.getElementById('{{ form.from_date.id_for_label }}');
    const toDateInput = document.getElementById('{{ form.to_date.id_for_label }}');
    const dayPills = document.querySelectorAll('.day-pill');

    // Set min date to today
    const today = new Date().toISOString().split('T')[0];
    fromDateInput.setAttribute('min', today);
    toDateInput.setAttribute('min', today);

    // Leave type change
    if (leaveTypeSelect) {
        leaveTypeSelect.addEventListener('change', function(e) {
            updateBalance(e.target.value);
        });
        if (leaveTypeSelect.value) {
            updateBalance(leaveTypeSelect.value);
        }
    }

    function updateBalance(leaveTypeId) {
        const display = document.getElementById('balance-display');
        const number = document.getElementById('balance-number');
        const info = document.getElementById('balance-info');
        const details = document.getElementById('balance-details');

        const balance = leaveBalances[leaveTypeId] || leaveBalances[String(leaveTypeId)];

        if (balance) {
            display.classList.add('show');
            number.textContent = balance.remaining;
            info.textContent = balance.leave_type;
            details.textContent = `Used ${balance.used} of ${balance.allocated} days`;

            number.className = 'balance-number';
            if (balance.remaining <= 0) number.classList.add('low');
            else if (balance.remaining <= 3) number.classList.add('medium');
        } else {
            display.classList.remove('show');
        }
    }

    // Duration tabs
    fullDayTab.addEventListener('click', function() {
        fullDayTab.classList.add('active');
        halfDayTab.classList.remove('active');
        fullDaySection.style.display = 'block';
        halfDaySection.style.display = 'none';
        halfDayCheckbox.checked = false;
    });

    halfDayTab.addEventListener('click', function() {
        halfDayTab.classList.add('active');
        fullDayTab.classList.remove('active');
        fullDaySection.style.display = 'none';
        halfDaySection.style.display = 'block';
        halfDayCheckbox.checked = true;
    });

    // Quick days selector
    dayPills.forEach(pill => {
        pill.addEventListener('click', function() {
            dayPills.forEach(p => p.classList.remove('active'));
            this.classList.add('active');

            const days = this.getAttribute('data-days');
            if (days === 'custom') {
                toDateInput.readOnly = false;
            } else {
                toDateInput.readOnly = true;
                // Auto-fill start date with today if not set
                if (!fromDateInput.value) {
                    fromDateInput.value = today;
                }
                // Calculate and set end date
                toDateInput.value = calculateEndDate(fromDateInput.value, parseInt(days));
                updateDaysText(parseInt(days));
            }
        });
    });

    function calculateEndDate(start, days) {
        const date = new Date(start);
        date.setDate(date.getDate() + days - 1);
        return date.toISOString().split('T')[0];
    }

    function updateDaysText(days) {
        const text = document.getElementById('total-days-text');
        text.textContent = days === 1 ? '1 day' : `${days} days`;
    }

    fromDateInput.addEventListener('change', function() {
        const active = document.querySelector('.day-pill.active');
        const days = active ? active.getAttribute('data-days') : null;
        if (days && days !== 'custom') {
            toDateInput.value = calculateEndDate(this.value, parseInt(days));
            updateDaysText(parseInt(days));
        }
    });

    toDateInput.addEventListener('change', function() {
        if (fromDateInput.value && this.value) {
            const start = new Date(fromDateInput.value);
            const end = new Date(this.value);
            const days = Math.ceil((end - start) / (1000 * 60 * 60 * 24)) + 1;
            updateDaysText(days);
        }
    });

    // Initialize
    toDateInput.readOnly = true;
});
</script>
{% endblock %}
