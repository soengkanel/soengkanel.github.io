{% extends 'base/base.html' %}
{% load static %}

{% block title %}Edit Timesheet - Project Management{% endblock %}

{% block extra_css %}
<style>
    /* Subtable Design Variables */
    :root {
        --primary: #3b82f6;
        --success: #10b981;
        --warning: #f59e0b;
        --danger: #ef4444;
        --border: #e5e7eb;
        --bg-gray: #f9fafb;
    }

    body {
        font-size: 13px;
    }

    /* Compact Page Header */
    .page-header-compact {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 12px 0;
        border-bottom: 1px solid var(--border);
        margin-bottom: 12px;
    }

    .page-header-compact h1 {
        font-size: 16px;
        font-weight: 600;
        color: #111827;
        margin: 0;
        display: flex;
        align-items: center;
        gap: 6px;
    }

    /* Compact Buttons */
    .btn-compact {
        display: inline-flex;
        align-items: center;
        gap: 4px;
        padding: 5px 10px;
        font-size: 12px;
        font-weight: 500;
        border-radius: 4px;
        text-decoration: none;
        transition: all 0.15s;
        border: 1px solid;
        cursor: pointer;
    }

    .btn-primary-compact {
        background: var(--primary);
        color: white;
        border-color: var(--primary);
    }

    .btn-primary-compact:hover {
        background: #2563eb;
        color: white;
    }

    .btn-secondary-compact {
        background: white;
        color: #374151;
        border-color: var(--border);
    }

    .btn-secondary-compact:hover {
        background: var(--bg-gray);
        color: #111827;
    }

    .btn-success-compact {
        background: var(--success);
        color: white;
        border-color: var(--success);
    }

    .btn-success-compact:hover {
        background: #059669;
        color: white;
    }

    /* Form Controls */
    .form-group {
        margin-bottom: 12px;
    }

    .form-label {
        display: block;
        font-size: 12px;
        font-weight: 600;
        color: #374151;
        margin-bottom: 4px;
    }

    .form-control-compact,
    .form-select-compact,
    .form-textarea-compact {
        width: 100%;
        padding: 6px 8px;
        font-size: 12px;
        border: 1px solid var(--border);
        border-radius: 4px;
        background: white;
    }

    .form-control-compact:focus,
    .form-select-compact:focus,
    .form-textarea-compact:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.1);
    }

    .form-help {
        font-size: 11px;
        color: #6b7280;
        margin-top: 2px;
    }

    .form-error {
        font-size: 11px;
        color: var(--danger);
        margin-top: 2px;
    }

    /* Inline Form Controls in Table */
    .form-control-inline,
    .form-select-inline {
        width: 100%;
        padding: 5px 8px;
        font-size: 12px;
        border: 1px solid var(--border);
        border-radius: 4px;
        background: white;
        height: 30px;
    }

    .form-control-inline:focus,
    .form-select-inline:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.1);
    }

    input[type="number"].form-control-inline {
        text-align: right;
        font-weight: 600;
    }

    /* Subtable Design */
    .subtable-container {
        background: white;
        border: 1px solid var(--border);
        border-radius: 6px;
        overflow: hidden;
    }

    .subtable-header {
        background: var(--bg-gray);
        padding: 8px 10px;
        border-bottom: 1px solid var(--border);
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .subtable-title {
        font-size: 13px;
        font-weight: 600;
        color: #111827;
        margin: 0;
    }

    .subtable-count {
        font-size: 11px;
        color: #6b7280;
    }

    .subtable {
        width: 100%;
        margin: 0;
        font-size: 12px;
        border-collapse: collapse;
    }

    .subtable thead th {
        background: var(--bg-gray);
        padding: 6px 8px;
        font-size: 10px;
        font-weight: 600;
        color: #6b7280;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        border-bottom: 1px solid var(--border);
        text-align: left;
        white-space: nowrap;
    }

    .subtable thead th.text-end {
        text-align: right;
    }

    .subtable tbody td {
        padding: 6px 8px;
        border-bottom: 1px solid #f3f4f6;
        color: #111827;
        vertical-align: middle;
    }

    .subtable tbody tr:last-child td {
        border-bottom: none;
    }

    .subtable tbody tr:hover {
        background: #f9fafb;
    }

    .subtable tbody td.text-end {
        text-align: right;
    }

    /* Empty State */
    .empty-state-compact {
        text-align: center;
        padding: 30px 20px;
        color: #6b7280;
    }

    .empty-state-compact i {
        font-size: 40px;
        color: #d1d5db;
        margin-bottom: 8px;
    }

    .empty-state-compact h3 {
        font-size: 14px;
        font-weight: 600;
        color: #111827;
        margin: 0 0 4px 0;
    }

    .empty-state-compact p {
        font-size: 12px;
        margin: 0;
    }

    /* Action Buttons */
    .btn-icon-sm {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 24px;
        height: 24px;
        padding: 0;
        border-radius: 4px;
        border: 1px solid var(--border);
        background: white;
        color: #6b7280;
        cursor: pointer;
        transition: all 0.15s;
        font-size: 11px;
    }

    .btn-icon-sm:hover {
        background: var(--bg-gray);
        border-color: #d1d5db;
        color: #111827;
    }

    .btn-icon-sm.danger {
        color: var(--danger);
    }

    .btn-icon-sm.danger:hover {
        background: #fee2e2;
        border-color: var(--danger);
    }

    .badge-compact {
        display: inline-block;
        padding: 2px 8px;
        border-radius: 10px;
        font-size: 10px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.3px;
    }

    .badge-draft { background: #f3f4f6; color: #4b5563; }
    .badge-submitted { background: #fef3c7; color: #92400e; }
    .badge-approved { background: #d1fae5; color: #065f46; }

    /* Grid Layout */
    .grid-2col {
        display: grid;
        grid-template-columns: 2fr 1fr;
        gap: 12px;
    }

    /* Responsive */
    @media (max-width: 1024px) {
        .grid-2col {
            grid-template-columns: 1fr;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid px-3 py-3">
    <!-- Header -->
    <div class="page-header-compact">
        <h1>
            <i class="bi bi-pencil-square"></i>
            Edit Timesheet
        </h1>
        <div style="display: flex; gap: 6px;">
            <a href="{% url 'project:timesheet_detail' timesheet.id %}" class="btn-compact btn-secondary-compact">
                <i class="bi bi-arrow-left"></i>
                Back
            </a>
        </div>
    </div>

    <form method="post" id="timesheetForm">
        {% csrf_token %}

        <div class="grid-2col">
            <!-- Main Content -->
            <div>
                <!-- Timesheet Details -->
                <div class="subtable-container" style="margin-bottom: 12px;">
                    <div class="subtable-header">
                        <h3 class="subtable-title">Timesheet Details</h3>
                    </div>
                    <div style="padding: 12px;">
                        <!-- Employee Selection -->
                        <div class="form-group">
                            <label for="{{ form.employee.id_for_label }}" class="form-label">
                                Employee <span style="color: var(--danger);">*</span>
                            </label>
                            {{ form.employee }}
                            {% if form.employee.errors %}
                                <p class="form-error">{{ form.employee.errors.0 }}</p>
                            {% else %}
                                <p class="form-help">Select the employee for this timesheet</p>
                            {% endif %}
                        </div>

                        <!-- Date Range -->
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                            <div class="form-group">
                                <label for="{{ form.start_date.id_for_label }}" class="form-label">
                                    Start Date <span style="color: var(--danger);">*</span>
                                </label>
                                {{ form.start_date }}
                                {% if form.start_date.errors %}
                                    <p class="form-error">{{ form.start_date.errors.0 }}</p>
                                {% else %}
                                    <p class="form-help">First day of the period</p>
                                {% endif %}
                            </div>
                            <div class="form-group">
                                <label for="{{ form.end_date.id_for_label }}" class="form-label">
                                    End Date <span style="color: var(--danger);">*</span>
                                </label>
                                {{ form.end_date }}
                                {% if form.end_date.errors %}
                                    <p class="form-error">{{ form.end_date.errors.0 }}</p>
                                {% else %}
                                    <p class="form-help">Last day of the period</p>
                                {% endif %}
                            </div>
                        </div>

                        <!-- Notes (Optional) -->
                        <div class="form-group">
                            <label for="{{ form.notes.id_for_label }}" class="form-label">Notes</label>
                            {{ form.notes }}
                            {% if form.notes.errors %}
                                <p class="form-error">{{ form.notes.errors.0 }}</p>
                            {% else %}
                                <p class="form-help">Optional notes about this timesheet period</p>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!-- Time Entries -->
                <div class="subtable-container">
                    <div class="subtable-header">
                        <h3 class="subtable-title">Time Entries</h3>
                        <span class="subtable-count"><span id="entries-count">0</span> entries</span>
                    </div>

                    <!-- Entries Table -->
                    <table class="subtable">
                        <thead>
                            <tr>
                                <th style="width: 110px;">Date</th>
                                <th>Project</th>
                                <th class="text-end" style="width: 80px;">Hours</th>
                                <th style="width: 90px;">Billable</th>
                                <th>Description</th>
                                <th style="width: 50px;">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="entries-tbody">
                            <!-- New Entry Row -->
                            <tr style="background: var(--bg-gray);">
                                <td>
                                    <input type="date"
                                           id="entry-date"
                                           class="form-control-inline"
                                           style="width: 100%; border: 1px solid var(--border);">
                                </td>
                                <td>
                                    <select id="entry-project" class="form-select-inline" style="width: 100%; border: 1px solid var(--border);">
                                        <option value="">Select Project...</option>
                                        {% if form.project.field.queryset %}
                                            {% for project in form.project.field.queryset %}
                                            <option value="{{ project.id }}">{{ project.project_name }}</option>
                                            {% endfor %}
                                        {% endif %}
                                    </select>
                                </td>
                                <td>
                                    <input type="number"
                                           id="entry-hours"
                                           step="0.25"
                                           min="0"
                                           max="24"
                                           class="form-control-inline"
                                           placeholder="0.00"
                                           style="width: 100%; text-align: right; border: 1px solid var(--border);">
                                </td>
                                <td>
                                    <select id="entry-billable" class="form-select-inline" style="width: 100%; border: 1px solid var(--border);">
                                        <option value="true">Billable</option>
                                        <option value="false">Non-billable</option>
                                    </select>
                                </td>
                                <td>
                                    <input type="text"
                                           id="entry-description"
                                           class="form-control-inline"
                                           placeholder="Description..."
                                           style="width: 100%; border: 1px solid var(--border);">
                                </td>
                                <td>
                                    <button type="button" class="btn-icon-sm" onclick="addEntry()" title="Add Entry" style="background: var(--primary); color: white; border-color: var(--primary);">
                                        <i class="bi bi-plus"></i>
                                    </button>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Sidebar -->
            <div>
                <!-- Quick Info -->
                <div class="subtable-container" style="margin-bottom: 12px;">
                    <div class="subtable-header">
                        <h3 class="subtable-title">Summary</h3>
                    </div>
                    <div style="padding: 12px;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                            <span style="font-size: 12px; color: #6b7280;">Total Hours:</span>
                            <span id="total-hours" style="font-size: 14px; font-weight: 700; color: #111827;">0.00h</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                            <span style="font-size: 12px; color: #6b7280;">Billable:</span>
                            <span id="billable-hours" style="font-size: 14px; font-weight: 700; color: var(--success);">0.00h</span>
                        </div>
                        <div style="display: flex; justify-content: space-between;">
                            <span style="font-size: 12px; color: #6b7280;">Non-billable:</span>
                            <span id="non-billable-hours" style="font-size: 14px; font-weight: 700; color: #6b7280;">0.00h</span>
                        </div>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="subtable-container">
                    <div style="padding: 12px; display: flex; flex-direction: column; gap: 8px;">
                        <button type="submit" class="btn-compact btn-success-compact" style="width: 100%; justify-content: center;">
                            <i class="bi bi-save"></i>
                            Update Timesheet
                        </button>
                        <a href="{% url 'project:timesheet_detail' timesheet.id %}" class="btn-compact btn-secondary-compact" style="width: 100%; justify-content: center; text-decoration: none;">
                            <i class="bi bi-x"></i>
                            Cancel
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <!-- Hidden input for time entries -->
        <input type="hidden" name="time_entries" id="time_entries" value="[]">
    </form>
</div>

<script>
// Load existing time entries
let timeEntries = [
    {% for entry in entries %}
    {
        id: {{ entry.id }},
        activity_date: '{{ entry.activity_date|date:"Y-m-d" }}',
        project: {{ entry.project.id|default:"null" }},
        project_name: '{{ entry.project.project_name|default:"-"|escapejs }}',
        hours: {{ entry.hours }},
        is_billable: {{ entry.is_billable|yesno:"true,false" }},
        description: '{{ entry.description|default:""|escapejs }}'
    }{% if not forloop.last %},{% endif %}
    {% endfor %}
];

// Auto-calculate end date when start date changes
document.getElementById('id_start_date').addEventListener('change', function() {
    const startDate = new Date(this.value);
    if (startDate) {
        // Add 6 days to get end of week
        const endDate = new Date(startDate);
        endDate.setDate(startDate.getDate() + 6);

        // Format date as YYYY-MM-DD
        const formattedDate = endDate.toISOString().split('T')[0];
        document.getElementById('id_end_date').value = formattedDate;
    }

    // Update entry date range
    updateEntryDateRange();
});

// Validate date range
document.getElementById('id_end_date').addEventListener('change', function() {
    const startDate = new Date(document.getElementById('id_start_date').value);
    const endDate = new Date(this.value);

    if (startDate && endDate && endDate < startDate) {
        alert('End date cannot be earlier than start date');
        this.value = '';
    }

    // Update entry date range
    updateEntryDateRange();
});

function updateEntryDateRange() {
    const startDate = document.getElementById('id_start_date').value;
    const endDate = document.getElementById('id_end_date').value;
    const entryDate = document.getElementById('entry-date');

    if (startDate) {
        entryDate.setAttribute('min', startDate);
    }
    if (endDate) {
        entryDate.setAttribute('max', endDate);
    }
}

function addEntry() {
    const date = document.getElementById('entry-date').value;
    const projectSelect = document.getElementById('entry-project');
    const projectId = projectSelect.value;
    const projectName = projectSelect.options[projectSelect.selectedIndex].text;
    const hours = parseFloat(document.getElementById('entry-hours').value);
    const isBillable = document.getElementById('entry-billable').value === 'true';
    const description = document.getElementById('entry-description').value;

    // Validate
    if (!date || !projectId || !hours) {
        alert('Please fill in Date, Project, and Hours');
        return;
    }

    // Add to array
    const entry = {
        activity_date: date,
        project: projectId,
        project_name: projectName,
        hours: hours,
        is_billable: isBillable,
        description: description
    };

    timeEntries.push(entry);

    // Update hidden input
    document.getElementById('time_entries').value = JSON.stringify(timeEntries);

    // Reset form
    document.getElementById('entry-date').value = '';
    document.getElementById('entry-project').value = '';
    document.getElementById('entry-hours').value = '';
    document.getElementById('entry-billable').value = 'true';
    document.getElementById('entry-description').value = '';

    // Render table
    renderEntriesTable();
    updateSummary();
}

function removeEntry(index) {
    if (confirm('Remove this entry?')) {
        timeEntries.splice(index, 1);
        document.getElementById('time_entries').value = JSON.stringify(timeEntries);
        renderEntriesTable();
        updateSummary();
    }
}

function renderEntriesTable() {
    const tbody = document.getElementById('entries-tbody');
    const count = document.getElementById('entries-count');
    const inputRow = tbody.querySelector('tr[style*="background: var(--bg-gray)"]');

    count.textContent = timeEntries.length;

    // Remove all existing entry rows (keep the input row)
    const rows = tbody.querySelectorAll('tr:not([style*="background: var(--bg-gray)"])');
    rows.forEach(row => row.remove());

    // Add entry rows before the input row
    timeEntries.forEach((entry, index) => {
        const date = new Date(entry.activity_date);
        const dateStr = date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        const dayStr = date.toLocaleDateString('en-US', { weekday: 'short' });

        const row = document.createElement('tr');
        row.innerHTML = `
            <td>
                <div style="font-weight: 600;">${dateStr}</div>
                <div style="font-size: 10px; color: #9ca3af;">${dayStr}</div>
            </td>
            <td>
                <div style="font-weight: 600;">${entry.project_name}</div>
            </td>
            <td class="text-end">
                <span style="font-weight: 700;">${entry.hours.toFixed(2)}</span>
            </td>
            <td>
                ${entry.is_billable
                    ? '<span class="badge-compact badge-approved">Yes</span>'
                    : '<span class="badge-compact badge-draft">No</span>'}
            </td>
            <td>
                <div style="max-width: 250px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                    ${entry.description || '-'}
                </div>
            </td>
            <td>
                <button type="button" class="btn-icon-sm danger" title="Delete" onclick="removeEntry(${index})">
                    <i class="bi bi-trash"></i>
                </button>
            </td>
        `;
        tbody.insertBefore(row, inputRow);
    });
}

function updateSummary() {
    let totalHours = 0;
    let billableHours = 0;
    let nonBillableHours = 0;

    timeEntries.forEach(entry => {
        totalHours += entry.hours;
        if (entry.is_billable) {
            billableHours += entry.hours;
        } else {
            nonBillableHours += entry.hours;
        }
    });

    document.getElementById('total-hours').textContent = totalHours.toFixed(2) + 'h';
    document.getElementById('billable-hours').textContent = billableHours.toFixed(2) + 'h';
    document.getElementById('non-billable-hours').textContent = nonBillableHours.toFixed(2) + 'h';
}

// Initialize date range on page load
updateEntryDateRange();

// Load existing entries into the UI
document.getElementById('time_entries').value = JSON.stringify(timeEntries);
renderEntriesTable();
updateSummary();
</script>
{% endblock %}