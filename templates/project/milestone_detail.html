{% extends 'base.html' %}

{% block title %}{{ milestone.milestone_name }} - Milestone Details{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header -->
    <div class="mb-4">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="{% url 'project:milestone_list' %}">Milestones</a></li>
                <li class="breadcrumb-item"><a href="{% url 'project:project_detail' milestone.project.id %}">{{ milestone.project.project_name }}</a></li>
                <li class="breadcrumb-item active">{{ milestone.milestone_name }}</li>
            </ol>
        </nav>

        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h2 class="fw-bold text-dark-emphasis mb-2">{{ milestone.milestone_name }}</h2>
                <div class="d-flex align-items-center gap-3 mb-2">
                    <span class="status-badge status-{{ milestone.status }}">{{ milestone.get_status_display }}</span>
                    <span class="badge bg-{{ milestone.milestone_type }} bg-opacity-20 text-{{ milestone.milestone_type }}">
                        {{ milestone.get_milestone_type_display }}
                    </span>
                    {% if milestone.is_overdue %}
                    <span class="badge bg-danger">
                        <i class="bi bi-exclamation-triangle"></i> Overdue
                    </span>
                    {% elif milestone.is_critical %}
                    <span class="badge bg-warning">
                        <i class="bi bi-clock"></i> Critical
                    </span>
                    {% endif %}
                </div>
            </div>

            <div class="d-flex gap-2">
                {% if milestone.status != 'completed' %}
                <button type="button" class="btn-success-modern" onclick="markCompleted()">
                    <i class="bi bi-check-circle"></i> Mark Completed
                </button>
                {% endif %}
                {% if milestone.requires_approval and milestone.status == 'completed' and not milestone.approved_by %}
                <form method="post" action="{% url 'project:milestone_approve' milestone.id %}" style="display: inline;">
                    {% csrf_token %}
                    <button type="submit" class="btn-warning-modern">
                        <i class="bi bi-shield-check"></i> Approve
                    </button>
                </form>
                {% endif %}
                <a href="{% url 'project:milestone_edit' milestone.id %}" class="btn-outline-modern">
                    <i class="bi bi-pencil"></i> Edit
                </a>
                <button type="button" class="btn-danger-modern" onclick="confirmDelete()">
                    <i class="bi bi-trash"></i> Delete
                </button>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Main Content -->
        <div class="col-md-8 mb-4">
            <!-- Progress Card -->
            <div class="card mb-4">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col-md-6">
                            <h6 class="card-title mb-2">Completion Progress</h6>
                            <div class="progress mb-2" style="height: 12px;">
                                <div class="progress-bar bg-{{ milestone.progress_color }}"
                                     role="progressbar"
                                     style="width: {{ milestone.completion_percentage }}%">
                                </div>
                            </div>
                            <div class="small text-muted">{{ milestone.completion_percentage|floatformat:1 }}% Complete</div>
                        </div>
                        <div class="col-md-6">
                            <div class="text-center">
                                <div class="h4 text-{{ milestone.progress_color }}">{{ milestone.completion_percentage|floatformat:0 }}%</div>
                                <div class="small text-muted">Progress</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Description -->
            {% if milestone.description %}
            <div class="card mb-4">
                <div class="card-header">
                    <h6 class="card-title mb-0">Description</h6>
                </div>
                <div class="card-body">
                    <p class="mb-0">{{ milestone.description|linebreaks }}</p>
                </div>
            </div>
            {% endif %}

            <!-- Deliverables -->
            {% if milestone.deliverables %}
            <div class="card mb-4">
                <div class="card-header">
                    <h6 class="card-title mb-0">
                        <i class="bi bi-list-check"></i> Deliverables
                    </h6>
                </div>
                <div class="card-body">
                    <div class="text-break">{{ milestone.deliverables|linebreaks }}</div>
                </div>
            </div>
            {% endif %}

            <!-- Acceptance Criteria -->
            {% if milestone.acceptance_criteria %}
            <div class="card mb-4">
                <div class="card-header">
                    <h6 class="card-title mb-0">
                        <i class="bi bi-check-square"></i> Acceptance Criteria
                    </h6>
                </div>
                <div class="card-body">
                    <div class="text-break">{{ milestone.acceptance_criteria|linebreaks }}</div>
                </div>
            </div>
            {% endif %}

            <!-- Dependencies -->
            {% if milestone.depends_on_milestones.exists or dependent_milestones %}
            <div class="card">
                <div class="card-header">
                    <h6 class="card-title mb-0">
                        <i class="bi bi-diagram-2"></i> Dependencies
                    </h6>
                </div>
                <div class="card-body">
                    {% if blocking_dependencies %}
                    <div class="mb-3">
                        <h6 class="text-danger">
                            <i class="bi bi-exclamation-triangle"></i> Blocking Dependencies
                        </h6>
                        <p class="small text-muted">These milestones must be completed first:</p>
                        {% for dep in blocking_dependencies %}
                        <div class="alert alert-warning py-2 mb-2">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <strong>{{ dep.milestone_name }}</strong>
                                    <div class="small">{{ dep.project.project_name }}</div>
                                </div>
                                <span class="status-badge status-{{ dep.status }}">{{ dep.get_status_display }}</span>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% endif %}

                    {% if dependent_milestones %}
                    <div>
                        <h6 class="text-info">
                            <i class="bi bi-arrow-right-circle"></i> Dependent Milestones
                        </h6>
                        <p class="small text-muted">These milestones depend on this one:</p>
                        {% for dep in dependent_milestones %}
                        <div class="d-flex justify-content-between align-items-center border-bottom py-2">
                            <div>
                                <strong>{{ dep.milestone_name }}</strong>
                                <div class="small text-muted">{{ dep.project.project_name }}</div>
                            </div>
                            <span class="status-badge status-{{ dep.status }}">{{ dep.get_status_display }}</span>
                        </div>
                        {% endfor %}
                    </div>
                    {% endif %}
                </div>
            </div>
            {% endif %}
        </div>

        <!-- Sidebar -->
        <div class="col-md-4">
            <!-- Key Information -->
            <div class="card mb-3">
                <div class="card-header">
                    <h6 class="card-title mb-0">Milestone Details</h6>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label class="form-label small text-muted">Project</label>
                        <div>
                            <a href="{% url 'project:project_detail' milestone.project.id %}" class="text-decoration-none fw-medium">
                                {{ milestone.project.project_name }}
                            </a>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label small text-muted">Due Date</label>
                        <div class="d-flex align-items-center">
                            <div class="fw-medium">{{ milestone.milestone_date|date:"F d, Y" }}</div>
                            {% if milestone.is_overdue %}
                            <span class="badge bg-danger ms-2">Overdue</span>
                            {% elif milestone.is_critical %}
                            <span class="badge bg-warning ms-2">Critical</span>
                            {% endif %}
                        </div>
                        {% if milestone.days_until_due %}
                        <div class="small text-muted">
                            {% if milestone.days_until_due > 0 %}
                            {{ milestone.days_until_due }} days remaining
                            {% elif milestone.days_until_due == 0 %}
                            Due today
                            {% else %}
                            {{ milestone.days_until_due|add:"-1" }} days overdue
                            {% endif %}
                        </div>
                        {% endif %}
                    </div>

                    {% if milestone.task %}
                    <div class="mb-3">
                        <label class="form-label small text-muted">Linked Task</label>
                        <div>
                            <a href="{% url 'project:task_detail' milestone.task.id %}" class="text-decoration-none">
                                {{ milestone.task.task_name }}
                            </a>
                        </div>
                    </div>
                    {% endif %}

                    {% if milestone.amount %}
                    <div class="mb-3">
                        <label class="form-label small text-muted">Amount</label>
                        <div class="fw-medium text-success">
                            ${{ milestone.amount|floatformat:2 }}
                            {% if milestone.is_billable %}
                            <span class="badge bg-success bg-opacity-20 text-success ms-1">Billable</span>
                            {% endif %}
                        </div>
                    </div>
                    {% endif %}

                    <div class="mb-3">
                        <label class="form-label small text-muted">Created</label>
                        <div>{{ milestone.created_at|date:"M d, Y" }}</div>
                        {% if milestone.created_by %}
                        <div class="small text-muted">by {{ milestone.created_by.get_full_name|default:milestone.created_by.username }}</div>
                        {% endif %}
                    </div>

                    {% if milestone.completed_date %}
                    <div class="mb-3">
                        <label class="form-label small text-muted">Completed</label>
                        <div>{{ milestone.completed_date|date:"M d, Y" }}</div>
                        {% if milestone.completed_by %}
                        <div class="small text-muted">by {{ milestone.completed_by.full_name }}</div>
                        {% endif %}
                    </div>
                    {% endif %}

                    {% if milestone.approved_by %}
                    <div class="mb-0">
                        <label class="form-label small text-muted">Approved</label>
                        <div class="text-success">
                            <i class="bi bi-check-circle"></i> {{ milestone.approved_date|date:"M d, Y" }}
                        </div>
                        <div class="small text-muted">by {{ milestone.approved_by.full_name }}</div>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="card">
                <div class="card-header">
                    <h6 class="card-title mb-0">Quick Actions</h6>
                </div>
                <div class="card-body">
                    {% if milestone.status != 'completed' %}
                    <div class="mb-2">
                        <label class="form-label small">Update Progress</label>
                        <form method="post" action="{% url 'project:milestone_update_status' milestone.id %}">
                            {% csrf_token %}
                            <div class="input-group mb-2">
                                <input type="number" name="completion_percentage" class="form-control form-control-sm"
                                       min="0" max="100" value="{{ milestone.completion_percentage|floatformat:0 }}"
                                       placeholder="Progress %">
                                <button type="submit" class="btn btn-outline-primary btn-sm">Update</button>
                            </div>
                        </form>
                    </div>
                    {% endif %}

                    <div class="d-grid gap-2">
                        {% if milestone.project %}
                        <a href="{% url 'project:project_detail' milestone.project.id %}" class="btn btn-outline-primary btn-sm">
                            <i class="bi bi-folder"></i> View Project
                        </a>
                        {% endif %}
                        {% if milestone.task %}
                        <a href="{% url 'project:task_detail' milestone.task.id %}" class="btn btn-outline-info btn-sm">
                            <i class="bi bi-check-square"></i> View Task
                        </a>
                        {% endif %}
                        <a href="{% url 'project:milestone_list' %}?project={{ milestone.project.id }}" class="btn btn-outline-secondary btn-sm">
                            <i class="bi bi-list"></i> Project Milestones
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1">
    <div class="modal-dialog modal-sm">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Delete Milestone</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete this milestone?</p>
                <p class="small text-danger">This action cannot be undone.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Cancel</button>
                <form method="post" action="{% url 'project:milestone_delete' milestone.id %}" style="display: inline;">
                    {% csrf_token %}
                    <input type="hidden" name="_method" value="DELETE">
                    <button type="submit" class="btn btn-danger btn-sm">Delete Milestone</button>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
function confirmDelete() {
    const modal = new bootstrap.Modal(document.getElementById('deleteModal'));
    modal.show();
}

function markCompleted() {
    if (confirm('Are you sure you want to mark this milestone as completed?')) {
        fetch('{% url "project:milestone_update_status" milestone.id %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: 'status=completed&completion_percentage=100'
        })
        .then(() => {
            location.reload();
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Failed to update milestone status');
        });
    }
}
</script>

<style>
.status-badge {
    padding: 4px 8px;
    border-radius: 12px;
    font-size: 10px;
    font-weight: 600;
    text-transform: uppercase;
}

.status-pending { background-color: #fef3c7; color: #92400e; }
.status-in_progress { background-color: #dbeafe; color: #1e40af; }
.status-completed { background-color: #dcfce7; color: #166534; }
.status-overdue { background-color: #fee2e2; color: #dc2626; }
.status-cancelled { background-color: #f3f4f6; color: #6b7280; }

.bg-deliverable { background-color: #3b82f6; }
.bg-payment { background-color: #10b981; }
.bg-review { background-color: #f59e0b; }
.bg-approval { background-color: #8b5cf6; }
.bg-launch { background-color: #ef4444; }
.bg-testing { background-color: #06b6d4; }
.bg-other { background-color: #6b7280; }

.text-deliverable { color: #3b82f6; }
.text-payment { color: #10b981; }
.text-review { color: #f59e0b; }
.text-approval { color: #8b5cf6; }
.text-launch { color: #ef4444; }
.text-testing { color: #06b6d4; }
.text-other { color: #6b7280; }
</style>
{% endblock %}