<!-- Project Team Tab - Subtable Design -->
<style>
    /* Subtable Design Variables */
    :root {
        --primary: #3b82f6;
        --success: #10b981;
        --danger: #ef4444;
        --border: #e5e7eb;
        --bg-gray: #f9fafb;
    }

    /* Subtable Container */
    .subtable-container {
        background: white;
        border: 1px solid var(--border);
        border-radius: 6px;
        overflow: visible;
    }

    .subtable-header {
        background: var(--bg-gray);
        padding: 8px 10px;
        border-bottom: 1px solid var(--border);
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .subtable-title {
        font-size: 13px;
        font-weight: 600;
        color: #111827;
        margin: 0;
    }

    .subtable-count {
        font-size: 11px;
        color: #6b7280;
    }

    .subtable {
        width: 100%;
        margin: 0;
        font-size: 12px;
        border-collapse: collapse;
        table-layout: fixed;
    }

    .subtable thead th {
        background: var(--bg-gray);
        padding: 6px 8px;
        font-size: 10px;
        font-weight: 600;
        color: #6b7280;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        border-bottom: 1px solid var(--border);
        text-align: left;
        white-space: nowrap;
    }

    .subtable tbody td {
        padding: 6px 8px;
        border-bottom: 1px solid #f3f4f6;
        color: #111827;
        vertical-align: middle;
    }

    .subtable tbody tr:last-child td {
        border-bottom: none;
    }

    .subtable tbody tr:hover {
        background: #f9fafb;
    }

    /* Inline Form Controls */
    .form-control-inline {
        width: 100%;
        padding: 5px 8px;
        font-size: 12px;
        border: 1px solid var(--border);
        border-radius: 4px;
        background: white;
        height: 30px;
    }

    .form-control-inline:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.1);
    }

    .form-control-inline.error {
        border-color: var(--danger);
        background-color: #fef2f2;
    }

    .form-control-inline.error:focus {
        box-shadow: 0 0 0 2px rgba(239, 68, 68, 0.1);
    }

    .field-error {
        color: var(--danger);
        font-size: 10px;
        margin-top: 2px;
        display: none;
    }

    .field-error.show {
        display: block;
    }

    input[type="number"].form-control-inline {
        text-align: right;
    }

    /* New member row */
    .new-member-row {
        background-color: #f0fdf4;
    }

    /* Compact Buttons */
    .btn-compact {
        display: inline-flex;
        align-items: center;
        gap: 4px;
        padding: 5px 10px;
        font-size: 12px;
        font-weight: 500;
        border-radius: 4px;
        text-decoration: none;
        transition: all 0.15s;
        border: 1px solid;
        cursor: pointer;
    }

    .btn-primary-compact {
        background: var(--primary);
        color: white;
        border-color: var(--primary);
    }

    .btn-primary-compact:hover {
        background: #2563eb;
        color: white;
    }

    /* Icon Buttons */
    .btn-icon-sm {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 24px;
        height: 24px;
        padding: 0;
        border-radius: 4px;
        border: 1px solid var(--border);
        background: white;
        color: #6b7280;
        cursor: pointer;
        transition: all 0.15s;
        font-size: 11px;
    }

    .btn-icon-sm:hover {
        background: var(--bg-gray);
        border-color: #d1d5db;
        color: #111827;
    }

    .btn-icon-sm.danger {
        color: var(--danger);
    }

    .btn-icon-sm.danger:hover {
        background: #fee2e2;
        border-color: var(--danger);
    }

    .btn-icon-sm.success {
        background: var(--success);
        color: white;
        border-color: var(--success);
    }

    .btn-icon-sm.success:hover {
        background: #059669;
    }

    /* Avatar */
    .avatar-cell {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
    }

    .avatar-sm {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        background: var(--primary);
        color: white;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        font-size: 0.75rem;
        font-weight: 600;
    }

    /* Autocomplete */
    .autocomplete-container {
        position: relative;
        width: 100%;
    }

    .autocomplete-dropdown {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: white;
        border: 1px solid var(--border);
        border-top: none;
        max-height: 250px;
        overflow-y: auto;
        z-index: 1000;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        display: none;
    }

    .autocomplete-dropdown.show {
        display: block;
    }

    .autocomplete-item {
        padding: 0.5rem 0.75rem;
        cursor: pointer;
        border-bottom: 1px solid #f3f4f6;
    }

    .autocomplete-item:hover,
    .autocomplete-item.selected {
        background: var(--bg-gray);
    }

    .autocomplete-item-name {
        font-weight: 500;
        font-size: 0.875rem;
    }

    .autocomplete-item-email {
        font-size: 0.75rem;
        color: #6b7280;
    }

    .autocomplete-no-results {
        padding: 0.75rem;
        text-align: center;
        color: #9ca3af;
        font-size: 0.875rem;
    }

    /* Saving Indicator */
    .saving-indicator {
        display: none;
        position: fixed;
        bottom: 20px;
        right: 20px;
        background: #1a1a1a;
        color: white;
        padding: 8px 16px;
        border-radius: 6px;
        font-size: 0.875rem;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        z-index: 1000;
    }

    .saving-indicator.show {
        display: block;
        animation: fadeIn 0.2s;
    }

    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }

    @keyframes rotate {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
    }

    /* Empty State */
    .empty-state-compact {
        text-align: center;
        padding: 30px 20px;
        color: #6b7280;
    }

    .empty-state-compact i {
        font-size: 40px;
        color: #d1d5db;
        margin-bottom: 8px;
    }

    .empty-state-compact h3 {
        font-size: 14px;
        font-weight: 600;
        color: #111827;
        margin: 0 0 4px 0;
    }

    .empty-state-compact p {
        font-size: 12px;
        margin: 0;
    }
    /* Action Buttons */
    .btn-icon-compact {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 25px;
        height: 25px;
        padding: 0;
        border-radius: 10px;
        border: 1px solid #e5e7eb;
        background: white;
        color: #6b7280;
        cursor: pointer;
        transition: all 0.15s;
    }

    .btn-icon-compact:hover {
        background: #f9fafb;
        border-color: #d1d5db;
        color: #111827;
    }

    .btn-icon-compact.success {
        color: var(--success);
        border-color: var(--success);
    }

    .btn-icon-compact.success:hover {
        background: #d1fae5;
    }

    .btn-icon-compact.danger {
        color: var(--danger);
        border-color: var(--danger);
    }

    .btn-icon-compact.danger:hover {
        background: #fee2e2;
    }

    .btn-icon-compact.warning {
        color: var(--warning);
        border-color: var(--warning);
    }

    .btn-icon-compact.warning:hover {
        background: #f7e2be;
    }
    .btn-icon-compact.primary {
        color: var(--primary);
        border-color: var(--primary);
    }

    .btn-icon-compact.primary:hover {
        background: #c8daf7;
    }
</style>

<div class="team-content">
    <!-- Subtable Container -->
    <div class="subtable-container">
        <div class="subtable-header">
            <h3 class="subtable-title">Team Members</h3>
            <button type="button" id="add-member-btn" class="button-min-primary py-1">
                <div>
                    <i class="bi bi-plus"></i>
                    <span>
                        Add
                    </span>
                </div>
            </button>
        </div>
        <div class="card">
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead class="table-light">
                            <tr>
                                <th style="width: 20%;">Employee</th>
                                <th style="width: 12%;">Role</th>
                                <th style="width: 12%;">Pay Type</th>
                                <th style="width: 12%;">Daily Rate (USD)</th>
                                <th style="width: 10%;">Multiplier</th>
                                <th style="width: 11%;">Start Date</th>
                                <th style="width: 11%;">End Date</th>
                                <th style="width: 6%;"></th>
                            </tr>
                        </thead>
                        <tbody id="team-table-body">
                            <!-- New member rows will be inserted here dynamically -->

                            <!-- Existing Team Members -->
                            {% if project.team_members.exists %}
                                {% for member in project.team_members.all %}
                                <tr class="team-member-row"
                                    id="member-{{ member.id }}"
                                    data-member-id="{{ member.id }}">
                                    <td>
                                        <div class="avatar-cell">
                                            <span class="avatar-sm">{{ member.employee.get_full_name|slice:":2"|upper }}</span>
                                            <div>
                                                <div style="font-weight: 500; font-size: 12px;">{{ member.employee.get_full_name }}</div>
                                                <small style="font-size: 10px; color: #6b7280;">{% if member.employee.email %}{{ member.employee.email }}{% elif member.employee.user %}{{ member.employee.user.email }}{% endif %}</small>
                                            </div>
                                        </div>
                                    </td>
                                    <td>
                                        <input type="text"
                                            class="form-control-inline"
                                            value="{{ member.role|default:'Team Member' }}"
                                            placeholder="Role"
                                            data-field="role"
                                            data-member-id="{{ member.id }}">
                                    </td>
                                    <td>
                                        <select class="form-control-inline"
                                                data-field="pay_type"
                                                data-member-id="{{ member.id }}">
                                            <option value="Normal" {% if member.pay_type == 'Normal' %}selected{% endif %}>Normal</option>
                                            <option value="PH" {% if member.pay_type == 'PH' %}selected{% endif %}>PH</option>
                                            <option value="OT" {% if member.pay_type == 'OT' %}selected{% endif %}>OT</option>
                                            <option value="Weekend" {% if member.pay_type == 'Weekend' %}selected{% endif %}>Weekend</option>
                                        </select>
                                    </td>
                                    <td>
                                        <input type="number"
                                            class="form-control-inline"
                                            value="{{ member.daily_rate_usd|default:'' }}"
                                            min="0"
                                            step="0.01"
                                            placeholder="0.00"
                                            data-field="daily_rate_usd"
                                            data-member-id="{{ member.id }}">
                                    </td>
                                    <td>
                                        <input type="number"
                                            class="form-control-inline"
                                            value="{{ member.multiplier|default:'1.0' }}"
                                            min="0"
                                            step="0.1"
                                            placeholder="1.0"
                                            data-field="multiplier"
                                            data-member-id="{{ member.id }}">
                                    </td>
                                    <td>
                                        <input type="date"
                                            class="form-control-inline"
                                            value="{{ member.start_date|date:'Y-m-d'|default:'' }}"
                                            data-field="start_date"
                                            data-member-id="{{ member.id }}">
                                    </td>
                                    <td>
                                        <input type="date"
                                            class="form-control-inline"
                                            value="{{ member.end_date|date:'Y-m-d'|default:'' }}"
                                            data-field="end_date"
                                            data-member-id="{{ member.id }}">
                                    </td>
                                    <td>
                                        <button type="button" class="btn-icon-sm danger delete-member-btn"
                                                title="Remove member"
                                                data-member-id="{{ member.id }}">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </td>
                                </tr>
                                {% endfor %}
                            {% else %}
                                <tr id="no-members-row">
                                    <td colspan="8">
                                        <div class="empty-state-compact">
                                            <i class="bi bi-people"></i>
                                            <h3>No team members yet</h3>
                                            <p>Click "Add Member" button to add your first team member.</p>
                                        </div>
                                    </td>
                                </tr>
                            {% endif %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Saving Indicator -->
<div id="team-saving-indicator" class="saving-indicator">
    <svg class="spinner" width="14" height="14" viewBox="0 0 50 50" style="display: inline-block; margin-right: 8px; animation: rotate 1s linear infinite;">
        <circle cx="25" cy="25" r="20" fill="none" stroke="white" stroke-width="5" stroke-dasharray="80" stroke-dashoffset="60"></circle>
    </svg>
    Saving...
</div>

<style>
    @keyframes rotate {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
    }
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const addMemberBtn = document.getElementById('add-member-btn');
    const savingIndicator = document.getElementById('team-saving-indicator');
    const noMembersRow = document.getElementById('no-members-row');
    const tbody = document.getElementById('team-table-body');

    let newRowCounter = 0;

    // Get CSRF token
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value || '{{ csrf_token }}';

    // Available employees for dropdown (all employees minus current members)
    const availableEmployees = [
        {% for employee in available_employees %}
        {
            id: '{{ employee.id }}',
            name: '{{ employee.get_full_name }}',
            email: '{% if employee.email %}{{ employee.email }}{% elif employee.user %}{{ employee.user.email }}{% endif %}',
            initials: '{{ employee.get_full_name|slice:":2"|upper }}'
        },
        {% endfor %}
    ];

    // Show saving indicator
    function showSaving() {
        savingIndicator.classList.add('show');
    }

    function hideSaving() {
        setTimeout(() => {
            savingIndicator.classList.remove('show');
        }, 500);
    }

    // Create new team member row HTML
    function createNewMemberRow() {
        const rowId = `new-member-row-${++newRowCounter}`;

        // Get today's date in YYYY-MM-DD format
        const today = new Date().toISOString().split('T')[0];

        return `
            <tr id="${rowId}" class="new-member-row" data-new-row="true">
                <td>
                    <div class="autocomplete-container" data-row-id="${rowId}">
                        <input type="text"
                               class="form-control-inline autocomplete-input new-member-employee"
                               placeholder="Type to search employee..."
                               autocomplete="off"
                               data-row-id="${rowId}">
                        <input type="hidden" class="new-member-employee-id" data-row-id="${rowId}">
                        <div class="autocomplete-dropdown" data-row-id="${rowId}"></div>
                    </div>
                </td>
                <td>
                    <input type="text"
                           class="form-control-inline new-member-role"
                           placeholder="Team Member"
                           value="Team Member"
                           data-row-id="${rowId}">
                </td>
                <td>
                    <select class="form-control-inline new-member-pay-type"
                            data-row-id="${rowId}">
                        <option value="Normal">Normal</option>
                        <option value="PH">PH</option>
                        <option value="OT">OT</option>
                        <option value="Weekend">Weekend</option>
                    </select>
                </td>
                <td>
                    <input type="number"
                           class="form-control-inline new-member-daily-rate"
                           placeholder="0.00"
                           min="0"
                           step="0.01"
                           data-row-id="${rowId}">
                </td>
                <td>
                    <input type="number"
                           class="form-control-inline new-member-multiplier"
                           placeholder="1.0"
                           min="0"
                           step="0.1"
                           value="1.0"
                           data-row-id="${rowId}">
                </td>
                <td>
                    <input type="date"
                           class="form-control-inline new-member-start-date"
                           value="${today}"
                           data-row-id="${rowId}">
                </td>
                <td>
                    <input type="date"
                           class="form-control-inline new-member-end-date"
                           value="${today}"
                           data-row-id="${rowId}">
                </td>
                <td style="display: flex; gap: 4px;">
                    <button type="button" class="btn-icon-compact success" title="Save member" data-row-id="${rowId}">
                        <i class="bi bi-check"></i>
                    </button>
                    <button type="button" class="btn-icon-compact danger" title="Cancel" data-row-id="${rowId}">
                        <i class="bi bi-x"></i>
                    </button>
                </td>
            </tr>
        `;
    }

    // Autocomplete functionality
    function setupAutocomplete(row) {
        const input = row.querySelector('.autocomplete-input');
        const hiddenInput = row.querySelector('.new-member-employee-id');
        const dropdown = row.querySelector('.autocomplete-dropdown');
        let selectedIndex = -1;

        // Show dropdown on focus
        input.addEventListener('focus', function() {
            filterEmployees('');
        });

        // Filter on input
        input.addEventListener('input', function() {
            const query = this.value;
            hiddenInput.value = ''; // Clear selection when typing
            filterEmployees(query);
        });

        // Keyboard navigation
        input.addEventListener('keydown', function(e) {
            const items = dropdown.querySelectorAll('.autocomplete-item');

            if (e.key === 'ArrowDown') {
                e.preventDefault();
                selectedIndex = Math.min(selectedIndex + 1, items.length - 1);
                updateSelection(items);
            } else if (e.key === 'ArrowUp') {
                e.preventDefault();
                selectedIndex = Math.max(selectedIndex - 1, -1);
                updateSelection(items);
            } else if (e.key === 'Enter') {
                e.preventDefault();
                if (selectedIndex >= 0 && items[selectedIndex]) {
                    items[selectedIndex].click();
                }
            } else if (e.key === 'Escape') {
                dropdown.classList.remove('show');
                selectedIndex = -1;
            }
        });

        // Close dropdown when clicking outside
        document.addEventListener('click', function(e) {
            if (!row.contains(e.target)) {
                dropdown.classList.remove('show');
                selectedIndex = -1;
            }
        });

        function filterEmployees(query) {
            query = query.toLowerCase();
            const filtered = availableEmployees.filter(emp =>
                emp.name.toLowerCase().includes(query) ||
                emp.email.toLowerCase().includes(query)
            );

            if (filtered.length === 0) {
                dropdown.innerHTML = '<div class="autocomplete-no-results">No employees found</div>';
            } else {
                dropdown.innerHTML = filtered.map((emp, index) => `
                    <div class="autocomplete-item" data-employee-id="${emp.id}" data-index="${index}">
                        <div class="autocomplete-item-name">${emp.name}</div>
                        <div class="autocomplete-item-email">${emp.email}</div>
                    </div>
                `).join('');

                // Add click handlers
                dropdown.querySelectorAll('.autocomplete-item').forEach(item => {
                    item.addEventListener('click', function() {
                        const employeeId = this.dataset.employeeId;
                        const employee = availableEmployees.find(e => e.id === employeeId);
                        input.value = employee.name;
                        hiddenInput.value = employeeId;
                        dropdown.classList.remove('show');
                        selectedIndex = -1;
                    });
                });
            }

            dropdown.classList.add('show');
            selectedIndex = -1;
        }

        function updateSelection(items) {
            items.forEach((item, index) => {
                if (index === selectedIndex) {
                    item.classList.add('selected');
                    item.scrollIntoView({ block: 'nearest' });
                } else {
                    item.classList.remove('selected');
                }
            });
        }
    }

    // Add new member row
    addMemberBtn.addEventListener('click', function() {
        if (availableEmployees.length === 0) {
            alert('All employees are already added to this project.');
            return;
        }

        if (noMembersRow) {
            noMembersRow.style.display = 'none';
        }

        // Create and insert new row at the top
        const newRowHtml = createNewMemberRow();
        tbody.insertAdjacentHTML('afterbegin', newRowHtml);

        // Focus on the employee input
        const newRow = tbody.querySelector(`#new-member-row-${newRowCounter}`);
        const employeeInput = newRow.querySelector('.new-member-employee');
        employeeInput.focus();

        // Setup autocomplete and event listeners for this row
        setupAutocomplete(newRow);
        setupNewRowListeners(newRow);
    });

    // Setup listeners for a new row
    function setupNewRowListeners(row) {
        const rowId = row.id;
        const saveBtn = row.querySelector('.save-new-member-btn');
        const cancelBtn = row.querySelector('.cancel-new-member-btn');

        // Save button
        saveBtn.addEventListener('click', function() {
            saveNewMember(row);
        });

        // Cancel button
        cancelBtn.addEventListener('click', function() {
            row.remove();

            // Show no members row if no members exist
            const memberRows = tbody.querySelectorAll('.team-member-row');
            const newRows = tbody.querySelectorAll('[data-new-row="true"]');
            if (memberRows.length === 0 && newRows.length === 0 && noMembersRow) {
                noMembersRow.style.display = '';
            }
        });
    }

    // Validate field
    function validateField(input, errorMsg) {
        const value = input.value.trim();
        let isValid = true;
        let message = '';

        // Clear previous error
        input.classList.remove('error');

        if (!value && errorMsg) {
            isValid = false;
            message = errorMsg;
        }

        // Validate numeric fields
        if (input.type === 'number' && value) {
            const numValue = parseFloat(value);
            if (isNaN(numValue) || numValue < 0) {
                isValid = false;
                message = 'Must be a positive number';
            }
        }

        // Validate date fields
        if (input.type === 'date' && value) {
            const dateValue = new Date(value);
            if (isNaN(dateValue.getTime())) {
                isValid = false;
                message = 'Invalid date';
            }
        }

        if (!isValid) {
            input.classList.add('error');
        }

        return { isValid, message };
    }

    // Show validation error
    function showValidationError(input, message) {
        input.classList.add('error');
        // You can add a tooltip or inline error message here if needed
    }

    // Clear validation error
    function clearValidationError(input) {
        input.classList.remove('error');
    }

    // Save new team member
    function saveNewMember(row) {
        const employeeInput = row.querySelector('.new-member-employee');
        const employeeId = row.querySelector('.new-member-employee-id').value;
        const startDateInput = row.querySelector('.new-member-start-date');
        const endDateInput = row.querySelector('.new-member-end-date');
        const dailyRateInput = row.querySelector('.new-member-daily-rate');
        const multiplierInput = row.querySelector('.new-member-multiplier');

        // Clear all previous errors
        clearValidationError(employeeInput);
        clearValidationError(startDateInput);
        clearValidationError(endDateInput);
        clearValidationError(dailyRateInput);
        clearValidationError(multiplierInput);

        let hasError = false;
        let errorMessage = '';

        // Validate employee selection
        if (!employeeId) {
            showValidationError(employeeInput, 'Employee is required');
            errorMessage = 'Please select an employee from the list';
            hasError = true;
        }

        // Validate dates
        const startDate = startDateInput.value;
        const endDate = endDateInput.value;

        if (startDate && endDate) {
            const start = new Date(startDate);
            const end = new Date(endDate);
            if (end < start) {
                showValidationError(endDateInput, 'End date must be after start date');
                errorMessage = 'End date must be after start date';
                hasError = true;
            }
        }

        // Validate daily rate if provided
        if (dailyRateInput.value) {
            const dailyRate = parseFloat(dailyRateInput.value);
            if (isNaN(dailyRate) || dailyRate < 0) {
                showValidationError(dailyRateInput, 'Invalid daily rate');
                errorMessage = 'Daily rate must be a positive number';
                hasError = true;
            }
        }

        // Validate multiplier
        const multiplier = parseFloat(multiplierInput.value);
        if (isNaN(multiplier) || multiplier < 0) {
            showValidationError(multiplierInput, 'Invalid multiplier');
            errorMessage = 'Multiplier must be a positive number';
            hasError = true;
        }

        if (hasError) {
            alert(errorMessage);
            return;
        }

        const formData = new FormData();
        formData.append('employee_id', employeeId);
        formData.append('role', row.querySelector('.new-member-role').value || 'Team Member');
        formData.append('pay_type', row.querySelector('.new-member-pay-type').value);
        formData.append('daily_rate_usd', row.querySelector('.new-member-daily-rate').value);
        formData.append('multiplier', row.querySelector('.new-member-multiplier').value);
        formData.append('start_date', row.querySelector('.new-member-start-date').value);
        formData.append('end_date', row.querySelector('.new-member-end-date').value);
        formData.append('csrfmiddlewaretoken', csrfToken);

        showSaving();

        fetch('{% url "project:team_member_add_inline" project.id %}', {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrfToken,
                'HX-Request': 'true'
            },
            body: formData
        })
        .then(response => {
            // Clone the response so we can read it multiple times if needed
            const clonedResponse = response.clone();

            if (!response.ok) {
                // Try to parse as JSON first
                return response.json()
                    .then(data => {
                        throw new Error(data.error || `Server error: ${response.status}`);
                    })
                    .catch(err => {
                        // If JSON parsing fails, try text
                        return clonedResponse.text().then(text => {
                            throw new Error(`Server error: ${response.status} - ${text.substring(0, 200)}`);
                        });
                    });
            }

            return response.json();
        })
        .then(data => {
            hideSaving();
            // Reload the page to refresh the team list
            window.location.reload();
        })
        .catch(error => {
            alert('Failed to add team member: ' + error.message);
            hideSaving();
        });
    }

    // Setup inline editing for existing team members
    function setupInlineEditing(row) {
        const memberId = row.dataset.memberId;

        // Text and number inputs
        row.querySelectorAll('input[type="text"], input[type="number"]').forEach(input => {
            input.addEventListener('blur', function() {
                updateMemberField(memberId, this.dataset.field, this.value);
            });

            input.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    this.blur();
                }
            });
        });

        // Date inputs
        row.querySelectorAll('input[type="date"]').forEach(input => {
            input.addEventListener('change', function() {
                updateMemberField(memberId, this.dataset.field, this.value);
            });
        });

        // Select dropdowns
        row.querySelectorAll('select').forEach(select => {
            select.addEventListener('change', function() {
                updateMemberField(memberId, this.dataset.field, this.value);
            });
        });

        // Delete button
        const deleteBtn = row.querySelector('.delete-member-btn');
        if (deleteBtn) {
            deleteBtn.addEventListener('click', function() {
                if (confirm('Are you sure you want to remove this team member from the project?')) {
                    deleteMember(memberId, row);
                }
            });
        }
    }

    // Update member field
    function updateMemberField(memberId, field, value) {
        showSaving();

        const formData = new FormData();
        formData.append(field, value);
        formData.append('csrfmiddlewaretoken', csrfToken);

        fetch(`/project/team-members/${memberId}/update-inline/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrfToken
            },
            body: formData
        })
        .then(response => {
            if (response.ok) {
                hideSaving();
            } else {
                throw new Error('Update failed');
            }
        })
        .catch(error => {
            alert('Failed to update team member. Please try again.');
            hideSaving();
        });
    }

    // Delete member
    function deleteMember(memberId, row) {
        showSaving();

        fetch(`/project/team-members/${memberId}/remove/`, {
            method: 'DELETE',
            headers: {
                'X-CSRFToken': csrfToken
            }
        })
        .then(response => {
            if (response.ok) {
                row.remove();

                // Show no members row if no members left
                const memberRows = document.querySelectorAll('.team-member-row');
                if (memberRows.length === 0 && noMembersRow) {
                    noMembersRow.style.display = '';
                }

                hideSaving();
            } else {
                throw new Error('Delete failed');
            }
        })
        .catch(error => {
            alert('Failed to remove team member. Please try again.');
            hideSaving();
        });
    }

    // Setup inline editing for existing members
    document.querySelectorAll('.team-member-row').forEach(row => {
        setupInlineEditing(row);
    });
});
</script>
