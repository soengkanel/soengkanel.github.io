<tr>
    <td>
        <div>
            <div class="fw-medium mb-1">
                <a href="{% url 'project:milestone_detail' milestone.id %}" class="text-decoration-none">
                    {{ milestone.milestone_name }}
                </a>
            </div>
            {% if milestone.description %}
            <div class="text-muted small">{{ milestone.description|truncatewords:10 }}</div>
            {% endif %}
            {% if milestone.amount %}
            <div class="small text-success">
                <i class="bi bi-currency-dollar"></i> {{ milestone.amount|floatformat:2 }}
                {% if milestone.is_billable %}<span class="badge bg-success bg-opacity-20 text-success ms-1">Billable</span>{% endif %}
            </div>
            {% endif %}
        </div>
    </td>
    <td>
        <div>
            <div class="fw-medium">{{ milestone.project.project_name }}</div>
            <div class="text-muted small">{{ milestone.project.project_code }}</div>
        </div>
    </td>
    <td>
        <span class="badge bg-{{ milestone.milestone_type }} bg-opacity-20 text-{{ milestone.milestone_type }}">
            {{ milestone.get_milestone_type_display }}
        </span>
    </td>
    <td>
        <span class="status-badge status-{{ milestone.status }}">
            {{ milestone.get_status_display }}
        </span>
        {% if milestone.requires_approval and not milestone.approved_by %}
        <div class="small text-warning mt-1">
            <i class="bi bi-shield-check"></i> Requires Approval
        </div>
        {% elif milestone.approved_by %}
        <div class="small text-success mt-1">
            <i class="bi bi-check-circle"></i> Approved
        </div>
        {% endif %}
    </td>
    <td>
        <div class="d-flex align-items-center gap-2">
            <div class="progress" style="width: 60px; height: 8px;">
                <div class="progress-bar bg-{{ milestone.progress_color }}"
                     role="progressbar"
                     style="width: {{ milestone.completion_percentage }}%">
                </div>
            </div>
            <span class="small">{{ milestone.completion_percentage|floatformat:0 }}%</span>
        </div>
    </td>
    <td>
        <div>
            <div class="fw-medium">{{ milestone.milestone_date|date:"M d, Y" }}</div>
            {% if milestone.is_overdue %}
            <div class="small text-danger">
                <i class="bi bi-exclamation-triangle"></i> {{ milestone.days_until_due|add:"-1" }} days overdue
            </div>
            {% elif milestone.is_critical %}
            <div class="small text-warning">
                <i class="bi bi-clock"></i> Due in {{ milestone.days_until_due }} days
            </div>
            {% else %}
            <div class="small text-muted">
                {% if milestone.days_until_due > 0 %}
                {{ milestone.days_until_due }} days remaining
                {% elif milestone.days_until_due == 0 %}
                Due today
                {% endif %}
            </div>
            {% endif %}
        </div>
    </td>
    <td>
        <div class="d-flex gap-1">
            <a href="{% url 'project:milestone_detail' milestone.id %}" class="btn-outline-modern btn-sm">
                <i class="bi bi-eye"></i>
            </a>
            <a href="{% url 'project:milestone_edit' milestone.id %}" class="btn-light-modern btn-sm">
                <i class="bi bi-pencil"></i>
            </a>
            {% if milestone.status != 'completed' %}
            <button type="button" class="btn-success-modern btn-sm"
                    onclick="updateMilestoneStatus('{{ milestone.id }}', 'completed')"
                    title="Mark as completed">
                <i class="bi bi-check"></i>
            </button>
            {% endif %}
            {% if milestone.requires_approval and not milestone.approved_by and milestone.status == 'completed' %}
            <form method="post" action="{% url 'project:milestone_approve' milestone.id %}" style="display: inline;">
                {% csrf_token %}
                <button type="submit" class="btn-warning-modern btn-sm" title="Approve milestone">
                    <i class="bi bi-shield-check"></i>
                </button>
            </form>
            {% endif %}
        </div>
    </td>
</tr>

<script>
function updateMilestoneStatus(milestoneId, status) {
    if (confirm('Are you sure you want to mark this milestone as ' + status + '?')) {
        fetch(`/project/milestones/${milestoneId}/status/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: `status=${status}&completion_percentage=100`
        })
        .then(response => response.text())
        .then(html => {
            document.querySelector(`tr:has(a[href*="${milestoneId}"])`).outerHTML = html;
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Failed to update milestone status');
        });
    }
}
</script>

<style>
.status-badge {
    padding: 4px 8px;
    border-radius: 12px;
    font-size: 10px;
    font-weight: 600;
    text-transform: uppercase;
}

.status-pending { background-color: #fef3c7; color: #92400e; }
.status-in_progress { background-color: #dbeafe; color: #1e40af; }
.status-completed { background-color: #dcfce7; color: #166534; }
.status-overdue { background-color: #fee2e2; color: #dc2626; }
.status-cancelled { background-color: #f3f4f6; color: #6b7280; }

.bg-deliverable { background-color: #3b82f6; }
.bg-payment { background-color: #10b981; }
.bg-review { background-color: #f59e0b; }
.bg-approval { background-color: #8b5cf6; }
.bg-launch { background-color: #ef4444; }
.bg-testing { background-color: #06b6d4; }
.bg-other { background-color: #6b7280; }

.text-deliverable { color: #3b82f6; }
.text-payment { color: #10b981; }
.text-review { color: #f59e0b; }
.text-approval { color: #8b5cf6; }
.text-launch { color: #ef4444; }
.text-testing { color: #06b6d4; }
.text-other { color: #6b7280; }
</style>