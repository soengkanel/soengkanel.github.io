<!-- Project Tasks Tab - Subtable Design -->
<style>
    /* Subtable Design Variables */
    :root {
        --primary: #3b82f6;
        --success: #10b981;
        --danger: #ef4444;
        --border: #e5e7eb;
        --bg-gray: #f9fafb;
    }

    /* Subtable Container */
    .subtable-container {
        background: white;
        border: 1px solid var(--border);
        border-radius: 6px;
        overflow: visible;
    }

    .subtable-header {
        background: var(--bg-gray);
        padding: 8px 10px;
        border-bottom: 1px solid var(--border);
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .subtable-title {
        font-size: 13px;
        font-weight: 600;
        color: #111827;
        margin: 0;
    }

    .subtable-count {
        font-size: 11px;
        color: #6b7280;
    }

    .subtable {
        width: 100%;
        margin: 0;
        font-size: 12px;
        border-collapse: collapse;
        table-layout: fixed;
    }

    .subtable thead th {
        background: var(--bg-gray);
        padding: 6px 8px;
        font-size: 10px;
        font-weight: 600;
        color: #6b7280;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        border-bottom: 1px solid var(--border);
        text-align: left;
        white-space: nowrap;
    }

    .subtable tbody td {
        padding: 6px 8px;
        border-bottom: 1px solid #f3f4f6;
        color: #111827;
        vertical-align: middle;
    }

    .subtable tbody tr:last-child td {
        border-bottom: none;
    }

    .subtable tbody tr:hover {
        background: #f9fafb;
    }

    /* Inline Form Controls */
    .form-control-inline {
        width: 100%;
        padding: 5px 8px;
        font-size: 12px;
        border: 1px solid var(--border);
        border-radius: 4px;
        background: white;
        height: 30px;
    }

    .form-control-inline:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.1);
    }

    input[type="number"].form-control-inline {
        text-align: right;
    }

    /* New task row */
    .new-task-row {
        background-color: #f0fdf4;
    }

    /* Compact Buttons */
    .btn-compact {
        display: inline-flex;
        align-items: center;
        gap: 4px;
        padding: 5px 10px;
        font-size: 12px;
        font-weight: 500;
        border-radius: 4px;
        text-decoration: none;
        transition: all 0.15s;
        border: 1px solid;
        cursor: pointer;
    }

    .btn-primary-compact {
        background: var(--primary);
        color: white;
        border-color: var(--primary);
    }

    .btn-primary-compact:hover {
        background: #2563eb;
        color: white;
    }

    /* Icon Buttons */
    .btn-icon-sm {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 24px;
        height: 24px;
        padding: 0;
        border-radius: 4px;
        border: 1px solid var(--border);
        background: white;
        color: #6b7280;
        cursor: pointer;
        transition: all 0.15s;
        font-size: 11px;
    }

    .btn-icon-sm:hover {
        background: var(--bg-gray);
        border-color: #d1d5db;
        color: #111827;
    }

    .btn-icon-sm.danger {
        color: var(--danger);
    }

    .btn-icon-sm.danger:hover {
        background: #fee2e2;
        border-color: var(--danger);
    }

    .btn-icon-sm.success {
        background: var(--success);
        color: white;
        border-color: var(--success);
    }

    .btn-icon-sm.success:hover {
        background: #059669;
    }

    /* Saving Indicator */
    .saving-indicator {
        display: none;
        position: fixed;
        bottom: 20px;
        right: 20px;
        background: #1a1a1a;
        color: white;
        padding: 8px 16px;
        border-radius: 6px;
        font-size: 0.875rem;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        z-index: 1000;
    }

    .saving-indicator.show {
        display: block;
        animation: fadeIn 0.2s;
    }

    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }

    @keyframes rotate {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
    }

    /* Empty State */
    .empty-state-compact {
        text-align: center;
        padding: 30px 20px;
        color: #6b7280;
    }

    .empty-state-compact i {
        font-size: 40px;
        color: #d1d5db;
        margin-bottom: 8px;
    }

    .empty-state-compact h3 {
        font-size: 14px;
        font-weight: 600;
        color: #111827;
        margin: 0 0 4px 0;
    }

    .empty-state-compact p {
        font-size: 12px;
        margin: 0;
    }

    /* Autocomplete - matching team tab design exactly */
    .assignee-autocomplete-wrapper {
        position: relative;
        width: 100%;
    }

    .assignee-autocomplete-input {
        width: 100%;
        padding: 5px 8px;
        font-size: 12px;
        border: 1px solid #e5e7eb;
        border-radius: 4px;
        background: white;
        height: 30px;
    }

    .assignee-autocomplete-input:focus {
        outline: none;
        border-color: #3b82f6;
        box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.1);
    }

    .assignee-autocomplete-dropdown {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: white;
        border: 1px solid #e5e7eb;
        border-top: none;
        z-index: 1000;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        display: none;
    }

    .assignee-autocomplete-dropdown.show {
        display: block;
    }

    .assignee-autocomplete-item {
        padding: 0.5rem 0.75rem;
        cursor: pointer;
        border-bottom: 1px solid #f3f4f6;
    }

    .assignee-autocomplete-item:hover,
    .assignee-autocomplete-item.selected {
        background: #f9fafb;
    }

    .assignee-autocomplete-item-name {
        font-weight: 500;
        font-size: 0.875rem;
    }

    .assignee-autocomplete-item-email {
        font-size: 0.75rem;
        color: #6b7280;
    }

    .assignee-autocomplete-empty {
        padding: 0.75rem;
        text-align: center;
        color: #9ca3af;
        font-size: 0.875rem;
    }
    .stat-card {
        border: 1px solid #e5e7eb;
        border-radius: 6px;
        padding: 1rem;
        background: #fff;
    }
    .stat-value {
        font-size: 1.5rem;
        font-weight: 600;
        color: #111827;
        margin: 0.25rem 0;
    }
    .stat-label {
        font-size: 0.75rem;
        color: #6b7280;
        text-transform: uppercase;
        letter-spacing: 0.025em;
    }
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
        gap: 6px;
        margin-bottom: 12px;
    }
    /* Compact Filters */
    .filters-compact {
        background: white;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        padding: 12px;
        margin-bottom: 16px;
    }

    .filters-compact input,
    .filters-compact select {
        font-size: 13px;
        padding: 6px 10px;
        border: 1px solid #d1d5db;
        border-radius: 6px;
    }
    /* Action Buttons */
    .btn-icon-compact {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 25px;
        height: 25px;
        padding: 0;
        border-radius: 10px;
        border: 1px solid #e5e7eb;
        background: white;
        color: #6b7280;
        cursor: pointer;
        transition: all 0.15s;
    }

    .btn-icon-compact:hover {
        background: #f9fafb;
        border-color: #d1d5db;
        color: #111827;
    }

    .btn-icon-compact.success {
        color: var(--success);
        border-color: var(--success);
    }

    .btn-icon-compact.success:hover {
        background: #d1fae5;
    }

    .btn-icon-compact.danger {
        color: var(--danger);
        border-color: var(--danger);
    }

    .btn-icon-compact.danger:hover {
        background: #fee2e2;
    }

    .btn-icon-compact.warning {
        color: var(--warning);
        border-color: var(--warning);
    }

    .btn-icon-compact.warning:hover {
        background: #f7e2be;
    }
    .btn-icon-compact.primary {
        color: var(--primary);
        border-color: var(--primary);
    }

    .btn-icon-compact.primary:hover {
        background: #c8daf7;
    }
    .page-header { padding: 6px 0; margin-bottom: 12px; }
    .page-header h2 { font-size: 16px; font-weight: 600; margin: 0; color: #1a1a1a; }
    .form-control { font-size: 11px !important; padding: 4px 6px !important; height: auto !important; border-radius: 3px; border: 1px solid #d1d5db; }
    .form-label { font-size: 10px !important; margin-bottom: 3px !important; font-weight: 500; color: #374151; }
    .status-badge { padding: 3px 8px; border-radius: 12px; font-size: 10px; font-weight: 500; text-transform: uppercase; }
    .status-draft { background-color: #f3f4f6; color: #374151; }
    .status-processing { background-color: #fef3c7; color: #92400e; }
    .status-closed { background-color: #f73636; color: #f3f4f6;; }
    .status-approved { background-color: #dbeafe; color: #1e40af; }
    .status-paid { background-color: #dcfce7; color: #166534; }
    .status-cancelled { background-color: #fee2e2; color: #991b1b; }
    .table { font-size: 11px; }
    .table th { font-weight: 600; color: #374151; text-transform: uppercase; font-size: 10px; padding: 8px; border-bottom: 2px solid #e2e8f0; }
    .table td { padding: 8px; vertical-align: middle; }
    .filter-pill { padding: 4px 12px; border: 1px solid #e2e8f0; border-radius: 12px; font-size: 10px; text-decoration: none; color: #6b7280; transition: all 0.2s; }
    .filter-pill:hover, .filter-pill.active { background: #3b82f6; color: white; border-color: #3b82f6; }
</style>

<div class="tasks-content">
    <!-- Subtable Container -->
    <div class="subtable-container">
        <div class="subtable-header">
            <h3 class="subtable-title">
                Tasks
                <span class="subtable-count">({{ task_stats.total }})</span>
            </h3>
            <button type="button" id="add-task-btn" class="button-min-primary py-1">
                <div>
                    <i class="bi bi-plus"></i>
                    <span>
                        Add
                    </span>
                </div>
            </button>
        </div>
        <div class="card">
            <div class="card-body">
                <div class="table-responsive"> 
                    <table class="table table-hover">
                        <thead class="table-light">
                            <tr>
                                <th style="width: 30%;">Task Name</th>
                                <th style="width: 15%;">Assignee</th>
                                <th style="width: 12%;">Status</th>
                                <th style="width: 10%;">Priority</th>
                                <th style="width: 12%;">Progress</th>
                                <th style="width: 12%;">Due Date</th>
                                <th style="width: 9%;"></th>
                            </tr>
                        </thead>
                        <tbody id="tasks-table-body">
                            <!-- New task rows will be inserted here dynamically -->

                            <!-- Existing Tasks -->
                            {% if project.tasks.exists %}
                                {% for task in project.tasks.all %}
                                    {% include 'project/partials/task_row_inline.html' with task=task project=project %}
                                {% endfor %}
                            {% else %}
                                <tr id="no-tasks-row">
                                    <td colspan="7">
                                        <div class="empty-state-compact">
                                            <i class="bi bi-list-task"></i>
                                            <h3>No tasks yet</h3>
                                            <p>Click "Add Task" button to create your first task.</p>
                                        </div>
                                    </td>
                                </tr>
                            {% endif %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Saving Indicator -->
<div id="saving-indicator" class="saving-indicator">
    <svg class="spinner" width="14" height="14" viewBox="0 0 50 50" style="display: inline-block; margin-right: 8px; animation: rotate 1s linear infinite;">
        <circle cx="25" cy="25" r="20" fill="none" stroke="white" stroke-width="5" stroke-dasharray="80" stroke-dashoffset="60"></circle>
    </svg>
    Saving...
</div>

<style>
    @keyframes rotate {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
    }
</style>

{% load static %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const addTaskBtn = document.getElementById('add-task-btn');
    const savingIndicator = document.getElementById('saving-indicator');
    const noTasksRow = document.getElementById('no-tasks-row');
    const tbody = document.getElementById('tasks-table-body');

    let newRowCounter = 0;

    // Get CSRF token
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value || '{{ csrf_token }}';

    // All active employees for dropdown (not just team members)
    const allEmployees = [
        {% for emp in all_employees_data %}
        {
            id: '{{ emp.id }}',
            name: '{{ emp.name }}',
            email: '{{ emp.email }}',
            initials: '{{ emp.initials }}'
        },
        {% endfor %}
    ];

    // Show saving indicator
    function showSaving() {
        savingIndicator.classList.add('show');
    }

    function hideSaving() {
        setTimeout(() => {
            savingIndicator.classList.remove('show');
        }, 500);
    }

    // Create new task row HTML
    function createNewTaskRow() {
        const rowId = `new-task-row-${++newRowCounter}`;

        return `
            <tr id="${rowId}" class="new-task-row" data-new-row="true">
                <td>
                    <input type="text"
                           class="form-control-inline new-task-name"
                           placeholder="Task name..."
                           data-row-id="${rowId}">
                </td>
                <td>
                    <div class="assignee-autocomplete-wrapper">
                        <input type="text"
                               class="assignee-autocomplete-input new-task-assignee"
                               data-row-id="${rowId}"
                               data-employee-id=""
                               value=""
                               placeholder="Type to search employee..."
                               autocomplete="off">
                        <div class="assignee-autocomplete-dropdown"></div>
                    </div>
                </td>
                <td>
                    <select class="form-control-inline new-task-status" data-row-id="${rowId}">
                        <option value="open" selected>Open</option>
                        <option value="working">Working</option>
                        <option value="pending_review">Pending Review</option>
                        <option value="completed">Completed</option>
                    </select>
                </td>
                <td>
                    <select class="form-control-inline new-task-priority" data-row-id="${rowId}">
                        <option value="low">Low</option>
                        <option value="medium" selected>Medium</option>
                        <option value="high">High</option>
                        <option value="urgent">Urgent</option>
                    </select>
                </td>
                <td>
                    <input type="number"
                           class="form-control-inline new-task-progress"
                           value="0"
                           min="0"
                           max="100"
                           step="5"
                           placeholder="0"
                           data-row-id="${rowId}">
                </td>
                <td>
                    <input type="date"
                           class="form-control-inline new-task-due-date"
                           data-row-id="${rowId}">
                </td>
                <td style="display: flex; gap: 4px;">
                    <button type="button" class="btn-icon-compact success" title="Save task" data-row-id="${rowId}">
                        <i class="bi bi-check"></i>
                    </button>
                    <button type="button" class="btn-icon-compact danger" title="Cancel" data-row-id="${rowId}">
                        <i class="bi bi-x"></i>
                    </button>
                </td>
            </tr>
        `;
    }

    // Add new task row
    addTaskBtn.addEventListener('click', function() {
        if (noTasksRow) {
            noTasksRow.style.display = 'none';
        }

        // Create and insert new row at the top
        const newRowHtml = createNewTaskRow();
        tbody.insertAdjacentHTML('afterbegin', newRowHtml);

        // Focus on the first new task name input
        const newRow = tbody.querySelector(`#new-task-row-${newRowCounter}`);
        const nameInput = newRow.querySelector('.new-task-name');
        nameInput.focus();

        // Setup event listeners for this row
        setupNewRowListeners(newRow);

        // Initialize autocomplete for the new row
        setTimeout(() => {
            initializeAutocomplete();
        }, 50);
    });

    // Setup listeners for a new row
    function setupNewRowListeners(row) {
        const rowId = row.id;
        const saveBtn = row.querySelector('.save-new-task-btn');
        const cancelBtn = row.querySelector('.cancel-new-task-btn');
        const nameInput = row.querySelector('.new-task-name');

        // Save button
        saveBtn.addEventListener('click', function() {
            saveNewTask(row);
        });

        // Cancel button
        cancelBtn.addEventListener('click', function() {
            row.remove();

            // Show no tasks row if no tasks exist
            const taskRows = tbody.querySelectorAll('.task-row');
            const newRows = tbody.querySelectorAll('[data-new-row="true"]');
            if (taskRows.length === 0 && newRows.length === 0 && noTasksRow) {
                noTasksRow.style.display = '';
            }
        });

        // Enter key to save
        nameInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                saveNewTask(row);
            }
        });
    }

    // Save new task
    function saveNewTask(row) {
        const rowId = row.id;
        const taskName = row.querySelector('.new-task-name').value.trim();

        if (!taskName) {
            alert('Please enter a task name');
            row.querySelector('.new-task-name').focus();
            return;
        }

        const formData = new FormData();
        formData.append('task_name', taskName);
        formData.append('description', row.querySelector('.new-task-description').value);
        formData.append('assigned_to', row.querySelector('.new-task-assignee').dataset.employeeId || '');
        formData.append('status', row.querySelector('.new-task-status').value);
        formData.append('priority', row.querySelector('.new-task-priority').value);
        formData.append('progress', row.querySelector('.new-task-progress').value);
        formData.append('expected_end_date', row.querySelector('.new-task-due-date').value);
        formData.append('csrfmiddlewaretoken', csrfToken);

        showSaving();

        fetch('{% url "project:task_create_inline" project.id %}', {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrfToken,
                'HX-Request': 'true'
            },
            body: formData
        })
        .then(response => {
            console.log('Response status:', response.status);
            if (!response.ok) {
                return response.text().then(text => {
                    console.error('Error response:', text);
                    throw new Error(`Server error: ${response.status}`);
                });
            }
            return response.text();
        })
        .then(html => {
            console.log('Response HTML:', html.substring(0, 200));

            // Create temp div to parse HTML
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = html;
            const savedRow = tempDiv.querySelector('tr');

            if (!savedRow) {
                console.error('No <tr> found in response');
                throw new Error('Invalid response format');
            }

            // Replace the new row with the saved row
            row.parentNode.replaceChild(savedRow, row);

            // Setup inline editing for the saved row
            setupInlineEditing(savedRow);

            // Initialize autocomplete for the saved row
            setTimeout(() => {
                initializeAutocomplete();
            }, 50);

            hideSaving();
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Failed to create task: ' + error.message);
            hideSaving();
        });
    }

    // Setup inline editing for existing tasks
    function setupInlineEditing(row) {
        const taskId = row.id.replace('task-', '');

        // Text inputs (task name and description)
        row.querySelectorAll('input[type="text"], textarea').forEach(input => {
            input.addEventListener('blur', function() {
                updateTaskField(taskId, this.dataset.field, this.value);
            });

            input.addEventListener('keypress', function(e) {
                if (e.key === 'Enter' && this.tagName !== 'TEXTAREA') {
                    e.preventDefault();
                    this.blur();
                }
            });
        });

        // Selects (assignee, status, priority)
        row.querySelectorAll('select').forEach(select => {
            select.addEventListener('change', function() {
                updateTaskField(taskId, this.dataset.field, this.value);
            });
        });

        // Number inputs (progress)
        row.querySelectorAll('input[type="number"]').forEach(input => {
            input.addEventListener('blur', function() {
                updateTaskField(taskId, this.dataset.field, this.value);
            });

            input.addEventListener('change', function() {
                updateTaskField(taskId, this.dataset.field, this.value);
            });
        });

        // Date inputs
        row.querySelectorAll('input[type="date"]').forEach(input => {
            input.addEventListener('change', function() {
                updateTaskField(taskId, this.dataset.field, this.value);
            });
        });

        // Delete button
        const deleteBtn = row.querySelector('.delete-task-btn');
        if (deleteBtn) {
            deleteBtn.addEventListener('click', function() {
                if (confirm('Are you sure you want to delete this task?')) {
                    deleteTask(taskId, row);
                }
            });
        }
    }

    // Update task field
    function updateTaskField(taskId, field, value) {
        showSaving();

        const formData = new FormData();
        formData.append(field, value);
        formData.append('csrfmiddlewaretoken', csrfToken);

        fetch(`/project/tasks/${taskId}/update-inline/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrfToken
            },
            body: formData
        })
        .then(response => {
            if (response.ok) {
                hideSaving();
            } else {
                throw new Error('Update failed');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Failed to update task. Please try again.');
            hideSaving();
        });
    }

    // Delete task
    function deleteTask(taskId, row) {
        showSaving();

        fetch(`/project/tasks/${taskId}/delete/`, {
            method: 'DELETE',
            headers: {
                'X-CSRFToken': csrfToken
            }
        })
        .then(response => {
            if (response.ok) {
                row.remove();

                // Show no tasks row if no tasks left
                const taskRows = document.querySelectorAll('.task-row');
                if (taskRows.length === 0 && noTasksRow) {
                    noTasksRow.style.display = '';
                }

                hideSaving();
            } else {
                throw new Error('Delete failed');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Failed to delete task. Please try again.');
            hideSaving();
        });
    }

    // Setup inline editing for existing tasks
    document.querySelectorAll('.task-row').forEach(row => {
        setupInlineEditing(row);
    });

    // Task filtering
    const statusFilter = document.getElementById('task-status-filter');
    const assigneeFilter = document.getElementById('task-assignee-filter');

    function filterTasks() {
        const statusValue = statusFilter.value;
        const assigneeValue = assigneeFilter.value;
        const rows = document.querySelectorAll('.task-row');

        rows.forEach(row => {
            const taskStatus = row.dataset.status;
            const taskAssignee = row.dataset.assignee;

            let showRow = true;

            if (statusValue && taskStatus !== statusValue) {
                showRow = false;
            }

            if (assigneeValue && taskAssignee !== assigneeValue) {
                showRow = false;
            }

            row.style.display = showRow ? '' : 'none';
        });
    }

    statusFilter.addEventListener('change', filterTasks);
    assigneeFilter.addEventListener('change', filterTasks);

    // Autocomplete functionality (following team tab pattern)
    function setupAutocomplete(wrapper) {
        const input = wrapper.querySelector('.assignee-autocomplete-input');
        const dropdown = wrapper.querySelector('.assignee-autocomplete-dropdown');
        let selectedIndex = -1;

        // Skip if already initialized
        if (input.dataset.autocompleteInitialized) {
            return;
        }
        input.dataset.autocompleteInitialized = 'true';

        // Show dropdown on focus
        input.addEventListener('focus', function() {
            filterEmployees('');
        });

        // Filter on input
        input.addEventListener('input', function() {
            const query = this.value;
            filterEmployees(query);
        });

        // Keyboard navigation
        input.addEventListener('keydown', function(e) {
            const items = dropdown.querySelectorAll('.assignee-autocomplete-item');

            if (e.key === 'ArrowDown') {
                e.preventDefault();
                selectedIndex = Math.min(selectedIndex + 1, items.length - 1);
                updateSelection(items);
            } else if (e.key === 'ArrowUp') {
                e.preventDefault();
                selectedIndex = Math.max(selectedIndex - 1, -1);
                updateSelection(items);
            } else if (e.key === 'Enter') {
                e.preventDefault();
                if (selectedIndex >= 0 && items[selectedIndex]) {
                    items[selectedIndex].click();
                }
            } else if (e.key === 'Escape') {
                dropdown.classList.remove('show');
                selectedIndex = -1;
            }
        });

        // Close dropdown when clicking outside
        document.addEventListener('click', function(e) {
            if (!wrapper.contains(e.target)) {
                dropdown.classList.remove('show');
                selectedIndex = -1;
            }
        });

        function filterEmployees(query) {
            query = query.toLowerCase();
            const filtered = allEmployees.filter(emp =>
                emp.name.toLowerCase().includes(query) ||
                emp.email.toLowerCase().includes(query)
            );

            // Limit to first 8 results to avoid scrolling
            const limitedResults = filtered.slice(0, 8);

            if (limitedResults.length === 0) {
                dropdown.innerHTML = '<div class="assignee-autocomplete-empty">No employees found</div>';
            } else {
                let html = limitedResults.map((emp, index) => `
                    <div class="assignee-autocomplete-item" data-employee-id="${emp.id}" data-index="${index}">
                        <div class="assignee-autocomplete-item-name">${emp.name}</div>
                    </div>
                `).join('');

                // Show "and X more" if there are more results
                if (filtered.length > 8) {
                    html += `<div class="assignee-autocomplete-empty" style="border-top: 1px solid #e5e7eb; font-style: italic;">and ${filtered.length - 8} more... (type to refine)</div>`;
                }

                dropdown.innerHTML = html;

                // Add click handlers
                dropdown.querySelectorAll('.assignee-autocomplete-item').forEach(item => {
                    item.addEventListener('click', function() {
                        const employeeId = this.dataset.employeeId;
                        const employee = allEmployees.find(e => e.id === employeeId);
                        input.value = employee.name;
                        input.dataset.employeeId = employeeId;
                        dropdown.classList.remove('show');
                        selectedIndex = -1;

                        // Update task if it's an existing task
                        const taskId = input.dataset.taskId;
                        if (taskId) {
                            updateTaskField(taskId, 'assigned_to', employeeId);
                        }
                    });
                });
            }

            dropdown.classList.add('show');
            selectedIndex = -1;
        }

        function updateSelection(items) {
            items.forEach((item, index) => {
                if (index === selectedIndex) {
                    item.classList.add('selected');
                    item.scrollIntoView({ block: 'nearest' });
                } else {
                    item.classList.remove('selected');
                }
            });
        }
    }

    // Initialize autocomplete for all existing inputs
    function initializeAutocomplete() {
        document.querySelectorAll('.assignee-autocomplete-wrapper').forEach(wrapper => {
            setupAutocomplete(wrapper);
        });
    }

    // Initialize on page load
    initializeAutocomplete();
});
</script>
