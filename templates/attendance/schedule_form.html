{% extends 'base.html' %}
{% load i18n %}

{% block title %}
    {% if object %}
        {% trans "Edit Work Schedule" %} - {{ object.name }}
    {% else %}
        {% trans "Create Work Schedule" %}
    {% endif %}
{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="row">
        <div class="col-md-10 mx-auto">
            <div class="card">
                <div class="card-header">
                    <h4>
                        {% if object %}
                            <i class="fas fa-edit"></i> {% trans "Edit Work Schedule" %} - {{ object.name }}
                        {% else %}
                            <i class="fas fa-plus"></i> {% trans "Create Work Schedule" %}
                        {% endif %}
                    </h4>
                </div>
                <div class="card-body">
                    <form method="post" novalidate>
                        {% csrf_token %}

                        <div class="row">
                            <div class="col-md-8">
                                <div class="mb-3">
                                    <label for="{{ form.name.id_for_label }}" class="form-label">
                                        <i class="fas fa-tag"></i> {{ form.name.label }}
                                        <span class="text-danger">*</span>
                                    </label>
                                    {{ form.name }}
                                    {% if form.name.errors %}
                                        <div class="invalid-feedback d-block">
                                            {{ form.name.errors.0 }}
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="{{ form.schedule_type.id_for_label }}" class="form-label">
                                        <i class="fas fa-clock"></i> {{ form.schedule_type.label }}
                                    </label>
                                    {{ form.schedule_type }}
                                    {% if form.schedule_type.errors %}
                                        <div class="invalid-feedback d-block">
                                            {{ form.schedule_type.errors.0 }}
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="{{ form.description.id_for_label }}" class="form-label">
                                <i class="fas fa-comment"></i> {{ form.description.label }}
                            </label>
                            {{ form.description }}
                            {% if form.description.errors %}
                                <div class="invalid-feedback d-block">
                                    {{ form.description.errors.0 }}
                                </div>
                            {% endif %}
                        </div>

                        <!-- Days of the Week Schedule -->
                        <div class="card mb-4">
                            <div class="card-header">
                                <h6 class="mb-0">
                                    <i class="fas fa-calendar-week"></i> {% trans "Weekly Schedule" %}
                                </h6>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <!-- Monday -->
                                    <div class="col-lg-6 col-xl-4 mb-3">
                                        <div class="card">
                                            <div class="card-header py-2">
                                                <div class="form-check">
                                                    {{ form.monday_enabled }}
                                                    <label class="form-check-label fw-bold" for="{{ form.monday_enabled.id_for_label }}">
                                                        {% trans "Monday" %}
                                                    </label>
                                                </div>
                                            </div>
                                            <div class="card-body py-2 monday-schedule">
                                                <div class="row">
                                                    <div class="col-6">
                                                        <label class="form-label small">{% trans "Start Time" %}</label>
                                                        {{ form.monday_start }}
                                                    </div>
                                                    <div class="col-6">
                                                        <label class="form-label small">{% trans "End Time" %}</label>
                                                        {{ form.monday_end }}
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Tuesday -->
                                    <div class="col-lg-6 col-xl-4 mb-3">
                                        <div class="card">
                                            <div class="card-header py-2">
                                                <div class="form-check">
                                                    {{ form.tuesday_enabled }}
                                                    <label class="form-check-label fw-bold" for="{{ form.tuesday_enabled.id_for_label }}">
                                                        {% trans "Tuesday" %}
                                                    </label>
                                                </div>
                                            </div>
                                            <div class="card-body py-2 tuesday-schedule">
                                                <div class="row">
                                                    <div class="col-6">
                                                        <label class="form-label small">{% trans "Start Time" %}</label>
                                                        {{ form.tuesday_start }}
                                                    </div>
                                                    <div class="col-6">
                                                        <label class="form-label small">{% trans "End Time" %}</label>
                                                        {{ form.tuesday_end }}
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Wednesday -->
                                    <div class="col-lg-6 col-xl-4 mb-3">
                                        <div class="card">
                                            <div class="card-header py-2">
                                                <div class="form-check">
                                                    {{ form.wednesday_enabled }}
                                                    <label class="form-check-label fw-bold" for="{{ form.wednesday_enabled.id_for_label }}">
                                                        {% trans "Wednesday" %}
                                                    </label>
                                                </div>
                                            </div>
                                            <div class="card-body py-2 wednesday-schedule">
                                                <div class="row">
                                                    <div class="col-6">
                                                        <label class="form-label small">{% trans "Start Time" %}</label>
                                                        {{ form.wednesday_start }}
                                                    </div>
                                                    <div class="col-6">
                                                        <label class="form-label small">{% trans "End Time" %}</label>
                                                        {{ form.wednesday_end }}
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Thursday -->
                                    <div class="col-lg-6 col-xl-4 mb-3">
                                        <div class="card">
                                            <div class="card-header py-2">
                                                <div class="form-check">
                                                    {{ form.thursday_enabled }}
                                                    <label class="form-check-label fw-bold" for="{{ form.thursday_enabled.id_for_label }}">
                                                        {% trans "Thursday" %}
                                                    </label>
                                                </div>
                                            </div>
                                            <div class="card-body py-2 thursday-schedule">
                                                <div class="row">
                                                    <div class="col-6">
                                                        <label class="form-label small">{% trans "Start Time" %}</label>
                                                        {{ form.thursday_start }}
                                                    </div>
                                                    <div class="col-6">
                                                        <label class="form-label small">{% trans "End Time" %}</label>
                                                        {{ form.thursday_end }}
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Friday -->
                                    <div class="col-lg-6 col-xl-4 mb-3">
                                        <div class="card">
                                            <div class="card-header py-2">
                                                <div class="form-check">
                                                    {{ form.friday_enabled }}
                                                    <label class="form-check-label fw-bold" for="{{ form.friday_enabled.id_for_label }}">
                                                        {% trans "Friday" %}
                                                    </label>
                                                </div>
                                            </div>
                                            <div class="card-body py-2 friday-schedule">
                                                <div class="row">
                                                    <div class="col-6">
                                                        <label class="form-label small">{% trans "Start Time" %}</label>
                                                        {{ form.friday_start }}
                                                    </div>
                                                    <div class="col-6">
                                                        <label class="form-label small">{% trans "End Time" %}</label>
                                                        {{ form.friday_end }}
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Saturday -->
                                    <div class="col-lg-6 col-xl-4 mb-3">
                                        <div class="card">
                                            <div class="card-header py-2">
                                                <div class="form-check">
                                                    {{ form.saturday_enabled }}
                                                    <label class="form-check-label fw-bold" for="{{ form.saturday_enabled.id_for_label }}">
                                                        {% trans "Saturday" %}
                                                    </label>
                                                </div>
                                            </div>
                                            <div class="card-body py-2 saturday-schedule">
                                                <div class="row">
                                                    <div class="col-6">
                                                        <label class="form-label small">{% trans "Start Time" %}</label>
                                                        {{ form.saturday_start }}
                                                    </div>
                                                    <div class="col-6">
                                                        <label class="form-label small">{% trans "End Time" %}</label>
                                                        {{ form.saturday_end }}
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Sunday -->
                                    <div class="col-lg-6 col-xl-4 mb-3">
                                        <div class="card">
                                            <div class="card-header py-2">
                                                <div class="form-check">
                                                    {{ form.sunday_enabled }}
                                                    <label class="form-check-label fw-bold" for="{{ form.sunday_enabled.id_for_label }}">
                                                        {% trans "Sunday" %}
                                                    </label>
                                                </div>
                                            </div>
                                            <div class="card-body py-2 sunday-schedule">
                                                <div class="row">
                                                    <div class="col-6">
                                                        <label class="form-label small">{% trans "Start Time" %}</label>
                                                        {{ form.sunday_start }}
                                                    </div>
                                                    <div class="col-6">
                                                        <label class="form-label small">{% trans "End Time" %}</label>
                                                        {{ form.sunday_end }}
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Grace Periods and Settings -->
                        <div class="card mb-4">
                            <div class="card-header">
                                <h6 class="mb-0">
                                    <i class="fas fa-clock"></i> {% trans "Grace Periods & Settings" %}
                                </h6>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-3">
                                        <div class="mb-3">
                                            <label for="{{ form.late_grace_minutes.id_for_label }}" class="form-label">
                                                {% trans "Late Grace (Minutes)" %}
                                            </label>
                                            {{ form.late_grace_minutes }}
                                            {% if form.late_grace_minutes.errors %}
                                                <div class="invalid-feedback d-block">
                                                    {{ form.late_grace_minutes.errors.0 }}
                                                </div>
                                            {% endif %}
                                            <small class="form-text text-muted">
                                                {% trans "Allow this many minutes late without penalty" %}
                                            </small>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="mb-3">
                                            <label for="{{ form.early_departure_grace_minutes.id_for_label }}" class="form-label">
                                                {% trans "Early Departure Grace" %}
                                            </label>
                                            {{ form.early_departure_grace_minutes }}
                                            {% if form.early_departure_grace_minutes.errors %}
                                                <div class="invalid-feedback d-block">
                                                    {{ form.early_departure_grace_minutes.errors.0 }}
                                                </div>
                                            {% endif %}
                                            <small class="form-text text-muted">
                                                {% trans "Allow early departure without penalty" %}
                                            </small>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="mb-3">
                                            <label for="{{ form.break_duration_minutes.id_for_label }}" class="form-label">
                                                {% trans "Break Duration" %}
                                            </label>
                                            {{ form.break_duration_minutes }}
                                            {% if form.break_duration_minutes.errors %}
                                                <div class="invalid-feedback d-block">
                                                    {{ form.break_duration_minutes.errors.0 }}
                                                </div>
                                            {% endif %}
                                            <small class="form-text text-muted">
                                                {% trans "Total daily break time in minutes" %}
                                            </small>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="mb-3">
                                            <label for="{{ form.overtime_threshold_minutes.id_for_label }}" class="form-label">
                                                {% trans "Overtime Threshold" %}
                                            </label>
                                            {{ form.overtime_threshold_minutes }}
                                            {% if form.overtime_threshold_minutes.errors %}
                                                <div class="invalid-feedback d-block">
                                                    {{ form.overtime_threshold_minutes.errors.0 }}
                                                </div>
                                            {% endif %}
                                            <small class="form-text text-muted">
                                                {% trans "Minutes beyond schedule for overtime" %}
                                            </small>
                                        </div>
                                    </div>
                                </div>

                                <div class="row">
                                    <div class="col-md-4">
                                        <div class="form-check">
                                            {{ form.flexible_timing }}
                                            <label class="form-check-label" for="{{ form.flexible_timing.id_for_label }}">
                                                {% trans "Flexible Timing" %}
                                            </label>
                                            <small class="form-text text-muted d-block">
                                                {% trans "Allow flexible start and end times within core hours" %}
                                            </small>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="form-check">
                                            {{ form.track_breaks }}
                                            <label class="form-check-label" for="{{ form.track_breaks.id_for_label }}">
                                                {% trans "Track Breaks" %}
                                            </label>
                                            <small class="form-text text-muted d-block">
                                                {% trans "Monitor and log break times" %}
                                            </small>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="form-check">
                                            {{ form.auto_clock_out }}
                                            <label class="form-check-label" for="{{ form.auto_clock_out.id_for_label }}">
                                                {% trans "Auto Clock Out" %}
                                            </label>
                                            <small class="form-text text-muted d-block">
                                                {% trans "Automatically clock out at end time" %}
                                            </small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Action Buttons -->
                        <div class="row">
                            <div class="col-12">
                                <div class="d-flex justify-content-between">
                                    <a href="{% url 'attendance:schedule_list' %}" class="btn btn-secondary">
                                        <i class="fas fa-arrow-left"></i> {% trans "Back to Schedules" %}
                                    </a>

                                    <div class="btn-group">
                                        <button type="button" class="btn btn-outline-info" onclick="previewSchedule()">
                                            <i class="fas fa-eye"></i> {% trans "Preview Schedule" %}
                                        </button>
                                        <button type="submit" class="btn btn-primary">
                                            <i class="fas fa-save"></i>
                                            {% if object %}
                                                {% trans "Update Schedule" %}
                                            {% else %}
                                                {% trans "Create Schedule" %}
                                            {% endif %}
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Schedule Preview Modal -->
            <div class="modal fade" id="schedulePreviewModal" tabindex="-1">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">
                                <i class="fas fa-calendar-week"></i> {% trans "Schedule Preview" %}
                            </h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body" id="schedulePreviewContent">
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                                {% trans "Close" %}
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Toggle day schedule fields based on checkbox
document.addEventListener('DOMContentLoaded', function() {
    const days = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'];

    days.forEach(day => {
        const checkbox = document.getElementById(`id_${day}_enabled`);
        const scheduleDiv = document.querySelector(`.${day}-schedule`);

        if (checkbox && scheduleDiv) {
            const toggleSchedule = () => {
                scheduleDiv.style.opacity = checkbox.checked ? '1' : '0.5';
                const inputs = scheduleDiv.querySelectorAll('input, select');
                inputs.forEach(input => {
                    input.disabled = !checkbox.checked;
                });
            };

            checkbox.addEventListener('change', toggleSchedule);
            toggleSchedule(); // Initial state
        }
    });
});

function previewSchedule() {
    let previewHtml = '<div class="table-responsive"><table class="table table-bordered">';
    previewHtml += '<thead><tr><th>{% trans "Day" %}</th><th>{% trans "Status" %}</th><th>{% trans "Start Time" %}</th><th>{% trans "End Time" %}</th><th>{% trans "Hours" %}</th></tr></thead><tbody>';

    const days = [
        {name: 'monday', label: '{% trans "Monday" %}'},
        {name: 'tuesday', label: '{% trans "Tuesday" %}'},
        {name: 'wednesday', label: '{% trans "Wednesday" %}'},
        {name: 'thursday', label: '{% trans "Thursday" %}'},
        {name: 'friday', label: '{% trans "Friday" %}'},
        {name: 'saturday', label: '{% trans "Saturday" %}'},
        {name: 'sunday', label: '{% trans "Sunday" %}'}
    ];

    let totalHours = 0;

    days.forEach(day => {
        const enabled = document.getElementById(`id_${day.name}_enabled`).checked;
        const startTime = document.getElementById(`id_${day.name}_start`).value;
        const endTime = document.getElementById(`id_${day.name}_end`).value;

        let status = enabled ? '<span class="badge bg-success">Active</span>' : '<span class="badge bg-secondary">Off</span>';
        let hours = 0;

        if (enabled && startTime && endTime) {
            const start = new Date(`2000-01-01T${startTime}`);
            const end = new Date(`2000-01-01T${endTime}`);
            hours = (end - start) / (1000 * 60 * 60);
            totalHours += hours;
        }

        previewHtml += `<tr>
            <td><strong>${day.label}</strong></td>
            <td>${status}</td>
            <td>${enabled && startTime ? startTime : '-'}</td>
            <td>${enabled && endTime ? endTime : '-'}</td>
            <td>${hours > 0 ? hours.toFixed(1) + 'h' : '-'}</td>
        </tr>`;
    });

    previewHtml += '</tbody>';
    previewHtml += `<tfoot><tr class="table-dark"><td colspan="4"><strong>{% trans "Total Weekly Hours" %}</strong></td><td><strong>${totalHours.toFixed(1)}h</strong></td></tr></tfoot>`;
    previewHtml += '</table></div>';

    // Add grace period info
    previewHtml += '<div class="mt-3"><h6>{% trans "Settings:" %}</h6><ul>';
    previewHtml += `<li>{% trans "Late Grace:" %} ${document.getElementById('id_late_grace_minutes').value || 0} {% trans "minutes" %}</li>`;
    previewHtml += `<li>{% trans "Early Departure Grace:" %} ${document.getElementById('id_early_departure_grace_minutes').value || 0} {% trans "minutes" %}</li>`;
    previewHtml += `<li>{% trans "Break Duration:" %} ${document.getElementById('id_break_duration_minutes').value || 0} {% trans "minutes" %}</li>`;
    previewHtml += `<li>{% trans "Overtime Threshold:" %} ${document.getElementById('id_overtime_threshold_minutes').value || 0} {% trans "minutes" %}</li>`;
    previewHtml += '</ul></div>';

    document.getElementById('schedulePreviewContent').innerHTML = previewHtml;
    const modal = new bootstrap.Modal(document.getElementById('schedulePreviewModal'));
    modal.show();
}
</script>
{% endblock %}