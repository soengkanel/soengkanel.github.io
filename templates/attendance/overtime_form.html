{% extends 'base/base.html' %}
{% load static i18n %}

{% block title %}
    {% if object %}
        {% trans "Edit Overtime Request" %}
    {% else %}
        {% trans "Request Overtime" %}
    {% endif %}
{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'ui/css/app.css' %}">
<!-- Choices.js for searchable dropdowns -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css">
<style>
    /* Choices.js customization to match form style */
    .choices__inner {
        height: 38px;
        min-height: 38px;
        padding: 0.5rem 0.75rem;
        font-size: 0.875rem;
        line-height: 1.25rem;
        border-radius: 0.375rem;
        border: 1px solid #d1d5db;
        display: flex;
        align-items: center;
    }
    .choices__inner:focus,
    .choices.is-focused .choices__inner {
        border-color: #3b82f6;
        outline: none;
        box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.5);
    }
    .choices__list--dropdown .choices__item--selectable {
        padding: 0.5rem 0.75rem;
        font-size: 0.875rem;
    }
    .choices__list--dropdown {
        border-color: #d1d5db;
        border-radius: 0.375rem;
    }
    .choices__item--selectable.is-highlighted {
        background-color: #3b82f6;
    }
    .choices[data-type*=select-one] .choices__input {
        font-size: 0.875rem;
        margin-bottom: 0;
    }
    .choices__list--single {
        padding: 0;
    }
</style>
{% endblock %}

{% block content %}
<main class="min-h-screen h-auto">
    <div class="px-5 py-3">
        <form method="post" novalidate>
            {% csrf_token %}

            <!-- Employee and Date -->
            <div class="grid grid-cols-2 gap-4 mb-4">
                <div class="col-span-2 md:col-span-1">
                    <label for="{{ form.employee.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">
                        {{ form.employee.label }} *
                    </label>
                    {{ form.employee }}
                    {% if form.employee.errors %}
                    <p class="text-xs text-red-600 mt-1">{{ form.employee.errors.0 }}</p>
                    {% endif %}
                </div>

                <div class="col-span-2 md:col-span-1">
                    <label for="{{ form.date.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">
                        {{ form.date.label }} *
                    </label>
                    {{ form.date }}
                    {% if form.date.errors %}
                    <p class="text-xs text-red-600 mt-1">{{ form.date.errors.0 }}</p>
                    {% endif %}
                </div>
            </div>

            <!-- Project (Optional) -->
            <div class="mb-4">
                <label for="{{ form.project.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">
                    {{ form.project.label }}
                </label>
                {{ form.project }}
                {% if form.project.errors %}
                <p class="text-xs text-red-600 mt-1">{{ form.project.errors.0 }}</p>
                {% else %}
                <p class="text-xs text-gray-500 mt-1">{% trans "Optional: Link overtime to a specific project" %}</p>
                {% endif %}
            </div>

            <!-- Start Time and End Time -->
            <div class="grid grid-cols-2 gap-4 mb-4">
                <div class="col-span-2 md:col-span-1">
                    <label for="{{ form.start_time.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">
                        {{ form.start_time.label }} *
                    </label>
                    {{ form.start_time }}
                    {% if form.start_time.errors %}
                    <p class="text-xs text-red-600 mt-1">{{ form.start_time.errors.0 }}</p>
                    {% endif %}
                    <p class="text-xs text-gray-500 mt-1">{% trans "When did the overtime period start?" %}</p>
                </div>

                <div class="col-span-2 md:col-span-1">
                    <label for="{{ form.end_time.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">
                        {{ form.end_time.label }} *
                    </label>
                    {{ form.end_time }}
                    {% if form.end_time.errors %}
                    <p class="text-xs text-red-600 mt-1">{{ form.end_time.errors.0 }}</p>
                    {% endif %}
                    <p class="text-xs text-gray-500 mt-1">{% trans "When did the overtime period end?" %}</p>
                </div>
            </div>

            <!-- Hours, Rate, Calculated Amount -->
            <div class="grid grid-cols-3 gap-4 mb-4">
                <div class="col-span-3 md:col-span-1">
                    <label for="{{ form.hours.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">
                        {{ form.hours.label }} *
                    </label>
                    {{ form.hours }}
                    {% if form.hours.errors %}
                    <p class="text-xs text-red-600 mt-1">{{ form.hours.errors.0 }}</p>
                    {% endif %}
                    <p class="text-xs text-gray-500 mt-1">{% trans "Total overtime hours worked" %}</p>
                </div>

                <div class="col-span-3 md:col-span-1">
                    <label for="{{ form.overtime_rate.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">
                        {{ form.overtime_rate.label }}
                    </label>
                    {{ form.overtime_rate }}
                    {% if form.overtime_rate.errors %}
                    <p class="text-xs text-red-600 mt-1">{{ form.overtime_rate.errors.0 }}</p>
                    {% endif %}
                    <p class="text-xs text-gray-500 mt-1">{% trans "Hourly overtime rate (leave blank for default)" %}</p>
                </div>

                <div class="col-span-3 md:col-span-1">
                    <label class="block text-sm font-medium text-gray-700 mb-1">
                        {% trans "Calculated Amount" %}
                    </label>
                    <div class="w-full px-3 py-2 bg-gray-100 border border-gray-300 rounded-md text-gray-700" id="calculated-amount">
                        $0.00
                    </div>
                    <p class="text-xs text-gray-500 mt-1">{% trans "Auto-calculated based on hours and rate" %}</p>
                </div>
            </div>

            <!-- Reason -->
            <div class="mb-4">
                <label for="{{ form.reason.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">
                    {{ form.reason.label }} *
                </label>
                {{ form.reason }}
                {% if form.reason.errors %}
                <p class="text-xs text-red-600 mt-1">{{ form.reason.errors.0 }}</p>
                {% endif %}
                <p class="text-xs text-gray-500 mt-1">{% trans "Provide detailed justification for the overtime work" %}</p>
            </div>

            <!-- Rejection Notice -->
            {% if object and object.status == 'rejected' %}
            <div class="mb-4 bg-red-50 border border-red-200 rounded-md p-4">
                <div class="flex">
                    <i class="fas fa-times-circle text-red-500 mt-0.5 mr-3"></i>
                    <div>
                        <h6 class="text-sm font-semibold text-red-800 mb-1">{% trans "Previous Rejection Reason" %}</h6>
                        <p class="text-sm text-red-700 mb-0">{{ object.rejection_reason }}</p>
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Request Status -->
            {% if object %}
            <div class="mb-4 bg-gray-50 border border-gray-200 rounded-md p-4">
                <h6 class="text-sm font-semibold text-gray-800 mb-3">
                    <i class="fas fa-info-circle mr-1"></i>{% trans "Request Status" %}
                </h6>
                <div class="grid grid-cols-3 gap-4">
                    <div>
                        <strong class="text-sm text-gray-700">{% trans "Current Status:" %}</strong><br>
                        <span class="inline-block mt-1 px-2 py-1 text-xs rounded {% if object.status == 'approved' %}bg-green-100 text-green-800{% elif object.status == 'rejected' %}bg-red-100 text-red-800{% elif object.status == 'pending' %}bg-yellow-100 text-yellow-800{% else %}bg-gray-100 text-gray-800{% endif %}">
                            {{ object.get_status_display }}
                        </span>
                    </div>
                    <div>
                        <strong class="text-sm text-gray-700">{% trans "Requested On:" %}</strong><br>
                        <span class="text-sm text-gray-600">{{ object.created_at|date:"Y-m-d H:i" }}</span>
                    </div>
                    <div>
                        {% if object.approved_by %}
                            <strong class="text-sm text-gray-700">{% trans "Approved By:" %}</strong><br>
                            <span class="text-sm text-gray-600">{{ object.approved_by.full_name }}</span>
                            <br><small class="text-xs text-gray-500">{{ object.approved_at|date:"Y-m-d H:i" }}</small>
                        {% elif object.rejected_by %}
                            <strong class="text-sm text-gray-700">{% trans "Rejected By:" %}</strong><br>
                            <span class="text-sm text-gray-600">{{ object.rejected_by.full_name }}</span>
                            <br><small class="text-xs text-gray-500">{{ object.rejected_at|date:"Y-m-d H:i" }}</small>
                        {% else %}
                            <strong class="text-sm text-gray-700">{% trans "Pending Review" %}</strong><br>
                            <small class="text-xs text-gray-500">{% trans "Awaiting manager approval" %}</small>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Actions -->
            <div class="flex justify-end items-center mt-3 mb-4 space-x-1">
                <a href="{% url 'attendance:overtime_list' %}"
                    class="button-min-danger">
                    <div>
                            <i class="fas fa-arrow-left mr-1"></i>
                            {% trans "Back" %}
                    </div>
                </a>
                {% if not object or object.status == 'draft' or object.status == 'rejected' %}
                <button type="submit" name="action" value="save_draft"
                        class="button-min-warn">
                    <div>
                        <i class="fas fa-save mr-1"></i>
                        <span>{% trans "Draft" %}</span>
                    </div>
                </button>
                <button type="submit" name="action" value="submit"
                        class="button-min-primary">
                        <div>
                            <i class="fas fa-paper-plane mr-1"></i>
                            <span>{% trans "Submit" %}</span>
                        </div>
                </button>
                {% else %}
                <button type="submit"
                        class="button-min-primary">
                    <div>
                        <i class="fas fa-save mr-1"></i>
                        <span>{% trans "Update" %}</span>
                    </div>
                </button>
                {% endif %}
            </div>
        </form>

        <!-- Manager Approval Section -->
        {% if object and object.status == 'pending' and perms.attendance.can_approve_overtime %}
        <div class="mt-6 bg-yellow-50 border border-yellow-200 rounded-md p-4">
            <h5 class="text-base font-semibold text-yellow-900 mb-3">
                <i class="fas fa-user-check mr-2"></i>{% trans "Manager Approval" %}
            </h5>
            <form method="post" action="{% url 'attendance:overtime_approve' object.pk %}">
                {% csrf_token %}

                <div class="mb-4">
                    <label for="approval_comments" class="block text-sm font-medium text-gray-700 mb-1">
                        {% trans "Approval Comments" %}
                    </label>
                    <textarea name="approval_comments" id="approval_comments"
                              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                              rows="3"
                              placeholder="{% trans 'Add any comments about this approval/rejection...' %}"></textarea>
                </div>

                <div class="flex gap-2">
                    <button type="submit" name="action" value="approve"
                            class="px-4 py-2 text-white bg-green-600 rounded-md hover:bg-green-700 transition-colors">
                        <i class="fas fa-check mr-1"></i>{% trans "Approve Request" %}
                    </button>
                    <button type="submit" name="action" value="reject"
                            class="px-4 py-2 text-white bg-red-600 rounded-md hover:bg-red-700 transition-colors">
                        <i class="fas fa-times mr-1"></i>{% trans "Reject Request" %}
                    </button>
                </div>
            </form>
        </div>
        {% endif %}
    </div>
</main>

<!-- Choices.js for searchable dropdowns -->
<script src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize Choices.js for employee and project dropdowns
    const employeeSelect = document.getElementById('{{ form.employee.id_for_label }}');
    const projectSelect = document.getElementById('{{ form.project.id_for_label }}');

    if (employeeSelect) {
        new Choices(employeeSelect, {
            searchEnabled: true,
            searchPlaceholderValue: 'Search employee...',
            itemSelectText: 'Click to select',
            shouldSort: false,
            removeItemButton: false,
            noResultsText: 'No employee found',
            noChoicesText: 'No employees available',
        });
    }

    if (projectSelect) {
        new Choices(projectSelect, {
            searchEnabled: true,
            searchPlaceholderValue: 'Search project...',
            itemSelectText: 'Click to select',
            shouldSort: false,
            removeItemButton: false,
            noResultsText: 'No project found',
            noChoicesText: 'No projects available',
        });
    }

    // Overtime calculation
    const hoursField = document.getElementById('{{ form.hours.id_for_label }}');
    const rateField = document.getElementById('{{ form.overtime_rate.id_for_label }}');
    const calculatedAmountDiv = document.getElementById('calculated-amount');
    const startTimeField = document.getElementById('{{ form.start_time.id_for_label }}');
    const endTimeField = document.getElementById('{{ form.end_time.id_for_label }}');

    function calculateAmount() {
        const hours = parseFloat(hoursField.value) || 0;
        const rate = parseFloat(rateField.value) || 1.5;
        const amount = hours * rate;
        calculatedAmountDiv.textContent = '$' + amount.toFixed(2);
    }

    function calculateHours() {
        if (startTimeField.value && endTimeField.value) {
            const start = new Date('2000-01-01T' + startTimeField.value);
            const end = new Date('2000-01-01T' + endTimeField.value);

            if (end > start) {
                const diffMs = end - start;
                const diffHours = diffMs / (1000 * 60 * 60);
                hoursField.value = diffHours.toFixed(2);
                calculateAmount();
            }
        }
    }

    // Event listeners
    if (hoursField) hoursField.addEventListener('input', calculateAmount);
    if (rateField) rateField.addEventListener('input', calculateAmount);
    if (startTimeField) startTimeField.addEventListener('change', calculateHours);
    if (endTimeField) endTimeField.addEventListener('change', calculateHours);

    // Initial calculation
    calculateAmount();
});
</script>
{% endblock %}