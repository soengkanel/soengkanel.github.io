{% extends 'base/base.html' %}
{% load static i18n %}

{% block title %}Manual Attendance Entry{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'ui/css/app.css' %}">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css">
<style>
    /* Choices.js customization - Global Design Standard */
    .choices__inner {
        min-height: 28px;
        padding: 6px 8px;
        font-size: 13px;
        line-height: 1.4;
        border-radius: 3px;
        border: 1px solid #e5e7eb;
        display: flex;
        align-items: center;
        box-shadow: none;
    }
    .choices__inner:focus,
    .choices.is-focused .choices__inner {
        border-color: #3b82f6;
        outline: none;
        box-shadow: none;
    }
    .choices__list--dropdown .choices__item--selectable {
        padding: 6px 8px;
        font-size: 13px;
    }
    .choices__list--dropdown {
        border-color: #e5e7eb;
        border-radius: 3px;
    }
    .choices__item--selectable.is-highlighted {
        background-color: #3b82f6;
    }
    .choices[data-type*=select-one] .choices__input {
        font-size: 13px;
        margin-bottom: 0;
    }
    .choices__list--single {
        padding: 0;
    }

    /* Form field styles - Global Design Standard */
    .form-control,
    .form-select,
    input[type="text"],
    input[type="date"],
    input[type="time"],
    select,
    textarea {
        font-size: 13px !important;
        padding: 6px 8px !important;
        height: auto !important;
        min-height: 28px !important;
        border-radius: 3px;
        border: 1px solid #e5e7eb;
        line-height: 1.4 !important;
        box-shadow: none !important;
    }

    .form-control:focus,
    .form-select:focus,
    input:focus,
    select:focus,
    textarea:focus {
        border-color: #3b82f6;
        outline: none;
        box-shadow: none !important;
    }

    textarea.form-control {
        min-height: 60px;
    }

    /* Labels - Global Design Standard */
    label {
        font-size: 10px !important;
        margin-bottom: 4px !important;
        font-weight: 500;
        color: #6b7280;
        text-transform: uppercase;
        letter-spacing: 0.2px;
        display: block;
    }

    /* Info boxes */
    .info-box {
        border: 1px solid #e5e7eb;
        border-radius: 6px;
        padding: 12px;
        margin-bottom: 12px;
    }

    .info-box.blue {
        background: #eff6ff;
        border-color: #dbeafe;
    }

    .info-box.yellow {
        background: #fef3c7;
        border-color: #fde68a;
    }

    .info-box h6 {
        font-size: 12px;
        font-weight: 600;
        color: #1a1a1a;
        margin: 0 0 8px 0;
    }

    .info-box p {
        font-size: 11px;
        margin: 0;
    }
</style>
{% endblock %}

{% block content %}
<main class="min-h-screen h-auto">
    <div class="px-5 py-3">
        <form method="post" novalidate class="bg-white border border-gray-200 rounded-lg p-6">
            {% csrf_token %}

            <!-- Employee and Date -->
            <div class="grid grid-cols-2 gap-4 mb-4">
                <div class="col-span-2 md:col-span-1">
                    <label for="{{ form.employee.id_for_label }}">
                        {{ form.employee.label }} *
                    </label>
                    {{ form.employee }}
                    {% if form.employee.errors %}
                    <p class="text-xs text-red-600 mt-1">{{ form.employee.errors.0 }}</p>
                    {% endif %}
                    <p class="text-xs text-gray-500 mt-1">Select the employee for this attendance record</p>
                </div>

                <div class="col-span-2 md:col-span-1">
                    <label for="{{ form.date.id_for_label }}">
                        {{ form.date.label }} *
                    </label>
                    {{ form.date }}
                    {% if form.date.errors %}
                    <p class="text-xs text-red-600 mt-1">{{ form.date.errors.0 }}</p>
                    {% endif %}
                </div>
            </div>

            <!-- Project -->
            <div class="mb-4">
                <label for="{{ form.current_project.id_for_label }}">
                    {{ form.current_project.label }} <span class="text-gray-500 text-xs">(Optional)</span>
                </label>
                {{ form.current_project }}
                {% if form.current_project.errors %}
                <p class="text-xs text-red-600 mt-1">{{ form.current_project.errors.0 }}</p>
                {% endif %}
                {% if form.current_project.help_text %}
                <p class="text-xs text-gray-500 mt-1">{{ form.current_project.help_text }}</p>
                {% endif %}
            </div>

            <!-- Clock In/Out Times -->
            <div class="grid grid-cols-2 gap-4 mb-4">
                <div class="col-span-2 md:col-span-1">
                    <label for="{{ form.clock_in.id_for_label }}">
                        {{ form.clock_in.label }}
                    </label>
                    {{ form.clock_in }}
                    {% if form.clock_in.errors %}
                    <p class="text-xs text-red-600 mt-1">{{ form.clock_in.errors.0 }}</p>
                    {% endif %}
                    <p class="text-xs text-gray-500 mt-1">When did the employee start work?</p>
                </div>

                <div class="col-span-2 md:col-span-1">
                    <label for="{{ form.clock_out.id_for_label }}">
                        {{ form.clock_out.label }}
                    </label>
                    {{ form.clock_out }}
                    {% if form.clock_out.errors %}
                    <p class="text-xs text-red-600 mt-1">{{ form.clock_out.errors.0 }}</p>
                    {% endif %}
                    <p class="text-xs text-gray-500 mt-1">When did the employee finish work?</p>
                </div>
            </div>

            <!-- Status and Manual Entry Reason -->
            <div class="grid grid-cols-2 gap-4 mb-4">
                <div class="col-span-2 md:col-span-1">
                    <label for="{{ form.status.id_for_label }}">
                        {{ form.status.label }}
                    </label>
                    {{ form.status }}
                    {% if form.status.errors %}
                    <p class="text-xs text-red-600 mt-1">{{ form.status.errors.0 }}</p>
                    {% endif %}
                </div>

                <div class="col-span-2 md:col-span-1">
                    <label for="{{ form.manual_entry_reason.id_for_label }}">
                        {{ form.manual_entry_reason.label }} *
                    </label>
                    {{ form.manual_entry_reason }}
                    {% if form.manual_entry_reason.errors %}
                    <p class="text-xs text-red-600 mt-1">{{ form.manual_entry_reason.errors.0 }}</p>
                    {% endif %}
                    <p class="text-xs text-gray-500 mt-1">Required: Explain why manual entry is needed</p>
                </div>
            </div>

            <!-- Notes -->
            <div class="mb-4">
                <label for="{{ form.notes.id_for_label }}">
                    {{ form.notes.label }}
                </label>
                {{ form.notes }}
                {% if form.notes.errors %}
                <p class="text-xs text-red-600 mt-1">{{ form.notes.errors.0 }}</p>
                {% endif %}
                <p class="text-xs text-gray-500 mt-1">Add any additional notes or reasons for manual entry</p>
            </div>

            <!-- Work Hours Calculation Display -->
            <div class="info-box blue">
                <h6>Calculated Work Hours</h6>
                <div class="grid grid-cols-4 gap-4" id="calculation-display">
                    <div>
                        <strong class="text-xs text-gray-700">Total Hours:</strong>
                        <div class="text-xs text-gray-600 mt-1" id="total-hours">--</div>
                    </div>
                    <div>
                        <strong class="text-xs text-gray-700">Break Time:</strong>
                        <div class="text-xs text-gray-600 mt-1" id="break-time">--</div>
                    </div>
                    <div>
                        <strong class="text-xs text-gray-700">Net Hours:</strong>
                        <div class="text-xs text-gray-600 mt-1" id="net-hours">--</div>
                    </div>
                    <div>
                        <strong class="text-xs text-gray-700">Overtime:</strong>
                        <div class="text-xs text-gray-600 mt-1" id="overtime-hours">--</div>
                    </div>
                </div>
                <p class="text-xs text-gray-500 mt-2">Hours are calculated automatically based on clock in/out times and breaks</p>
            </div>

            <!-- Warning for Manual Entry -->
            <div class="info-box yellow">
                <h6>Manual Entry Notice</h6>
                <p class="text-yellow-800">This attendance record will be marked as manually entered and will require manager approval. Make sure all information is accurate.</p>
            </div>

            <!-- Action Buttons -->
            <div class="flex items-center justify-end space-x-3 mb-3">
                <a href="{% url 'attendance:attendance_list' %}" class="button-min-danger">
                    Cancel
                </a>
                <button type="button" onclick="previewRecord()" class="button-min-default">
                    Preview
                </button>
                <button type="submit" class="button-min-primary px-4">
                    Save
                </button>
            </div>
        </form>
    </div>
</main>

<!-- Preview Modal -->
<div id="previewModal" class="hidden fixed inset-0 z-50 overflow-y-auto">
    <div class="flex items-center justify-center min-h-screen px-4">
        <div class="fixed inset-0 bg-black opacity-50" onclick="closePreviewModal()"></div>
        <div class="relative bg-white rounded-lg shadow-xl max-w-2xl w-full">
            <div class="flex justify-between items-center p-4 border-b border-gray-200">
                <h5 class="text-lg font-semibold text-gray-900">
                    Attendance Record Preview
                </h5>
                <button type="button" onclick="closePreviewModal()" class="text-gray-400 hover:text-gray-600">
                    Ã—
                </button>
            </div>
            <div class="p-4" id="preview-content">
                <!-- Preview content will be populated by JavaScript -->
            </div>
            <div class="flex justify-end p-4 border-t border-gray-200">
                <button type="button" onclick="closePreviewModal()" class="button-min-default">
                    Close
                </button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize Choices.js for employee dropdown
    const employeeSelect = document.getElementById('{{ form.employee.id_for_label }}');

    if (employeeSelect) {
        new Choices(employeeSelect, {
            searchEnabled: true,
            searchPlaceholderValue: 'Search employee...',
            itemSelectText: 'Click to select',
            shouldSort: false,
            removeItemButton: false,
            noResultsText: 'No employee found',
            noChoicesText: 'No employees available',
        });
    }

    // Initialize Choices.js for project dropdown (optional)
    const projectSelect = document.getElementById('{{ form.current_project.id_for_label }}');

    if (projectSelect) {
        new Choices(projectSelect, {
            searchEnabled: true,
            searchPlaceholderValue: 'Search project or leave empty...',
            itemSelectText: 'Click to select',
            shouldSort: false,
            removeItemButton: true,
            noResultsText: 'No project found',
            noChoicesText: 'No projects available',
            allowHTML: false,
        });
    }

    // Hours calculation
    const clockInField = document.getElementById('{{ form.clock_in.id_for_label }}');
    const clockOutField = document.getElementById('{{ form.clock_out.id_for_label }}');

    function calculateHours() {
        const clockIn = clockInField.value;
        const clockOut = clockOutField.value;
        const breakMinutes = 0; // No break field in this form

        if (clockIn && clockOut) {
            // Calculate total hours
            const start = new Date(`2000-01-01T${clockIn}`);
            const end = new Date(`2000-01-01T${clockOut}`);

            if (end > start) {
                const diffMs = end - start;
                const totalMinutes = diffMs / (1000 * 60);
                const totalHours = totalMinutes / 60;
                const netMinutes = totalMinutes - breakMinutes;
                const netHours = netMinutes / 60;

                // Standard work day (8 hours)
                const standardHours = 8;
                const overtimeHours = Math.max(0, netHours - standardHours);

                // Update display
                document.getElementById('total-hours').textContent = totalHours.toFixed(2) + 'h';
                document.getElementById('break-time').textContent = breakMinutes + 'min';
                document.getElementById('net-hours').textContent = netHours.toFixed(2) + 'h';
                document.getElementById('overtime-hours').textContent = overtimeHours > 0 ? overtimeHours.toFixed(2) + 'h' : 'None';
            } else {
                // Reset display
                document.getElementById('total-hours').textContent = '--';
                document.getElementById('break-time').textContent = '--';
                document.getElementById('net-hours').textContent = '--';
                document.getElementById('overtime-hours').textContent = '--';
            }
        }
    }

    // Add event listeners
    if (clockInField) clockInField.addEventListener('change', calculateHours);
    if (clockOutField) clockOutField.addEventListener('change', calculateHours);

    // Set default date to today
    const dateField = document.getElementById('{{ form.date.id_for_label }}');
    if (dateField && !dateField.value) {
        dateField.value = new Date().toISOString().split('T')[0];
    }

    // Initial calculation
    calculateHours();
});

function previewRecord() {
    const form = document.querySelector('form');
    const formData = new FormData(form);

    let previewHtml = '<div class="grid grid-cols-2 gap-4 mb-4">';

    // Employee
    const employeeSelect = document.getElementById('{{ form.employee.id_for_label }}');
    const employeeName = employeeSelect.options[employeeSelect.selectedIndex].text;
    previewHtml += `<div><strong class="text-sm text-gray-700">Employee:</strong><br><span class="text-sm text-gray-600">${employeeName}</span></div>`;

    // Date
    const date = formData.get('date');
    previewHtml += `<div><strong class="text-sm text-gray-700">Date:</strong><br><span class="text-sm text-gray-600">${date}</span></div>`;

    // Clock times
    const clockIn = formData.get('clock_in');
    const clockOut = formData.get('clock_out');
    previewHtml += `<div><strong class="text-sm text-gray-700">Clock In:</strong><br><span class="text-sm text-gray-600">${clockIn || 'Not set'}</span></div>`;
    previewHtml += `<div><strong class="text-sm text-gray-700">Clock Out:</strong><br><span class="text-sm text-gray-600">${clockOut || 'Not set'}</span></div>`;

    // Status
    const statusSelect = document.getElementById('{{ form.status.id_for_label }}');
    const statusName = statusSelect.options[statusSelect.selectedIndex].text;
    previewHtml += `<div><strong class="text-sm text-gray-700">Status:</strong><br><span class="text-sm text-gray-600">${statusName}</span></div>`;

    // Manual entry reason
    const reason = formData.get('manual_entry_reason') || '';
    previewHtml += `<div><strong class="text-sm text-gray-700">Entry Reason:</strong><br><span class="text-sm text-gray-600">${reason}</span></div>`;

    previewHtml += '</div>';

    // Notes
    const notes = formData.get('notes');
    if (notes) {
        previewHtml += `<div class="pt-4 border-t border-gray-200"><strong class="text-sm text-gray-700">Notes:</strong><br><p class="text-sm text-gray-600 mt-1">${notes}</p></div>`;
    }

    // Calculation summary
    previewHtml += '<div class="pt-4 border-t border-gray-200 bg-blue-50 border border-blue-200 rounded-md p-4 mt-4">';
    previewHtml += '<strong class="text-sm text-gray-700">Calculated Hours:</strong><br>';
    previewHtml += '<div class="grid grid-cols-4 gap-4 mt-2">';
    previewHtml += '<div><span class="text-xs text-gray-600">Total:</span><br><strong class="text-sm">' + document.getElementById('total-hours').textContent + '</strong></div>';
    previewHtml += '<div><span class="text-xs text-gray-600">Break:</span><br><strong class="text-sm">' + document.getElementById('break-time').textContent + '</strong></div>';
    previewHtml += '<div><span class="text-xs text-gray-600">Net:</span><br><strong class="text-sm">' + document.getElementById('net-hours').textContent + '</strong></div>';
    previewHtml += '<div><span class="text-xs text-gray-600">Overtime:</span><br><strong class="text-sm">' + document.getElementById('overtime-hours').textContent + '</strong></div>';
    previewHtml += '</div></div>';

    document.getElementById('preview-content').innerHTML = previewHtml;
    document.getElementById('previewModal').classList.remove('hidden');
}

function closePreviewModal() {
    document.getElementById('previewModal').classList.add('hidden');
}
</script>
{% endblock %}
