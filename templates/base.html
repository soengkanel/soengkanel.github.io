{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="csrf-token" content="{{ csrf_token }}">
    <title>{% block title %}{{ system_title }}{% endblock %}</title>
    
    <!-- Bootstrap CSS (Local) -->
    <link href="{% static 'vendor/bootstrap/bootstrap.min.css' %}" rel="stylesheet">
    <!-- Bootstrap Icons (Local) -->
    <link rel="stylesheet" href="{% static 'vendor/bootstrap-icons/bootstrap-icons.css' %}">
    <!-- FontAwesome (Local) -->
    <link rel="stylesheet" href="{% static 'vendor/fontawesome/css/all.min.css' %}">
    
    <!-- Base CSS Files -->
    <link rel="stylesheet" href="{% static 'css/base.css' %}">
    
    <!-- Sidebar CSS -->
    <link rel="stylesheet" href="{% static 'css/sidebar.css' %}">
    
    <!-- Core CSS Files -->
    <link rel="stylesheet" href="{% static 'css/utilities.css' %}">

    <!-- Common Component CSS Files -->
    <link rel="stylesheet" href="{% static 'css/forms.css' %}">
    <link rel="stylesheet" href="{% static 'css/lists-tables.css' %}">

    <!-- Module-Specific CSS Files -->
    <link rel="stylesheet" href="{% static 'css/auth.css' %}">
    <link rel="stylesheet" href="{% static 'css/delete-confirm.css' %}">
    <link rel="stylesheet" href="{% static 'css/tailwind.min.css' %}">
    <link rel="stylesheet" href="{% static 'css/button-mini.css' %}">

    <!-- Custom CSS Block for Individual Pages -->
    {% block extra_css %}{% endblock %}

    <!-- Header Fix CSS -->
    <style>
        /* Fancy Logo Styling with Brand Colors */
        .logo-text {
            font-family: 'Arial Black', 'Helvetica Neue', Arial, sans-serif;
            font-size: 22px !important;
            font-weight: 900 !important;
            letter-spacing: 3px;
            transition: all 0.3s ease;
        }

        .logo-text:hover {
            letter-spacing: 4px;
            transform: scale(1.08);
        }

        .logo-text strong {
            font-weight: 900 !important;
            display: inline-block;
        }
        .logo-ng {
            color: #1d6652 !important;
        }

        .logo-hr {
            color: #FDB913 !important;
        }
        /* Compact header design */
        .loper-header {
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            right: 0 !important;
            z-index: 1030 !important;
            background: #87CEEB !important; /* Light blue background */
            border-bottom: 1px solid #4682B4 !important;
            height: 40px !important; /* Reduced from 60px to 40px */
            box-shadow: 0 0.1rem 0.5rem 0 rgba(58, 59, 69, 0.1) !important;
        }
        /* Compact header design */
        .loper-header {
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            right: 0 !important;
            z-index: 1030 !important;
            background: #87CEEB !important; /* Light blue background */
            border-bottom: 1px solid #4682B4 !important;
            height: 40px !important; /* Reduced from 60px to 40px */
            box-shadow: 0 0.1rem 0.5rem 0 rgba(58, 59, 69, 0.1) !important;
        }
        
        /* Ensure body has proper top padding */
        body {
            padding-top: 40px !important; /* Reduced to match header height */
        }
        
        /* Fix sidebar positioning */
        .sidebar {
            top: 40px !important; /* Reduced to match header height */
            height: calc(100vh - 40px) !important;
            z-index: 1020 !important;
        }
        
        /* Mobile header fixes */
        @media (max-width: 768px) {
            .header-center {
                display: none !important;
            }
            
            .user-details {
                display: none !important;
            }
            
            .brand-name {
                display: none !important;
            }
        }
        
        /* Ensure dropdown menus appear above other elements */
        .dropdown-menu {
            z-index: 1050 !important;
        }
        
        /* User dropdown button hover effect */
        .btn-link:hover {
            background-color: rgba(255, 255, 255, 0.1) !important;
            border-radius: 4px !important;
        }
        
        /* Professional Logout Modal Styling */
        #logoutModal .modal-content {
            border: none !important;
            border-radius: 12px !important;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1) !important;
        }
        
        #logoutModal .modal-header {
            background: linear-gradient(135deg, #f8f9fc 0%, #ffffff 100%) !important;
            border-radius: 12px 12px 0 0 !important;
        }
        
        #logoutModal .modal-body {
            background: #ffffff !important;
        }
        
        #logoutModal .modal-footer {
            background: #f8f9fc !important;
            border-radius: 0 0 12px 12px !important;
        }
        
        #logoutModal .btn {
            border-radius: 8px !important;
            font-weight: 500 !important;
            padding: 8px 20px !important;
            transition: all 0.2s ease !important;
        }
        
        #logoutModal .btn-danger {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%) !important;
            border: none !important;
            box-shadow: 0 2px 8px rgba(220, 53, 69, 0.3) !important;
        }
        
        #logoutModal .btn-danger:hover {
            transform: translateY(-1px) !important;
            box-shadow: 0 4px 15px rgba(220, 53, 69, 0.4) !important;
        }
        
        #logoutModal .btn-secondary {
            background: #6c757d !important;
            border: none !important;
        }
        
        #logoutModal .btn-secondary:hover {
            background: #5a6268 !important;
            transform: translateY(-1px) !important;
        }
        
        /* Smooth modal animations */
        .modal.fade .modal-dialog {
            transform: translate(0, -50px) !important;
            transition: transform 0.3s ease-out !important;
        }
        
        .modal.show .modal-dialog {
            transform: translate(0, 0) !important;
        }
        
        /* Fix main content positioning */
        #main-content {
            margin-top: 0 !important;
            padding-top: 1rem !important;
        }
        
        /* Ensure toast container is above everything */
        .toast-container {
            z-index: 1050 !important;
        }
        
        /* Compact header elements */
        .loper-header .header-container {
            padding: 0 8px !important; /* Reduced padding */
            height: 100% !important;
        }
        
        .loper-header .menu-toggle {
            color: #1e3a8a !important;
            background: transparent !important;
            border: none !important;
            padding: 4px 6px !important; /* Compact padding */
            font-size: 14px !important; /* Smaller icon */
            border-radius: 3px !important;
        }
        
        .loper-header .menu-toggle:hover {
            background: rgba(30, 58, 138, 0.1) !important;
            color: #1e40af !important;
        }
        
        .loper-header .brand-logo {
            color: #1e3a8a !important;
            font-size: 14px !important; /* Smaller brand text */
            gap: 4px !important; /* Reduced gap */
        }
        
        .loper-header .brand-logo:hover {
            color: #1e40af !important;
            text-decoration: none !important;
        }
        
        .loper-header .brand-logo i {
            color: #f59e0b !important;
            font-size: 16px !important; /* Smaller icon */
        }
        
        .loper-header .brand-name {
            font-size: 13px !important; /* Compact brand name */
        }
        
        .loper-header .search-field {
            background: rgba(255, 255, 255, 0.95) !important;
            border: none !important;
            color: #1f2937 !important;
            border-radius: 3px !important;
            padding: 4px 8px 4px 24px !important; /* Compact padding */
            font-size: 12px !important; /* Smaller text */
            height: 28px !important; /* Reduced height */
        }
        
        .loper-header .search-field::placeholder {
            color: #6b7280 !important;
        }
        
        .loper-header .search-field:focus {
            background: #ffffff !important;
            border: none !important; /* Remove outline */
            box-shadow: 0 0 0 2px rgba(30, 58, 138, 0.3) !important;
        }
        
        .loper-header .main-search i {
            color: #6b7280 !important;
            font-size: 12px !important; /* Smaller search icon */
            left: 8px !important; /* Adjusted position */
        }
        
        .loper-header .header-center {
            margin: 0 12px !important; /* Reduced margins */
            max-width: 300px !important; /* Smaller search area */
        }
        
        .loper-header .nav-icon-btn {
            color: #1e3a8a !important;
            background: transparent !important;
            border: none !important;
            border-radius: 3px !important;
            padding: 4px 6px !important; /* Compact padding */
            font-size: 13px !important; /* Smaller icons */
        }
        
        .loper-header .nav-icon-btn:hover {
            background: rgba(30, 58, 138, 0.1) !important;
            color: #1e40af !important;
            border: none !important;
        }
        
        .loper-header .header-right {
            gap: 4px !important; /* Reduced gap between buttons */
        }
        
        .loper-header .user-profile-btn {
            color: #1e3a8a !important;
            background: transparent !important;
            border: none !important;
            border-radius: 3px !important;
            padding: 2px 4px !important; /* Very compact padding */
            gap: 6px !important; /* Reduced gap */
        }
        
        .loper-header .user-profile-btn:hover {
            background: rgba(30, 58, 138, 0.1) !important;
        }
        
        .loper-header .user-display-name {
            color: #1e3a8a !important;
            font-weight: 600 !important;
            font-size: 12px !important; /* Smaller text */
        }
        
        .loper-header .user-role {
            color: #4b5563 !important;
            font-size: 10px !important; /* Smaller role text */
        }

        /* Compact avatar styling */
        .profile-avatar, .profile-avatar-large {
            object-fit: cover !important;
            background-color: #f8f9fc !important;
            border: 1px solid #1e3a8a !important; /* Thinner border */
            border-radius: 50% !important;
        }
        
        .profile-avatar {
            width: 24px !important; /* Smaller avatar */
            height: 24px !important;
        }
        
        .profile-avatar-large {
            width: 32px !important; /* Smaller large avatar */
            height: 32px !important;
        }
        
        /* Mobile sidebar overlay fixes */
        .sidebar-overlay {
            position: fixed !important;
            top: 40px !important; /* Adjusted for compact header */
            left: 0 !important;
            width: 100% !important;
            height: calc(100vh - 40px) !important;
            background: rgba(0, 0, 0, 0.5) !important;
            z-index: 1019 !important;
            opacity: 0 !important;
            visibility: hidden !important;
            transition: all 0.3s ease !important;
        }
        
        .sidebar-overlay.active {
            opacity: 1 !important;
            visibility: visible !important;
        }
        
        /* Mobile sidebar behavior */
        @media (max-width: 768px) {
            .sidebar {
                width: 280px !important;
                transform: translateX(-100%) !important;
                top: 40px !important; /* Adjusted for compact header */
                height: calc(100vh - 40px) !important;
            }
            
            .sidebar.mobile-open {
                transform: translateX(0) !important;
            }
            
            .sidebar.collapsed {
                width: 280px !important;
            }
        }




        /* Ultra Minimal Compact Notification Dropdown */
        .notification-dropdown-minimal {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif !important;
            background: #ffffff !important;
        }
        
        .notification-dropdown-header {
            background: #f8f9fc !important;
            color: #2d3748 !important;
            padding: 8px 12px !important;
            display: flex !important;
            justify-content: space-between !important;
            align-items: center !important;
            border-bottom: 1px solid #e2e8f0 !important;
        }
        
        .notification-dropdown-title {
            font-size: 13px !important;
            font-weight: 600 !important;
            margin: 0 !important;
            display: flex !important;
            align-items: center !important;
            gap: 6px !important;
            color: #4a5568 !important;
        }
        
        .notification-dropdown-title i {
            font-size: 12px !important;
            color: #718096 !important;
        }
        
        .notification-dropdown-badge {
            background: #3182ce !important;
            color: white !important;
            font-size: 9px !important;
            font-weight: 600 !important;
            padding: 2px 6px !important;
            border-radius: 8px !important;
            min-width: 16px !important;
            text-align: center !important;
            line-height: 1.2 !important;
        }
        
        .notification-dropdown-action {
            background: #f7fafc !important;
            border-bottom: 1px solid #e2e8f0 !important;
            padding: 6px 12px !important;
            text-align: right !important;
        }
        
        .mark-all-read-btn {
            background: transparent !important;
            color: #4299e1 !important;
            border: none !important;
            padding: 4px 8px !important;
            font-size: 11px !important;
            font-weight: 500 !important;
            cursor: pointer !important;
            transition: color 0.15s ease !important;
            text-decoration: none !important;
        }
        
        .mark-all-read-btn:hover {
            color: #2b6cb0 !important;
        }
        
        .notification-dropdown-list {
            max-height: 280px !important;
            overflow-y: auto !important;
            scrollbar-width: thin !important;
            scrollbar-color: #cbd5e0 transparent !important;
        }
        
        .notification-dropdown-list::-webkit-scrollbar {
            width: 3px !important;
        }
        
        .notification-dropdown-list::-webkit-scrollbar-track {
            background: transparent !important;
        }
        
        .notification-dropdown-list::-webkit-scrollbar-thumb {
            background: #cbd5e0 !important;
            border-radius: 2px !important;
        }
        
        .notification-dropdown-item {
            padding: 8px 12px !important;
            border-bottom: 1px solid #f7fafc !important;
            display: flex !important;
            align-items: center !important;
            gap: 8px !important;
            transition: background 0.15s ease !important;
            cursor: pointer !important;
            position: relative !important;
        }
        
        .notification-dropdown-item:last-child {
            border-bottom: none !important;
        }
        
        .notification-dropdown-item:hover {
            background: #f7fafc !important;
        }
        
        .notification-dropdown-item.unread {
            background: #ebf8ff !important;
            border-left: 2px solid #3182ce !important;
        }
        
        .notification-dropdown-item.unread::before {
            content: '' !important;
            position: absolute !important;
            left: 6px !important;
            top: 12px !important;
            width: 4px !important;
            height: 4px !important;
            background: #3182ce !important;
            border-radius: 50% !important;
        }
        
        .notification-dropdown-icon {
            width: 20px !important;
            height: 20px !important;
            border-radius: 4px !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            font-size: 10px !important;
            font-weight: 500 !important;
            color: white !important;
            flex-shrink: 0 !important;
        }
        
        .notification-dropdown-icon.critical {
            background: #e53e3e !important;
        }
        
        .notification-dropdown-icon.high {
            background: #dd6b20 !important;
        }
        
        .notification-dropdown-icon.medium {
            background: #d69e2e !important;
        }
        
        .notification-dropdown-icon.low {
            background: #38a169 !important;
        }
        
        .notification-dropdown-content {
            flex: 1 !important;
            min-width: 0 !important;
        }
        
        .notification-dropdown-subject {
            font-size: 12px !important;
            font-weight: 500 !important;
            color: #2d3748 !important;
            margin: 0 0 2px 0 !important;
            line-height: 1.3 !important;
            display: -webkit-box !important;
            -webkit-line-clamp: 1 !important;
            -webkit-box-orient: vertical !important;
            overflow: hidden !important;
        }
        
        .notification-dropdown-message {
            font-size: 11px !important;
            color: #718096 !important;
            margin: 0 0 2px 0 !important;
            line-height: 1.3 !important;
            display: -webkit-box !important;
            -webkit-line-clamp: 1 !important;
            -webkit-box-orient: vertical !important;
            overflow: hidden !important;
        }
        
        .notification-dropdown-time {
            font-size: 9px !important;
            color: #a0aec0 !important;
            font-weight: 400 !important;
        }
        
        .notification-dropdown-arrow {
            display: flex !important;
            align-items: center !important;
            color: #cbd5e0 !important;
            font-size: 10px !important;
            opacity: 0 !important;
            transition: opacity 0.15s ease !important;
        }
        
        .notification-dropdown-item:hover .notification-dropdown-arrow {
            opacity: 1 !important;
        }
        
        .notification-dropdown-empty {
            padding: 24px 12px !important;
            text-align: center !important;
            color: #a0aec0 !important;
        }
        
        .notification-dropdown-empty i {
            font-size: 24px !important;
            color: #e2e8f0 !important;
            margin-bottom: 8px !important;
            display: block !important;
        }
        
        .empty-title {
            font-size: 12px !important;
            font-weight: 500 !important;
            margin: 0 0 2px 0 !important;
            color: #718096 !important;
        }
        
        .empty-subtitle {
            font-size: 10px !important;
            color: #a0aec0 !important;
            margin: 0 !important;
        }
        
        .notification-dropdown-footer {
            background: #f7fafc !important;
            border-top: 1px solid #e2e8f0 !important;
            padding: 6px 12px !important;
        }
        
        .view-all-btn {
            display: block !important;
            width: 100% !important;
            text-align: center !important;
            padding: 6px 8px !important;
            background: transparent !important;
            color: #4299e1 !important;
            text-decoration: none !important;
            border: none !important;
            font-size: 11px !important;
            font-weight: 500 !important;
            transition: color 0.15s ease !important;
        }
        
        .view-all-btn:hover {
            color: #2b6cb0 !important;
            text-decoration: none !important;
        }

        /* Responsive minimal notification dropdown */
        @media (max-width: 768px) {
            .notification-dropdown-minimal {
                width: 280px !important;
                max-height: 360px !important;
            }
            
            .notification-dropdown-item {
                padding: 6px 10px !important;
                gap: 6px !important;
            }
            
            .notification-dropdown-icon {
                width: 18px !important;
                height: 18px !important;
                font-size: 9px !important;
            }
        }
        .sidebar-w-full{
            width:15%;
        }
        .sidebar-w-0{
            width:0;
            overflow:hidden;
        }
        
        /* Mobile sidebar styles */
        @media (max-width: 768px) {
            .sidebar-w-full {
                width: 280px !important;
                position: fixed !important;
                z-index: 1025 !important;
            }
            
            .sidebar-w-0 {
                width: 0 !important;
                transform: translateX(-100%);
            }
        }
        
        /* Sidebar overlay styles */
        .sidebar-overlay {
            position: fixed;
            top: 40px;
            left: 0;
            width: 100%;
            height: calc(100vh - 40px);
            background: rgba(0, 0, 0, 0.5);
            z-index: 1024;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }
        
        .sidebar-overlay.active {
            opacity: 1;
            visibility: visible;
        }
        
        /* Main content responsive behavior */
        #main-content {
            transition: none !important;
        }

        /* Page load animation - smooth fade in without horizontal movement */
        @keyframes fadeInContent {
            0% {
                opacity: 0;
                transform: translateY(10px);
            }
            100% {
                opacity: 1;
                transform: translateY(0);
            }
        }

        #main-content {
            animation: fadeInContent 0.4s ease-out forwards;
        }

        /* Only transition width/margin when sidebar is toggled, not on page load */
        #main-content.sidebar-transitioning {
            transition: width 0.3s ease, margin-left 0.3s ease !important;
        }
        
        /* Ensure mobile main content is always full width */
        @media (max-width: 768px) {
            #main-content {
                width: 100% !important;
                margin-left: 0 !important;
            }
        }
    </style>
</head>

<body>
    <!-- Toast Container for notifications -->
    <div class="toast-container position-fixed top-0 end-0 p-3" id="toast-container" role="alert" aria-live="polite" aria-atomic="true">
        <!-- Toasts will be dynamically added here -->
    </div>
    


    {% if user.is_authenticated %}
        <!-- Navbar -->
         {% include 'navbar.html' %}
        <!-- Navbar -->

        <div class="container-fluid">
            <div class="flex items-start">
                {% include 'partials/sidebar.html' %}
    
                <!-- Sidebar overlay for mobile -->
                <div id="sidebar-overlay" class="sidebar-overlay"></div>

                <main id="main-content" class="{% block main_class %} main-content {% endblock %} px-1 transition-bg-color" role="main" style="width:85%;">
                    <!-- Messages -->
                    {% if messages %}
                        <div class="mt-3 ">
                            {% for message in messages %}
                                <div class="alert alert-{% if message.tags == 'error' %}danger{% elif message.tags == 'warning' %}warning{% elif message.tags == 'success' %}success{% else %}info{% endif %} alert-dismissible fade show" role="alert">
                                    {{ message }}
                                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                                </div>
                            {% endfor %}
                        </div>
                    {% endif %}
                    
                    {% block content %}{% endblock %}
                </main>
            </div>
        </div>
    {% else %}
        <!-- Content for non-authenticated users -->
        {% block unauthenticated_content %}{% endblock %}
    {% endif %}
    
    <!-- Bootstrap JS -->
    <script src="{% static 'vendor/bootstrap/bootstrap.bundle.min.js' %}"></script>
    
    <!-- Bootstrap Dropdown Fix Script -->
    <script>
    // Ensure Bootstrap dropdowns work properly
    document.addEventListener('DOMContentLoaded', function() {
        // Initialize all dropdowns
        const dropdownTriggerList = document.querySelectorAll('[data-bs-toggle="dropdown"]');
        
        dropdownTriggerList.forEach(function(dropdownTriggerEl) {
            new bootstrap.Dropdown(dropdownTriggerEl);
        });
        
        // Professional Logout Modal Enhancement
        const logoutModal = document.getElementById('logoutModal');
        if (logoutModal) {
            // Add subtle animation when modal opens
            logoutModal.addEventListener('show.bs.modal', function() {
                // Auto-focus the Cancel button for better UX
                setTimeout(() => {
                    const cancelBtn = logoutModal.querySelector('.btn-danger[data-bs-dismiss="modal"]');
                    if (cancelBtn) cancelBtn.focus();
                }, 300);
            });
            
            // Handle keyboard shortcuts
            logoutModal.addEventListener('keydown', function(e) {
                // Enter key should trigger logout (dangerous action)
                if (e.key === 'Enter') {
                    e.preventDefault();
                    const logoutBtn = logoutModal.querySelector('.btn-danger');
                    if (logoutBtn) logoutBtn.click();
                }
                // Escape key should cancel
                if (e.key === 'Escape') {
                    bootstrap.Modal.getInstance(logoutModal).hide();
                }
            });
        }
    });
    </script>
    
    <!-- UI/UX Enhancement Scripts -->
    <script>
    // Toast Notification System
    const toast = {
        show: function(message, type = 'info', duration = 5000) {
            const toastContainer = document.getElementById('toast-container');
            const toastId = 'toast-' + Date.now();
            
            const iconMap = {
                success: 'bi-check-circle-fill',
                error: 'bi-x-circle-fill',
                warning: 'bi-exclamation-triangle-fill',
                info: 'bi-info-circle-fill'
            };
            
            const toastHtml = `
                <div id="${toastId}" class="toast align-items-center text-bg-${type === 'error' ? 'danger' : type} border-0" role="alert" aria-live="assertive" aria-atomic="true">
                    <div class="d-flex">
                        <div class="toast-body d-flex align-items-center">
                            <i class="bi ${iconMap[type]} me-2 icon-md"></i>
                            ${message}
                        </div>
                        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                    </div>
                </div>
            `;
            
            toastContainer.insertAdjacentHTML('beforeend', toastHtml);
            
            const toastElement = document.getElementById(toastId);
            const bsToast = new bootstrap.Toast(toastElement, {
                delay: duration,
                autohide: true
            });
            
            bsToast.show();
            
            // Remove toast from DOM after it's hidden
            toastElement.addEventListener('hidden.bs.toast', function() {
                this.remove();
            });
        },
        
        success: function(message, duration = 5000) {
            this.show(message, 'success', duration);
        },
        
        error: function(message, duration = 7000) {
            this.show(message, 'error', duration);
        },
        
        warning: function(message, duration = 6000) {
            this.show(message, 'warning', duration);
        },
        
        info: function(message, duration = 5000) {
            this.show(message, 'info', duration);
        }
    };

    // Notification functions
    function markAllNotificationsRead() {
        fetch('/notifications/read-all/', {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken'),
                'Content-Type': 'application/json',
            },
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Update notification badge
                const badge = document.querySelector('.notification-dropdown-container .badge');
                if (badge) {
                    badge.remove();
                }
                
                // Update notification items
                document.querySelectorAll('.notification-item.bg-light').forEach(item => {
                    item.classList.remove('bg-light');
                });
                
                toast.success(`Marked ${data.count} notifications as read`);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            toast.error('Failed to mark notifications as read');
        });
    }

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    // Enhanced button interactions
    document.addEventListener('DOMContentLoaded', function() {
        // Get all alerts for both conversion and auto-hide functionality
        const alerts = document.querySelectorAll('.alert:not(.alert-permanent)');
        
        // Convert Django messages to toasts
        const convertMessagesToToasts = () => {
            if (alerts.length === 0) return;
            
            // Track shown messages to prevent duplicates
            const shownMessages = new Set();
            
            alerts.forEach(alert => {
                // Get message text excluding the close button
                const closeButton = alert.querySelector('.btn-close');
                let messageText = alert.textContent.trim();
                if (closeButton) {
                    const alertClone = alert.cloneNode(true);
                    const closeButtonClone = alertClone.querySelector('.btn-close');
                    if (closeButtonClone) {
                        closeButtonClone.remove();
                    }
                    messageText = alertClone.textContent.trim();
                }
                
                // Create a unique key for this message
                const messageKey = messageText.toLowerCase().replace(/\s+/g, '');
                
                // Skip if we've already shown this message
                if (shownMessages.has(messageKey)) {
                    alert.style.display = 'none';
                    return;
                }
                
                shownMessages.add(messageKey);
                
                let messageType = 'info';
                
                if (alert.classList.contains('alert-success')) {
                    messageType = 'success';
                } else if (alert.classList.contains('alert-danger')) {
                    messageType = 'error';
                } else if (alert.classList.contains('alert-warning')) {
                    messageType = 'warning';
                }
                
                // Ensure toast function is available
                if (typeof toast !== 'undefined' && toast.show) {
                    // Show toast and hide the alert
                    toast.show(messageText, messageType);
                    alert.style.display = 'none';
                } else {
                    console.error('Toast function not available');
                }
            });
        };
        
        // Convert messages with a small delay to ensure everything is loaded
        setTimeout(convertMessagesToToasts, 100);

        // Auto-hide any remaining alerts (fallback)
        alerts.forEach(alert => {
            if (alert.classList.contains('alert-success') && alert.style.display !== 'none') {
                setTimeout(() => {
                    const bsAlert = new bootstrap.Alert(alert);
                    bsAlert.close();
                }, 5000);
            }
        });

        // Enhance table row interactions
        const tableRows = document.querySelectorAll('table tbody tr[data-href]');
        tableRows.forEach(row => {
            row.style.cursor = 'pointer';
            row.addEventListener('click', function(e) {
                if (!e.target.closest('a, button, input, select')) {
                    window.location.href = this.dataset.href;
                }
            });
        });

        // Enhanced modal focus management
        const modals = document.querySelectorAll('.modal');
        modals.forEach(modal => {
            modal.addEventListener('shown.bs.modal', function() {
                const firstInput = this.querySelector('input:not([type="hidden"]), select, textarea');
                if (firstInput) {
                    firstInput.focus();
                }
            });
        });
    });

    // Global keyboard shortcuts
    document.addEventListener('keydown', function(e) {
        // Escape key to close modals and dropdowns
        if (e.key === 'Escape') {
            const openModal = document.querySelector('.modal.show');
            if (openModal) {
                bootstrap.Modal.getInstance(openModal)?.hide();
            }
            
            const openDropdown = document.querySelector('.dropdown-menu.show');
            if (openDropdown) {
                bootstrap.Dropdown.getInstance(openDropdown.previousElementSibling)?.hide();
            }
        }
        
        // Ctrl+/ for help (if help modal exists)
        if (e.ctrlKey && e.key === '/') {
            e.preventDefault();
            const helpModal = document.querySelector('#helpModal');
            if (helpModal) {
                new bootstrap.Modal(helpModal).show();
            }
        }
    });



    // Unified Sidebar Toggle Functionality
    document.addEventListener('DOMContentLoaded', function() {
        // Get elements - using the actual IDs from the HTML
        const sidebarToggle = document.querySelector('#toggleSidebar');
        const sidebar = document.querySelector('#sidebar');
        const overlay = document.querySelector('#sidebar-overlay');
        const mainContent = document.querySelector('#main-content');

        if (!sidebarToggle || !sidebar) {
            return;
        }

        // Load sidebar state from localStorage
        function loadSidebarState() {
            const savedState = localStorage.getItem('sidebarState');
            return savedState === 'collapsed' ? 'collapsed' : 'expanded';
        }

        // Save sidebar state to localStorage
        function saveSidebarState(state) {
            localStorage.setItem('sidebarState', state);
        }

        // Toggle sidebar function
        function toggleSidebar() {
            if (window.innerWidth <= 768) {
                // Mobile behavior - show/hide sidebar
                if (sidebar.classList.contains('sidebar-w-0')) {
                    // Show sidebar
                    sidebar.classList.remove('sidebar-w-0');
                    sidebar.classList.add('sidebar-w-full');
                    if (overlay) overlay.classList.add('active');
                    document.body.style.overflow = 'hidden';
                    // On mobile, main content doesn't need to adjust
                } else {
                    // Hide sidebar
                    sidebar.classList.remove('sidebar-w-full');
                    sidebar.classList.add('sidebar-w-0');
                    if (overlay) overlay.classList.remove('active');
                    document.body.style.overflow = '';
                }
            } else {
                // Desktop behavior - collapse/expand with main content adjustment
                if (mainContent) {
                    mainContent.classList.add('sidebar-transitioning');
                }

                if (sidebar.classList.contains('sidebar-w-full')) {
                    // Collapse sidebar
                    sidebar.classList.remove('sidebar-w-full');
                    sidebar.classList.add('sidebar-w-0');
                    // Expand main content to full width
                    if (mainContent) {
                        mainContent.style.width = '100%';
                        mainContent.style.marginLeft = '0';
                    }
                    saveSidebarState('collapsed');
                } else {
                    // Expand sidebar
                    sidebar.classList.remove('sidebar-w-0');
                    sidebar.classList.add('sidebar-w-full');
                    // Restore main content to sidebar layout
                    if (mainContent) {
                        mainContent.style.width = '85%';
                        mainContent.style.marginLeft = '15%';
                    }
                    saveSidebarState('expanded');
                }

                // Remove transition class after animation completes
                setTimeout(() => {
                    if (mainContent) {
                        mainContent.classList.remove('sidebar-transitioning');
                    }
                }, 300);
            }
        }

        // Attach click event to toggle button
        sidebarToggle.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            toggleSidebar();
        });

        // Close sidebar when clicking overlay (mobile only)
        if (overlay) {
            overlay.addEventListener('click', function() {
                sidebar.classList.remove('sidebar-w-full');
                sidebar.classList.add('sidebar-w-0');
                overlay.classList.remove('active');
                document.body.style.overflow = '';
            });
        }

        // Handle window resize
        window.addEventListener('resize', function() {
            if (window.innerWidth > 768) {
                // Desktop - reset mobile-specific styles
                if (overlay) overlay.classList.remove('active');
                document.body.style.overflow = '';

                // Load saved state on desktop
                const savedState = loadSidebarState();

                if (savedState === 'collapsed') {
                    sidebar.classList.remove('sidebar-w-full');
                    sidebar.classList.add('sidebar-w-0');
                    if (mainContent) {
                        mainContent.style.width = '100%';
                        mainContent.style.marginLeft = '0';
                    }
                } else {
                    sidebar.classList.remove('sidebar-w-0');
                    sidebar.classList.add('sidebar-w-full');
                    if (mainContent) {
                        mainContent.style.width = '85%';
                        mainContent.style.marginLeft = '15%';
                    }
                }
            } else {
                // Mobile - hide sidebar by default and reset main content
                if (!sidebar.classList.contains('sidebar-w-0')) {
                    sidebar.classList.remove('sidebar-w-full');
                    sidebar.classList.add('sidebar-w-0');
                }
                // Reset main content for mobile (full width)
                if (mainContent) {
                    mainContent.style.width = '100%';
                    mainContent.style.marginLeft = '0';
                }
            }
        });

        // Initialize proper state on page load
        if (window.innerWidth > 768) {
            // Desktop - restore saved state
            const savedState = loadSidebarState();

            if (savedState === 'collapsed') {
                sidebar.classList.remove('sidebar-w-full');
                sidebar.classList.add('sidebar-w-0');
                if (mainContent) {
                    mainContent.style.width = '100%';
                    mainContent.style.marginLeft = '0';
                }
            } else {
                sidebar.classList.remove('sidebar-w-0');
                sidebar.classList.add('sidebar-w-full');
                if (mainContent) {
                    mainContent.style.width = '85%';
                    mainContent.style.marginLeft = '15%';
                }
            }
        } else {
            // Mobile - hide sidebar by default
            sidebar.classList.remove('sidebar-w-full');
            sidebar.classList.add('sidebar-w-0');
            // Set main content for full width on mobile
            if (mainContent) {
                mainContent.style.width = '100%';
                mainContent.style.marginLeft = '0';
            }
        }
    });

    </script>

    {% block extra_js %}{% endblock %}

    <!-- Logout Confirmation Modal -->
    <div class="modal fade" id="logoutModal" tabindex="-1" role="dialog" aria-labelledby="logoutModalLabel" aria-modal="true">
        <div class="modal-dialog modal-dialog-centered" role="document">
            <div class="modal-content">
                <div class="modal-header border-0 pb-0">
                    <h5 class="modal-title fw-bold text-dark" id="logoutModalLabel">
                        <i class="bi bi-box-arrow-right text-danger me-2"></i>
                        Confirm Sign Out
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body pt-2">
                    <div class="d-flex align-items-center mb-3">
                        <div class="text-center w-100">
                            <div class="mb-3">
                                <i class="bi bi-person-circle text-muted" style="font-size: 4rem;"></i>
                            </div>
                            <p class="mb-2 text-dark fw-medium">{{ user.get_full_name|default:user.username }}</p>
                            <p class="text-muted small mb-3">{{ user.email|default:"" }}</p>
                            <p class="text-secondary">Are you sure you want to sign out of your account?</p>
                        </div>
                    </div>
                </div>
                <div class="modal-footer border-0 pt-0">
                    <button type="button" class="btn btn-danger" data-bs-dismiss="modal">
                        <i class="bi bi-x-circle me-1"></i>
                        Cancel
                    </button>
                    <a href="{% url 'logout' %}" class="btn btn-danger">
                        <i class="bi bi-box-arrow-right me-1"></i>
                        Sign Out
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Universal Modal Accessibility Script -->
    <script>
    (function() {
        // Fix ALL Bootstrap modals for accessibility
        function initializeModalAccessibility() {
            // Find all Bootstrap modals
            const allModals = document.querySelectorAll('.modal');

            allModals.forEach(function(modal) {
                // Add role and aria-modal if not present
                if (!modal.hasAttribute('role')) {
                    modal.setAttribute('role', 'dialog');
                }
                if (!modal.hasAttribute('aria-modal')) {
                    modal.setAttribute('aria-modal', 'true');
                }

                // Add role="document" to modal-dialog
                const modalDialog = modal.querySelector('.modal-dialog');
                if (modalDialog && !modalDialog.hasAttribute('role')) {
                    modalDialog.setAttribute('role', 'document');
                }

                // Remove aria-hidden when modal is about to show
                modal.addEventListener('show.bs.modal', function(e) {
                    this.removeAttribute('aria-hidden');
                });

                // Restore aria-hidden only after modal is completely hidden
                modal.addEventListener('hidden.bs.modal', function(e) {
                    this.setAttribute('aria-hidden', 'true');
                });

                // Focus management when modal is fully shown
                modal.addEventListener('shown.bs.modal', function(e) {
                    const focusableElements = this.querySelectorAll(
                        'button:not([disabled]), a[href], input:not([disabled]), select:not([disabled]), textarea:not([disabled]), [tabindex]:not([tabindex="-1"]):not([disabled])'
                    );

                    if (focusableElements.length > 0) {
                        // Try to focus the first button that's not a close/cancel button
                        const primaryButton = Array.from(focusableElements).find(el =>
                            el.tagName === 'BUTTON' &&
                            !el.hasAttribute('data-bs-dismiss') &&
                            !el.classList.contains('btn-close')
                        );

                        if (primaryButton) {
                            setTimeout(() => primaryButton.focus(), 100);
                        } else if (focusableElements[0]) {
                            // Otherwise focus first focusable element
                            setTimeout(() => focusableElements[0].focus(), 100);
                        }
                    }
                });
            });

            console.log(`âœ… Modal Accessibility: Initialized ${allModals.length} modal(s)`);
        }

        // Run when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeModalAccessibility);
        } else {
            initializeModalAccessibility();
        }

        // Also re-run when new modals might be added dynamically
        const observer = new MutationObserver(function(mutations) {
            mutations.forEach(function(mutation) {
                mutation.addedNodes.forEach(function(node) {
                    if (node.nodeType === 1 && node.classList && node.classList.contains('modal')) {
                        // New modal added, initialize it
                        initializeModalAccessibility();
                    }
                });
            });
        });

        // Start observing
        if (document.body) {
            observer.observe(document.body, { childList: true, subtree: true });
        }
    })();
    </script>

    <!-- Conditional Modals Block - Pages can opt-in to modals they need -->
    {% block modals %}
        {# Child templates can include modals here using {% include 'components/delete_modal.html' %} #}
    {% endblock %}
</body>
</html> 