{% load i18n %}
<!-- Global View Overtime Modal Component -->
<div class="modal fade" id="viewOvertimeModal" tabindex="-1" aria-labelledby="viewOvertimeModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="viewOvertimeModalLabel">
                    <i class="bi bi-clock-history me-1"></i>
                    <span id="viewOvertimeModalTitle">{% trans "Overtime Request Details" %}</span>
                </h5>
                <button type="button" class="btn-close btn-close-sm" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- Employee Info Card -->
                <div style="background: #f8fafb; border: 1px solid #e2e8f0; border-radius: 6px; padding: 12px; margin-bottom: 16px;">
                    <div class="d-flex align-items-center">
                        <div id="viewEmployeeAvatar" class="employee-avatar-list me-3" style="width: 40px; height: 40px; font-size: 14px;"></div>
                        <div>
                            <div id="viewEmployeeName" style="font-size: 14px; font-weight: 600; color: #1f2937;"></div>
                            <div id="viewEmployeeId" style="font-size: 11px; color: #6b7280;"></div>
                        </div>
                    </div>
                </div>

                <!-- Request Details Grid -->
                <div class="row g-3 mb-3">
                    <div class="col-6">
                        <div style="background: white; border: 1px solid #e2e8f0; border-radius: 6px; padding: 10px;">
                            <div style="font-size: 10px; color: #6b7280; text-transform: uppercase; font-weight: 500; margin-bottom: 4px;">{% trans "Date" %}</div>
                            <div id="viewDate" style="font-size: 13px; font-weight: 600; color: #1f2937;"></div>
                            <div id="viewDay" style="font-size: 10px; color: #6b7280;"></div>
                        </div>
                    </div>
                    <div class="col-6">
                        <div style="background: white; border: 1px solid #e2e8f0; border-radius: 6px; padding: 10px;">
                            <div style="font-size: 10px; color: #6b7280; text-transform: uppercase; font-weight: 500; margin-bottom: 4px;">{% trans "Time Period" %}</div>
                            <div id="viewTimePeriod" style="font-size: 13px; font-weight: 600; color: #1f2937;"></div>
                            <div id="viewOvertimeType" style="font-size: 10px; color: #6b7280;"></div>
                        </div>
                    </div>
                    <div class="col-4">
                        <div style="background: white; border: 1px solid #e2e8f0; border-radius: 6px; padding: 10px;">
                            <div style="font-size: 10px; color: #6b7280; text-transform: uppercase; font-weight: 500; margin-bottom: 4px;">{% trans "Hours" %}</div>
                            <div id="viewHours" style="font-size: 16px; font-weight: 700; color: #3b82f6;"></div>
                        </div>
                    </div>
                    <div class="col-4">
                        <div style="background: white; border: 1px solid #e2e8f0; border-radius: 6px; padding: 10px;">
                            <div style="font-size: 10px; color: #6b7280; text-transform: uppercase; font-weight: 500; margin-bottom: 4px;">{% trans "Multiplier" %}</div>
                            <div id="viewRate" style="font-size: 16px; font-weight: 700; color: #f59e0b;"></div>
                        </div>
                    </div>
                    <div class="col-4">
                        <div style="background: white; border: 1px solid #e2e8f0; border-radius: 6px; padding: 10px;">
                            <div style="font-size: 10px; color: #6b7280; text-transform: uppercase; font-weight: 500; margin-bottom: 4px;">{% trans "Amount" %}</div>
                            <div id="viewAmount" style="font-size: 16px; font-weight: 700; color: #10b981;"></div>
                        </div>
                    </div>
                </div>

                <!-- Reason Section -->
                <div style="background: white; border: 1px solid #e2e8f0; border-radius: 6px; padding: 12px; margin-bottom: 16px;">
                    <div style="font-size: 11px; color: #6b7280; text-transform: uppercase; font-weight: 500; margin-bottom: 6px;">{% trans "Reason" %}</div>
                    <p id="viewReason" style="font-size: 12px; color: #374151; margin: 0;"></p>
                </div>

                <!-- Status Section -->
                <div id="viewStatusSection"></div>
            </div>

            <div class="modal-footer">
                <!-- Approve/Reject buttons - shown only for pending with permission -->
                <div class="d-flex align-items-end gap-1" id="viewOvertimeActions" style="display: none;">
                    <button type="button" class="button-min-default bg-success py-1 text-white" id="approveFromModal">
                        <div>
                            <i class="bi bi-check-circle"></i>
                            {% trans "Approve" %}
                        </div>
                    </button>
                    <button type="button" class="button-min-danger py-1" id="rejectFromModal">
                        <div>
                            <i class="bi bi-x-circle"></i>
                            {% trans "Reject" %}
                        </div>
                    </button>
                    <button type="button" class="button-min-warn py-1" data-bs-dismiss="modal">
                        <div>
                            <i class="bi bi-x-circle"></i>
                            {% trans "Close" %}
                        </div>
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
/* Modal Styles - Following Design Guideline */
#viewOvertimeModal {
    z-index: 1070 !important;
}

#viewOvertimeModal .modal-dialog {
    position: relative;
    margin: auto;
    z-index: 1071;
    max-width: 600px;
    width: 90%;
}

@media (min-width: 768px) {
    #viewOvertimeModal .modal-dialog {
        width: 600px;
    }
}

#viewOvertimeModal .modal-content {
    border: none;
    border-radius: 12px;
    box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
    position: relative;
    z-index: 1071;
}

#viewOvertimeModal.modal.show .modal-dialog {
    animation: modalSlideIn 0.2s ease-out;
}

#viewOvertimeModal .modal-header {
    border-bottom: 1px solid #e5e7eb;
    padding: 0.75rem 1rem;
    position: relative;
    z-index: 1072;
}

#viewOvertimeModal .modal-title {
    font-weight: 600;
    font-size: 0.875rem;
    color: #1f2937;
}

#viewOvertimeModal .modal-title i {
    font-size: 0.875rem;
}

#viewOvertimeModal .modal-body {
    padding: 1rem;
    color: #4b5563;
    position: relative;
    z-index: 1072;
}

#viewOvertimeModal .modal-footer {
    border-top: 1px solid #e5e7eb;
    padding: 0.75rem 1rem;
    gap: 0.5rem;
    position: relative;
    z-index: 1072;
}

#viewOvertimeModal .modal-footer .btn,
#viewOvertimeModal .modal-footer button {
    font-size: 11px;
    padding: 6px 12px;
    position: relative;
    z-index: 1073;
    pointer-events: auto !important;
}

#viewOvertimeModal .modal-footer .btn i {
    font-size: 10px;
}

#viewOvertimeModal .modal-header .btn-close {
    position: relative;
    z-index: 1074;
    pointer-events: auto !important;
    font-size: 0.75rem;
    padding: 0.25rem;
    cursor: pointer;
}

/* Ensure backdrop doesn't block interaction */
/* DO NOT set z-index here - it's handled in JavaScript */
.modal-backdrop {
    position: fixed !important;
    top: 0 !important;
    left: 0 !important;
    width: 100vw !important;
    height: 100vh !important;
}

/* Ensure view overtime modal backdrop is below the modal */
#viewOvertimeModal ~ .modal-backdrop {
    z-index: 1065 !important;
}

/* Prevent body scroll when modal is open */
body.modal-open {
    overflow: hidden;
}

/* Ensure modal doesn't cause page scroll */
#viewOvertimeModal {
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
    overflow-x: hidden;
    overflow-y: auto;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    width: 100vw;
    height: 100vh;
    padding: 1rem;
}

@keyframes modalSlideIn {
    from {
        opacity: 0;
        transform: scale(0.95) translateY(-10px);
    }
    to {
        opacity: 1;
        transform: scale(1) translateY(0);
    }
}

.modal-backdrop.show {
    backdrop-filter: blur(3px);
}

/* Employee Avatar */
.employee-avatar-list {
    width: 28px;
    height: 28px;
    border-radius: 50%;
    background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 600;
    font-size: 11px;
}
</style>

<script>
// Global view overtime modal functionality
function initializeViewOvertimeModal() {
    console.log('üëÅÔ∏è VIEW OVERTIME MODAL: Initializing...');
    const viewModalElement = document.getElementById('viewOvertimeModal');

    if (!viewModalElement) {
        console.error('‚ùå VIEW OVERTIME MODAL: Modal element not found!');
        return;
    }

    const viewModal = new bootstrap.Modal(viewModalElement);
    console.log('‚úÖ VIEW OVERTIME MODAL: Modal initialized');

    // Watch for backdrop creation and immediately fix it
    let backdropFixed = false;
    const observer = new MutationObserver((mutations) => {
        mutations.forEach((mutation) => {
            mutation.addedNodes.forEach((node) => {
                if (node.classList && node.classList.contains('modal-backdrop') && !backdropFixed) {
                    console.log('üé≠ VIEW OVERTIME BACKDROP DETECTED: Fixing immediately');

                    // Mark as fixed to prevent infinite loop
                    backdropFixed = true;

                    // Disconnect observer to prevent loop
                    observer.disconnect();

                    // CRITICAL: Move backdrop BEFORE the modal in DOM
                    if (viewModalElement.parentNode && viewModalElement.parentNode.contains(node)) {
                        viewModalElement.parentNode.insertBefore(node, viewModalElement);
                        console.log('‚úÖ Backdrop moved before modal in DOM');
                    }

                    // Set z-index lower than modal
                    node.style.setProperty('z-index', '1065', 'important');
                    node.style.setProperty('pointer-events', 'auto', 'important');

                    console.log('‚úÖ View overtime backdrop fixed - z-index:', node.style.zIndex);
                }
            });
        });
    });

    // Start observing when modal is about to show
    viewModalElement.addEventListener('show.bs.modal', function() {
        backdropFixed = false;
        observer.observe(document.body, { childList: true });
        console.log('üëÄ VIEW OVERTIME OBSERVER: Started watching for backdrop');

        // Set modal z-index IMMEDIATELY
        viewModalElement.style.setProperty('z-index', '1070', 'important');

        // Also try to fix any existing backdrop immediately
        setTimeout(() => {
            const existingBackdrop = document.querySelector('.modal-backdrop');
            if (existingBackdrop) {
                console.log('üîß Found existing backdrop, fixing immediately');

                // Move it before the modal
                if (viewModalElement.parentNode) {
                    viewModalElement.parentNode.insertBefore(existingBackdrop, viewModalElement);
                }

                existingBackdrop.style.setProperty('z-index', '1065', 'important');
                console.log('‚úÖ Existing backdrop fixed');
            }
        }, 10);
    });

    // Stop observing after modal is shown
    viewModalElement.addEventListener('shown.bs.modal', function() {
        setTimeout(() => {
            observer.disconnect();
            console.log('üëÄ VIEW OVERTIME OBSERVER: Stopped watching');

            // Double-check backdrop z-index
            const backdrop = document.querySelector('.modal-backdrop.show');
            if (backdrop) {
                const backdropZIndex = window.getComputedStyle(backdrop).zIndex;
                const modalZIndex = window.getComputedStyle(viewModalElement).zIndex;
                console.log('üîç Backdrop z-index:', backdropZIndex);
                console.log('üîç Modal z-index:', modalZIndex);

                // Force fix if needed
                if (parseInt(backdropZIndex) >= parseInt(modalZIndex)) {
                    console.warn('‚ö†Ô∏è Backdrop z-index is higher! Forcing fix...');
                    backdrop.style.setProperty('z-index', '1065', 'important');
                }
            }
        }, 100);

        // Ensure modal has higher z-index than backdrop
        viewModalElement.style.setProperty('z-index', '1070', 'important');

        // Ensure modal uses flexbox centering
        viewModalElement.style.setProperty('display', 'flex', 'important');
        viewModalElement.style.setProperty('align-items', 'center', 'important');
        viewModalElement.style.setProperty('justify-content', 'center', 'important');

        // Ensure modal dialog is positioned correctly
        const modalDialog = viewModalElement.querySelector('.modal-dialog');
        if (modalDialog) {
            modalDialog.style.setProperty('position', 'relative', 'important');
            modalDialog.style.setProperty('margin', 'auto', 'important');
            modalDialog.style.setProperty('transform', 'none', 'important');
            console.log('‚úÖ Modal dialog centered with flexbox');
        }

        // Ensure all interactive elements have pointer-events enabled
        const allInteractive = viewModalElement.querySelectorAll('input, select, textarea, button');
        allInteractive.forEach(element => {
            element.style.setProperty('pointer-events', 'auto', 'important');
        });

        // Focus close button
        const focusableElement = viewModalElement.querySelector('button[data-bs-dismiss="modal"]');
        if (focusableElement) {
            focusableElement.focus();
        }

        console.log('‚úÖ VIEW OVERTIME MODAL: All interactive elements enabled');
    });

    // Keyboard navigation
    viewModalElement.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            const modalInstance = bootstrap.Modal.getInstance(viewModalElement);
            if (modalInstance) {
                modalInstance.hide();
            }
        }
    });

    // Fix ARIA attributes before modal hides
    viewModalElement.addEventListener('hide.bs.modal', function() {
        // Remove aria-hidden to prevent accessibility warning
        viewModalElement.removeAttribute('aria-hidden');
        console.log('‚úÖ VIEW OVERTIME MODAL: ARIA attributes cleared before hide');
    });

    // Restore ARIA attributes after modal is hidden
    viewModalElement.addEventListener('hidden.bs.modal', function() {
        // Restore aria-hidden after modal is completely hidden
        viewModalElement.setAttribute('aria-hidden', 'true');

        // Remove focus from modal
        if (document.activeElement === viewModalElement) {
            document.activeElement.blur();
        }

        console.log('‚úÖ VIEW OVERTIME MODAL: ARIA attributes restored after hide');
    });

    // Store current request ID for modal actions
    let currentRequestId = null;

    // Handle view button clicks
    document.addEventListener('click', function(e) {
        if (e.target.closest('.view-overtime-btn')) {
            e.preventDefault();
            const button = e.target.closest('.view-overtime-btn');

            console.log('üëÅÔ∏è VIEW OVERTIME: Button clicked');

            // Get data attributes
            const data = {
                requestId: button.dataset.requestId,
                employeeName: button.dataset.employeeName,
                employeeId: button.dataset.employeeId,
                employeeInitials: button.dataset.employeeInitials,
                date: button.dataset.date,
                day: button.dataset.day,
                startTime: button.dataset.startTime,
                endTime: button.dataset.endTime,
                overtimeType: button.dataset.overtimeType,
                hours: button.dataset.hours,
                rate: button.dataset.rate,
                amount: button.dataset.amount,
                reason: button.dataset.reason,
                status: button.dataset.status,
                statusDisplay: button.dataset.statusDisplay,
                approvedBy: button.dataset.approvedBy,
                approvedAt: button.dataset.approvedAt,
                approvalComments: button.dataset.approvalComments,
                rejectionReason: button.dataset.rejectionReason,
                manager: button.dataset.manager,
                canApprove: button.dataset.canApprove
            };

            console.log('üìä Data:', data);
            console.log('üîç Raw data attributes:', {
                requestId: button.dataset.requestId,
                status: button.dataset.status,
                canApprove: button.dataset.canApprove
            });

            // Store request ID for modal actions
            currentRequestId = data.requestId;

            // Update employee info
            document.getElementById('viewEmployeeAvatar').textContent = data.employeeInitials || '';
            document.getElementById('viewEmployeeName').textContent = data.employeeName || '';
            document.getElementById('viewEmployeeId').textContent = data.employeeId || '';

            // Update request details
            document.getElementById('viewDate').textContent = data.date || '';
            document.getElementById('viewDay').textContent = data.day || '';
            document.getElementById('viewTimePeriod').textContent = `${data.startTime} - ${data.endTime}`;
            document.getElementById('viewOvertimeType').textContent = data.overtimeType || '';
            document.getElementById('viewHours').textContent = `${data.hours}h`;
            document.getElementById('viewRate').textContent = `${data.rate}x`;
            document.getElementById('viewAmount').textContent = `$${data.amount}`;
            document.getElementById('viewReason').textContent = data.reason || '';

            // Update status section
            const statusSection = document.getElementById('viewStatusSection');
            let statusHTML = '';

            if (data.approvedBy) {
                statusHTML = `
                    <div style="background: #dcfce7; border-left: 4px solid #10b981; border-radius: 6px; padding: 12px;">
                        <div style="display: flex; align-items-start;">
                            <i class="bi bi-check-circle-fill me-2" style="color: #10b981; font-size: 18px;"></i>
                            <div style="flex: 1;">
                                <div style="font-size: 12px; font-weight: 600; color: #166534; margin-bottom: 4px;">{% trans "Approved" %}</div>
                                <div style="font-size: 11px; color: #166534;">
                                    <strong>{% trans "By:" %}</strong> ${data.approvedBy}<br>
                                    <strong>{% trans "On:" %}</strong> ${data.approvedAt}
                                    ${data.approvalComments ? `<br><strong>{% trans "Comments:" %}</strong> ${data.approvalComments}` : ''}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            } else if (data.status === 'rejected') {
                statusHTML = `
                    <div style="background: #fee2e2; border-left: 4px solid #ef4444; border-radius: 6px; padding: 12px;">
                        <div style="display: flex; align-items-start;">
                            <i class="bi bi-x-circle-fill me-2" style="color: #ef4444; font-size: 18px;"></i>
                            <div style="flex: 1;">
                                <div style="font-size: 12px; font-weight: 600; color: #991b1b; margin-bottom: 4px;">{% trans "Rejected" %}</div>
                                <div style="font-size: 11px; color: #991b1b;">
                                    ${data.rejectionReason ? `<strong>{% trans "Reason:" %}</strong> ${data.rejectionReason}` : '{% trans "No reason provided" %}'}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            } else if (data.status === 'pending') {
                statusHTML = `
                    <div style="background: #fef3c7; border-left: 4px solid #f59e0b; border-radius: 6px; padding: 12px;">
                        <div style="display: flex; align-items-start;">
                            <i class="bi bi-clock-fill me-2" style="color: #f59e0b; font-size: 18px;"></i>
                            <div style="flex: 1;">
                                <div style="font-size: 12px; font-weight: 600; color: #92400e; margin-bottom: 4px;">{% trans "Pending Approval" %}</div>
                                <div style="font-size: 11px; color: #92400e;">
                                    ${data.manager ? `<strong>{% trans "Assigned Manager:" %}</strong> ${data.manager}` : '{% trans "Waiting for manager approval" %}'}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            } else {
                statusHTML = `
                    <div style="background: #f3f4f6; border-left: 4px solid #6b7280; border-radius: 6px; padding: 12px;">
                        <div style="display: flex; align-items-center;">
                            <i class="bi bi-file-earmark me-2" style="color: #6b7280; font-size: 18px;"></i>
                            <span class="status-badge status-${data.status}">${data.statusDisplay}</span>
                        </div>
                    </div>
                `;
            }

            statusSection.innerHTML = statusHTML;

            // Show/hide action buttons based on status and permission
            const actionsDiv = document.getElementById('viewOvertimeActions');
            console.log('üîç Button visibility check:', {
                status: data.status,
                canApprove: data.canApprove,
                isPending: data.status === 'pending',
                hasPermission: data.canApprove === 'true',
                willShow: data.status === 'pending' && data.canApprove === 'true'
            });

            if (data.status === 'pending' && data.canApprove === 'true') {
                console.log('‚úÖ Showing approve/reject buttons');
                actionsDiv.style.display = 'block';
            } else {
                console.log('‚ùå Hiding approve/reject buttons');
                actionsDiv.style.display = 'none';
            }

            // Show modal
            viewModal.show();

            // Ensure flexbox centering
            setTimeout(() => {
                viewModalElement.style.setProperty('display', 'flex', 'important');
                viewModalElement.style.setProperty('align-items', 'center', 'important');
                viewModalElement.style.setProperty('justify-content', 'center', 'important');

                const modalDialog = viewModalElement.querySelector('.modal-dialog');
                if (modalDialog) {
                    modalDialog.style.setProperty('position', 'relative', 'important');
                    modalDialog.style.setProperty('margin', 'auto', 'important');
                }
            }, 0);

            console.log('‚úÖ VIEW OVERTIME MODAL: Modal shown successfully');
        }
    });

    // Handle approve button click from modal
    document.getElementById('approveFromModal').addEventListener('click', function() {
        if (currentRequestId && typeof approveRequest === 'function') {
            // Get the current button data
            const viewButton = document.querySelector(`.view-overtime-btn[data-request-id="${currentRequestId}"]`);
            if (viewButton) {
                const employeeName = viewButton.dataset.employeeName;
                const date = viewButton.dataset.date;
                const hours = viewButton.dataset.hours;
                const rate = viewButton.dataset.rate;
                const amount = viewButton.dataset.amount;

                const modalInstance = bootstrap.Modal.getInstance(viewModalElement);
                if (modalInstance) {
                    modalInstance.hide();
                }

                // Call approve with all required parameters
                approveRequest(currentRequestId, employeeName, date, hours, rate, amount);
            }
        }
    });

    // Handle reject button click from modal
    document.getElementById('rejectFromModal').addEventListener('click', function() {
        if (currentRequestId && typeof rejectRequest === 'function') {
            // Get the current button data
            const viewButton = document.querySelector(`.view-overtime-btn[data-request-id="${currentRequestId}"]`);
            if (viewButton) {
                const employeeName = viewButton.dataset.employeeName;
                const date = viewButton.dataset.date;

                const modalInstance = bootstrap.Modal.getInstance(viewModalElement);
                if (modalInstance) {
                    modalInstance.hide();
                }

                // Call reject with all required parameters
                rejectRequest(currentRequestId, employeeName, date);
            }
        }
    });

    console.log('‚úÖ VIEW OVERTIME MODAL: Initialized successfully');
}

// Initialize when DOM is loaded
document.addEventListener('DOMContentLoaded', initializeViewOvertimeModal);
</script>
