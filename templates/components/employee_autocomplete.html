{% comment %}
Employee Autocomplete Component
================================

A reusable employee autocomplete field with search by name or ID.

Usage:
------
1. Include this component in your form:
   {% include 'components/employee_autocomplete.html' with field_name='employee' label='Employee' required=True %}

2. In your view, pass employees queryset:
   employees = Employee.objects.filter(employment_status='active').order_by('first_name', 'last_name')

3. The component will create:
   - A visible search input field (id: {field_name}-search)
   - A hidden field with the selected employee ID (name: {field_name})
   - An autocomplete dropdown

Parameters:
-----------
- field_name: Name of the hidden input field (default: 'employee')
- label: Label text (default: 'Employee')
- required: Whether the field is required (default: True)
- placeholder: Custom placeholder text (optional)
- help_text: Custom help text (optional)

Example:
--------
{% include 'components/employee_autocomplete.html' with
   field_name='assigned_to'
   label='Assign To'
   required=True
   placeholder='Search employee by name or ID...'
   help_text='Select the employee to assign this task to'
%}

Features:
---------
- Searches by employee name (first + last)
- Searches by employee ID (e.g., EMP2024001)
- Keyboard navigation (Arrow Up/Down, Enter, Escape)
- Click outside to close
- Visual feedback on selection
- Handles special characters and empty values
{% endcomment %}

<!-- Set default values -->
{% if not field_name %}{% with field_name='employee' %}{% endwith %}{% endif %}
{% if not label %}{% with label='Employee' %}{% endwith %}{% endif %}
{% if required == None %}{% with required=True %}{% endwith %}{% endif %}

<style>
    /* Autocomplete Container */
    .autocomplete-container-{{ field_name }} {
        position: relative;
        width: 100%;
    }

    /* Autocomplete Input */
    .autocomplete-input-{{ field_name }} {
        width: 100%;
        padding: 6px 8px;
        font-size: 12px;
        border: 1px solid #e5e7eb;
        border-radius: 4px;
        background: white;
    }

    .autocomplete-input-{{ field_name }}:focus {
        outline: none;
        border-color: #3b82f6;
        box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.1);
    }

    /* Autocomplete Dropdown */
    .autocomplete-dropdown-{{ field_name }} {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: white;
        border: 1px solid #e5e7eb;
        border-top: none;
        max-height: 250px;
        overflow-y: auto;
        z-index: 1000;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        display: none;
        border-radius: 0 0 4px 4px;
    }

    .autocomplete-dropdown-{{ field_name }}.show {
        display: block;
    }

    /* Autocomplete Items */
    .autocomplete-item-{{ field_name }} {
        padding: 8px 10px;
        cursor: pointer;
        border-bottom: 1px solid #f3f4f6;
        transition: background 0.1s;
    }

    .autocomplete-item-{{ field_name }}:last-child {
        border-bottom: none;
    }

    .autocomplete-item-{{ field_name }}:hover,
    .autocomplete-item-{{ field_name }}.selected {
        background: #f9fafb;
    }

    .autocomplete-item-name-{{ field_name }} {
        font-weight: 600;
        font-size: 12px;
        color: #111827;
    }

    .autocomplete-item-id-{{ field_name }} {
        font-size: 11px;
        color: #6b7280;
        margin-top: 2px;
    }

    .autocomplete-no-results-{{ field_name }} {
        padding: 12px;
        text-align: center;
        color: #9ca3af;
        font-size: 11px;
    }
</style>

<!-- Employee Selection Field -->
<div class="form-group">
    <label for="{{ field_name }}" class="form-label">
        {{ label }} {% if required %}<span style="color: #ef4444;">*</span>{% endif %}
    </label>
    <div class="autocomplete-container-{{ field_name }}">
        <input type="text"
               id="{{ field_name }}-search"
               class="autocomplete-input-{{ field_name }}"
               placeholder="{% if placeholder %}{{ placeholder }}{% else %}Search by name or employee ID...{% endif %}"
               autocomplete="off"
               {% if value %}value="{{ value }}"{% endif %}>
        <input type="hidden" name="{{ field_name }}" id="{{ field_name }}" {% if required %}required{% endif %} {% if value %}value="{{ value }}"{% endif %}>
        <div class="autocomplete-dropdown-{{ field_name }}" id="{{ field_name }}-dropdown"></div>
    </div>
    <p class="form-help">
        {% if help_text %}{{ help_text }}{% else %}Search by employee name or ID (e.g., "John" or "EMP2024001"){% endif %}
    </p>
</div>

<script>
(function() {
    // Employee data
    const employees_{{ field_name }} = [
        {% for employee in employees %}
        {
            id: {{ employee.id }},
            name: '{{ employee.first_name|escapejs }} {{ employee.last_name|escapejs }}',
            employee_id: '{{ employee.employee_id|escapejs }}'
        }{% if not forloop.last %},{% endif %}
        {% endfor %}
    ];

    const searchInput = document.getElementById('{{ field_name }}-search');
    const hiddenInput = document.getElementById('{{ field_name }}');
    const dropdown = document.getElementById('{{ field_name }}-dropdown');
    let selectedIndex = -1;

    // Show dropdown on focus
    searchInput.addEventListener('focus', function() {
        filterEmployees('');
    });

    // Filter on input
    searchInput.addEventListener('input', function() {
        const query = this.value;
        hiddenInput.value = ''; // Clear selection when typing
        filterEmployees(query);
    });

    // Keyboard navigation
    searchInput.addEventListener('keydown', function(e) {
        const items = dropdown.querySelectorAll('.autocomplete-item-{{ field_name }}');

        if (e.key === 'ArrowDown') {
            e.preventDefault();
            selectedIndex = Math.min(selectedIndex + 1, items.length - 1);
            updateSelection(items);
        } else if (e.key === 'ArrowUp') {
            e.preventDefault();
            selectedIndex = Math.max(selectedIndex - 1, -1);
            updateSelection(items);
        } else if (e.key === 'Enter') {
            e.preventDefault();
            if (selectedIndex >= 0 && items[selectedIndex]) {
                items[selectedIndex].click();
            }
        } else if (e.key === 'Escape') {
            dropdown.classList.remove('show');
            selectedIndex = -1;
        }
    });

    // Close dropdown when clicking outside
    document.addEventListener('click', function(e) {
        if (!e.target.closest('.autocomplete-container-{{ field_name }}')) {
            dropdown.classList.remove('show');
            selectedIndex = -1;
        }
    });

    function filterEmployees(query) {
        query = query.toLowerCase().trim();
        const filtered = employees_{{ field_name }}.filter(emp => {
            const name = (emp.name || '').toLowerCase();
            const empId = (emp.employee_id || '').toLowerCase();
            return name.includes(query) || empId.includes(query);
        });

        if (filtered.length === 0) {
            dropdown.innerHTML = '<div class="autocomplete-no-results-{{ field_name }}">No employees found matching your search</div>';
        } else {
            dropdown.innerHTML = filtered.map((emp, index) => {
                const name = (emp.name || '').trim();
                const empId = (emp.employee_id || '').trim();
                const displayName = name || empId || 'Unnamed Employee';
                const escapedName = displayName.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
                const escapedId = empId.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
                return `
                <div class="autocomplete-item-{{ field_name }}" data-employee-id="${emp.id}" data-index="${index}">
                    <div class="autocomplete-item-name-{{ field_name }}">${escapedName}</div>
                    ${escapedId ? `<div class="autocomplete-item-id-{{ field_name }}">ID: ${escapedId}</div>` : ''}
                </div>
                `;
            }).join('');

            // Add click handlers
            dropdown.querySelectorAll('.autocomplete-item-{{ field_name }}').forEach(item => {
                item.addEventListener('click', function() {
                    const employeeId = parseInt(this.dataset.employeeId);
                    const employee = employees_{{ field_name }}.find(e => e.id === employeeId);
                    if (employee) {
                        searchInput.value = employee.name;
                        hiddenInput.value = employeeId;
                        dropdown.classList.remove('show');
                        selectedIndex = -1;
                    }
                });
            });
        }

        dropdown.classList.add('show');
        selectedIndex = -1;
    }

    function updateSelection(items) {
        items.forEach((item, index) => {
            if (index === selectedIndex) {
                item.classList.add('selected');
                item.scrollIntoView({ block: 'nearest' });
            } else {
                item.classList.remove('selected');
            }
        });
    }
})();
</script>
