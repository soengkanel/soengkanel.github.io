<!-- Global Confirmation Modal Component - Compact & Minimal -->
<div class="modal fade" id="confirmActionModal" tabindex="-1" aria-labelledby="confirmActionModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-sm">
        <div class="modal-content">
            <div class="modal-header">
                <h6 class="modal-title" id="confirmActionModalLabel">
                    <i class="bi bi-question-circle-fill text-primary me-1" style="font-size: 14px;"></i>
                    <span id="confirmModalTitle">Confirm Action</span>
                </h6>
                <button type="button" class="btn-close btn-close-sm" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p class="mb-1" id="confirmModalMessage" style="font-size: 13px; font-weight: 500;"></p>
                <p class="text-muted mb-0" id="confirmModalNote" style="font-size: 11px;">
                    <i class="bi bi-info-circle me-1"></i>
                    <span></span>
                </p>
            </div>
            <div class="modal-footer">
                <button type="button" class="button-min-default" data-bs-dismiss="modal">
                    Cancel
                </button>
                <button type="button" class="button-min-primary" id="confirmActionBtn">
                    Confirm
                </button>
            </div>
        </div>
    </div>
</div>

<style>
/* Compact & Minimal Modal Styles */
#confirmActionModal {
    z-index: 1055;
}

#confirmActionModal .modal-dialog {
    margin: 1.75rem auto;
    position: relative;
    z-index: 1056;
    max-width: 380px;
}

#confirmActionModal .modal-content {
    border: none;
    border-radius: 8px;
    box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
    position: relative;
    z-index: 1057;
}

#confirmActionModal.modal.show .modal-content {
    animation: modalSlideIn 0.2s ease-out;
}

#confirmActionModal .modal-header {
    border-bottom: 1px solid #e5e7eb;
    padding: 10px 12px;
}

#confirmActionModal .modal-title {
    font-weight: 600;
    font-size: 13px;
    color: #1f2937;
    display: flex;
    align-items: center;
}

#confirmActionModal .modal-body {
    padding: 12px;
    color: #4b5563;
}

#confirmActionModal .modal-footer {
    border-top: 1px solid #e5e7eb;
    padding: 8px 12px;
    gap: 6px;
    display: flex;
    justify-content: flex-end;
}

#confirmActionModal .btn-close {
    font-size: 10px;
    padding: 6px;
    opacity: 0.5;
}

#confirmActionModal .btn-close:hover {
    opacity: 1;
}

@keyframes modalSlideIn {
    from {
        opacity: 0;
        transform: scale(0.96) translateY(-10px);
    }
    to {
        opacity: 1;
        transform: scale(1) translateY(0);
    }
}

/* Backdrop styling - ensure it's below modal content */
#confirmActionModal ~ .modal-backdrop,
.modal-backdrop.show {
    z-index: 1050 !important;
    backdrop-filter: blur(2px);
    opacity: 0.4;
}
</style>

<script>
// Global confirmation modal functionality
let currentActionUrl = null;

function initializeConfirmModal() {
    const confirmModalElement = document.getElementById('confirmActionModal');
    const confirmModal = new bootstrap.Modal(confirmModalElement);
    const confirmActionBtn = document.getElementById('confirmActionBtn');

    // Enhanced modal behavior
    confirmModalElement.addEventListener('shown.bs.modal', function() {
        const focusableElement = confirmModalElement.querySelector('button:not([data-bs-dismiss])');
        if (focusableElement) {
            focusableElement.focus();
        }
    });

    // Keyboard navigation
    confirmModalElement.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            const modalInstance = bootstrap.Modal.getInstance(confirmModalElement);
            if (modalInstance) {
                modalInstance.hide();
            }
        }
    });

    // Handle confirm button clicks
    document.addEventListener('click', function(e) {
        if (e.target.closest('.confirm-action-btn')) {
            e.preventDefault();
            const button = e.target.closest('.confirm-action-btn');

            const title = button.dataset.actionTitle || 'Confirm Action';
            const message = button.dataset.actionMessage || '';
            const note = button.dataset.actionNote || '';
            const url = button.dataset.actionUrl || button.href;

            console.log('‚úÖ CONFIRM MODAL: Action button clicked');
            console.log('üéØ Action URL:', url);

            // Store action URL
            currentActionUrl = url;

            // Update modal content
            document.querySelector('#confirmModalTitle').textContent = title;
            document.getElementById('confirmModalMessage').textContent = message;

            const noteElement = document.querySelector('#confirmModalNote span');
            const noteContainer = document.getElementById('confirmModalNote');
            if (note) {
                noteElement.textContent = note;
                noteContainer.style.display = 'block';
            } else {
                noteContainer.style.display = 'none';
            }

            // Show modal
            confirmModal.show();
        }
    });

    // Handle action confirmation
    confirmActionBtn.addEventListener('click', function() {
        console.log('üî• CONFIRM MODAL: Confirm button clicked');

        if (currentActionUrl) {
            // Get CSRF token
            function getCSRFToken() {
                const csrfMeta = document.querySelector('meta[name="csrf-token"]');
                if (csrfMeta) return csrfMeta.getAttribute('content');

                const csrfInput = document.querySelector('[name=csrfmiddlewaretoken]');
                if (csrfInput) return csrfInput.value;

                const csrfCookie = document.cookie.match(/csrftoken=([^;]+)/);
                if (csrfCookie) return csrfCookie[1];

                return null;
            }

            const csrfToken = getCSRFToken();

            if (!csrfToken) {
                alert('Security token not found. Please refresh the page and try again.');
                return;
            }

            // Show loading state
            const originalContent = confirmActionBtn.innerHTML;
            confirmActionBtn.disabled = true;
            confirmActionBtn.innerHTML = 'Processing...';

            // Create and submit form
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = currentActionUrl;

            const csrfInput = document.createElement('input');
            csrfInput.type = 'hidden';
            csrfInput.name = 'csrfmiddlewaretoken';
            csrfInput.value = csrfToken;
            form.appendChild(csrfInput);

            // Add timeout to prevent indefinite hanging
            const timeoutId = setTimeout(() => {
                confirmActionBtn.disabled = false;
                confirmActionBtn.innerHTML = originalContent;
                confirmModal.hide();
            }, 30000);

            form.addEventListener('submit', function() {
                clearTimeout(timeoutId);
                confirmModal.hide();
            });

            document.body.appendChild(form);

            try {
                form.submit();
                console.log('‚úÖ CONFIRM MODAL: Form submitted successfully');
            } catch (error) {
                console.error('‚ùå CONFIRM MODAL: Error submitting form:', error);
                alert('Error submitting request: ' + error.message);
                confirmActionBtn.disabled = false;
                confirmActionBtn.innerHTML = originalContent;
            }
        }
    });

    // Reset modal when hidden
    confirmModalElement.addEventListener('hidden.bs.modal', function() {
        currentActionUrl = null;
        confirmActionBtn.disabled = false;
        confirmActionBtn.innerHTML = 'Confirm';
    });
}

// Initialize when DOM is loaded
document.addEventListener('DOMContentLoaded', initializeConfirmModal);
</script>
