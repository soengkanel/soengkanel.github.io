{# Department Autocomplete Component #}
{# Usage: {% include 'components/department_autocomplete.html' with field_name='department' label='Department' required=True %} #}

{% load static %}

<div class="form-group">
    <label for="{{ field_name|default:'department' }}-search" class="form-label">
        {{ label|default:'Department' }}
        {% if required %}<span style="color: var(--danger);">*</span>{% endif %}
    </label>

    <div class="autocomplete-container-{{ field_name|default:'department' }}" style="position: relative;">
        <input type="text"
               id="{{ field_name|default:'department' }}-search"
               class="form-control-compact"
               placeholder="{{ placeholder|default:'Search by department name or code...' }}"
               autocomplete="off"
               {% if value %}value="{{ value }}"{% endif %}
               style="width: 100%; padding: 6px 8px; font-size: 12px; border: 1px solid var(--border); border-radius: 4px;">

        <input type="hidden"
               id="{{ field_name|default:'department' }}"
               name="{{ field_name|default:'department' }}"
               {% if required %}required{% endif %}
               {% if value %}value="{{ value }}"{% endif %}>

        <div id="{{ field_name|default:'department' }}-dropdown"
             class="autocomplete-dropdown-{{ field_name|default:'department' }}"
             style="display: none; position: absolute; top: 100%; left: 0; right: 0; max-height: 200px; overflow-y: auto; background: white; border: 1px solid var(--border); border-radius: 4px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); z-index: 1000; margin-top: 2px;">
        </div>
    </div>

    {% if help_text %}
    <div class="form-help">{{ help_text }}</div>
    {% else %}
    <div class="form-help">Select a department from the list or search by name/code</div>
    {% endif %}
</div>

<script>
(function() {
    const fieldName = '{{ field_name|default:"department"|escapejs }}';
    const searchInput = document.getElementById(fieldName + '-search');
    const hiddenInput = document.getElementById(fieldName);
    const dropdown = document.getElementById(fieldName + '-dropdown');

    // Department data
    const departments = [
        {% for dept in departments %}
        {
            id: {{ dept.id }},
            name: '{{ dept.name|escapejs }}',
            code: '{{ dept.code|escapejs }}'
        }{% if not forloop.last %},{% endif %}
        {% endfor %}
    ];

    let selectedIndex = -1;

    function showDropdown() {
        if (departments.length === 0) {
            dropdown.innerHTML = '<div style="padding: 8px; font-size: 12px; color: #6b7280;">No departments available</div>';
        } else {
            renderDepartments(departments);
        }
        dropdown.style.display = 'block';
    }

    function hideDropdown() {
        dropdown.style.display = 'none';
        selectedIndex = -1;
    }

    function renderDepartments(depts) {
        if (depts.length === 0) {
            dropdown.innerHTML = '<div style="padding: 8px; font-size: 12px; color: #6b7280;">No departments found</div>';
            return;
        }

        dropdown.innerHTML = depts.map((dept, index) =>
            `<div class="autocomplete-item-${fieldName}" data-index="${index}" data-id="${dept.id}" data-name="${dept.name}" style="padding: 8px; cursor: pointer; font-size: 12px; border-bottom: 1px solid #f3f4f6;">
                <div style="font-weight: 600; color: #1f2937;">${dept.name}</div>
                <div style="font-size: 11px; color: #6b7280;">Code: ${dept.code}</div>
            </div>`
        ).join('');

        // Add click handlers
        document.querySelectorAll('.autocomplete-item-' + fieldName).forEach(item => {
            item.addEventListener('click', function() {
                selectDepartment(this.dataset.id, this.dataset.name);
            });

            item.addEventListener('mouseenter', function() {
                selectedIndex = parseInt(this.dataset.index);
                highlightItem();
            });
        });
    }

    function selectDepartment(id, name) {
        hiddenInput.value = id;
        searchInput.value = name;
        hideDropdown();
    }

    function filterDepartments(query) {
        if (!query) {
            return departments;
        }

        query = query.toLowerCase();
        return departments.filter(dept =>
            dept.name.toLowerCase().includes(query) ||
            dept.code.toLowerCase().includes(query)
        );
    }

    function highlightItem() {
        document.querySelectorAll('.autocomplete-item-' + fieldName).forEach((item, index) => {
            if (index === selectedIndex) {
                item.style.background = '#eff6ff';
            } else {
                item.style.background = 'white';
            }
        });
    }

    // Event listeners
    searchInput.addEventListener('focus', showDropdown);

    searchInput.addEventListener('input', function() {
        const filtered = filterDepartments(this.value);
        renderDepartments(filtered);
        selectedIndex = -1;
    });

    searchInput.addEventListener('keydown', function(e) {
        const items = document.querySelectorAll('.autocomplete-item-' + fieldName);

        if (e.key === 'ArrowDown') {
            e.preventDefault();
            selectedIndex = Math.min(selectedIndex + 1, items.length - 1);
            highlightItem();
            items[selectedIndex]?.scrollIntoView({ block: 'nearest' });
        } else if (e.key === 'ArrowUp') {
            e.preventDefault();
            selectedIndex = Math.max(selectedIndex - 1, 0);
            highlightItem();
            items[selectedIndex]?.scrollIntoView({ block: 'nearest' });
        } else if (e.key === 'Enter' && selectedIndex >= 0) {
            e.preventDefault();
            const item = items[selectedIndex];
            if (item) {
                selectDepartment(item.dataset.id, item.dataset.name);
            }
        } else if (e.key === 'Escape') {
            hideDropdown();
        }
    });

    // Click outside to close
    document.addEventListener('click', function(e) {
        if (!searchInput.contains(e.target) && !dropdown.contains(e.target)) {
            hideDropdown();
        }
    });
})();
</script>
