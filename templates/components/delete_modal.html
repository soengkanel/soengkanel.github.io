<!-- Global Delete Confirmation Modal Component -->
<div class="modal fade" id="deleteModal" tabindex="-1" role="dialog" aria-labelledby="deleteModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-sm" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteModalLabel">
                    <i class="bi bi-exclamation-triangle-fill text-danger me-1"></i>
                    <span id="deleteModalTitle">Delete Item?</span>
                </h5>
                <button type="button" class="btn-close btn-close-sm" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p class="mb-2" id="deleteModalName" style="font-size: 12px; font-weight: 500; color: #1f2937;"></p>
                <p class="text-muted mb-0" style="font-size: 11px;">
                    <i class="bi bi-info-circle me-1"></i>
                    This action cannot be undone
                </p>
            </div>
            <div class="modal-footer">
                <div class="d-flex gap-1 w-100 justify-content-end">
                    <button type="button" class="button-min-warn py-1" data-bs-dismiss="modal">
                        <i class="bi bi-x-circle me-1"></i>
                        Cancel
                    </button>
                    <button type="button" class="button-min-danger py-1" id="confirmDeleteBtn">
                        <i class="bi bi-trash3 me-1"></i>
                        Delete
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    /* Modal Styles - Following Design Guideline */
    #deleteModal {
        z-index: 1090 !important;
    }

    #deleteModal .modal-dialog {
        position: relative;
        margin: auto;
        z-index: 1091;
        max-width: 400px;
        width: 90%;
    }

    @media (min-width: 576px) {
        #deleteModal .modal-dialog {
            width: 400px;
        }
    }

    #deleteModal .modal-content {
        border: none;
        border-radius: 12px;
        box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        position: relative;
        z-index: 1091;
    }

    #deleteModal.modal.show .modal-dialog {
        animation: modalSlideIn 0.2s ease-out;
    }

    #deleteModal .modal-header {
        border-bottom: 1px solid #e5e7eb;
        padding: 0.75rem 1rem;
        position: relative;
        z-index: 1092;
    }

    #deleteModal .modal-title {
        font-weight: 600;
        font-size: 0.875rem;
        color: #1f2937;
    }

    #deleteModal .modal-title i {
        font-size: 0.875rem;
    }

    #deleteModal .modal-body {
        padding: 1rem;
        color: #4b5563;
        position: relative;
        z-index: 1092;
    }

    #deleteModal .modal-footer {
        border-top: 1px solid #e5e7eb;
        padding: 0.75rem 1rem;
        gap: 0.5rem;
        position: relative;
        z-index: 1092;
    }

    #deleteModal .modal-footer .btn,
    #deleteModal .modal-footer button {
        font-size: 11px;
        padding: 6px 12px;
        position: relative;
        z-index: 1093;
        pointer-events: auto !important;
    }

    #deleteModal .modal-footer .btn i,
    #deleteModal .modal-footer button i {
        font-size: 10px;
    }

    @keyframes modalSlideIn {
        from {
            opacity: 0;
            transform: scale(0.95) translateY(-10px);
        }
        to {
            opacity: 1;
            transform: scale(1) translateY(0);
        }
    }

    #deleteModal .modal-header .btn-close {
        position: relative;
        z-index: 1094;
        pointer-events: auto !important;
        font-size: 0.75rem;
        padding: 0.25rem;
    }

    /* Ensure backdrop doesn't block interaction */
    /* DO NOT set z-index here - it's handled in JavaScript */
    .modal-backdrop {
        position: fixed !important;
        top: 0 !important;
        left: 0 !important;
        width: 100vw !important;
        height: 100vh !important;
    }

    .modal-backdrop.show {
        backdrop-filter: blur(3px);
    }

    /* Ensure delete modal backdrop is below the modal */
    #deleteModal ~ .modal-backdrop {
        z-index: 1085 !important;
    }

    /* Prevent body scroll when modal is open */
    body.modal-open {
        overflow: hidden;
        position: fixed;
        width: 100%;
    }

    /* Ensure modal doesn't cause page scroll when shown */
    #deleteModal.show {
        display: flex !important;
        align-items: center !important;
        justify-content: center !important;
        overflow-x: hidden;
        overflow-y: auto;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        width: 100vw;
        height: 100vh;
        padding: 1rem;
    }
</style>

<script>
// Global delete modal functionality
let currentDeleteUrl = null;

function initializeDeleteModal() {
    console.log('üóëÔ∏è DELETE MODAL: Initializing...');
    const deleteModalElement = document.getElementById('deleteModal');

    if (!deleteModalElement) {
        console.error('‚ùå DELETE MODAL: Modal element not found!');
        return;
    }

    const deleteModal = new bootstrap.Modal(deleteModalElement);
    const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');
    console.log('‚úÖ DELETE MODAL: Modal initialized');

    // Watch for backdrop creation and immediately fix it
    let backdropFixed = false;
    const observer = new MutationObserver((mutations) => {
        mutations.forEach((mutation) => {
            mutation.addedNodes.forEach((node) => {
                if (node.classList && node.classList.contains('modal-backdrop') && !backdropFixed) {
                    console.log('üé≠ DELETE BACKDROP DETECTED: Fixing immediately');

                    // Mark as fixed to prevent infinite loop
                    backdropFixed = true;

                    // Disconnect observer to prevent loop
                    observer.disconnect();

                    // CRITICAL: Move backdrop BEFORE the modal in DOM
                    if (deleteModalElement.parentNode && deleteModalElement.parentNode.contains(node)) {
                        deleteModalElement.parentNode.insertBefore(node, deleteModalElement);
                        console.log('‚úÖ Backdrop moved before modal in DOM');
                    }

                    // Set z-index lower than modal
                    node.style.setProperty('z-index', '1085', 'important');
                    node.style.setProperty('pointer-events', 'auto', 'important');

                    console.log('‚úÖ Delete backdrop fixed - z-index:', node.style.zIndex);
                }
            });
        });
    });

    // Start observing when modal is about to show
    deleteModalElement.addEventListener('show.bs.modal', function() {
        // CRITICAL: Remove aria-hidden IMMEDIATELY to prevent accessibility warning
        this.removeAttribute('aria-hidden');
        console.log('‚úÖ DELETE MODAL: aria-hidden removed before show');

        // Reset flag for each modal show
        backdropFixed = false;
        observer.observe(document.body, { childList: true });
        console.log('üëÄ DELETE OBSERVER: Started watching for backdrop');

        // Set modal z-index IMMEDIATELY
        deleteModalElement.style.setProperty('z-index', '1090', 'important');

        // Also try to fix any existing backdrop immediately
        setTimeout(() => {
            const existingBackdrop = document.querySelector('.modal-backdrop');
            if (existingBackdrop) {
                console.log('üîß Found existing backdrop, fixing immediately');

                // Move it before the modal
                if (deleteModalElement.parentNode) {
                    deleteModalElement.parentNode.insertBefore(existingBackdrop, deleteModalElement);
                }

                existingBackdrop.style.setProperty('z-index', '1085', 'important');
                console.log('‚úÖ Existing backdrop fixed');
            }
        }, 10);
    });

    // Stop observing after modal is shown
    deleteModalElement.addEventListener('shown.bs.modal', function() {
        setTimeout(() => {
            observer.disconnect();
            console.log('üëÄ DELETE OBSERVER: Stopped watching');

            // Double-check backdrop z-index
            const backdrop = document.querySelector('.modal-backdrop.show');
            if (backdrop) {
                const backdropZIndex = window.getComputedStyle(backdrop).zIndex;
                const modalZIndex = window.getComputedStyle(deleteModalElement).zIndex;
                console.log('üîç Backdrop z-index:', backdropZIndex);
                console.log('üîç Modal z-index:', modalZIndex);

                // Force fix if needed
                if (parseInt(backdropZIndex) >= parseInt(modalZIndex)) {
                    console.warn('‚ö†Ô∏è Backdrop z-index is higher! Forcing fix...');
                    backdrop.style.setProperty('z-index', '1085', 'important');
                }
            }
        }, 100);

        // Ensure modal has higher z-index than backdrop
        deleteModalElement.style.setProperty('z-index', '1090', 'important');

        // Ensure modal uses flexbox centering
        deleteModalElement.style.setProperty('display', 'flex', 'important');
        deleteModalElement.style.setProperty('align-items', 'center', 'important');
        deleteModalElement.style.setProperty('justify-content', 'center', 'important');

        // Ensure modal dialog is positioned correctly
        const modalDialog = deleteModalElement.querySelector('.modal-dialog');
        if (modalDialog) {
            modalDialog.style.setProperty('position', 'relative', 'important');
            modalDialog.style.setProperty('margin', 'auto', 'important');
            modalDialog.style.setProperty('transform', 'none', 'important');
            console.log('‚úÖ Modal dialog centered with flexbox');
        }

        // Ensure all interactive elements have pointer-events enabled
        const allInteractive = deleteModalElement.querySelectorAll('input, select, textarea, button');
        allInteractive.forEach(element => {
            element.style.setProperty('pointer-events', 'auto', 'important');
        });

        // Focus first element
        const focusableElement = deleteModalElement.querySelector('button:not([data-bs-dismiss])');
        if (focusableElement) {
            focusableElement.focus();
        }

        console.log('‚úÖ DELETE MODAL: All interactive elements enabled');
    });

    // Keyboard navigation
    deleteModalElement.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            const modalInstance = bootstrap.Modal.getInstance(deleteModalElement);
            if (modalInstance) {
                modalInstance.hide();
            }
        }
    });

    // Restore ARIA attributes after modal is completely hidden
    deleteModalElement.addEventListener('hidden.bs.modal', function() {
        // Restore aria-hidden after modal is completely hidden and focus is gone
        this.setAttribute('aria-hidden', 'true');

        // Remove focus from modal if it still has it
        if (document.activeElement === this || this.contains(document.activeElement)) {
            document.activeElement.blur();
        }

        console.log('‚úÖ DELETE MODAL: aria-hidden restored after hide');
    });

    // Handle delete button clicks
    document.addEventListener('click', function(e) {
        if (e.target.closest('.delete-btn')) {
            e.preventDefault();
            const button = e.target.closest('.delete-btn');

            const title = button.dataset.deleteTitle || 'Delete Item?';
            const name = button.dataset.deleteName || '';
            const url = button.dataset.deleteUrl || button.href;

            console.log('üóëÔ∏è DELETE MODAL: Delete button clicked');
            console.log('üéØ Delete URL:', url);
            console.log('üìù Item name:', name);
            console.log('üè∑Ô∏è Title:', title);

            // Validate URL
            if (!url || url === 'undefined' || url === '#') {
                console.error('‚ùå DELETE MODAL: Invalid delete URL');
                if (typeof showToast === 'function') {
                    showToast('Error: Invalid delete URL', false);
                } else {
                    alert('Error: Invalid delete URL');
                }
                return;
            }

            // Store delete URL
            currentDeleteUrl = url;

            // Update modal content
            document.querySelector('#deleteModalTitle').textContent = title;
            document.getElementById('deleteModalName').textContent = name;

            // Show modal
            deleteModal.show();

            // Ensure flexbox centering
            setTimeout(() => {
                deleteModalElement.style.setProperty('display', 'flex', 'important');
                deleteModalElement.style.setProperty('align-items', 'center', 'important');
                deleteModalElement.style.setProperty('justify-content', 'center', 'important');

                const modalDialog = deleteModalElement.querySelector('.modal-dialog');
                if (modalDialog) {
                    modalDialog.style.setProperty('position', 'relative', 'important');
                    modalDialog.style.setProperty('margin', 'auto', 'important');
                }
            }, 0);

            console.log('‚úÖ DELETE MODAL: Modal shown successfully');
        }
    });

    // Handle delete confirmation
    confirmDeleteBtn.addEventListener('click', function() {
        console.log('üî• DELETE MODAL: Confirm delete button clicked');

        if (currentDeleteUrl) {
            // Get CSRF token
            function getCSRFToken() {
                const csrfMeta = document.querySelector('meta[name="csrf-token"]');
                if (csrfMeta) return csrfMeta.getAttribute('content');

                const csrfInput = document.querySelector('[name=csrfmiddlewaretoken]');
                if (csrfInput) return csrfInput.value;

                const csrfCookie = document.cookie.match(/csrftoken=([^;]+)/);
                if (csrfCookie) return csrfCookie[1];

                return null;
            }

            const csrfToken = getCSRFToken();

            if (!csrfToken) {
                alert('Security token not found. Please refresh the page and try again.');
                return;
            }

            // Show loading state
            const originalContent = confirmDeleteBtn.innerHTML;
            confirmDeleteBtn.disabled = true;
            confirmDeleteBtn.innerHTML = '<i class="bi bi-hourglass-split me-1"></i>Deleting...';

            // Create and submit form
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = currentDeleteUrl;

            const csrfInput = document.createElement('input');
            csrfInput.type = 'hidden';
            csrfInput.name = 'csrfmiddlewaretoken';
            csrfInput.value = csrfToken;
            form.appendChild(csrfInput);

            // Add timeout to prevent indefinite hanging
            const timeoutId = setTimeout(() => {
                confirmDeleteBtn.disabled = false;
                confirmDeleteBtn.innerHTML = originalContent;
                deleteModal.hide();
            }, 10000);

            form.addEventListener('submit', function() {
                clearTimeout(timeoutId);
                deleteModal.hide();
            });

            document.body.appendChild(form);

            try {
                console.log('üì§ DELETE MODAL: Submitting form to:', currentDeleteUrl);
                form.submit();
                console.log('‚úÖ DELETE MODAL: Form submitted successfully');
            } catch (error) {
                console.error('‚ùå DELETE MODAL: Error submitting form:', error);
                console.error('‚ùå Stack trace:', error.stack);

                // Show user-friendly error message
                if (typeof showToast === 'function') {
                    showToast('Error deleting item: ' + error.message, false);
                } else {
                    alert('Error submitting delete request: ' + error.message);
                }

                confirmDeleteBtn.disabled = false;
                confirmDeleteBtn.innerHTML = originalContent;
            }
        }
    });

    // Reset modal when hidden
    deleteModalElement.addEventListener('hidden.bs.modal', function() {
        currentDeleteUrl = null;
        confirmDeleteBtn.disabled = false;
        confirmDeleteBtn.innerHTML = '<i class="bi bi-trash3 me-1"></i>Delete';

        // Reset modal content
        document.querySelector('#deleteModalTitle').textContent = 'Delete Item?';
        document.getElementById('deleteModalName').textContent = '';
    });
}

// Initialize when DOM is loaded
document.addEventListener('DOMContentLoaded', initializeDeleteModal);
</script>
