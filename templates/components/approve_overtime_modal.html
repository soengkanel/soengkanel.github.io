{% load i18n %}
<!-- Approve Overtime Modal Component -->
<div class="modal fade" id="approveOvertimeModal" tabindex="-1" aria-labelledby="approveOvertimeModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="approveOvertimeModalLabel">
                    <i class="bi bi-check-circle-fill text-success me-1"></i>
                    <span>{% trans "Approve Overtime Request" %}</span>
                </h5>
                <button type="button" class="btn-close btn-close-sm" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p class="mb-2" style="font-size: 12px; font-weight: 500;">
                    <span id="approveOvertimeEmployeeName"></span> - <span id="approveOvertimeDate"></span>
                </p>
                <div class="mb-3">
                    <p style="font-size: 12px; color: #6b7280;">
                        <strong>{% trans "Hours:" %}</strong> <span id="approveOvertimeHours"></span><br>
                        <strong>{% trans "Rate:" %}</strong> <span id="approveOvertimeRate"></span><br>
                        <strong>{% trans "Amount:" %}</strong> <span id="approveOvertimeAmount"></span>
                    </p>
                </div>
                <p class="text-muted mb-0" style="font-size: 11px;">
                    <i class="bi bi-info-circle me-1"></i>
                    {% trans "Are you sure you want to approve this overtime request?" %}
                </p>
            </div>
            <div class="modal-footer">
                <div class="d-flex gap-1 w-100 justify-content-end">
                    <button type="button" class="button-min-default py-1" data-bs-dismiss="modal">
                        {% trans "Cancel" %}
                    </button>
                    <button type="button" class="button-min-success py-1" id="confirmApproveBtn">
                        <i class="bi bi-check-circle me-1"></i>
                        {% trans "Approve Request" %}
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    /* Approve Overtime Modal Styles */
    #approveOvertimeModal {
        z-index: 1080 !important;
    }

    #approveOvertimeModal .modal-dialog {
        margin: 1.75rem auto;
        position: relative;
        z-index: 1081;
        max-width: 500px;
    }

    #approveOvertimeModal .modal-content {
        border: none;
        border-radius: 12px;
        box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        position: relative;
        z-index: 1081;
    }

    #approveOvertimeModal.modal.show .modal-content {
        animation: modalSlideIn 0.3s ease-out;
    }

    #approveOvertimeModal .modal-header {
        border-bottom: 1px solid #e5e7eb;
        padding: 0.75rem 1rem;
        position: relative;
        z-index: 1082;
    }

    #approveOvertimeModal .modal-title {
        font-weight: 600;
        font-size: 0.875rem;
        color: #1f2937;
    }

    #approveOvertimeModal .modal-title i {
        font-size: 0.875rem;
    }

    #approveOvertimeModal .modal-body {
        padding: 1rem;
        color: #4b5563;
        position: relative;
        z-index: 1082;
    }

    #approveOvertimeModal .modal-footer {
        border-top: 1px solid #e5e7eb;
        padding: 0.75rem 1rem;
        gap: 0.5rem;
        position: relative;
        z-index: 1082;
    }

    #approveOvertimeModal .form-control {
        font-size: 12px;
        border-radius: 6px;
        border: 1px solid #d1d5db;
    }

    #approveOvertimeModal .form-control:focus {
        border-color: #10b981;
        box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
    }

    #approveOvertimeModal .form-label {
        font-size: 11px;
        font-weight: 600;
        color: #374151;
        margin-bottom: 0.5rem;
    }

    #approveOvertimeModal .modal-header .btn-close {
        position: relative;
        z-index: 1084;
        pointer-events: auto;
        font-size: 0.75rem;
        padding: 0.25rem;
    }

    @keyframes modalSlideIn {
        from {
            opacity: 0;
            transform: scale(0.95) translateY(-20px);
        }
        to {
            opacity: 1;
            transform: scale(1) translateY(0);
        }
    }
</style>

<script>
// Approve overtime modal functionality
let currentApproveRequestId = null;

function initializeApproveOvertimeModal() {
    console.log('‚úÖ APPROVE MODAL: Initializing...');
    const approveModalElement = document.getElementById('approveOvertimeModal');

    if (!approveModalElement) {
        console.error('‚ùå APPROVE MODAL: Modal element not found!');
        return;
    }

    const approveModal = new bootstrap.Modal(approveModalElement);
    const confirmApproveBtn = document.getElementById('confirmApproveBtn');

    console.log('‚úÖ APPROVE MODAL: Modal initialized');

    // Watch for backdrop creation
    const observer = new MutationObserver((mutations) => {
        mutations.forEach((mutation) => {
            mutation.addedNodes.forEach((node) => {
                if (node.classList && node.classList.contains('modal-backdrop')) {
                    if (approveModalElement.parentNode) {
                        approveModalElement.parentNode.insertBefore(node, approveModalElement);
                    }
                    node.style.setProperty('z-index', '1075', 'important');
                }
            });
        });
    });

    approveModalElement.addEventListener('show.bs.modal', function() {
        observer.observe(document.body, { childList: true });
        approveModalElement.style.setProperty('z-index', '1080', 'important');
    });

    approveModalElement.addEventListener('shown.bs.modal', function() {
        setTimeout(() => {
            observer.disconnect();
        }, 100);

        // Ensure all interactive elements have pointer-events enabled
        const allInteractive = approveModalElement.querySelectorAll('input, select, textarea, button');
        allInteractive.forEach(element => {
            element.style.setProperty('pointer-events', 'auto', 'important');
        });
    });

    // Handle approve confirmation
    confirmApproveBtn.addEventListener('click', function() {
        console.log('üî• APPROVE MODAL: Confirm approve button clicked');

        if (currentApproveRequestId) {
            // Get CSRF token
            function getCSRFToken() {
                const csrfMeta = document.querySelector('meta[name="csrf-token"]');
                if (csrfMeta) return csrfMeta.getAttribute('content');

                const csrfInput = document.querySelector('[name=csrfmiddlewaretoken]');
                if (csrfInput) return csrfInput.value;

                const csrfCookie = document.cookie.match(/csrftoken=([^;]+)/);
                if (csrfCookie) return csrfCookie[1];

                return null;
            }

            const csrfToken = getCSRFToken();

            if (!csrfToken) {
                alert('Security token not found. Please refresh the page and try again.');
                return;
            }

            // Show loading state
            const originalContent = confirmApproveBtn.innerHTML;
            confirmApproveBtn.disabled = true;
            confirmApproveBtn.innerHTML = '<i class="bi bi-hourglass-split me-1"></i>Approving...';

            // Create and submit form
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = `/attendance/overtime/${currentApproveRequestId}/approve/`;

            const csrfInput = document.createElement('input');
            csrfInput.type = 'hidden';
            csrfInput.name = 'csrfmiddlewaretoken';
            csrfInput.value = csrfToken;
            form.appendChild(csrfInput);

            const actionInput = document.createElement('input');
            actionInput.type = 'hidden';
            actionInput.name = 'action';
            actionInput.value = 'approve';
            form.appendChild(actionInput);

            // Add timeout to prevent indefinite hanging
            const timeoutId = setTimeout(() => {
                confirmApproveBtn.disabled = false;
                confirmApproveBtn.innerHTML = originalContent;
                approveModal.hide();
            }, 10000);

            form.addEventListener('submit', function() {
                clearTimeout(timeoutId);
                approveModal.hide();
            });

            document.body.appendChild(form);

            try {
                form.submit();
                console.log('‚úÖ APPROVE MODAL: Form submitted successfully');
            } catch (error) {
                console.error('‚ùå APPROVE MODAL: Error submitting form:', error);
                alert('Error submitting approval: ' + error.message);
                confirmApproveBtn.disabled = false;
                confirmApproveBtn.innerHTML = originalContent;
            }
        }
    });

    // Reset modal when hidden
    approveModalElement.addEventListener('hidden.bs.modal', function() {
        currentApproveRequestId = null;
        confirmApproveBtn.disabled = false;
        confirmApproveBtn.innerHTML = '<i class="bi bi-check-circle me-1"></i>{% trans "Approve Request" %}';
    });
}

// Global function to show approve modal
function showApproveModal(requestId, employeeName, date, hours, rate, amount) {
    currentApproveRequestId = requestId;
    document.getElementById('approveOvertimeEmployeeName').textContent = employeeName;
    document.getElementById('approveOvertimeDate').textContent = date;
    document.getElementById('approveOvertimeHours').textContent = hours + 'h';
    document.getElementById('approveOvertimeRate').textContent = rate + 'x';
    document.getElementById('approveOvertimeAmount').textContent = '$' + amount;

    const approveModalElement = document.getElementById('approveOvertimeModal');
    const approveModal = bootstrap.Modal.getInstance(approveModalElement) || new bootstrap.Modal(approveModalElement);
    approveModal.show();
}

// Initialize when DOM is loaded
document.addEventListener('DOMContentLoaded', initializeApproveOvertimeModal);
</script>
