{% extends 'base/base.html' %} {% load static %} {% block title %}Permissions:
{{ role.name }} - User Management{% endblock %} {% block main_class %}col-md-10
ms-sm-auto col-lg-10{% endblock %} {% block extra_css %} {{ block.super }}
<style>
  /* Role Permissions Matrix - Employee Table Style */
  .container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 8px;
  }

  .header {
    background: white;
    padding: 8px 12px;
    border-radius: 4px;
    margin-bottom: 12px;
    border: 1px solid #e2e8f0;
  }

  .header h1 {
    color: #374151;
    font-size: 16px;
    margin-bottom: 2px;
    font-weight: 600;
  }

  .header p {
    color: #6b7280;
    font-size: 11px;
  }

  .nav-buttons {
    margin-bottom: 12px;
  }

  .btn {
    display: inline-block;
    padding: 3px 6px;
    margin: 1px;
    text-decoration: none;
    border-radius: 3px;
    font-size: 9px;
    border: none;
    cursor: pointer;
    font-weight: 500;
  }

  .btn-secondary {
    background: #6b7280;
    color: white;
  }
  .btn-primary {
    background: #3b82f6;
    color: white;
  }
  .btn:hover {
    opacity: 0.9;
  }

  /* Search functionality */
  .search-container {
    background: white;
    padding: 12px;
    border-radius: 4px;
    margin-bottom: 12px;
    border: 1px solid #e2e8f0;
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .search-input {
    flex: 1;
    padding: 6px 8px;
    border: 1px solid #d1d5db;
    border-radius: 3px;
    font-size: 11px;
    background: #f9f9f9;
  }

  .search-input:focus {
    outline: none;
    border-color: #3b82f6;
    background: #fff;
  }

  .search-stats {
    font-size: 10px;
    color: #6b7280;
    font-weight: 500;
  }

  .search-icon {
    color: #6b7280;
    font-size: 12px;
  }

  .matrix-container {
    background: white;
    border: 1px solid #e2e8f0;
    border-radius: 6px;
    overflow: hidden;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
  }

  .matrix-table {
    margin: 0;
    font-size: 12px;
  }

  .matrix-table th {
    font-size: 11px;
    font-weight: 600;
    color: #374151;
    background: #f8fafb;
    border-bottom: 1px solid #e2e8f0;
    padding: 8px 12px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    text-align: center;
  }

  .matrix-table th:first-child {
    text-align: left;
  }

  .matrix-table td {
    padding: 8px 12px;
    border-bottom: 1px solid #f1f5f9;
    text-align: center;
    vertical-align: middle;
  }

  .matrix-table tbody tr:last-child td {
    border-bottom: none;
  }

  .matrix-table tbody tr:hover {
    background: #f8fafb;
  }

  .matrix-table tr.hidden {
    display: none;
  }

  .model-name {
    font-weight: 600;
    color: #1a1a1a;
    text-align: left !important;
    font-size: 13px;
    margin: 0;
  }

  .app-name {
    font-size: 11px;
    color: #6b7280;
    text-align: left !important;
    margin: 2px 0 0 0;
  }

  .permission-checkbox {
    width: 14px;
    height: 14px;
    cursor: pointer;
  }

  .permission-cell {
    position: relative;
  }

  .actions-section {
    margin-top: 16px;
    background: #fff;
    padding: 12px;
    border-radius: 4px;
    border: 1px solid #e5e5e5;
  }

  .actions-section h3 {
    color: #333;
    margin-bottom: 8px;
    font-size: 12px;
    font-weight: 600;
  }

  .success-message {
    background: #dcfce7;
    color: #166534;
    padding: 6px;
    border-radius: 3px;
    margin-bottom: 12px;
    display: none;
    font-size: 10px;
  }

  .error-message {
    background: #fecaca;
    color: #991b1b;
    padding: 6px;
    border-radius: 3px;
    margin-bottom: 12px;
    display: none;
    font-size: 10px;
  }

  .no-results {
    text-align: center;
    padding: 24px;
    color: #666;
    font-size: 11px;
    display: none;
  }
</style>
{% endblock %} {% block content %}
<div class="container">
  <div class="flex justify-between items-start py-2">
    <div>
      <h1 class="text-lg font-medium">Permissions: <strong>{{ role.name }}</strong></h1>
      <p class="text-gray-500">{{ role.description|default:"No description" }}</p>
    </div>
    <div class="nav-buttons">
    
      <a
        href="{% url 'user_management:role_edit' role.id %}"
        class="button-min-primary"
        >Edit</a
      >
    </div>
  </div>

  

  <div id="messages">
    <div id="success-message" class="success-message"></div>
    <div id="error-message" class="error-message"></div>
  </div>

  <!-- Search functionality -->
  <div class="search-container mt-3">
    <i class="bi bi-search search-icon"></i>
    <input
      type="text"
      id="permission-search"
      class="search-input"
      placeholder="Search models or apps..."
      autocomplete="off"
    />
    <div class="search-stats">
      <span id="visible-count">{{ permission_matrix|length }}</span> / {{ permission_matrix|length }} models
    </div>
  </div>

  <div class="matrix-container">
    <table class="matrix-table w-full">
      <thead>
        <tr>
          <th style="width: 200px">Model</th>
          <th style="width: 60px">Add</th>
          <th style="width: 60px">View</th>
          <th style="width: 60px">Change</th>
          <th style="width: 60px">Delete</th>
        </tr>
      </thead>
      <tbody id="permissions-tbody">
        {% for perm in permission_matrix %}
        <tr
          class="permission-row"
          data-model-name="{{ perm.model_name|lower }}"
          data-app-name="{{ perm.app_name|lower }}"
        >
          <td>
            <div class="model-name">{{ perm.model_name }}</div>
            <div class="app-name">{{ perm.app_name }}</div>
          </td>
          <td class="permission-cell">
            {% if perm.add %}
            <input
              type="checkbox"
              class="permission-checkbox"
              data-role-id="{{ role.id }}"
              data-permission-id="{{ perm.add.id }}"
              {% if perm.has_add %}checked{% endif %}
            />
            {% else %}
            <span style="color: #ccc">—</span>
            {% endif %}
          </td>
          <td class="permission-cell">
        
            {% if perm.view %}
            <input
              type="checkbox"
              class="permission-checkbox"
              data-role-id="{{ role.id }}"
              data-permission-id="{{ perm.view.id }}"
              {% if perm.has_view %}checked{% endif %}
            />
            {% else %}
            <span style="color: #ccc">—</span>
            {% endif %}
          </td>
          <td class="permission-cell">
            {% if perm.change %}
            <input
              type="checkbox"
              class="permission-checkbox"
              data-role-id="{{ role.id }}"
              data-permission-id="{{ perm.change.id }}"
              {% if perm.has_change %}checked{% endif %}
            />
            {% else %}
            <span style="color: #ccc">—</span>
            {% endif %}
          </td>
          <td class="permission-cell">
            {% if perm.delete %}
            <input
              type="checkbox"
              class="permission-checkbox"
              data-role-id="{{ role.id }}"
              data-permission-id="{{ perm.delete.id }}"
              {%if perm.has_delete %}checked{% endif %}
            />
            {% else %}
            <span style="color: #ccc">—</span>
            {% endif %}
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
    <div id="no-results" class="no-results">
      No models found matching your search.
    </div>
  </div>

  {% comment %} <div class="actions-section">
    <h3>Actions</h3>
    <a href="{% url 'user_management:role_list' %}" class="btn btn-secondary"
      >Back</a
    >
    <a
      href="{% url 'user_management:role_edit' role.id %}"
      class="btn btn-primary"
      >Edit Role</a
    >
  </div> {% endcomment %}
</div>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    const checkboxes = document.querySelectorAll(".permission-checkbox");
    const successMessage = document.getElementById("success-message");
    const errorMessage = document.getElementById("error-message");
    const searchInput = document.getElementById("permission-search");
    const permissionRows = document.querySelectorAll(".permission-row");
    const visibleCount = document.getElementById("visible-count");
    const noResults = document.getElementById("no-results");
    const totalCount = permissionRows.length;

    // Search functionality
    searchInput.addEventListener("input", function () {
      const searchTerm = this.value.toLowerCase().trim();
      let visibleRows = 0;

      permissionRows.forEach((row) => {
        const modelName = row.dataset.modelName;
        const appName = row.dataset.appName;
        const isVisible =
          modelName.includes(searchTerm) || appName.includes(searchTerm);

        if (isVisible) {
          row.classList.remove("hidden");
          visibleRows++;
        } else {
          row.classList.add("hidden");
        }
      });

      // Update visible count
      visibleCount.textContent = visibleRows;

      // Show/hide no results message
      if (visibleRows === 0 && searchTerm !== "") {
        noResults.style.display = "block";
      } else {
        noResults.style.display = "none";
      }
    });

    // Permission checkbox functionality
    checkboxes.forEach((checkbox) => {
      checkbox.addEventListener("change", function () {
        const roleId = this.dataset.roleId;
        const permissionId = this.dataset.permissionId;
        const isChecked = this.checked;

        this.disabled = true;

        fetch('{% url "user_management:update_permission" %}', {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": "{{ csrf_token }}",
          },
          body: JSON.stringify({
            role_id: roleId,
            permission_id: permissionId,
            is_checked: isChecked,
          }),
        })
          .then((response) => response.json())
          .then((data) => {
            if (data.success) {
              showMessage(successMessage, data.message);
            } else {
              showMessage(errorMessage, data.message);
              this.checked = !isChecked;
            }
          })
          .catch((error) => {
            showMessage(errorMessage, "Error updating permissions.");
            this.checked = !isChecked;
          })
          .finally(() => {
            this.disabled = false;
          });
      });
    });

    function showMessage(element, message) {
      element.textContent = message;
      element.style.display = "block";
      setTimeout(() => {
        element.style.display = "none";
      }, 2000);
    }

    // Focus search input on Ctrl+F or Cmd+F
    document.addEventListener("keydown", function (e) {
      if ((e.ctrlKey || e.metaKey) && e.key === "f") {
        e.preventDefault();
        searchInput.focus();
        searchInput.select();
      }
    });
  });
</script>
{% endblock %}
