{% extends 'base/base.html' %}
{% load static %}

{% block title %}{% if user_form.instance.pk %}Edit User{% else %}Create User{% endif %} - User Management{% endblock %}

{% block main_class %}col-md-10 ms-sm-auto col-lg-10{% endblock %}

{% block extra_css %}
{{ block.super }}
<style>
/* Compact User Form */
.container {
    max-width: 600px;
    margin: 0 auto;
    padding: 12px;
}

.header {
    background: #fff;
    padding: 12px;
    border-radius: 4px;
    margin-bottom: 16px;
    border: 1px solid #e5e5e5;
}

.header h1 {
    color: #333;
    font-size: 18px;
    font-weight: 600;
}

.form-container {
    background: #fff;
    padding: 12px;
    border-radius: 8px;
    border: 1px solid #e5e5e5;
}

.form-group {
    margin-bottom: 12px;
}

.form-group label {
    display: block;
    margin-bottom: 4px;
    color: #333;
    font-size: 11px;
    font-weight: 500;
}

.form-group input, .form-group select, .form-group textarea {
    width: 100%;
    padding: 6px;
    border: 1px solid #d1d5db;
    border-radius: 3px;
    font-size: 11px;
}

.form-group input:focus, .form-group select:focus, .form-group textarea:focus {
    outline: none;
    border-color: #2563eb;
}

.form-group input.error, .form-group select.error, .form-group textarea.error {
    border-color: #dc2626;
}

.form-group.checkbox {
    display: flex;
    align-items: center;
}

.form-group.checkbox input {
    width: auto;
    margin-right: 6px;
}

.help-text {
    font-size: 9px;
    color: #666;
    margin-top: 2px;
}

.error {
    color: #dc2626;
    font-size: 9px;
    margin-top: 2px;
    font-weight: 500;
}

.form-errors {
    background-color: #fef2f2;
    border: 1px solid #fecaca;
    border-radius: 4px;
    padding: 8px;
    margin-bottom: 12px;
}

.form-errors ul {
    margin: 0;
    padding-left: 16px;
    color: #dc2626;
    font-size: 10px;
}

.btn {
    display: inline-block;
    padding: 6px 12px;
    margin: 2px;
    text-decoration: none;
    border-radius: 3px;
    font-size: 11px;
    border: none;
    cursor: pointer;
    font-weight: 500;
}

.btn-primary {
    background: #2563eb;
    color: white;
}

.btn-secondary {
    background: #6b7280;
    color: white;
}

.btn-danger {
    background: #dc3545;
    color: white;
}

.btn:hover {
    opacity: 0.9;
}

.actions {
    margin-top: 16px;
    padding-top: 12px;
    border-top: 1px solid #f0f0f0;
}

.required {
    color: #dc2626;
}
</style>
{% endblock %}

{% block content %}
<div class="container">
    <div class="flex py-2 justify-between">
        <h1 class="text-lg font-medium">{% if user_form.instance.pk %}Edit User{% else %}Create User{% endif %}</h1>
    </div>

    <div class="form-container rounded-lg p-3 mt-2">
        <!-- Display form-wide errors -->
        {% if user_form.non_field_errors or assignment_form.non_field_errors %}
        <div class="form-errors">
            {% if user_form.non_field_errors %}
                <ul>
                    {% for error in user_form.non_field_errors %}
                        <li>{{ error }}</li>
                    {% endfor %}
                </ul>
            {% endif %}
            {% if assignment_form.non_field_errors %}
                <ul>
                    {% for error in assignment_form.non_field_errors %}
                        <li>{{ error }}</li>
                    {% endfor %}
                </ul>
            {% endif %}
        </div>
        {% endif %}

        <form method="post" id="user-form">
            {% csrf_token %}
            
            <!-- User Fields -->
            <div class="form-group">
                <label for="{{ user_form.username.id_for_label }}">{{ user_form.username.label }}</label>
                {{ user_form.username }}
                {% if user_form.username.help_text %}<div class="help-text">{{ user_form.username.help_text }}</div>{% endif %}
                {% if user_form.username.errors %}<div class="error">{{ user_form.username.errors.0 }}</div>{% endif %}
            </div>

            <div class="form-group">
                <label for="{{ user_form.email.id_for_label }}">{{ user_form.email.label }}</label>
                {{ user_form.email }}
                {% if user_form.email.help_text %}<div class="help-text">{{ user_form.email.help_text }}</div>{% endif %}
                {% if user_form.email.errors %}<div class="error">{{ user_form.email.errors.0 }}</div>{% endif %}
            </div>

            <div class="form-group">
                <label for="{{ user_form.first_name.id_for_label }}">{{ user_form.first_name.label }}</label>
                {{ user_form.first_name }}
                {% if user_form.first_name.help_text %}<div class="help-text">{{ user_form.first_name.help_text }}</div>{% endif %}
                {% if user_form.first_name.errors %}<div class="error">{{ user_form.first_name.errors.0 }}</div>{% endif %}
            </div>

            <div class="form-group">
                <label for="{{ user_form.last_name.id_for_label }}">{{ user_form.last_name.label }}</label>
                {{ user_form.last_name }}
                {% if user_form.last_name.help_text %}<div class="help-text">{{ user_form.last_name.help_text }}</div>{% endif %}
                {% if user_form.last_name.errors %}<div class="error">{{ user_form.last_name.errors.0 }}</div>{% endif %}
            </div>

            {% if not user_form.instance.pk %}
            <div class="form-group">
                <label for="{{ user_form.password.id_for_label }}">{{ user_form.password.label }} <span class="required">*</span></label>
                {{ user_form.password }}
                {% if user_form.password.help_text %}<div class="help-text">{{ user_form.password.help_text }}</div>{% endif %}
                {% if user_form.password.errors %}<div class="error">{{ user_form.password.errors.0 }}</div>{% endif %}
            </div>

            <div class="form-group">
                <label for="{{ user_form.password_confirm.id_for_label }}">{{ user_form.password_confirm.label }} <span class="required">*</span></label>
                {{ user_form.password_confirm }}
                {% if user_form.password_confirm.help_text %}<div class="help-text">{{ user_form.password_confirm.help_text }}</div>{% endif %}
                {% if user_form.password_confirm.errors %}<div class="error">{{ user_form.password_confirm.errors.0 }}</div>{% endif %}
            </div>
            {% endif %}
            
            <div class="form-group checkbox">
                {{ user_form.is_active }}
                <label for="{{ user_form.is_active.id_for_label }}">{{ user_form.is_active.label }}</label>
                {% if user_form.is_active.help_text %}<div class="help-text">{{ user_form.is_active.help_text }}</div>{% endif %}
                {% if user_form.is_active.errors %}<div class="error">{{ user_form.is_active.errors.0 }}</div>{% endif %}
            </div>
            
            <div class="form-group checkbox">
                {{ user_form.is_staff }}
                <label for="{{ user_form.is_staff.id_for_label }}">{{ user_form.is_staff.label }}</label>
                {% if user_form.is_staff.help_text %}<div class="help-text">{{ user_form.is_staff.help_text }}</div>{% endif %}
                {% if user_form.is_staff.errors %}<div class="error">{{ user_form.is_staff.errors.0 }}</div>{% endif %}
            </div>

            <!-- Profile Fields -->
            {% if assignment_form %}
            {% if edit_user.is_superuser %}
            <div class="form-group">
                <label for="{{ assignment_form.role.id_for_label }}">{{ assignment_form.role.label }}</label>
                {{ assignment_form.role }}
                {% if assignment_form.role.help_text %}<div class="help-text">{{ assignment_form.role.help_text }}</div>{% endif %}
                {% if assignment_form.role.errors %}<div class="error">{{ assignment_form.role.errors.0 }}</div>{% endif %}
            </div>
            {% else %}
            <input type="hidden" id="role_id" name="role" value="{{assignment.role.id}}"/>
            {% endif %}
            <div class="form-group checkbox">
                {{ assignment_form.is_active }}
                <label for="{{ assignment_form.is_active.id_for_label }}">{{ assignment_form.is_active.label }}</label>
                {% if assignment_form.is_active.help_text %}<div class="help-text">{{ assignment_form.is_active.help_text }}</div>{% endif %}
                {% if assignment_form.is_active.errors %}<div class="error">{{ assignment_form.is_active.errors.0 }}</div>{% endif %}
            </div>

            {% if assignment_form.notes %}
            <div class="form-group">
                <label for="{{ assignment_form.notes.id_for_label }}">{{ assignment_form.notes.label }}</label>
                {{ assignment_form.notes }}
                {% if assignment_form.notes.help_text %}<div class="help-text">{{ assignment_form.notes.help_text }}</div>{% endif %}
                {% if assignment_form.notes.errors %}<div class="error">{{ assignment_form.notes.errors.0 }}</div>{% endif %}
            </div>
            {% endif %}
            {% endif %}

            <div class="flex justify-end space-x-3">
                
                <a href="{% url 'user_management:user_list' %}" class="button-min-danger">Cancel</a>
                <button type="submit" class="button-min-primary">Save</button>
            </div>
            
            <input type="hidden" name="user" id="user" value="{{edit_user.is_superuser}}"/>
        </form>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Add client-side validation for better UX
    const form = document.getElementById('user-form');
    
    form.addEventListener('submit', function(e) {
        let hasErrors = false;
        
        // Clear previous error states
        document.querySelectorAll('.form-group input, .form-group select').forEach(field => {
            field.classList.remove('error');
        });
        
        // Check required fields
        const requiredFields = ['username', 'email', 'first_name', 'last_name'];
        requiredFields.forEach(fieldName => {
            const field = document.querySelector(`[name="${fieldName}"]`);
            if (field && !field.value.trim()) {
                field.classList.add('error');
                hasErrors = true;
            }
        });
        
        // Check passwords match (if creating new user)
        const passwordField = document.querySelector('input[name="password"]');
        const passwordConfirmField = document.querySelector('input[name="password_confirm"]');
        
        if (passwordField && passwordConfirmField) {
            if (passwordField.value !== passwordConfirmField.value) {
                passwordField.classList.add('error');
                passwordConfirmField.classList.add('error');
                hasErrors = true;
                
                if (typeof toast !== 'undefined') {
                    toast.error('Passwords do not match');
                }
            }
            
            if (passwordField.value && passwordField.value.length < 8) {
                passwordField.classList.add('error');
                hasErrors = true;
                
                if (typeof toast !== 'undefined') {
                    toast.error('Password must be at least 8 characters long');
                }
            }
        }
        
        if (hasErrors) {
            e.preventDefault();
            if (typeof toast !== 'undefined') {
                toast.error('Please fix the form errors before submitting');
            }
        }
    });

    //set role admin option to disabled for role manager
    var userValue = document.getElementById("user");
   
    if(userValue.value == "False"){
        document.querySelector('#id_role').value  = document.getElementById("role_id").value;
        document.querySelector('#id_role').disabled=true;
    }
});
</script>
{% endblock %} 