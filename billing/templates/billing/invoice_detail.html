{% extends 'base/base.html' %}
{% load static %}

{% block title %}Invoice #{{ invoice.invoice_number }} - Billing{% endblock %}

{% block main_class %}col-md-10 ms-sm-auto col-lg-10{% endblock %}

{% block extra_css %}
<style>
    /* Enhanced Compact System Design */
    :root {
        --primary: #0066cc;
        --primary-dark: #0052a3;
        --primary-light: #e6f2ff;
        --success: #00a854;
        --warning: #ffab00;
        --danger: #e74c3c;
        --info: #0095ff;
        --text-primary: #1a1a1a;
        --text-secondary: #666666;
        --text-muted: #999999;
        --bg-primary: #ffffff;
        --bg-secondary: #f8f9fa;
        --bg-tertiary: #f0f2f5;
        --border-light: #e8eaed;
        --border-medium: #d2d5da;
        --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.08);
        --shadow-md: 0 2px 4px rgba(0, 0, 0, 0.12);
        --shadow-lg: 0 4px 8px rgba(0, 0, 0, 0.16);
        --radius-sm: 4px;
        --radius-md: 6px;
        --radius-lg: 8px;
    }

    /* Global reset for compact design */
    * {
        box-sizing: border-box;
    }

    /* Main container */
    .invoice-wrapper {
        max-width: 1400px;
        margin: 0 auto;
        padding: 16px;
    }

    /* Compact header */
    .invoice-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 16px;
        padding-bottom: 12px;
        border-bottom: 1px solid var(--border-light);
    }



    .header-actions {
        display: flex;
        gap: 8px;
        align-items: center;
    }

    /* Quick action bar */
    .quick-actions {
        background: var(--bg-secondary);
        border: 1px solid var(--border-light);
        border-radius: var(--radius-md);
        padding: 12px;
        margin-bottom: 16px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        flex-wrap: wrap;
        gap: 12px;
    }

    .invoice-status-pill {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 6px 12px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .status-pending {
        background: rgba(255, 171, 0, 0.15);
        color: #cc8800;
    }

    .status-paid {
        background: rgba(0, 168, 84, 0.15);
        color: #008642;
    }

    .status-overdue {
        background: rgba(231, 76, 60, 0.15);
        color: #c0392b;
    }

    .status-cancelled {
        background: rgba(102, 102, 102, 0.15);
        color: #4d4d4d;
    }

    .action-buttons {
        display: flex;
        gap: 8px;
        align-items: center;
    }

    /* Compact button styles */
    .btn-compact {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 6px 12px;
        border: 1px solid transparent;
        border-radius: var(--radius-sm);
        font-size: 13px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s;
        text-decoration: none;
        white-space: nowrap;
    }

    .btn-compact i {
        font-size: 14px;
    }

    .btn-primary {
        background: var(--primary);
        color: white;
        border-color: var(--primary);
    }

    .btn-primary:hover {
        background: var(--primary-dark);
        color: white;
        transform: translateY(-1px);
        box-shadow: var(--shadow-md);
    }

    .btn-outline {
        background: white;
        color: var(--primary);
        border-color: var(--border-medium);
    }

    .btn-outline:hover {
        background: var(--bg-secondary);
        color: var(--primary-dark);
        border-color: var(--primary);
    }

    .btn-success {
        background: var(--success);
        color: white;
    }

    .btn-success:hover {
        background: #008a43;
        color: white;
        transform: translateY(-1px);
    }

    .btn-warning {
        background: var(--warning);
        color: white;
    }

    .btn-warning:hover {
        background: #cc8800;
        color: white;
        transform: translateY(-1px);
    }

    /* Main content grid */
    .invoice-content {
        display: grid;
        grid-template-columns: 2fr 1fr;
        gap: 16px;
    }

    /* Info cards */
    .info-card {
        background: white;
        border: 1px solid var(--border-light);
        border-radius: var(--radius-md);
        overflow: hidden;
        box-shadow: var(--shadow-sm);
        transition: box-shadow 0.2s;
    }

    .info-card:hover {
        box-shadow: var(--shadow-md);
    }

    .card-header {
        background: var(--bg-secondary);
        padding: 10px 16px;
        border-bottom: 1px solid var(--border-light);
        display: flex;
        align-items: center;
        justify-content: space-between;
    }

    .card-title {
        font-size: 14px;
        font-weight: 600;
        color: var(--text-primary);
        margin: 0;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .card-title i {
        color: var(--primary);
        font-size: 16px;
    }

    .card-body {
        padding: 16px;
    }

    /* Compact info grid */
    .info-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 12px;
    }

    .info-item {
        display: flex;
        flex-direction: column;
        gap: 4px;
    }

    .info-label {
        font-size: 11px;
        font-weight: 600;
        color: var(--text-muted);
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .info-value {
        font-size: 14px;
        font-weight: 500;
        color: var(--text-primary);
    }

    .info-value.monospace {
        font-family: 'SF Mono', 'Monaco', 'Inconsolata', 'Fira Code', monospace;
    }

    .info-value.primary {
        color: var(--primary);
    }

    .info-value.danger {
        color: var(--danger);
    }

    /* Compact table design */
    .table-compact {
        width: 100%;
        font-size: 13px;
        border-collapse: collapse;
    }

    .table-compact thead {
        background: var(--bg-tertiary);
    }

    .table-compact th {
        padding: 10px 12px;
        text-align: left;
        font-weight: 600;
        font-size: 12px;
        color: var(--text-secondary);
        text-transform: uppercase;
        letter-spacing: 0.5px;
        border-bottom: 1px solid var(--border-light);
    }

    .table-compact td {
        padding: 12px;
        border-bottom: 1px solid var(--bg-secondary);
        vertical-align: top;
    }

    .table-compact tbody tr {
        transition: background 0.2s;
    }

    .table-compact tbody tr:hover {
        background: var(--bg-secondary);
    }

    .table-compact tbody tr:last-child td {
        border-bottom: none;
    }

    /* Line item styles */
    .item-description {
        font-weight: 500;
        color: var(--text-primary);
        line-height: 1.4;
    }

    .item-service {
        font-size: 11px;
        color: var(--text-muted);
        margin-top: 2px;
    }

    .item-notes {
        font-size: 11px;
        color: var(--text-secondary);
        font-style: italic;
        margin-top: 4px;
    }

    .text-right {
        text-align: right;
    }

    .text-nowrap {
        white-space: nowrap;
    }

    /* Totals section */
    .invoice-totals {
        background: var(--bg-tertiary);
        padding: 16px;
        border-top: 2px solid var(--border-light);
    }

    .totals-grid {
        display: grid;
        grid-template-columns: 1fr auto;
        gap: 8px;
        max-width: 300px;
        margin-left: auto;
    }

    .total-label {
        font-size: 13px;
        color: var(--text-secondary);
        text-align: right;
    }

    .total-value {
        font-size: 13px;
        font-weight: 600;
        color: var(--text-primary);
        text-align: right;
        min-width: 80px;
    }

    .total-row-final {
        padding-top: 8px;
        border-top: 2px solid var(--primary);
        margin-top: 8px;
    }

    .total-row-final .total-label,
    .total-row-final .total-value {
        font-size: 16px;
        font-weight: 700;
        color: var(--primary);
    }

    /* Sidebar cards */
    .sidebar-card {
        background: white;
        border: 1px solid var(--border-light);
        border-radius: var(--radius-md);
        padding: 16px;
        margin-bottom: 16px;
        box-shadow: var(--shadow-sm);
    }

    .sidebar-title {
        font-size: 14px;
        font-weight: 600;
        color: var(--text-primary);
        margin-bottom: 12px;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .sidebar-title i {
        color: var(--primary);
        font-size: 16px;
    }

    /* Payment timeline */
    .payment-timeline {
        position: relative;
        padding-left: 24px;
    }

    .timeline-item {
        position: relative;
        padding-bottom: 16px;
        border-left: 2px solid var(--border-light);
    }

    .timeline-item:last-child {
        border-left: none;
        padding-bottom: 0;
    }

    .timeline-dot {
        position: absolute;
        left: -25px;
        top: 2px;
        width: 10px;
        height: 10px;
        border-radius: 50%;
        background: white;
        border: 2px solid var(--border-medium);
    }

    .timeline-dot.active {
        background: var(--primary);
        border-color: var(--primary);
    }

    .timeline-date {
        font-size: 11px;
        color: var(--text-muted);
        margin-bottom: 2px;
    }

    .timeline-title {
        font-size: 13px;
        font-weight: 500;
        color: var(--text-primary);
    }

    /* Alert box */
    .alert-compact {
        padding: 10px 12px;
        border-radius: var(--radius-sm);
        font-size: 12px;
        display: flex;
        align-items: center;
        gap: 8px;
        margin-bottom: 12px;
    }

    .alert-warning {
        background: rgba(255, 171, 0, 0.1);
        border: 1px solid rgba(255, 171, 0, 0.3);
        color: #cc8800;
    }

    .alert-danger {
        background: rgba(231, 76, 60, 0.1);
        border: 1px solid rgba(231, 76, 60, 0.3);
        color: #c0392b;
    }

    /* Notes section */
    .notes-box {
        background: var(--bg-secondary);
        border: 1px solid var(--border-light);
        border-radius: var(--radius-sm);
        padding: 12px;
        font-size: 13px;
        line-height: 1.5;
        color: var(--text-secondary);
    }

    /* Print styles */
    @media print {

        .invoice-header,
        .quick-actions,
        .action-buttons,
        .btn-compact {
            display: none !important;
        }

        .invoice-content {
            grid-template-columns: 1fr;
        }

        .info-card,
        .sidebar-card {
            box-shadow: none;
            border: 1px solid #ddd;
            break-inside: avoid;
        }
    }

    /* Mobile responsive */
    @media (max-width: 768px) {
        .invoice-content {
            grid-template-columns: 1fr;
        }

        .quick-actions {
            flex-direction: column;
            align-items: stretch;
        }

        .action-buttons {
            width: 100%;
            justify-content: space-between;
        }

        .info-grid {
            grid-template-columns: 1fr;
        }

        .table-compact {
            font-size: 12px;
        }

        .table-compact th,
        .table-compact td {
            padding: 8px;
        }

        .hide-mobile {
            display: none;
        }
    }

    /* Workflow Steps Styling */
    .workflow-steps {
        position: relative;
    }

    .workflow-step {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 12px 0;
        position: relative;
        border-left: 2px solid var(--border-light);
        padding-left: 20px;
        margin-left: 15px;
    }

    .workflow-step:last-child {
        border-left: none;
    }

    .workflow-step.completed {
        border-left-color: var(--success);
    }

    .workflow-step.pending {
        border-left-color: var(--warning);
    }

    .workflow-step.inactive {
        border-left-color: var(--border-light);
        opacity: 0.6;
    }

    .step-icon {
        position: absolute;
        left: -28px;
        width: 24px;
        height: 24px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 12px;
        background: white;
        border: 2px solid var(--border-light);
        color: var(--text-muted);
    }

    .workflow-step.completed .step-icon {
        background: var(--success);
        border-color: var(--success);
        color: white;
    }

    .workflow-step.pending .step-icon {
        background: var(--warning);
        border-color: var(--warning);
        color: white;
    }

    .step-content {
        flex: 1;
        min-width: 0;
    }

    .step-title {
        font-size: 13px;
        font-weight: 600;
        color: var(--text-primary);
        margin-bottom: 2px;
    }

    .step-date,
    .step-subtitle {
        font-size: 11px;
        color: var(--text-muted);
        line-height: 1.3;
    }

    .step-actions {
        display: flex;
        flex-direction: column;
        gap: 4px;
    }

    .btn-step {
        font-size: 10px;
        padding: 4px 8px;
        border-radius: 3px;
        text-decoration: none;
        text-align: center;
        transition: all 0.2s;
        border: 1px solid var(--border-medium);
        background: white;
        color: var(--text-secondary);
        min-width: 50px;
    }

    .btn-step:hover {
        background: var(--bg-secondary);
        color: var(--primary);
        border-color: var(--primary);
    }

    .btn-step.active {
        background: var(--primary);
        color: white;
        border-color: var(--primary);
    }

    .btn-group-vertical {
        display: flex;
        flex-direction: column;
        gap: 2px;
    }

    /* Loading animation */
    @keyframes pulse {
        0% {
            opacity: 0.6;
        }

        50% {
            opacity: 1;
        }

        100% {
            opacity: 0.6;
        }
    }

    .loading {
        animation: pulse 1.5s ease-in-out infinite;
    }
</style>
{% endblock %}

{% block content %}
<div class="invoice-wrapper">
    <div class="py-3 px-1 flex items-start justify-between">
        <div>
            <h1 class="text-xl font-semibold">Invoice</h1>
        </div>
        <div class="text-right">
            <h1 class="text-lg font-semibold text-blue-500">#{{ invoice.invoice_number }}</h1>
            <span class="text-muted text-xs font-medium">Created {{ invoice.created_at|date:"d/m/Y" }}</span>
        </div>
    </div>

    <!-- Quick Actions Bar -->
    <div class="flex justify-between items-center py-3 px-3 border rounded-xl mb-4">
        <span class="invoice-status-pill status-{{ invoice.status }}{% if invoice.is_overdue and invoice.status == 'pending' %} status-overdue{% endif %}">
            <i class="bi bi-circle-fill" style="font-size: 8px;"></i>
            {% if invoice.is_overdue and invoice.status == 'pending' %}
                OVERDUE
            {% else %}
                {{ invoice.get_status_display|upper }}
            {% endif %}
        </span>
        <div>
        
        </div>
        
        <div class="flex space-x-3">
            {% if role.role.name == 'User'%}
            <a href="{% url 'billing:invoice_edit' invoice.id %}" class="button-min-default">
                <i class="bi bi-pencil"></i>
                <span class="hide-mobile">Edit</span>
            </a>
            
            <a href="{% url 'billing:invoice_print_preview' invoice.id %}" class="button-min-primary"
                target="_blank">
                <div>
                    <i class="bi bi-eye"></i>
                <span class="hide-mobile">Print Preview</span>
                </div>
            </a>
         
            {% else %}
            <a href="{% url 'billing:invoice_edit' invoice.id %}" class="button-min-default">
                <i class="bi bi-pencil"></i>
                <span class="hide-mobile">Edit</span>
            </a>
            {% if invoice.status == 'paid' %}
            {% if line_items.0 %}
           
                {% if line_items.0.service.name == 'Worker ID Card Replacement' %}
                    <a href="{% url 'cards:worker_id_card_print_preview' %}?cards={{ card.id }}" class="button-min-primary"
                    target="_blank">
                        <div>
                            <i class="fa fa-print"></i>
                             <span class="hide-mobile">Print Card</span>
                        </div>
                    </a>
                   
                {% endif%}
            {% endif %}
            {% endif %}

            <a href="{% url 'billing:invoice_print_preview' invoice.id %}" class="button-min-primary"
                target="_blank">
                <div>
                    <i class="bi bi-eye"></i>
                <span class="hide-mobile">Print Preview</span>
                </div>
            </a>
            {% if invoice.status != 'paid' %}
            {% comment %} <a href="{% url 'billing:cash_receipt_create' %}?invoice={{ invoice.id }}" class="button-min-primary">
               <div>
                <i class="bi bi-receipt"></i>
                Record Payment
               </div>
            </a> {% endcomment %}
                {%if role.role.name == 'Manager' or role.role.name == 'Admin' %}
                <a href="{% url 'billing:invoice_mark_paid' invoice.id %}" class="button-min-primary">
                <div>
                    <i class="bi bi-check-circle"></i>
                    Mark as Paid
                </div>
                </a>
                {% endif %}
            {% endif %}
            {% if invoice.status != 'cancelled' and invoice.status != 'paid' %}
            {%if role.role.name == 'Manager' or role.role.name == 'Admin' %}
            <a href="{% url 'billing:invoice_void' invoice.id %}" class="button-min-warn">
                <div>
                    <i class="bi bi-x-circle"></i>
                <span class="hide-mobile">Void</span>
                </div>
            </a>
            {% endif %}
            {% endif %}
            
            {%if role.role.name == 'Manager' or role.role.name == 'Admin' %}
            <a href="{% url 'billing:invoice_delete' invoice.id %}" class="button-min-danger">
               <div>
                <i class="bi bi-trash"></i>
                <span class="hide-mobile">Delete</span>
               </div>
            </a>
            {% endif %}

            {% endif %}
        </div>
    </div>

    <!-- Main Content Grid -->
    <div class="invoice-content">
        <!-- Left Column - Main Invoice Details -->
        <div>
            <!-- Invoice Information -->
            <div class="info-card">
                <div class="card-header">
                    <h3 class="card-title">
                        <i class="bi bi-info-circle"></i>
                        Invoice Information
                    </h3>
                </div>
                <div class="card-body">
                    <div class="info-grid">
                        <div class="info-item">
                            <span class="info-label">Invoice Number</span>
                            <span class="info-value monospace primary">{{ invoice.invoice_number }}</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Client</span>
                            <span class="info-value">{{ invoice.get_client_name }}</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Issue Date</span>
                            <span class="info-value">{{ invoice.issue_date|date:"d/m/Y" }}</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Due Date</span>
                            <span class="info-value {% if invoice.is_overdue %}danger{% endif %}">
                                {{ invoice.due_date|date:"d/m/Y" }}
                                {% if invoice.is_overdue %}
                                <small class="text-danger">({{ invoice.days_overdue }} days overdue)</small>
                                {% endif %}
                            </span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Line Items -->
            <div class="info-card mt-3">
                <div class="card-header">
                    <h3 class="card-title">
                        <i class="bi bi-list-ul"></i>
                        Line Items
                    </h3>
                    <span class="text-muted" style="font-size: 12px;">{{ line_items|length }} item{{ line_items|length|pluralize }}</span>
                </div>

                {% if line_items %}
                <div class="table-responsive">
                    <table class="table-compact">
                        <thead>
                            <tr>
                                <th width="50%">Description</th>
                                <th width="15%" class="text-right">Qty</th>
                                <th width="15%" class="text-right">Unit Price</th>
                                <th width="20%" class="text-right">Amount</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in line_items %}
                            <tr>
                                <td>
                                    <div class="item-description">{{ item.description }}</div>
                                    {% if item.service %}
                                    <div class="item-service">
                                        <i class="bi bi-tag" style="font-size: 10px;"></i>
                                        {{ item.service.name }}
                                    </div>
                                    {% endif %}
                                    {% if item.notes %}
                                    <div class="item-notes">{{ item.notes }}</div>
                                    {% endif %}
                                </td>
                                <td class="text-left text-nowrap">{{ item.quantity|floatformat:"-2" }}</td>
                                <td class="text-left text-nowrap">${{ item.unit_price|floatformat:2 }}</td>
                                <td class="text-left text-nowrap"><strong>${{ item.total_amount|floatformat:2 }}</strong></td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>

                <!-- Totals -->
                <div class="invoice-totals">
                    <div class="totals-grid">
                        <span class="total-label">Subtotal</span>
                        <span class="total-value">${{ invoice.subtotal|floatformat:2 }}</span>

                        {% if invoice.tax_amount %}
                        <span class="total-label">Tax</span>
                        <span class="total-value">${{ invoice.tax_amount|floatformat:2 }}</span>
                        {% endif %}

                        <div class="total-row-final">
                            <span class="total-label">Total</span>
                        </div>
                        <div class="total-row-final">
                            <span class="total-value">${{ invoice.total_amount|floatformat:2 }}</span>
                        </div>
                    </div>
                </div>
                {% else %}
                <div class="card-body text-center text-muted">
                    <i class="bi bi-inbox" style="font-size: 32px;"></i>
                    <p class="mt-2 mb-0">No line items found</p>
                </div>
                {% endif %}
            </div>

            <!-- Notes -->
            {% if invoice.notes %}
            <div class="info-card mt-3">
                <div class="card-header">
                    <h3 class="card-title">
                        <i class="bi bi-sticky-note"></i>
                        Notes
                    </h3>
                </div>
                <div class="card-body">
                    <div class="notes-box">
                        {{ invoice.notes|linebreaks }}
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Reference Documents -->
            {% if invoice.reference_document or invoice.reference_document_2 or invoice.reference_document_3 %}
            <div class="info-card mt-3">
                <div class="card-header">
                    <h3 class="card-title">
                        <i class="bi bi-paperclip"></i>
                        Reference Documents
                    </h3>
                </div>
                <div class="card-body">
                    <div class="row">
                        {% if invoice.reference_document %}
                        <div class="col-md-4 mb-3">
                            <div class="document-item">
                                <i class="bi bi-file-earmark-pdf text-danger fs-3 mb-2"></i>
                                <h6>Document 1</h6>
                                <a href="{{ invoice.reference_document.url }}" target="_blank" class="btn btn-sm btn-outline-primary">
                                    <i class="bi bi-download"></i> Download
                                </a>
                            </div>
                        </div>
                        {% endif %}
                        
                        {% if invoice.reference_document_2 %}
                        <div class="col-md-4 mb-3">
                            <div class="document-item">
                                <i class="bi bi-file-earmark-pdf text-danger fs-3 mb-2"></i>
                                <h6>Document 2</h6>
                                <a href="{{ invoice.reference_document_2.url }}" target="_blank" class="btn btn-sm btn-outline-primary">
                                    <i class="bi bi-download"></i> Download
                                </a>
                            </div>
                        </div>
                        {% endif %}
                        
                        {% if invoice.reference_document_3 %}
                        <div class="col-md-4 mb-3">
                            <div class="document-item">
                                <i class="bi bi-file-earmark-pdf text-danger fs-3 mb-2"></i>
                                <h6>Document 3</h6>
                                <a href="{{ invoice.reference_document_3.url }}" target="_blank" class="btn btn-sm btn-outline-primary">
                                    <i class="bi bi-download"></i> Download
                                </a>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% endif %}
        </div>

        <!-- Right Column - Sidebar -->
        <div>
            <!-- Billing Workflow -->
            <div class="sidebar-card p-0">
                <div class="px-3 py-2 bg-gray-100 border-b">
                    <h4 class="sidebar-title mb-1">
                        <i class="bi bi-arrow-right-circle"></i>
                        Billing Workflow
                    </h4>
                </div>
                
                <div class="workflow-steps p-3">
                    <!-- Step 1: Invoice Created -->
                    <div class="workflow-step completed">
                        <div class="step-icon">
                            <i class="bi bi-file-earmark-text"></i>
                        </div>
                        <div class="step-content">
                            <div class="step-title">Invoice Created</div>
                            <div class="step-date">{{ invoice.issue_date|date:"d/m/Y" }}</div>
                        </div>
                        <div class="step-actions">
                            {% comment %} <a href="{% url 'billing:invoice_detail' invoice.id %}" class="button-min-default py-1">View</a> {% endcomment %}
                        </div>
                    </div>

                    <!-- Step 2: Payment Collection -->
                    <div class="workflow-step {% if invoice.status == 'paid' %}completed{% else %}pending{% endif %}">
                        <div class="step-icon">
                            <i class="bi bi-cash-coin"></i>
                        </div>
                        <div class="step-content">
                            <div class="step-title">Payment Collection</div>
                            <div class="step-subtitle">
                                {% if invoice.status == 'paid' %}
                                    Payment received from client
                                {% else %}
                                    Awaiting client payment
                                {% endif %}
                            </div>
                        </div>
                        <div class="step-actions">
                            {% if invoice.status != 'paid' %}
                                <div class="btn-group-vertical">
                                    {% comment %} <a href="{% url 'billing:cash_receipt_create' %}?invoice={{ invoice.id }}" class="btn-step">Record Payment</a> {% endcomment %}
                                    {% comment %} <a href="{% url 'billing:invoice_mark_paid' invoice.id %}" class="button-min-primary py-1">Mark Paid</a> {% endcomment %}
                                </div>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Optional: Receipts Documentation (if any exist) -->
                    {% if invoice.has_receipts %}
                    <div class="workflow-step completed" style="border-left-color: #17a2b8; opacity: 0.9;">
                        <div class="step-icon" style="background: #17a2b8; border-color: #17a2b8;">
                            <i class="bi bi-receipt"></i>
                        </div>
                        <div class="step-content">
                            <div class="step-title">Receipt Documentation</div>
                            <div class="step-subtitle">
                                {% if invoice.official_receipts.count %}{{ invoice.official_receipts.count }} official{% endif %}
                                {% if invoice.cash_receipts.count %}{% if invoice.official_receipts.count %}, {% endif %}{{ invoice.cash_receipts.count }} cash{% endif %}
                            </div>
                        </div>
                        <div class="step-actions">
                            <div class="btn-group-vertical">
                                {% if invoice.official_receipts.count %}
                                    <a href="{% url 'billing:official_receipt_list' %}?invoice={{ invoice.id }}" class="button-min-default py-1">Official</a>
                                {% endif %}
                                {% if invoice.cash_receipts.count %}
                                    <a href="{% url 'billing:cash_receipt_list' %}?invoice={{ invoice.id }}" class="button-min-default py-1">Cash</a>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    {% endif %}

                    <!-- Step 3: Completed -->
                    <div class="workflow-step {% if invoice.status == 'paid' %}completed{% else %}pending{% endif %}">
                        <div class="step-icon">
                            <i class="bi bi-check-circle"></i>
                        </div>
                        <div class="step-content">
                            <div class="step-title">Completed</div>
                            <div class="step-subtitle">
                                {% if invoice.status == 'paid' %}
                                    Fully paid
                                {% else %}
                                    Balance: ${{ invoice.balance_due|floatformat:2 }}
                                {% endif %}
                            </div>
                        </div>
                        <div class="step-actions">
                            {% if invoice.status != 'paid' and invoice.balance_due <= 0 %}
                                <a href="{% url 'billing:invoice_mark_paid' invoice.id %}" class="button-min-primary py-1">Mark Paid</a>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>

            <!-- Payment Status -->
            <div class="sidebar-card">
                <h4 class="sidebar-title">
                    <i class="bi bi-credit-card"></i>
                    Payment Status
                </h4>

                {% if invoice.status == 'cancelled' %}
                <div class="alert-compact alert-danger">
                    <i class="bi bi-x-circle-fill"></i>
                    <strong>Invoice Voided</strong>
                </div>
                {% elif invoice.is_overdue and invoice.status == 'pending' %}
                <div class="alert-compact alert-danger">
                    <i class="bi bi-exclamation-triangle-fill"></i>
                    <strong>{{ invoice.days_overdue }} days overdue</strong>
                </div>
                {% elif invoice.status == 'pending' %}
                <div class="alert-compact alert-warning">
                    <i class="bi bi-clock-fill"></i>
                    Payment pending
                </div>
                {% endif %}

                <div class="info-grid mb-3">
                    <div class="info-item">
                        <span class="info-label">Amount Due</span>
                        <span class="info-value" style="font-size: 18px; font-weight: 700; color: var(--primary);">
                            ${{ invoice.total_amount|floatformat:2 }}
                        </span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Status</span>
                        <span class="invoice-status-pill status-{{ invoice.status }}{% if invoice.is_overdue and invoice.status == 'pending' %} status-overdue{% endif %}" style="margin-top: 4px;">
                            <i class="bi bi-circle-fill" style="font-size: 8px;"></i>
                            {% if invoice.is_overdue and invoice.status == 'pending' %}
                                OVERDUE
                            {% else %}
                                {{ invoice.get_status_display|upper }}
                            {% endif %}
                        </span>
                    </div>
                </div>

                <div class="payment-timeline mt-3">
                    <div class="timeline-item">
                        <div class="timeline-dot active"></div>
                        <div class="timeline-date">{{ invoice.issue_date|date:"d/m/Y" }}</div>
                        <div class="timeline-title">Invoice Issued</div>
                    </div>

                    {% if invoice.status == 'paid' %}
                    <div class="timeline-item">
                        <div class="timeline-dot active"></div>
                        <div class="timeline-date">{{ invoice.updated_at|date:"d/m/Y" }}</div>
                        <div class="timeline-title">Payment Received</div>
                    </div>
                    {% else %}
                    <div class="timeline-item">
                        <div class="timeline-dot"></div>
                        <div class="timeline-date">{{ invoice.due_date|date:"d/m/Y" }}</div>
                        <div class="timeline-title">Payment Due</div>
                    </div>
                    {% endif %}
                </div>
            </div>



            <!-- Activity Log -->
            <div class="sidebar-card">
                <h4 class="sidebar-title">
                    <i class="bi bi-clock-history"></i>
                    Activity
                </h4>

                <div style="font-size: 12px; color: var(--text-secondary);">
                    <div class="mb-2">
                        <strong>Created:</strong><br>
                        {{ invoice.created_at|date:"d/m/Y g:i A" }}<br>
                        <span class="text-muted">by {% if invoice.created_by %}{{ invoice.created_by.get_full_name|default:invoice.created_by.username }}{% else %}System{% endif %}</span>
                    </div>
                    {% if invoice.updated_at != invoice.created_at %}
                    <div>
                        <strong>Last Updated:</strong><br>
                        {{ invoice.updated_at|date:"d/m/Y g:i A" }}
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Add interactivity
    document.addEventListener('DOMContentLoaded', function () {
        // Add hover effect to table rows
        const tableRows = document.querySelectorAll('.table-compact tbody tr');
        tableRows.forEach(row => {
            row.addEventListener('mouseenter', function () {
                this.style.backgroundColor = 'var(--bg-secondary)';
            });
            row.addEventListener('mouseleave', function () {
                this.style.backgroundColor = '';
            });
        });

        // Keyboard shortcuts
        document.addEventListener('keydown', function (e) {
            // Ctrl/Cmd + E for edit
            if ((e.ctrlKey || e.metaKey) && e.key === 'e') {
                e.preventDefault();
                window.location.href = "{% url 'billing:invoice_edit' invoice.id %}";
            }
        });
    });
</script>
{% endblock %}