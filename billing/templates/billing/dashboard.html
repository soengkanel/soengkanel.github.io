{% extends 'base/base.html' %}
{% load static %}

{% block title %}Billing Management{% endblock %}

{% block main_class %}col-md-10 ms-sm-auto col-lg-10{% endblock %}

{% block extra_css %}
{% include 'includes/compact_ui.html' %}
<style>
/* Override base template transition to prevent left-to-right animation */
#main-content {
    transition: none !important;
}

/* Billing-specific compact styles */
.workflow-steps {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: var(--space-6);
    margin-bottom: var(--space-8);
}

.workflow-step {
    background: var(--white);
    border: var(--border);
    border-radius: 8px;
    padding: var(--space-6);
    transition: var(--transition);
}

.workflow-step:hover {
    border-color: var(--primary);
    box-shadow: var(--shadow);
}

.step-number {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 2rem;
    height: 2rem;
    border-radius: 50%;
    background: var(--gray-100);
    color: var(--gray-700);
    font-size: var(--text-sm);
    font-weight: 600;
    margin-bottom: var(--space-4);
}

.step-number.step-1 { background: var(--primary-light); color: var(--primary-dark); }
.step-number.step-2 { background: var(--success-light); color: var(--success); }
.step-number.step-3 { background: var(--warning-light); color: var(--warning); }

.step-title {
    font-size: var(--text-lg);
    font-weight: 600;
    color: var(--black);
    margin: 0 0 var(--space-2) 0;
}

.step-description {
    font-size: var(--text-sm);
    color: var(--gray-600);
    margin: 0 0 var(--space-4) 0;
    line-height: 1.4;
}

.step-actions {
    display: flex;
    gap: var(--space-2);
    align-items: center;
}

.step-action {
    display: inline-flex;
    align-items: center;
    gap: var(--space-2);
    padding: var(--space-2) var(--space-4);
    background: var(--primary);
    color: var(--black);
    text-decoration: none;
    border-radius: var(--radius);
    font-size: var(--text-sm);
    font-weight: 500;
    transition: var(--transition);
}

.step-action:hover {
    background: var(--primary-dark);
    color: var(--white);
    text-decoration: none;
}

.step-link {
    font-size: var(--text-xs);
    color: var(--gray-500);
    text-decoration: none;
    transition: var(--transition);
}

.step-link:hover {
    color: var(--primary);
    text-decoration: underline;
}

/* Stats Grid */
.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: var(--space-6);
    margin-bottom: var(--space-8);
}

.stat-item {
    background: var(--white);
    border: var(--border);
    border-bottom: var(--border-thick);
    border-radius:8px;
    padding: var(--space-5);
    text-align: center;
}

.stat-value {
    font-size: var(--text-2xl);
    font-weight: 700;
    color: var(--black);
    margin-bottom: var(--space-1);
    line-height: 1;
}

.stat-label {
    font-size: var(--text-sm);
    color: var(--gray-500);
    font-weight: 500;
}

/* Activity Section */
.activity-section {
    background: var(--white);
    border: var(--border);
    border-radius: 8px;
    overflow: hidden;
}

.activity-header {
    background: var(--gray-50);
    padding: var(--space-5);
    border-bottom: var(--border);
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.activity-title {
    font-size: var(--text-lg);
    font-weight: 600;
    color: var(--black);
    margin: 0;
}

.view-all-link {
    font-size: var(--text-sm);
    color: var(--primary);
    text-decoration: none;
    transition: var(--transition);
}

.view-all-link:hover {
    color: var(--primary-dark);
    text-decoration: underline;
}

.activity-table {
    width: 100%;
    border-collapse: collapse;
    font-size: var(--text-sm);
}

.activity-table th {
    padding: var(--space-3) var(--space-5);
    text-align: left;
    font-weight: 600;
    color: var(--gray-700);
    background: var(--gray-50);
    border-bottom: var(--border);
    font-size: var(--text-xs);
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.activity-table td {
    padding: var(--space-3) var(--space-5);
    border-bottom: 1px solid var(--gray-100);
    color: var(--gray-700);
}

.activity-table tbody tr:hover {
    background: var(--gray-50);
    cursor: pointer;
}

/* Status Badges */
.status-badge {
    display: inline-block;
    padding: var(--space-1) var(--space-2);
    border-radius: var(--radius);
    font-size: var(--text-xs);
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.status-paid { background: var(--success-light); color: var(--success); }
.status-pending { background: var(--warning-light); color: var(--warning); }
.status-overdue { background: var(--danger-light); color: var(--danger); }
.status-cancelled { background: var(--gray-200); color: var(--gray-600); }

/* Empty State */
.empty-state {
    text-align: center;
    padding: var(--space-8);
    color: var(--gray-500);
}

.empty-state .icon {
    font-size: 3rem;
    margin-bottom: var(--space-4);
    color: var(--gray-300);
}

.empty-state p {
    font-size: var(--text-base);
    margin-bottom: var(--space-4);
}

/* Responsive */
@media (max-width: 768px) {
    .workflow-steps {
        grid-template-columns: 1fr;
        gap: var(--space-4);
    }
    
    .stats-grid {
        grid-template-columns: repeat(2, 1fr);
        gap: var(--space-4);
    }
    
    .activity-header {
        flex-direction: column;
        align-items: flex-start;
        gap: var(--space-2);
    }
    
    .step-actions {
        flex-direction: column;
        align-items: stretch;
    }
}

@media (max-width: 480px) {
    .stats-grid {
        grid-template-columns: 1fr;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="page-container shadow-none">
    <!-- Page Header -->
    <div class="page-header">
        <div class="page-header-center">
            <h1 class="page-title">
                Billing Management
            </h1>
        </div>
    </div>
<!-- Statistics -->
    <section class="stats-grid mt-3" style="display:none !important;">
        <div class="stat-item" style="border-left-color: var(--primary);">
            <div class="stat-value">{{ total_invoices|default:0 }}</div>
            <div class="stat-label">Total Invoices</div>
        </div>
        <div class="stat-item" style="border-left-color: var(--success);">
            <div class="stat-value">${{ total_revenue|floatformat:0|default:0 }}</div>
            <div class="stat-label">Revenue (Incoming)</div>
        </div>
        <div class="stat-item" style="border-left-color: var(--warning);">
            <div class="stat-value">{{ pending_count|default:0 }}</div>
            <div class="stat-label">Pending Payments</div>
        </div>
        <div class="stat-item" style="border-left-color: var(--info);">
            <div class="stat-value">{{ total_receipts|default:0 }}</div>
            <div class="stat-label">Receipts Issued</div>
        </div>
        <div class="stat-item" style="border-left-color: var(--warning);">
            <div class="stat-value">{{ total_vouchers|default:0 }}</div>
            <div class="stat-label">Payment Vouchers</div>
        </div>
        <div class="stat-item" style="border-left-color: var(--danger);">
            <div class="stat-value">${{ total_vouchers_amount|floatformat:0|default:0 }}</div>
            <div class="stat-label">Outgoing Payments</div>
        </div>
        <div class="stat-item" style="border-left-color: var(--warning);">
            <div class="stat-value">${{ pending_vouchers_amount|floatformat:0|default:0 }}</div>
            <div class="stat-label">Pending Approvals</div>
        </div>
        <div class="stat-item" style="border-left-color: var(--success);">
            <div class="stat-value">${{ approved_vouchers_amount|floatformat:0|default:0 }}</div>
            <div class="stat-label">Approved Payments</div>
        </div>
        <div class="stat-item" style="border-left-color: var(--info);">
            <div class="stat-value">${{ paid_vouchers_amount|floatformat:0|default:0 }}</div>
            <div class="stat-label">Paid Out</div>
        </div>
        <div class="stat-item" style="border-left-color: var(--secondary);">
            <div class="stat-value">${{ draft_invoices_amount|floatformat:0|default:0 }}</div>
            <div class="stat-label">Draft Invoices</div>
        </div>
        <div class="stat-item" style="border-left-color: var(--warning);">
            <div class="stat-value">${{ pending_approval_invoices_amount|floatformat:0|default:0 }}</div>
            <div class="stat-label">Awaiting Approval</div>
        </div>
        <div class="stat-item" style="border-left-color: var(--success);">
            <div class="stat-value">${{ approved_invoices_amount|floatformat:0|default:0 }}</div>
            <div class="stat-label">Approved Invoices</div>
        </div>
    </section>
    <!-- Main Workflow -->
    <section class="workflow-container border rounded-lg px-3">
        <h2 class="pt-3" style="font-size: var(--text-xl); font-weight: 600; margin-bottom: var(--space-6); color: var(--gray-800);">
            <i class="bi bi-arrow-right-circle text-blue-500 me-2"></i>
            Invoice Collection Workflow
        </h2>
        <div class="workflow-steps">
            <!-- Step 1: Invoice -->
            <div class="workflow-step">
                <div class="step-number step-1">
                    <i class="fa fa-dollar-sign"></i>
                </div>
                <h3 class="step-title">Create Invoice</h3>
                <p class="step-description">Generate professional invoices for your services and send to clients</p>
                <div class="step-actions gap-3">
                    <a href="{% url 'billing:invoice_create' %}" class="button-min-primary py-1">
                       <div>
                         <i class="fa fa-plus me-1"></i>
                        New Invoice
                       </div>
                    </a>
                    <a href="{% url 'billing:invoice_list' %}" class="step-link">View all invoices</a>
                </div>
            </div>

            <!-- Step 2: Payment Collection -->
            <div class="workflow-step">
                <div class="step-number step-2">
                    <i class="bi bi-receipt-cutoff"></i>
                </div>
                <h3 class="step-title">Collect Payment</h3>
                <p class="step-description">When client pays, choose: Record Payment (with receipt) or Mark as Paid (status only)</p>
                <div class="step-actions gap-3">
                    <a href="{% url 'billing:cash_receipt_create' %}" class="button-min-primary py-1">
                       <div>
                         <i class="bi bi-receipt me-1"></i>
                        Record Payment
                       </div>
                    </a>
                    <a href="{% url 'billing:invoice_list' %}?status=pending" class="step-link" style="display:none;">Pending invoices</a>
                </div>
            </div>

            <!-- Step 3: Complete -->
            <div class="workflow-step">
                <div class="step-number step-3">
                    <i class="bi bi-cash-coin"></i>
                </div>
                <h3 class="step-title">Create Payment Voucher</h3>
                <p class="step-description">Authorize payments to vendors, suppliers, or refunds (when YOU pay others)</p>
                <div class="step-actions gap-3">
                    <a href="{% url 'billing:payment_voucher_create' %}" class="button-min-warn py-1" style="background: var(--warning); color: white;">
                        <div>
                            <i class="fa fa-plus me-1"></i>
                        New Voucher
                        </div>
                    </a>
                    <a href="{% url 'billing:payment_voucher_list' %}" class="step-link">View all vouchers</a>
                </div>
            </div>
            <!-- Step 3: Complete -->
            <div class="workflow-step hidden" style="display:none;">
                <div class="step-number step-3">3</div>
                <h3 class="step-title">Invoice Complete</h3>
                <p class="step-description">Invoice marked as paid with optional receipt documentation</p>
                <div class="step-actions gap-3">
                    <a href="{% url 'billing:official_receipt_list' %}" class="button-min-primary py-1">
                        <div>
                            <i class="bi bi-file-earmark-text"></i>
                        View Receipts
                        </div>
                    </a>
                    <a href="{% url 'billing:invoice_list' %}?status=paid" class="step-link">Paid invoices</a>
                </div>
            </div>
        </div>
    </section>

    <!-- Payment Vouchers Section -->
    <section class="workflow-container border rounded-lg px-3 mt-3 hidden" style="display:none;">
        <h2 class="pt-3" style="font-size: var(--text-xl); font-weight: 600; margin-bottom: var(--space-6); color: var(--gray-800);">
            <i class="bi bi-receipt-cutoff" style="color: var(--warning); margin-right: var(--space-2);"></i>
            Payment Vouchers (Outgoing Payments)
        </h2>
        <div class="workflow-steps">
            <!-- Payment Voucher Creation -->
            <div class="workflow-step ">
                <div class="step-number" style="background: var(--warning-light); color: var(--warning);">ðŸ’¸</div>
                <h3 class="step-title">Create Payment Voucher</h3>
                <p class="step-description">Authorize payments to vendors, suppliers, or refunds (when YOU pay others)</p>
                <div class="step-actions gap-3">
                    <a href="{% url 'billing:payment_voucher_create' %}" class="button-min-warn py-1" style="background: var(--warning); color: white;">
                        <div>
                            <i class="fa fa-plus me-1"></i>
                        New Voucher
                        </div>
                    </a>
                    <a href="{% url 'billing:payment_voucher_list' %}" class="step-link">View all vouchers</a>
                </div>
            </div>
        </div>
    </section>

    

    <!-- Recent Activity -->
    <section class="activity-section mt-3 mb-5">
        <header class="activity-header">
            <h2 class="activity-title">Recent Activity</h2>
            <a href="{% url 'billing:invoice_list' %}" class="button-min-primary py-1">View all â†’</a>
        </header>
        {% if recent_invoices or recent_receipts %}
            <table class="activity-table">
                <thead>
                    <tr>
                        <th>Type</th>
                        <th>Number</th>
                        <th>Client</th>
                        <th>Date</th>
                        <th>Amount</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody>
                    {% for invoice in recent_invoices|slice:":3" %}
                    <tr onclick="location.href='{% url 'billing:invoice_detail' invoice.id %}'" style="cursor: pointer;">
                        <td><i class="bi bi-file-earmark-text" style="color: var(--primary);"></i> Invoice</td>
                        <td><strong>#{{ invoice.invoice_number }}</strong></td>
                        <td>{{ invoice.get_client_name }}</td>
                        <td>{{ invoice.created_at|date:"d/m/Y" }}</td>
                        <td><strong>${{ invoice.total_amount|floatformat:2 }}</strong></td>
                        <td>
                            <span class="status-badge status-{{ invoice.status|default:'pending' }}">{{ invoice.get_status_display|default:'Pending' }}</span>
                        </td>
                    </tr>
                    {% endfor %}
                    
                    {% for receipt in recent_receipts|slice:":2" %}
                    <tr onclick="location.href='{% url 'billing:official_receipt_detail' receipt.id %}'" style="cursor: pointer;">
                        <td><i class="bi bi-receipt" style="color: var(--success);"></i> Receipt</td>
                        <td><strong>{{ receipt.receipt_number }}</strong></td>
                        <td>{{ receipt.employee_name|default:receipt.received_from }}</td>
                        <td>{{ receipt.issue_date|date:"d/m/Y" }}</td>
                        <td><strong>${{ receipt.total_amount|floatformat:2 }}</strong></td>
                        <td>
                            <span class="status-badge status-paid">Received</span>
                        </td>
                    </tr>
                    {% endfor %}
                    
                    {% for voucher in recent_vouchers|slice:":2" %}
                    <tr onclick="location.href='{% url 'billing:payment_voucher_detail' voucher.id %}'" style="cursor: pointer;">
                        <td><i class="bi bi-receipt-cutoff" style="color: var(--warning);"></i> Voucher</td>
                        <td><strong>{{ voucher.voucher_number }}</strong></td>
                        <td>{{ voucher.payee }}</td>
                        <td>{{ voucher.date|date:"d/m/Y" }}</td>
                        <td><strong>${{ voucher.amount_usd|floatformat:2 }}</strong></td>
                        <td>
                            <span class="status-badge" style="background: var(--warning-light); color: var(--warning);">Authorized</span>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        {% else %}
            <div class="empty-state">
                <div class="icon">ðŸ“„</div>
                <p>No recent activity. Start by creating your first invoice!</p>
                <div class="flex w-full justify-center">
                    <a href="{% url 'billing:invoice_create' %}" class="button-min-primary">
                        <div>
                         <i class="fa fa-plus me-1"></i>
                         Create Invoice
                        </div>
                     </a>
                </div>
            </div>
        {% endif %}
    </section>
</div>
{% endblock %} 