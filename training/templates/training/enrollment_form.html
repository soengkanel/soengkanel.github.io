{% extends 'base/base.html' %}
{% load static %}

{% block title %}{% if form.instance.pk %}Edit Enrollment{% else %}Create Enrollment{% endif %} - LMS{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'ui/css/app.css' %}">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css">
<style>
    .form-container {
        max-width: 1000px;
        margin: 0 auto;
        padding: 20px;
    }

    .form-header {
        background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
        color: white;
        padding: 20px 24px;
        border-radius: 8px 8px 0 0;
        margin-bottom: 0;
    }

    .form-header h2 {
        margin: 0;
        font-size: 20px;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .form-body {
        background: white;
        padding: 24px;
        border: 1px solid #e5e7eb;
        border-top: none;
        border-radius: 0 0 8px 8px;
    }

    .section-divider {
        border-top: 1px solid #e5e7eb;
        margin: 24px 0;
    }

    .section-title {
        font-size: 14px;
        font-weight: 600;
        color: #1f2937;
        margin-bottom: 16px;
        padding-bottom: 8px;
        border-bottom: 2px solid #3b82f6;
    }

    /* Choices.js custom styling */
    .choices__inner {
        background-color: white;
        border: 1px solid #d1d5db;
        border-radius: 6px;
        padding: 8px 12px;
        font-size: 13px;
        min-height: auto;
    }

    .choices__inner:focus,
    .choices.is-focused .choices__inner {
        border-color: #3b82f6;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }

    .choices__list--dropdown {
        border: 1px solid #d1d5db;
        border-radius: 6px;
        font-size: 13px;
    }

    .choices__item--selectable {
        padding: 8px 12px;
    }

    .error-message {
        color: #dc2626;
        font-size: 12px;
        margin-top: 4px;
    }
</style>
{% endblock %}

{% block content %}
<main class="min-h-screen bg-gray-50">
    <div class="form-container">
        <div class="form-header">
            <h2>
                <i class="bi bi-person-check"></i>
                {% if form.instance.pk %}Edit Enrollment{% else %}Create New Enrollment{% endif %}
            </h2>
        </div>

        <div class="form-body">
            <form method="post" enctype="multipart/form-data">
                {% csrf_token %}

                <!-- Enrollment Information -->
                <div class="section-title">Enrollment Information</div>
                <div class="grid grid-cols-2 gap-4 mb-6">
                    <div class="col-span-2 md:col-span-1">
                        <label for="{{ form.employee.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">
                            Employee *
                        </label>
                        <select name="{{ form.employee.name }}"
                                id="{{ form.employee.id_for_label }}"
                                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                required>
                            <option value="">Select Employee</option>
                            {% for employee in employees %}
                            <option value="{{ employee.id }}"
                                    {% if form.employee.value == employee.id or form.employee.value|stringformat:"s" == employee.id|stringformat:"s" %}selected{% endif %}>
                                {{ employee.get_full_name }} - {{ employee.employee_id }}
                            </option>
                            {% endfor %}
                        </select>
                        {% if form.employee.errors %}
                            <p class="error-message">{{ form.employee.errors.0 }}</p>
                        {% endif %}
                        <p class="text-xs text-gray-500 mt-1">Search and select the employee to enroll</p>
                    </div>

                    <div class="col-span-2 md:col-span-1">
                        <label for="{{ form.course.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">
                            Course *
                        </label>
                        <select name="{{ form.course.name }}"
                                id="{{ form.course.id_for_label }}"
                                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                required>
                            <option value="">Select Course</option>
                            {% for course in courses %}
                            <option value="{{ course.id }}"
                                    {% if form.course.value == course.id or form.course.value|stringformat:"s" == course.id|stringformat:"s" %}selected{% endif %}>
                                {{ course.code }} - {{ course.title }}
                            </option>
                            {% endfor %}
                        </select>
                        {% if form.course.errors %}
                            <p class="error-message">{{ form.course.errors.0 }}</p>
                        {% endif %}
                        <p class="text-xs text-gray-500 mt-1">Search and select the course</p>
                    </div>

                    <div class="col-span-2 md:col-span-1">
                        <label for="{{ form.enrollment_date.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">
                            Enrollment Date *
                        </label>
                        <input type="date"
                               name="{{ form.enrollment_date.name }}"
                               id="{{ form.enrollment_date.id_for_label }}"
                               value="{{ form.enrollment_date.value|date:'Y-m-d'|default:'' }}"
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                               required>
                        {% if form.enrollment_date.errors %}
                            <p class="error-message">{{ form.enrollment_date.errors.0 }}</p>
                        {% endif %}
                    </div>

                    <div class="col-span-2 md:col-span-1">
                        <label for="{{ form.start_date.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">
                            Start Date
                        </label>
                        <input type="date"
                               name="{{ form.start_date.name }}"
                               id="{{ form.start_date.id_for_label }}"
                               value="{{ form.start_date.value|date:'Y-m-d'|default:'' }}"
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        {% if form.start_date.errors %}
                            <p class="error-message">{{ form.start_date.errors.0 }}</p>
                        {% endif %}
                        <p class="text-xs text-gray-500 mt-1">When the employee started the course</p>
                    </div>
                </div>

                <div class="section-divider"></div>

                <!-- Status & Completion -->
                <div class="section-title">Status & Completion</div>
                <div class="grid grid-cols-2 gap-4 mb-6">
                    <div class="col-span-2 md:col-span-1">
                        <label for="{{ form.status.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">
                            Status *
                        </label>
                        <select name="{{ form.status.name }}"
                                id="{{ form.status.id_for_label }}"
                                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                required>
                            {% for value, label in form.fields.status.choices %}
                                {% if value %}
                                <option value="{{ value }}"
                                        {% if form.status.value == value %}selected{% endif %}>
                                    {{ label }}
                                </option>
                                {% endif %}
                            {% endfor %}
                        </select>
                        {% if form.status.errors %}
                            <p class="error-message">{{ form.status.errors.0 }}</p>
                        {% endif %}
                    </div>

                    <div class="col-span-2 md:col-span-1">
                        <label for="{{ form.completion_date.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">
                            Completion Date
                        </label>
                        <input type="date"
                               name="{{ form.completion_date.name }}"
                               id="{{ form.completion_date.id_for_label }}"
                               value="{{ form.completion_date.value|date:'Y-m-d'|default:'' }}"
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        {% if form.completion_date.errors %}
                            <p class="error-message">{{ form.completion_date.errors.0 }}</p>
                        {% endif %}
                        <p class="text-xs text-gray-500 mt-1">Date when the course was completed</p>
                    </div>

                    <div class="col-span-2 md:col-span-1">
                        <label for="{{ form.final_score.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">
                            Final Score (%)
                        </label>
                        <input type="number"
                               name="{{ form.final_score.name }}"
                               id="{{ form.final_score.id_for_label }}"
                               value="{{ form.final_score.value|default:'' }}"
                               min="0"
                               max="100"
                               step="0.01"
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                               placeholder="e.g., 85.5">
                        {% if form.final_score.errors %}
                            <p class="error-message">{{ form.final_score.errors.0 }}</p>
                        {% endif %}
                        <p class="text-xs text-gray-500 mt-1">Score between 0 and 100</p>
                    </div>

                    <div class="col-span-2 md:col-span-1">
                        <label for="{{ form.rating.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">
                            Rating
                        </label>
                        <input type="number"
                               name="{{ form.rating.name }}"
                               id="{{ form.rating.id_for_label }}"
                               value="{{ form.rating.value|default:'' }}"
                               min="1"
                               max="5"
                               step="1"
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                               placeholder="1-5">
                        {% if form.rating.errors %}
                            <p class="error-message">{{ form.rating.errors.0 }}</p>
                        {% endif %}
                        <p class="text-xs text-gray-500 mt-1">Employee rating (1-5 stars)</p>
                    </div>
                </div>

                <div class="section-divider"></div>

                <!-- Certificate Information -->
                <div class="section-title">Certificate Information</div>
                <div class="grid grid-cols-2 gap-4 mb-6">
                    <div class="col-span-2 md:col-span-1">
                        <div class="flex items-center h-full pt-8">
                            <label class="flex items-center cursor-pointer">
                                <input type="checkbox"
                                       name="{{ form.certificate_issued.name }}"
                                       id="{{ form.certificate_issued.id_for_label }}"
                                       {% if form.certificate_issued.value %}checked{% endif %}
                                       class="w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                                <span class="ml-2 text-sm text-gray-700">Certificate Issued</span>
                            </label>
                        </div>
                        {% if form.certificate_issued.errors %}
                            <p class="error-message">{{ form.certificate_issued.errors.0 }}</p>
                        {% endif %}
                    </div>

                    <div class="col-span-2 md:col-span-1">
                        <label for="{{ form.certificate_date.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">
                            Certificate Date
                        </label>
                        <input type="date"
                               name="{{ form.certificate_date.name }}"
                               id="{{ form.certificate_date.id_for_label }}"
                               value="{{ form.certificate_date.value|date:'Y-m-d'|default:'' }}"
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        {% if form.certificate_date.errors %}
                            <p class="error-message">{{ form.certificate_date.errors.0 }}</p>
                        {% endif %}
                        <p class="text-xs text-gray-500 mt-1">Date when certificate was issued</p>
                    </div>
                </div>

                <div class="section-divider"></div>

                <!-- Feedback & Review -->
                <div class="section-title">Feedback & Review</div>
                <div class="grid grid-cols-1 gap-4 mb-6">
                    <div>
                        <label for="{{ form.feedback.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">
                            Feedback
                        </label>
                        <textarea name="{{ form.feedback.name }}"
                                  id="{{ form.feedback.id_for_label }}"
                                  rows="3"
                                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                  placeholder="Internal feedback or notes about the enrollment">{{ form.feedback.value|default:'' }}</textarea>
                        {% if form.feedback.errors %}
                            <p class="error-message">{{ form.feedback.errors.0 }}</p>
                        {% endif %}
                        <p class="text-xs text-gray-500 mt-1">Internal notes (not visible to employee)</p>
                    </div>

                    <div>
                        <label for="{{ form.review.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">
                            Employee Review
                        </label>
                        <textarea name="{{ form.review.name }}"
                                  id="{{ form.review.id_for_label }}"
                                  rows="3"
                                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                  placeholder="Employee's review of the course">{{ form.review.value|default:'' }}</textarea>
                        {% if form.review.errors %}
                            <p class="error-message">{{ form.review.errors.0 }}</p>
                        {% endif %}
                        <p class="text-xs text-gray-500 mt-1">Employee's feedback about the course</p>
                    </div>
                </div>

                <!-- Form Actions -->
                <div class="flex justify-end gap-3 pt-4 border-t border-gray-200">
                    <a href="{% url 'training:enrollment_list' %}"
                       class="px-4 py-2 border border-gray-300 rounded-md text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                        Cancel
                    </a>
                    <button type="submit"
                            class="px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                        <i class="bi bi-check-circle"></i>
                        {% if form.instance.pk %}Update Enrollment{% else %}Create Enrollment{% endif %}
                    </button>
                </div>
            </form>
        </div>
    </div>
</main>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize Choices.js for Employee dropdown
    const employeeSelect = document.getElementById('{{ form.employee.id_for_label }}');
    if (employeeSelect) {
        new Choices(employeeSelect, {
            searchEnabled: true,
            searchPlaceholderValue: 'Search employee by name or ID...',
            itemSelectText: 'Click to select',
            noResultsText: 'No employees found',
            noChoicesText: 'No employees available',
            shouldSort: false,
        });
    }

    // Initialize Choices.js for Course dropdown
    const courseSelect = document.getElementById('{{ form.course.id_for_label }}');
    if (courseSelect) {
        new Choices(courseSelect, {
            searchEnabled: true,
            searchPlaceholderValue: 'Search course by code or title...',
            itemSelectText: 'Click to select',
            noResultsText: 'No courses found',
            noChoicesText: 'No courses available',
            shouldSort: false,
        });
    }
});
</script>
{% endblock %}
