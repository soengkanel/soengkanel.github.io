{% extends 'base/base.html' %}
{% load widget_tweaks %}

{% block title %}Clear Audit Logs{% endblock %}

{% block main_class %}{% endblock %}

{% block extra_css %}
<style>
/* Ultra Minimal & Compact Clear Logs Design */

/* Page Headers */
.page-header {
    padding: 4px 0;
    margin-bottom: 8px;
}
.page-header h2 {
    font-size: 16px;
    font-weight: 600;
    margin: 0;
    color: #1a1a1a;
}
.page-header p {
    font-size: 10px;
    color: #666;
    margin: 0;
}

/* Ultra Compact Stats */
.stats-row {
    margin-bottom: 8px;
}

.stat-item {
    background: white;
    border: 1px solid #e2e8f0;
    border-radius: 4px;
    padding: 6px;
    text-align: center;
    box-shadow: 0 1px 2px rgba(0, 0, 0, 0.03);
}

.stat-number {
    font-size: 14px;
    font-weight: 700;
    color: #1a1a1a;
    margin: 0;
}

.stat-label {
    font-size: 9px;
    color: #6b7280;
    margin: 2px 0 0 0;
    text-transform: uppercase;
    font-weight: 500;
}

/* Unified Button System - Ultra Compact */
.btn-minimal {
    font-size: 10px;
    font-weight: 500;
    border-radius: 3px;
    padding: 3px 6px;
    border: 1px solid;
    cursor: pointer;
    transition: all 0.1s ease;
    text-decoration: none;
    display: inline-flex;
    align-items: center;
    gap: 2px;
    line-height: 1.2;
}

/* Primary - Blue */
.btn-minimal-primary {
    background: #3b82f6;
    color: white;
    border-color: #3b82f6;
}
.btn-minimal-primary:hover {
    background: #2563eb;
    color: white;
    border-color: #2563eb;
}

/* Secondary - Gray */
.btn-minimal-secondary {
    background: #f8fafc;
    color: #475569;
    border-color: #e2e8f0;
}
.btn-minimal-secondary:hover {
    background: #f1f5f9;
    color: #334155;
    border-color: #cbd5e1;
}

/* Danger - Red */
.btn-minimal-danger {
    background: #fee2e2;
    color: #991b1b;
    border-color: #fecaca;
}
.btn-minimal-danger:hover {
    background: #fecaca;
    color: #7f1d1d;
    border-color: #f87171;
}

/* Warning - Yellow */
.btn-minimal-warning {
    background: #fef3c7;
    color: #92400e;
    border-color: #fcd34d;
}
.btn-minimal-warning:hover {
    background: #fcd34d;
    color: #78350f;
    border-color: #f59e0b;
}

/* Success - Green */
.btn-minimal-success {
    background: #d1fae5;
    color: #065f46;
    border-color: #a7f3d0;
}
.btn-minimal-success:hover {
    background: #a7f3d0;
    color: #047857;
    border-color: #6ee7b7;
}

/* Compact Clear Options */
.clear-option {
    background: white;
    border: 1px solid #e2e8f0;
    border-radius: 4px;
    padding: 8px;
    margin-bottom: 6px;
    box-shadow: 0 1px 2px rgba(0, 0, 0, 0.03);
}

.clear-option.danger {
    border-left: 3px solid #ef4444;
    background: #fef9f9;
}

.clear-option.warning {
    border-left: 3px solid #f59e0b;
    background: #fefbf4;
}

.clear-option.primary {
    border-left: 3px solid #3b82f6;
    background: #f8faff;
}

.clear-option h5 {
    font-size: 12px;
    font-weight: 600;
    color: #374151;
    margin: 0 0 4px 0;
}

.clear-option p {
    font-size: 10px;
    color: #6b7280;
    margin: 0 0 6px 0;
    line-height: 1.3;
}

/* Compact Form Elements */
.form-label {
    font-size: 10px;
    margin-bottom: 2px;
    font-weight: 500;
    color: #374151;
}

.form-control, .form-select {
    font-size: 11px;
    padding: 4px 8px;
    height: auto;
    border-radius: 3px;
    border: 1px solid #d1d5db;
    line-height: 1.3;
    background: white;
}

.form-control:focus, .form-select:focus {
    border-color: #3b82f6;
    box-shadow: 0 0 0 1px rgba(59, 130, 246, 0.1);
    outline: none;
}

.form-text {
    font-size: 8px;
    color: #9ca3af;
    margin-top: 1px;
}

/* Alert Boxes */
.alert-box {
    border-radius: 4px;
    padding: 8px;
    margin-bottom: 6px;
    font-size: 10px;
    line-height: 1.3;
}

.alert-warning {
    background: #fef3c7;
    border: 1px solid #fcd34d;
    color: #92400e;
}

.alert-danger {
    background: #fee2e2;
    border: 1px solid #fecaca;
    color: #991b1b;
}

.alert-box h6 {
    font-size: 11px;
    font-weight: 600;
    margin: 0 0 4px 0;
}

.alert-box p {
    margin: 0;
}

/* Form Row Layout */
.form-row {
    display: grid;
    grid-template-columns: 1fr 1fr auto;
    gap: 6px;
    align-items: end;
}

.form-row-full {
    display: grid;
    grid-template-columns: 1fr 1fr 1fr auto;
    gap: 6px;
    align-items: end;
}

/* Custom Confirmation Modal */
.confirmation-modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 1050;
}

.confirmation-modal.show {
    display: flex;
}

.confirmation-content {
    background: white;
    border-radius: 6px;
    max-width: 400px;
    width: 90%;
    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
    overflow: hidden;
}

.confirmation-header {
    padding: 12px 16px;
    border-bottom: 1px solid #e5e7eb;
    display: flex;
    align-items: center;
    gap: 8px;
}

.confirmation-header.danger {
    background: #fef2f2;
    border-bottom-color: #fecaca;
}

.confirmation-header.warning {
    background: #fffbeb;
    border-bottom-color: #fde68a;
}

.confirmation-header.primary {
    background: #eff6ff;
    border-bottom-color: #dbeafe;
}

.confirmation-title {
    font-size: 14px;
    font-weight: 600;
    margin: 0;
}

.confirmation-body {
    padding: 16px;
}

.confirmation-message {
    font-size: 12px;
    color: #374151;
    margin: 0 0 12px 0;
    line-height: 1.4;
}

.confirmation-details {
    background: #f9fafb;
    border: 1px solid #e5e7eb;
    border-radius: 4px;
    padding: 8px;
    margin: 8px 0;
    font-size: 10px;
    color: #6b7280;
}

.confirmation-actions {
    display: flex;
    gap: 6px;
    justify-content: flex-end;
    padding: 12px 16px;
    background: #f9fafb;
    border-top: 1px solid #e5e7eb;
}

/* Loading State */
.btn-loading {
    opacity: 0.7;
    cursor: not-allowed;
    pointer-events: none;
}

.btn-loading::after {
    content: '';
    width: 8px;
    height: 8px;
    border: 1px solid currentColor;
    border-right-color: transparent;
    border-radius: 50%;
    display: inline-block;
    animation: spin 1s linear infinite;
    margin-left: 4px;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

/* Success Feedback */
.success-feedback {
    position: fixed;
    top: 20px;
    right: 20px;
    background: #d1fae5;
    color: #065f46;
    border: 1px solid #a7f3d0;
    border-radius: 4px;
    padding: 8px 12px;
    font-size: 11px;
    font-weight: 500;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    z-index: 1060;
    transform: translateX(100%);
    transition: transform 0.3s ease;
}

.success-feedback.show {
    transform: translateX(0);
}

/* Mobile Responsive */
@media (max-width: 768px) {
    .form-row,
    .form-row-full {
        grid-template-columns: 1fr;
        gap: 4px;
    }
    
    .page-header-actions {
        flex-direction: column;
        align-items: stretch;
        gap: 4px;
    }
    
    .stat-item {
        padding: 4px;
    }
    
    .stat-number {
        font-size: 12px;
    }
    
    .stat-label {
        font-size: 8px;
    }
    
    .confirmation-content {
        width: 95%;
        max-width: none;
    }
    
    .confirmation-actions {
        flex-direction: column;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid px-3">
    <!-- Compact Page Header -->
    <div class="page-header d-flex justify-content-between align-items-center">
        <div>
            <h2><i class="bi bi-trash3 me-2"></i>Clear Audit Logs</h2>
            <p>Manage audit log retention and cleanup</p>
        </div>
        <div class="d-flex align-items-center page-header-actions">
            <a href="{% url 'audit_management:dashboard' %}" class="btn-minimal btn-minimal-secondary">
                <i class="bi bi-arrow-left"></i>
                <span class="d-none d-md-inline">Dashboard</span>
            </a>
        </div>
    </div>

    <!-- Ultra Compact Stats -->
    <div class="row stats-row">
        <div class="col-4">
            <div class="stat-item">
                <div class="stat-number">{{ total_logs|default:"0" }}</div>
                <div class="stat-label">Logs</div>
            </div>
        </div>
        <div class="col-4">
            <div class="stat-item">
                <div class="stat-number">{{ total_sessions|default:"0" }}</div>
                <div class="stat-label">Sessions</div>
            </div>
        </div>
        <div class="col-4">
            <div class="stat-item">
                <div class="stat-number">{{ total_exceptions|default:"0" }}</div>
                <div class="stat-label">Exceptions</div>
            </div>
        </div>
    </div>

    <!-- Compact Warning -->
    <div class="alert-box alert-danger">
        <h6><i class="bi bi-exclamation-triangle"></i> Important</h6>
        <p><strong>Clearing audit logs is permanent!</strong> Consider exporting logs before clearing for compliance.</p>
    </div>

    <!-- Clear All Logs -->
    <div class="clear-option danger">
        <h5><i class="bi bi-trash3"></i> Clear All Logs</h5>
        <p>Permanently delete all audit logs, sessions, and exceptions.</p>
        <button type="button" class="btn-minimal btn-minimal-danger" onclick="showConfirmation('all')">
            <i class="bi bi-trash3"></i>
            <span>Clear All</span>
        </button>
    </div>

    <!-- Clear by Age -->
    <div class="clear-option warning">
        <h5><i class="bi bi-calendar-x"></i> Clear Logs Older Than</h5>
        <p>Delete logs older than specified days for retention compliance.</p>
        <div class="form-row">
            <div>
                <label for="days" class="form-label">Days</label>
                <input type="number" class="form-control" id="days" name="days" 
                       placeholder="90" min="1" max="3650" required>
                <div class="form-text">Delete logs older than this many days</div>
            </div>
            <div>
                <label class="form-label">&nbsp;</label>
                <button type="button" class="btn-minimal btn-minimal-warning" onclick="showConfirmation('older_than')">
                    <i class="bi bi-calendar-x"></i>
                    <span>Clear Old</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Clear by Type -->
    <div class="clear-option primary">
        <h5><i class="bi bi-funnel"></i> Clear by Type</h5>
        <p>Selectively delete logs by action or resource type.</p>
        <div class="form-row-full">
            <div>
                <label for="action_type" class="form-label">Action Type</label>
                <select class="form-select" id="action_type" name="action_type">
                    <option value="">All Actions</option>
                    {% for action in action_types %}
                    <option value="{{ action }}">{{ action|title }}</option>
                    {% endfor %}
                </select>
            </div>
            <div>
                <label for="resource_type" class="form-label">Resource Type</label>
                <select class="form-select" id="resource_type" name="resource_type">
                    <option value="">All Resources</option>
                    {% for resource in resource_types %}
                    <option value="{{ resource }}">{{ resource|title|truncatechars:15 }}</option>
                    {% endfor %}
                </select>
            </div>
            <div>
                <label class="form-label">&nbsp;</label>
                <button type="button" class="btn-minimal btn-minimal-primary" onclick="showConfirmation('by_type')">
                    <i class="bi bi-funnel"></i>
                    <span>Clear Types</span>
                </button>
            </div>
        </div>
        <div class="form-text">Select one or both filters. Both criteria must match if both selected.</div>
    </div>

    <!-- Export Before Clearing -->
    <div class="alert-box alert-warning">
        <h6><i class="bi bi-download"></i> Export Before Clearing</h6>
        <p style="margin-bottom: 6px;">Export logs for compliance and backup before clearing.</p>
        <a href="{% url 'audit_management:export_logs' %}" class="btn-minimal btn-minimal-success">
            <i class="bi bi-download"></i>
            <span>Export CSV</span>
        </a>
    </div>
</div>

<!-- Custom Confirmation Modal -->
<div class="confirmation-modal" id="confirmationModal">
    <div class="confirmation-content">
        <div class="confirmation-header" id="modalHeader">
            <i class="bi" id="modalIcon"></i>
            <h4 class="confirmation-title" id="modalTitle">Confirm Action</h4>
        </div>
        <div class="confirmation-body">
            <p class="confirmation-message" id="modalMessage">Are you sure you want to proceed?</p>
            <div class="confirmation-details" id="modalDetails" style="display: none;"></div>
        </div>
        <div class="confirmation-actions">
            <button type="button" class="btn-minimal btn-minimal-danger" onclick="hideConfirmation()">
                <i class="bi bi-x"></i>
                <span>Cancel</span>
            </button>
            <button type="button" class="btn-minimal" id="confirmButton" onclick="executeAction()">
                <i class="bi bi-check"></i>
                <span>Confirm</span>
            </button>
        </div>
    </div>
</div>

<!-- Hidden forms for submissions -->
<form method="post" id="clearAllForm" style="display: none;">
    {% csrf_token %}
    <input type="hidden" name="clear_type" value="all">
</form>

<form method="post" id="clearOldForm" style="display: none;">
    {% csrf_token %}
    <input type="hidden" name="clear_type" value="older_than">
    <input type="hidden" name="days" id="hiddenDays">
</form>

<form method="post" id="clearByTypeForm" style="display: none;">
    {% csrf_token %}
    <input type="hidden" name="clear_type" value="by_type">
    <input type="hidden" name="action_type" id="hiddenActionType">
    <input type="hidden" name="resource_type" id="hiddenResourceType">
</form>

<!-- Success Feedback -->
<div class="success-feedback" id="successFeedback">
    <i class="bi bi-check-circle"></i>
    <span id="successMessage">Operation completed successfully!</span>
</div>
{% endblock %}

{% block extra_js %}
<script>
let currentAction = null;

function showConfirmation(actionType) {
    const modal = document.getElementById('confirmationModal');
    const header = document.getElementById('modalHeader');
    const icon = document.getElementById('modalIcon');
    const title = document.getElementById('modalTitle');
    const message = document.getElementById('modalMessage');
    const details = document.getElementById('modalDetails');
    const confirmButton = document.getElementById('confirmButton');
    
    currentAction = actionType;
    
    // Reset modal styles
    header.className = 'confirmation-header';
    icon.className = 'bi';
    confirmButton.className = 'btn-minimal';
    details.style.display = 'none';
    
    switch(actionType) {
        case 'all':
            header.classList.add('danger');
            icon.classList.add('bi-exclamation-triangle');
            title.textContent = 'Clear All Logs';
            message.innerHTML = '<strong>This will permanently delete ALL audit logs!</strong><br>This action cannot be undone and will remove all historical audit data.';
            confirmButton.classList.add('btn-minimal-danger');
            confirmButton.innerHTML = '<i class="bi bi-trash3"></i><span>Delete All</span>';
            
            details.innerHTML = `
                <strong>What will be deleted:</strong><br>
                • ${document.querySelector('.stat-number').textContent} audit logs<br>
                • ${document.querySelectorAll('.stat-number')[1].textContent} sessions<br>
                • ${document.querySelectorAll('.stat-number')[2].textContent} exceptions
            `;
            details.style.display = 'block';
            break;
            
        case 'older_than':
            const daysValue = document.getElementById('days').value;
            if (!daysValue || daysValue < 1) {
                showError('Please enter a valid number of days (minimum 1)');
                return;
            }
            
            header.classList.add('warning');
            icon.classList.add('bi-calendar-x');
            title.textContent = 'Clear Old Logs';
            message.innerHTML = `Delete all audit logs older than <strong>${daysValue} days</strong>?<br>This will help maintain system performance and comply with retention policies.`;
            confirmButton.classList.add('btn-minimal-warning');
            confirmButton.innerHTML = '<i class="bi bi-calendar-x"></i><span>Delete Old Logs</span>';
            
            const cutoffDate = new Date();
            cutoffDate.setDate(cutoffDate.getDate() - parseInt(daysValue));
            details.innerHTML = `
                <strong>Cutoff Date:</strong> ${cutoffDate.toLocaleDateString()}<br>
                <strong>Impact:</strong> Logs before this date will be permanently deleted
            `;
            details.style.display = 'block';
            break;
            
        case 'by_type':
            const actionType = document.getElementById('action_type').value;
            const resourceType = document.getElementById('resource_type').value;
            
            if (!actionType && !resourceType) {
                showError('Please select at least one filter (Action Type or Resource Type)');
                return;
            }
            
            header.classList.add('primary');
            icon.classList.add('bi-funnel');
            title.textContent = 'Clear Filtered Logs';
            confirmButton.classList.add('btn-minimal-primary');
            confirmButton.innerHTML = '<i class="bi bi-funnel"></i><span>Delete Filtered</span>';
            
            let filterDesc = [];
            if (actionType) filterDesc.push(`Action: ${actionType}`);
            if (resourceType) filterDesc.push(`Resource: ${resourceType}`);
            
            message.innerHTML = `Delete all audit logs matching the selected criteria?<br><strong>Filters:</strong> ${filterDesc.join(', ')}`;
            
            details.innerHTML = `
                <strong>Matching Criteria:</strong><br>
                ${actionType ? `• Action Type: ${actionType}<br>` : ''}
                ${resourceType ? `• Resource Type: ${resourceType}<br>` : ''}
                ${actionType && resourceType ? '<em>Both criteria must match</em>' : '<em>Only this criterion needs to match</em>'}
            `;
            details.style.display = 'block';
            break;
    }
    
    modal.classList.add('show');
}

function hideConfirmation() {
    const modal = document.getElementById('confirmationModal');
    modal.classList.remove('show');
    currentAction = null;
}

function executeAction() {
    const confirmButton = document.getElementById('confirmButton');
    confirmButton.classList.add('btn-loading');
    
    let form;
    
    switch(currentAction) {
        case 'all':
            form = document.getElementById('clearAllForm');
            break;
            
        case 'older_than':
            form = document.getElementById('clearOldForm');
            document.getElementById('hiddenDays').value = document.getElementById('days').value;
            break;
            
        case 'by_type':
            form = document.getElementById('clearByTypeForm');
            document.getElementById('hiddenActionType').value = document.getElementById('action_type').value;
            document.getElementById('hiddenResourceType').value = document.getElementById('resource_type').value;
            break;
    }
    
    if (form) {
        form.submit();
    }
}

function showError(message) {
    const feedback = document.getElementById('successFeedback');
    feedback.style.background = '#fee2e2';
    feedback.style.color = '#991b1b';
    feedback.style.borderColor = '#fecaca';
    document.getElementById('successMessage').textContent = message;
    feedback.classList.add('show');
    
    setTimeout(() => {
        feedback.classList.remove('show');
        // Reset colors
        setTimeout(() => {
            feedback.style.background = '#d1fae5';
            feedback.style.color = '#065f46';
            feedback.style.borderColor = '#a7f3d0';
        }, 300);
    }, 3000);
}

document.addEventListener('DOMContentLoaded', function() {
    // Validate days input with better UX
    const daysInput = document.getElementById('days');
    if (daysInput) {
        daysInput.addEventListener('input', function() {
            const value = parseInt(this.value);
            if (value < 1) {
                this.setCustomValidity('Must be at least 1 day');
            } else if (value > 3650) {
                this.setCustomValidity('Cannot exceed 3650 days (10 years)');
            } else {
                this.setCustomValidity('');
            }
        });
        
        // Visual feedback on focus
        daysInput.addEventListener('focus', function() {
            this.style.borderColor = '#3b82f6';
        });
        
        daysInput.addEventListener('blur', function() {
            this.style.borderColor = '#d1d5db';
        });
    }
    
    // Keyboard shortcuts
    document.addEventListener('keydown', function(e) {
        // Escape to close modal or go back
        if (e.key === 'Escape') {
            if (document.getElementById('confirmationModal').classList.contains('show')) {
                hideConfirmation();
            } else {
                window.location.href = "{% url 'audit_management:dashboard' %}";
            }
        }
    });
    
    // Click outside modal to close
    document.getElementById('confirmationModal').addEventListener('click', function(e) {
        if (e.target === this) {
            hideConfirmation();
        }
    });
});
</script>
{% endblock %} 