{% extends 'base/base.html' %}
{% load widget_tweaks %}
{% load audit_filters %}

{% block title %}Audit Log Detail{% endblock %}

{% block main_class %}col-md-10 ms-sm-auto col-lg-10{% endblock %}

{% block extra_css %}
<style>
/* Compact Design System - Audit Log Detail */
.page-header {
    padding: 8px 0;
    margin-bottom: 12px;
}
.page-header h2 {
    font-size: 18px;
    font-weight: 600;
    margin: 0;
    color: #1a1a1a;
}
.page-header p {
    font-size: 11px;
    color: #666;
    margin: 0;
}

/* Ultra-Minimal Button System */
.btn-compact {
    font-size: 10px;
    font-weight: 500;
    border-radius: 3px;
    padding: 4px 8px;
    border: 1px solid #bfdbfe;
    cursor: pointer;
    transition: all 0.15s ease;
    text-decoration: none;
    display: inline-flex;
    align-items: center;
    gap: 3px;
    line-height: 1;
}
.btn-secondary-compact {
    background: #ffffff;
    color: #1e3a8a;
    border-color: #bfdbfe;
}
.btn-secondary-compact:hover {
    background: #eff6ff;
    color: #1e40af;
    text-decoration: none;
    transform: translateY(-1px);
}

/* Compact detail containers */
.detail-container {
    background: white;
    border: 1px solid #e2e8f0;
    border-radius: 6px;
    padding: 16px;
    margin-bottom: 12px;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
}
.detail-title {
    font-size: 14px;
    font-weight: 600;
    color: #1a1a1a;
    margin: 0 0 12px 0;
    padding-bottom: 8px;
    border-bottom: 1px solid #f1f5f9;
}

/* Ultra-compact info grid */
.info-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 16px;
}
.info-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 8px 0;
    border-bottom: 1px solid #f8fafb;
}
.info-item:last-child {
    border-bottom: none;
}
.info-label {
    font-size: 11px;
    font-weight: 500;
    color: #6b7280;
    text-transform: uppercase;
    letter-spacing: 0.3px;
}
.info-value {
    font-size: 12px;
    color: #1a1a1a;
    font-weight: 500;
}

/* Compact badges */
.risk-badge {
    padding: 2px 6px;
    border-radius: 12px;
    font-size: 9px;
    font-weight: 500;
    text-transform: uppercase;
    letter-spacing: 0.3px;
}
.risk-critical { background: #fee2e2; color: #991b1b; }
.risk-high { background: #fed7aa; color: #9a3412; }
.risk-medium { background: #fef3c7; color: #92400e; }
.risk-low { background: #dbeafe; color: #1d4ed8; }
.risk-minimal { background: #dcfce7; color: #166534; }

.severity-badge {
    padding: 2px 6px;
    border-radius: 12px;
    font-size: 9px;
    font-weight: 500;
    text-transform: uppercase;
    letter-spacing: 0.3px;
}
.severity-error { background: #fee2e2; color: #991b1b; }
.severity-warning { background: #fef3c7; color: #92400e; }
.severity-info { background: #dbeafe; color: #1d4ed8; }
.severity-debug { background: #f3f4f6; color: #6b7280; }

.action-badge {
    background: #e0e7ff;
    color: #3730a3;
    padding: 2px 6px;
    border-radius: 12px;
    font-size: 9px;
    font-weight: 500;
    text-transform: uppercase;
}

/* Compact JSON display */
.json-display {
    background: #f8fafb;
    border: 1px solid #e2e8f0;
    border-radius: 4px;
    padding: 12px;
    font-family: 'SF Mono', 'Monaco', 'Cascadia Code', 'Roboto Mono', Consolas, 'Courier New', monospace;
    font-size: 11px;
    max-height: 200px;
    overflow-y: auto;
    color: #374151;
    line-height: 1.4;
}

/* Description styling */
.description-text {
    font-size: 12px;
    color: #374151;
    line-height: 1.5;
    background: #f8fafb;
    padding: 12px;
    border-radius: 4px;
    border-left: 3px solid #87ceeb;
}

/* Responsive adjustments */
@media (max-width: 768px) {
    .info-grid {
        grid-template-columns: 1fr;
        gap: 8px;
    }
    .info-item {
        flex-direction: column;
        align-items: flex-start;
        gap: 4px;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid px-3">
    <!-- Compact Page Header -->
    <div class="page-header d-flex justify-content-between align-items-center">
        <div>
            <h2><i class="fas fa-eye"></i> Audit Log Detail</h2>
            <p>Detailed view of audit log entry #{{ log.id }}</p>
        </div>
        <div>
            <a href="{% url 'audit_management:logs' %}" class="btn-compact btn-secondary-compact">
                <i class="fas fa-arrow-left"></i> Back to Logs
            </a>
        </div>
    </div>
    
    <!-- Compact Main Information -->
    <div class="detail-container">
        <h6 class="detail-title">Log Information</h6>
        <div class="info-grid">
            <div class="info-item">
                <span class="info-label">Timestamp</span>
                <span class="info-value">{{ log.timestamp|cambodia_time }}</span>
            </div>
            <div class="info-item">
                <span class="info-label">User</span>
                <span class="info-value">
                    {% if log.user %}
                        {{ log.user.get_full_name|default:log.user.username }}
                    {% else %}
                        <em>Anonymous</em>
                    {% endif %}
                </span>
            </div>
            <div class="info-item">
                <span class="info-label">Action</span>
                <span class="info-value">
                    <span class="action-badge">{{ log.action_type }}</span>
                </span>
            </div>
            <div class="info-item">
                <span class="info-label">Resource</span>
                <span class="info-value">{{ log.resource_type|title }}</span>
            </div>
            <div class="info-item">
                <span class="info-label">Resource ID</span>
                <span class="info-value">{{ log.resource_id|default:"N/A" }}</span>
            </div>
            <div class="info-item">
                <span class="info-label">Resource Name</span>
                <span class="info-value">{{ log.resource_name|default:"N/A" }}</span>
            </div>
            <div class="info-item">
                <span class="info-label">Risk Score</span>
                <span class="info-value">
                    {% if log.risk_score >= 80 %}
                        <span class="risk-badge risk-critical">Critical</span>
                    {% elif log.risk_score >= 60 %}
                        <span class="risk-badge risk-high">High</span>
                    {% elif log.risk_score >= 40 %}
                        <span class="risk-badge risk-medium">Medium</span>
                    {% elif log.risk_score >= 20 %}
                        <span class="risk-badge risk-low">Low</span>
                    {% else %}
                        <span class="risk-badge risk-minimal">Minimal</span>
                    {% endif %}
                    {{ log.risk_score }}/100
                </span>
            </div>
            <div class="info-item">
                <span class="info-label">Severity</span>
                <span class="info-value">
                    <span class="severity-badge severity-{{ log.severity }}">{{ log.severity|title }}</span>
                </span>
            </div>
            <div class="info-item">
                <span class="info-label">IP Address</span>
                <span class="info-value">{{ log.ip_address|default:"N/A" }}</span>
            </div>
            <div class="info-item">
                <span class="info-label">Correlation ID</span>
                <span class="info-value">
                    {% if log.correlation_id %}
                        <code style="font-size: 10px;">{{ log.correlation_id|slice:":16" }}...</code>
                    {% else %}
                        N/A
                    {% endif %}
                </span>
            </div>
        </div>
    </div>
    
    <!-- Compact Description -->
    <div class="detail-container">
        <h6 class="detail-title">Description</h6>
        <div class="description-text">{{ log.description }}</div>
    </div>
    
    <!-- Compact Business Context -->
    {% if log.business_context %}
    <div class="detail-container">
        <h6 class="detail-title">Business Context</h6>
        <div class="json-display">{{ log.business_context|pprint }}</div>
    </div>
    {% endif %}
    
    <!-- Compact Previous Values -->
    {% if log.old_values %}
    <div class="detail-container">
        <h6 class="detail-title">Previous Values</h6>
        <div class="json-display">{{ log.old_values|pprint }}</div>
    </div>
    {% endif %}
    
    <!-- Compact New Values -->
    {% if log.new_values %}
    <div class="detail-container">
        <h6 class="detail-title">New Values</h6>
        <div class="json-display">{{ log.new_values|pprint }}</div>
    </div>
    {% endif %}
    
    <!-- Compact Tags -->
    {% if log.tags.exists %}
    <div class="detail-container">
        <h6 class="detail-title">Tags</h6>
        <div>
            {% for tag in log.tags.all %}
                <span class="action-badge me-1 mb-1">{{ tag.name }}</span>
            {% endfor %}
        </div>
    </div>
    {% endif %}
    
    <!-- Compact Session Information -->
    {% if log.session %}
    <div class="detail-container">
        <h6 class="detail-title">Session Information</h6>
        <div class="info-grid">
            <div class="info-item">
                <span class="info-label">Session ID</span>
                <span class="info-value"><code style="font-size: 10px;">{{ log.session.session_key|slice:":16" }}...</code></span>
            </div>
            <div class="info-item">
                <span class="info-label">Started</span>
                <span class="info-value">{{ log.session.start_time|cambodia_time }}</span>
            </div>
            <div class="info-item">
                <span class="info-label">Last Activity</span>
                <span class="info-value">{{ log.session.last_activity|cambodia_time }}</span>
            </div>
            <div class="info-item">
                <span class="info-label">Duration</span>
                <span class="info-value">{{ log.session.duration|default:"N/A" }}</span>
            </div>
        </div>
    </div>
    {% endif %}
    
    <!-- Compact Related Logs -->
    {% if related_logs %}
    <div class="detail-container">
        <h6 class="detail-title">Related Logs (Same Correlation ID)</h6>
        <div class="table-responsive">
            <table class="table">
                <thead>
                    <tr>
                        <th>Time</th>
                        <th>Action</th>
                        <th>Resource</th>
                        <th>Risk</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody>
                    {% for related_log in related_logs %}
                    <tr>
                        <td>{{ related_log.timestamp|cambodia_time_short }}</td>
                        <td><span class="action-badge">{{ related_log.action_type }}</span></td>
                        <td>{{ related_log.resource_type }}</td>
                        <td>
                            {% if related_log.risk_score >= 80 %}
                                <span class="risk-badge risk-critical">{{ related_log.risk_score }}</span>
                            {% elif related_log.risk_score >= 60 %}
                                <span class="risk-badge risk-high">{{ related_log.risk_score }}</span>
                            {% elif related_log.risk_score >= 40 %}
                                <span class="risk-badge risk-medium">{{ related_log.risk_score }}</span>
                            {% elif related_log.risk_score >= 20 %}
                                <span class="risk-badge risk-low">{{ related_log.risk_score }}</span>
                            {% else %}
                                <span class="risk-badge risk-minimal">{{ related_log.risk_score }}</span>
                            {% endif %}
                        </td>
                        <td>
                            <a href="{% url 'audit_management:log_detail' related_log.id %}" class="btn-compact btn-secondary-compact">
                                <i class="fas fa-eye"></i>
                            </a>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% endif %}
    
    <!-- Compact Django Auditlog Entry -->
    {% if django_log %}
    <div class="detail-container">
        <h6 class="detail-title">Django Auditlog Entry</h6>
        <div class="info-grid">
            <div class="info-item">
                <span class="info-label">Action</span>
                <span class="info-value">{{ django_log.get_action_display }}</span>
            </div>
            <div class="info-item">
                <span class="info-label">Object</span>
                <span class="info-value">{{ django_log.object_repr }}</span>
            </div>
        </div>
        {% if django_log.changes %}
        <h6 class="detail-title">Changes</h6>
        <div class="json-display">{{ django_log.changes|pprint }}</div>
        {% endif %}
    </div>
    {% endif %}
</div>
{% endblock %} 