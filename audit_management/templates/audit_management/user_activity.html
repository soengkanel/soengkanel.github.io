{% extends 'base/base.html' %}
{% load widget_tweaks %}
{% load audit_filters %}

{% block title %}User Activity - {{ target_user.get_full_name|default:target_user.username }}{% endblock %}

{% block extra_head %}
<!-- Include enhanced UI/UX components -->
{% include 'partials/form_enhancements.html' %}
{% include 'partials/modal.html' %}
{% endblock %}

{% block main_class %}col-md-10 ms-sm-auto col-lg-10{% endblock %}

{% block extra_css %}
<style>
/* Compact Design System - User Activity */
.page-header {
    padding: 8px 0;
    margin-bottom: 12px;
}
.page-header h2 {
    font-size: 18px;
    font-weight: 600;
    margin: 0;
    color: #1a1a1a;
}
.page-header p {
    font-size: 11px;
    color: #666;
    margin: 0;
}

/* Compact Sections */
.activity-section {
    background: #ffffff;
    border: 1px solid #e5e7eb;
    padding: 12px;
    margin-bottom: 10px;
    border-radius: 6px;
    box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
}

.activity-section h4 {
    color: #1f2937;
    font-size: 13px;
    font-weight: 600;
    margin-bottom: 10px;
    padding-bottom: 4px;
    border-bottom: 2px solid #667eea;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    display: flex;
    align-items: center;
    gap: 6px;
}

.activity-section h4 i {
    color: #667eea;
    font-size: 14px;
}

/* Compact User Header */
.user-header {
    color: white;
    padding: 12px 16px;
    border-radius: 6px;
    margin-bottom: 12px;
    box-shadow: 0 2px 8px rgba(102, 126, 234, 0.25);
}

.user-header h2 {
    font-size: 16px;
    font-weight: 600;
    margin: 0;
    color: white;
}

.user-header p {
    font-size: 11px;
    color: rgba(255, 255, 255, 0.9);
    margin: 2px 0 0 0;
}

/* Compact Stats */
.stat-mini {
    background: #f8fafc;
    border: 1px solid #e2e8f0;
    border-radius: 4px;
    padding: 8px 10px;
    text-align: center;
    margin-bottom: 6px;
}

.stat-mini.success { border-left: 3px solid #10b981; }
.stat-mini.warning { border-left: 3px solid #f59e0b; }
.stat-mini.danger { border-left: 3px solid #ef4444; }
.stat-mini.info { border-left: 3px solid #3b82f6; }

.stat-number {
    font-size: 14px;
    font-weight: 700;
    color: #1f2937;
    margin: 0;
}

.stat-label {
    font-size: 9px;
    color: #6b7280;
    text-transform: uppercase;
    letter-spacing: 0.3px;
    margin: 0;
}

/* Compact Badges */
.badge-mini {
    font-size: 9px;
    padding: 2px 5px;
    border-radius: 2px;
    font-weight: 500;
    text-transform: uppercase;
    letter-spacing: 0.3px;
}

.risk-critical { background: #dc2626; color: white; }
.risk-high { background: #ea580c; color: white; }
.risk-medium { background: #d97706; color: white; }
.risk-low { background: #0891b2; color: white; }
.risk-minimal { background: #059669; color: white; }

.severity-error { background: #dc2626; color: white; }
.severity-warning { background: #d97706; color: white; }
.severity-info { background: #0891b2; color: white; }
.severity-debug { background: #6b7280; color: white; }

/* Compact Timeline */
.timeline-compact {
    max-height: 400px;
    overflow-y: auto;
}

.timeline-item {
    border-left: 2px solid #e5e7eb;
    padding: 6px 0 6px 10px;
    margin-bottom: 8px;
    position: relative;
    font-size: 11px;
}

.timeline-item::before {
    content: '';
    position: absolute;
    left: -4px;
    top: 8px;
    width: 6px;
    height: 6px;
    border-radius: 50%;
    background: #3b82f6;
}

.timeline-item.risk-high::before { background: #ea580c; }
.timeline-item.risk-critical::before { background: #dc2626; }

/* Compact Forms */
.form-control-mini {
    font-size: 11px !important;
    padding: 4px 6px !important;
    height: auto !important;
    border-radius: 3px;
}

.btn-mini {
    font-size: 10px;
    padding: 4px 8px;
    border-radius: 3px;
}

/* Compact Tables */
.table-mini {
    font-size: 10px;
}

.table-mini th, .table-mini td {
    padding: 4px 6px;
    vertical-align: middle;
}

/* Grid System */
.row.g-mini {
    --bs-gutter-x: 0.5rem;
    --bs-gutter-y: 0.5rem;
}

/* Progress bars */
.progress-mini {
    height: 8px;
    background-color: #f1f5f9;
}

.progress-mini .progress-bar {
    font-size: 8px;
}

/* Export section */
.export-actions {
    background: #f8fafc;
    border: 1px dashed #cbd5e0;
    border-radius: 4px;
    padding: 10px;
    text-align: center;
}

/* Hover effects */
.activity-section:hover {
    transform: translateY(-1px);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    transition: all 0.2s ease;
}

.timeline-item:hover {
    background-color: #f9fafb;
    border-left-color: #667eea;
    transition: all 0.2s ease;
}

/* Responsive adjustments */
@media (max-width: 768px) {
    .user-header {
        padding: 10px;
    }
    
    .activity-section {
        padding: 8px;
    }
    
    .stat-mini {
        margin-bottom: 4px;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid p-2">
    <!-- Compact User Header -->
    <div class="user-header">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h2>
                    <i class="bi bi-person-badge me-1"></i>
                    {{ target_user.get_full_name|default:target_user.username }}
                </h2>
                <p>
                    {{ target_user.username }} • {{ target_user.email|default:"No email" }} • 
                    Last: {{ target_user.last_login|date:"M d, H:i"|default:"Never" }}
                </p>
            </div>
            <a href="{% url 'audit_management:dashboard' %}" class="btn btn-light btn-mini">
                <i class="bi bi-arrow-left"></i> Back
            </a>
        </div>
    </div>

    <!-- Compact Filter Section -->
    <div class="activity-section">
        <h4><i class="bi bi-funnel"></i>Filters</h4>
        <form method="get" class="row g-mini align-items-end">
            <div class="col-md-3">
                <label class="form-label" style="font-size: 10px; margin-bottom: 2px;">Start Date</label>
                <input type="date" class="form-control form-control-mini" name="start_date" 
                       value="{{ start_date|date:'Y-m-d' }}">
            </div>
            <div class="col-md-3">
                <label class="form-label" style="font-size: 10px; margin-bottom: 2px;">End Date</label>
                <input type="date" class="form-control form-control-mini" name="end_date" 
                       value="{{ end_date|date:'Y-m-d' }}">
            </div>
            <div class="col-md-3">
                <label class="form-label" style="font-size: 10px; margin-bottom: 2px;">Action Type</label>
                <select class="form-control form-control-mini" name="action_type">
                    <option value="">All Actions</option>
                    <option value="create">Create</option>
                    <option value="read">Read</option>
                    <option value="update">Update</option>
                    <option value="delete">Delete</option>
                    <option value="login">Login</option>
                    <option value="logout">Logout</option>
                </select>
            </div>
            <div class="col-md-3">
                <button type="submit" class="btn btn-primary btn-mini me-1">
                    <i class="bi bi-search"></i> Filter
                </button>
                <a href="{% url 'audit_management:user_activity' target_user.id %}" class="btn btn-outline-secondary btn-mini">
                    <i class="bi bi-x"></i> Clear
                </a>
            </div>
        </form>
    </div>

    <!-- Compact Statistics -->
    <div class="row g-mini">
        <div class="col-md-3">
            <div class="stat-mini info">
                <div class="stat-number">{{ activity_summary.total_actions|default:0 }}</div>
                <div class="stat-label">Total Actions</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-mini success">
                <div class="stat-number">{{ activity_summary.unique_sessions|default:0 }}</div>
                <div class="stat-label">Sessions</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-mini warning">
                <div class="stat-number">{{ activity_summary.high_risk_actions|default:0 }}</div>
                <div class="stat-label">High Risk</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-mini danger">
                <div class="stat-number">{{ activity_summary.failed_actions|default:0 }}</div>
                <div class="stat-label">Failed</div>
            </div>
        </div>
    </div>

    <!-- Compact Content Row -->
    <div class="row g-mini">
        <!-- Activity Breakdown -->
        <div class="col-md-6">
            <div class="activity-section">
                <h4><i class="bi bi-pie-chart"></i>Actions by Type</h4>
                {% if activity_summary.action_breakdown %}
                    <div class="table-responsive">
                        <table class="table table-mini table-borderless">
                            {% for action in activity_summary.action_breakdown %}
                            <tr>
                                <td style="width: 30%;">{{ action.action_type|title }}</td>
                                <td style="width: 20%;">{{ action.count }}</td>
                                <td style="width: 50%;">
                                    <div class="progress progress-mini">
                                        <div class="progress-bar bg-primary" style="width: {% widthratio action.count activity_summary.total_actions 100 %}%"></div>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </table>
                    </div>
                {% else %}
                    <p class="text-muted mb-0" style="font-size: 11px;">No activity data available</p>
                {% endif %}
            </div>
        </div>

        <!-- Risk Breakdown -->
        <div class="col-md-6">
            <div class="activity-section">
                <h4><i class="bi bi-shield-exclamation"></i>Risk Distribution</h4>
                {% if activity_summary.risk_breakdown %}
                    <div class="table-responsive">
                        <table class="table table-mini table-borderless">
                            {% for risk in activity_summary.risk_breakdown %}
                            <tr>
                                <td style="width: 60%;">
                                    <span class="badge-mini risk-{{ risk.risk_level|lower }}">
                                        {{ risk.risk_level }}
                                    </span>
                                </td>
                                <td style="width: 40%;">{{ risk.count }}</td>
                            </tr>
                            {% endfor %}
                        </table>
                    </div>
                {% else %}
                    <p class="text-muted mb-0" style="font-size: 11px;">No risk data available</p>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Recent Activity Timeline -->
    <div class="activity-section">
        <h4><i class="bi bi-clock-history"></i>Recent Activity</h4>
        {% if logs %}
            <div class="timeline-compact">
                {% for log in logs %}
                <div class="timeline-item {% if log.risk_score >= 60 %}risk-{% if log.risk_score >= 80 %}critical{% else %}high{% endif %}{% endif %}">
                    <div class="d-flex justify-content-between align-items-start">
                        <div class="flex-grow-1">
                            <div class="d-flex align-items-center gap-1 mb-1">
                                <span class="badge-mini bg-secondary">{{ log.action_type }}</span>
                                {% if log.risk_score >= 80 %}
                                    <span class="badge-mini risk-critical">Critical</span>
                                {% elif log.risk_score >= 60 %}
                                    <span class="badge-mini risk-high">High</span>
                                {% elif log.risk_score >= 40 %}
                                    <span class="badge-mini risk-medium">Medium</span>
                                {% elif log.risk_score >= 20 %}
                                    <span class="badge-mini risk-low">Low</span>
                                {% else %}
                                    <span class="badge-mini risk-minimal">Minimal</span>
                                {% endif %}
                                <span class="badge-mini severity-{{ log.severity }}">{{ log.severity }}</span>
                            </div>
                            <div style="font-size: 11px; font-weight: 500;">{{ log.resource_type|title }} - {{ log.description|truncatechars:60 }}</div>
                            {% if log.resource_name %}
                                <div style="font-size: 10px; color: #6b7280;">{{ log.resource_name|truncatechars:40 }}</div>
                            {% endif %}
                        </div>
                        <div class="text-end" style="min-width: 80px;">
                            <div style="font-size: 9px; color: #6b7280;">{{ log.timestamp|date:"M d" }}</div>
                            <div style="font-size: 9px; color: #6b7280;">{{ log.timestamp|date:"H:i" }}</div>
                            <a href="{% url 'audit_management:log_detail' log.id %}" class="btn btn-outline-primary btn-mini" style="font-size: 8px; padding: 2px 4px;">
                                <i class="bi bi-eye"></i>
                            </a>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        {% else %}
            <div class="text-center py-3">
                <i class="bi bi-clock-history" style="font-size: 24px; color: #9ca3af;"></i>
                <p class="text-muted mb-0" style="font-size: 11px;">No activity found for selected period</p>
            </div>
        {% endif %}
    </div>

    <!-- Export Section -->
    <div class="export-actions">
        <div style="font-size: 11px; font-weight: 600; margin-bottom: 6px;">Export User Activity</div>
        <div class="d-flex justify-content-center gap-2">
            <a href="{% url 'audit_management:export_logs' %}?user={{ target_user.username }}&start_date={{ start_date|date:'Y-m-d' }}&end_date={{ end_date|date:'Y-m-d' }}" 
               class="btn btn-success btn-mini">
                <i class="bi bi-download"></i> CSV
            </a>
            <a href="{% url 'audit_management:export_logs' %}?user={{ target_user.username }}&start_date={{ start_date|date:'Y-m-d' }}&end_date={{ end_date|date:'Y-m-d' }}&format=json" 
               class="btn btn-info btn-mini">
                <i class="bi bi-download"></i> JSON
            </a>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Auto-refresh every 10 minutes for active monitoring
    setTimeout(function() {
        location.reload();
    }, 600000);
    
    // Compact timeline scroll behavior
    const timeline = document.querySelector('.timeline-compact');
    if (timeline) {
        timeline.addEventListener('scroll', function() {
            if (this.scrollTop > 0) {
                this.style.borderTop = '1px solid #e5e7eb';
            } else {
                this.style.borderTop = 'none';
            }
        });
    }
});
</script>
{% endblock %} 