{% extends 'base/base.html' %}
{% load static %}

{% block title %}{{ title }} - HR Management{% endblock %}

{% block extra_head %}
<!-- Prevent photo caching -->
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Expires" content="0">
<!-- Include enhanced UI/UX components -->
{% include 'partials/form_enhancements.html' %}
{% include 'partials/modal.html' %}
{% endblock %}

{% block main_class %}col-md-10 ms-sm-auto col-lg-10{% endblock %}

{% block extra_css %}
<style>
/* Ultra Compact Design System - Employee Form */
.page-header {
    padding: 6px 0;
    margin-bottom: 8px;
}
.page-header h2 {
    font-size: 16px;
    font-weight: 600;
    margin: 0;
    color: #000000;
}
.page-header p {
    font-size: 10px;
    color: #666666;
    margin: 0;
}

/* Compact Form Sections */




.required-field {
    color: #ef4444;
    font-weight: normal;
}

/* HIGH PRIORITY: Override form enhancements CSS that adds asterisks */
html body .form-label.required::after,
html body label.required::after,
html body .form-label::after,
html body label::after {
    content: '' !important;
    display: none !important;
    visibility: hidden !important;
}

/* Nuclear option: disable all pseudo-element content on labels */
label *::after,
.form-label *::after {
    content: none !important;
}

/* Compact Form Controls */
.form-floating, 
.mb-1, .mb-2, .mb-3 {
    margin-bottom: 1rem !important;
}

.form-group {
    margin-bottom: 1rem;
}

/* Better alignment for form fields */
.form-floating > .form-control,
.form-floating > .form-select {
    padding-top: 1.625rem;
    padding-bottom: 0.625rem;
}

/* Consistent height for all inputs - Global Design Standard */
.form-control,
.form-select,
input[type="text"],
input[type="email"],
input[type="tel"],
input[type="date"],
select {
    font-size: 13px !important;
    padding: 6px 8px !important;
    height: auto !important;
    min-height: 28px !important;
    border-radius: 3px;
    border: 1px solid #e5e7eb;
    line-height: 1.4 !important;
    box-shadow: none !important;
}
.form-label {
    font-size: 10px !important;
    margin-bottom: 4px !important;
    font-weight: 500;
    color: #6b7280;
    text-transform: uppercase;
    letter-spacing: 0.2px;
    display: block;
}

.form-control:focus, .form-select:focus {
    border-color: #3b82f6 !important;
    box-shadow: none !important;
    outline: none !important;
}


/* Compact Textarea styling */
textarea.form-control {
    font-size: 13px !important;
    padding: 6px 8px !important;
    resize: vertical;
    min-height: 60px;
}

/* Ultra Compact Grid System */
.row.g-1 {
    --bs-gutter-x: 0.5rem;
    --bs-gutter-y: 0.5rem;
}

/* Standard Button System */
.btn-modern {
    font-size: 13px;
    font-weight: 500;
    border-radius: 6px;
    padding: 8px 16px;
    border: none;
    cursor: pointer;
    text-decoration: none;
    display: inline-flex;
    align-items: center;
    gap: 6px;
}

/* Primary Button - Standard Theme */
.btn-primary-modern {
    padding: 8px 16px;
    font-family: -apple-system, BlinkMacSystemFont, 'Roboto', sans-serif;
    border-radius: 6px;
    border: none;
    color: #ffffff;
    font-size: 13px;
    font-weight: 500;
    background: #3b82f6;
    background-origin: border-box;
    cursor: pointer;
    user-select: none;
    -webkit-user-select: none;
    touch-action: manipulation;
}

/* Light Button */
.btn-light-modern {
    background: #ffffff;
    color: #000000;
    border: 1px solid #cccccc;
}

/* Outline Button - White with Blue Border */
.btn-outline-modern {
    background: white;
    color: #000000;
    border: 1px solid #000000;
}

/* Ultra Compact Submit Area */
.submit-buttons {
    margin-top: 8px;
    padding: 8px;
    background: transparent;
    border-radius: 3px;
    border: none;
    box-shadow: none;
}

/* Ultra Compact Page Header */
.page-header {
    background: #3b82f6;
    color: white;
    padding: 8px 12px;
    border-radius: 3px;
    margin-bottom: 8px;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
}

.page-header h2 {
    font-size: 16px;
    font-weight: 600;
    margin: 0;
    color: white;
}

.page-header p {
    font-size: 11px;
    color: #ffffff;
    margin: 2px 0 0 0;
}


/* Enhanced Photo Section with Camera Support */
.application-photo-section {
    background: #ffffff;
    border: 1px solid #cccccc;
    border-radius: 8px;
    padding: 12px;
    text-align: center;
    height: fit-content;
    position: sticky;
    top: 10px;
}

.photo-section-label {
    font-size: 12px;
    font-weight: 600;
    color: #000000;
    margin-bottom: 10px;
    display: block;
    text-align: center;
}

/* Photo capture mode toggle buttons */
.photo-mode-toggle {
    display: flex;
    margin-bottom: 10px;
    border-radius: 6px;
    overflow: hidden;
    border: 1px solid #cccccc;
    background: #ffffff;
}

.mode-btn {
    flex: 1;
    padding: 6px 12px;
    font-size: 11px;
    font-weight: 500;
    border: none;
    background: transparent;
    color: #6b7280;
    cursor: pointer;
    text-transform: uppercase;
    letter-spacing: 0.3px;
}

.mode-btn.active {
    background: #667eea;
    color: white;
}


.application-photo-upload {
    border: 2px dashed #cbd5e1;
    border-radius: 8px;
    padding: 16px;
    background: #ffffff;
    cursor: pointer;
    margin-bottom: 10px;
    min-height: 140px;
    display: flex;
    align-items: center;
    justify-content: center;
    position: relative;
}


/* Camera container */
.camera-container {
    display: none;
    flex-direction: column;
    align-items: center;
    gap: 10px;
    width: 100%;
}

.camera-container.active {
    display: flex;
}

.camera-video {
    width: 100%;
    max-width: 200px;
    height: 150px;
    border-radius: 8px;
    object-fit: cover;
    border: 2px solid #e5e7eb;
    background: #f3f4f6;
}

.camera-controls {
    display: flex;
    gap: 8px;
    align-items: center;
    flex-wrap: wrap;
    justify-content: center;
}

.camera-btn {
    padding: 6px 12px;
    font-size: 11px;
    font-weight: 500;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 4px;
    text-transform: uppercase;
    letter-spacing: 0.3px;
}

.camera-btn-capture {
    background: #10b981;
    color: white;
}


.camera-btn-stop {
    background: #ef4444;
    color: white;
}


.camera-btn-start {
    background: #667eea;
    color: white;
}


.camera-status {
    font-size: 11px;
    color: #6b7280;
    margin-top: 6px;
    text-align: center;
}

.camera-error {
    color: #000000;
    font-size: 11px;
    padding: 6px 10px;
    background: #fee2e2;
    border-radius: 6px;
    margin-top: 6px;
    text-align: center;
}

.application-photo-current,
.application-photo-preview {
    width: 100px;
    height: 120px;
    border-radius: 8px;
    object-fit: cover;
    border: 2px solid #e5e7eb;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}


.photo-placeholder {
    width: 100%;
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
}


.placeholder-content {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 10px;
    color: #6b7280;
}

.placeholder-content i {
    font-size: 28px;
    color: #9ca3af;
    margin-bottom: 6px;
}

.placeholder-content span {
    font-weight: 600;
    color: #000000;
    font-size: 13px;
}

.placeholder-content small {
    font-size: 11px;
    color: #6b7280;
}

.photo-requirements {
    text-align: center;
    padding: 6px;
    background: #f1f5f9;
    border-radius: 6px;
    margin-top: 6px;
}

.photo-requirements small {
    font-size: 10px;
    line-height: 1.2;
    color: #64748b;
}

.current-photo-display {
    position: relative;
    display: inline-block;
}

.photo-overlay {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.7);
    color: white;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    border-radius: 8px;
    opacity: 0;
    gap: 4px;
}


.photo-overlay i {
    font-size: 16px;
    margin-bottom: 4px;
}

.photo-overlay small {
    font-size: 10px;
    font-weight: 500;
}

.form-check-input {
    margin-top: 0.125rem;
}
.form-check-label {
    font-size: 11px;
    margin-left: 0.25rem;
}
.form-text {
    font-size: 10px;
    margin-top: 2px;
    color: #6b7280;
}

/* Error messages */
.text-danger {
    font-size: 10px;
    color: #000000;
    margin-top: 2px;
}

/* Alert styling */
.alert {
    font-size: 11px;
    padding: 8px 12px;
    border-radius: 4px;
    margin-bottom: 8px;
}

/* Compact Document Management */
.document-form {
    border: 1px solid #cccccc;
    border-radius: 6px;
    padding: 10px;
    margin-bottom: 8px;
    background: #ffffff;
    box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
    border-left: 3px solid #667eea;
}


.document-form h5 {
    font-size: 12px;
    font-weight: 600;
    color: #000000;
    margin-bottom: 8px;
    border-bottom: 1px solid #e5e7eb;
    padding-bottom: 4px;
    display: flex;
    align-items: center;
    gap: 6px;
}

.document-form h5::before {
    content: '\F287';
    font-family: 'bootstrap-icons';
    color: #000000;
    font-size: 12px;
}

.delete-checkbox {
    background: #fef3c7;
    border: 1px solid #fde68a;
    border-radius: 4px;
    padding: 3px 6px;
    margin-top: 4px;
}
.delete-checkbox input {
    font-size: 10px;
}
.delete-checkbox label {
    font-size: 10px;
    margin-left: 4px;
    color: #92400e;
}

.add-document-btn {
    border: 2px dashed #d1d5db;
    background: transparent;
    color: #6b7280;
    border-radius: 4px;
    padding: 6px 12px;
    font-size: 11px;
    cursor: pointer;
    width: 20%;
    text-align: center;
}

/* Remove Document Button */
.remove-document-btn {
    background: #5DADE2;
    background-origin: border-box;
    color: white;
    border: none;
    border-radius: 10px;
    padding: 6px 11px;
    font-size: 11px;
    cursor: pointer;
    display: inline-flex;
    align-items: center;
    gap: 4px;
}

/* Document Preview Section (Left Column) */
.document-preview-section {
    background: #ffffff;
    padding: 1rem;
    border-radius: 8px;
    border: 1px solid #cccccc;
    height: 100%;
}

.document-preview-section .form-label {
    display: block;
    margin-bottom: 0.5rem;
    font-weight: 600;
    color: #000000;
    font-size: 0.875rem;
    line-height: 1.25;
}

.document-preview-section .form-label.fw-semibold.mb-2 {
    border-bottom: 1px solid #e2e8f0;
    padding-bottom: 0.75rem;
    margin-bottom: 1.5rem;
    color: #000000;
    font-size: 1rem;
}

.current-document-preview img {
    border: 2px solid #e2e8f0;
}


.pdf-preview-card {
}


.image-preview-card img {
}


.no-preview-placeholder {
    background: #f9fafb !important;
    border: 2px dashed #d1d5db !important;
}


/* Document Information Section (Right Column) */
.document-info-section {
    background: white;
    padding: 1.5rem;
    border-radius: 8px;
    border: 1px solid #cccccc;
    height: 100%;
}

.document-info-section .form-label {
    display: block;
    margin-bottom: 8px;
    font-weight: 600;
    color: #374151;
    font-size: 11px;
    line-height: 1.25;
    text-transform: uppercase;
    letter-spacing: 0.3px;
}

.document-info-section .form-control,
.document-info-section .form-select {
    font-size: 13px;
    padding: 10px 12px;
    border-radius: 4px;
    border: 1px solid #e5e7eb;
    width: 100%;
    background-color: #ffffff;
    line-height: 1.4;
    min-height: 36px;
    margin-bottom: 16px;
}

.document-info-section .form-control:focus,
.document-info-section .form-select:focus {
    border-color: #87CEEB;
    box-shadow: 0 0 0 2px rgba(135, 206, 235, 0.1);
    outline: none;
}

.document-info-section textarea.form-control {
    min-height: 80px;
    resize: vertical;
    padding: 10px 12px;
    line-height: 1.4;
}

/* Better spacing for document info fields */
.document-info-section .row {
    margin-bottom: 8px;
}

.document-info-section .col-md-6 {
    padding-right: 8px;
    padding-left: 8px;
}

.document-info-section h6 {
    margin-bottom: 20px;
    font-size: 14px;
    font-weight: 600;
    color: #374151;
    border-bottom: 1px solid #e5e7eb;
    padding-bottom: 8px;
}

/* Compact Responsive Design */
@media (max-width: 768px) {
    .form-section {
        padding: 8px;
        margin-bottom: 8px;
    }
    
    .application-photo-section {
        position: static;
        margin-top: 8px;
        padding: 8px;
    }
    
    .application-photo-upload {
        min-height: 100px;
        padding: 8px;
    }
    
    .application-photo-current,
    .application-photo-preview {
        width: 70px;
        height: 85px;
    }
    
    .row.g-1 > * {
        margin-bottom: 6px;
    }
    
    .submit-buttons {
        flex-direction: column;
        gap: 8px;
        padding: 10px;
    }
    
    .submit-buttons .btn-modern {
        width: 100%;
        justify-content: center;
        padding: 8px 12px;
        font-size: 11px;
    }
    
    .form-section h4 {
        font-size: 12px;
        margin-bottom: 8px;
    }
    
    .document-form {
        padding: 8px;
    }
}

/* Dark mode styles */
[data-bs-theme="dark"] .form-section {
    background-color: #2d2d2d !important;
    border-color: #404040 !important;
    color: #e0e0e0 !important;
}
[data-bs-theme="dark"] .form-section h4 {
    color: #ffffff !important;
    border-bottom-color: #404040 !important;
}
[data-bs-theme="dark"] .document-form {
    background-color: #1a1a1a !important;
    border-color: #404040 !important;
}
[data-bs-theme="dark"] .form-control,
[data-bs-theme="dark"] .form-select {
    background-color: #2d2d2d !important;
    border-color: #404040 !important;
    color: #ffffff !important;
}
[data-bs-theme="dark"] .form-control:focus,
[data-bs-theme="dark"] .form-select:focus {
    background-color: #2d2d2d !important;
    border-color: #667eea !important;
    color: #ffffff !important;
    box-shadow: 0 0 0 2px rgba(0, 0, 0, 0.25) !important;
}
        margin-bottom: 12px;
        text-align: center;
        border-radius: 0;
    }

    .application-header h1 {
        font-size: 14px;
        font-weight: 600;
        margin: 0;
        color: #1e40af;
        text-transform: none;
        letter-spacing: 0;
    }

    .application-header p {
        margin: 2px 0 0 0;
        font-size: 11px;
        color: #6b7280;
    }

    /* Modern Form Sections */
    .form-section {
        background: var(--card-bg);
        padding: 2rem;
        margin-bottom: 2rem;
        border-radius: var(--radius-lg);
        border: 1px solid var(--border-color);
            position: relative;
        overflow: hidden;
    }

    .form-section::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: #87CEEB;
        opacity: 0.8;
    }

    .form-section:hover {
    }

    .form-section h4 {
        font-size: 1.25rem;
        font-weight: 700;
        margin-bottom: 1.5rem;
        color: var(--text-primary);
        display: flex;
        align-items: center;
        gap: 0.75rem;
        padding-bottom: 1rem;
        border-bottom: 2px solid var(--border-color);
        position: relative;
    }

    .form-section h4::after {
        content: '';
        position: absolute;
        bottom: -2px;
        left: 0;
        width: 60px;
        height: 2px;
        background: #87CEEB;
    }

    .form-section h4 i {
        font-size: 1.25rem;
        background: rgba(0, 0, 0, 0.1);
        padding: 0.5rem;
        border-radius: var(--radius-md);
    }

    .required-field {
        color: #dc3545;
        font-weight: bold;
    }

    /* Modern Form Elements */
    .form-label {
        font-size: 0.80rem !important;
        margin-bottom: 0.5rem !important;
        font-weight: 600;
        color: var(--text-primary) !important;
        display: block;
        position: relative;
    }

    .form-label .required-field {
        margin-left: 0.25rem;
    }

    .form-control,
    .form-select {
        font-size: 0.875rem !important;
        padding: 0.75rem 1rem !important;
        height: auto !important;
        border-radius: var(--radius-md);
        border: 2px solid var(--border-color);
            font-family: inherit;
        background: var(--card-bg);
        color: var(--text-primary);
        box-shadow: var(--shadow-sm);
        min-height: 48px;
    }

    .form-control:focus,
    .form-select:focus {
        border: none;
        box-shadow: none;
        background-color: var(--card-bg);
        outline: none;
    }


    .form-control::placeholder {
        color: var(--text-secondary);
        opacity: 0.7;
    }

    /* Textarea specific styling */
    textarea.form-control {
        resize: vertical;
        min-height: 100px;
        line-height: 1.6;
    }

    .row.g-1 {
        --bs-gutter-x: 0.75rem;
        --bs-gutter-y: 0.75rem;
    }

    /* Modern Buttons - Compact & Rounded */
    .btn {
        font-size: 0.75rem;
        padding: 0.5rem 1rem;
        border-radius: 8px;
        font-weight: 600;
        text-transform: none;
        letter-spacing: 0.025em;
        border: 2px solid transparent;
        display: inline-flex;
        align-items: center;
        gap: 0.375rem;
        text-decoration: none;
        cursor: pointer;
        position: relative;
        overflow: hidden;
    }

    .btn::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: transparent;
    }


    .btn-primary {
        background: #87CEEB;
        color: white;
    }


    .btn-primary {
        background: #87CEEB;
        color: white;
        border: none;
    }


    .btn-success {
        background: #87CEEB;
        color: white;
        border: none;
    }


    .btn-danger {
        background: #dc3545;
        color: white;
        border: none;
    }
    
    .btn-danger:hover {
        background: #c82333;
        color: white;
    }

        color: white;
    }

    .btn-sm {
        font-size: 0.75rem;
        padding: 0.5rem 1rem;
    }

    .btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        box-shadow: var(--shadow-sm) !important;
    }

    .btn-secondary {
        background: #87CEEB;
        color: white;
        border: none;
    }

    /* Compact Photo Section */
    .application-photo-section {
        padding: 8px;
        text-align: center;
        height: fit-content;
        margin-bottom: 8px;
    }

    .photo-section-label {
        font-size: 9px;
        font-weight: 600;
        color: #1e40af;
        margin-bottom: 4px;
        display: block;
        text-align: center;
        text-transform: none;
        letter-spacing: 0;
    }

    /* Photo capture mode toggle buttons */
    .photo-mode-toggle {
        display: flex;
        margin-bottom: 10px;
        border-radius: 6px;
        overflow: hidden;
    }

    .mode-btn {
        flex: 1;
        padding: 6px 12px;
        font-size: 11px;
        font-weight: 500;
        border: none;
        background: transparent;
        color: #6b7280;
        cursor: pointer;
            text-transform: uppercase;
        letter-spacing: 0.3px;
    }

    .mode-btn.active {
        background: #4B91F7;
        color: white;
    }

    .mode-btn:hover:not(.active) {
    }

    .application-photo-upload {
        border: 2px dashed #cbd5e1;
        border-radius: 8px;
        padding: 16px;
            cursor: pointer;
        margin-bottom: 10px;
        min-height: 140px;
        display: flex;
        align-items: center;
        justify-content: center;
        position: relative;
    }


    /* Camera container */
    .camera-container {
        display: none;
        flex-direction: column;
        align-items: center;
        gap: 10px;
        width: 100%;
    }

    .camera-container.active {
        display: flex;
    }

    .camera-video {
        width: 100%;
        max-width: 200px;
        height: 150px;
        border-radius: 8px;
        object-fit: cover;
        border: 2px solid #e5e7eb;
    }

    .camera-controls {
        display: flex;
        gap: 8px;
        align-items: center;
        flex-wrap: wrap;
        justify-content: center;
    }

    .camera-btn {
        padding: 6px 12px;
        font-size: 11px;
        font-weight: 500;
        border: none;
        border-radius: 6px;
        cursor: pointer;
            display: flex;
        align-items: center;
        gap: 4px;
        text-transform: uppercase;
        letter-spacing: 0.3px;
    }

    .camera-btn-capture {
        background: #10b981;
        color: white;
    }


    .camera-btn-stop {
        background: #ef4444;
        color: white;
    }


    .camera-btn-start {
        background: linear-gradient(180deg, #4B91F7 0%, #367AF6 100%);
        background-origin: border-box;
        box-shadow: 0px 0.5px 1.5px rgba(54, 122, 246, 0.25), inset 0px 0.8px 0px -0.25px rgba(255, 255, 255, 0.2);
        color: white;
    }


    .camera-status {
        font-size: 11px;
        color: #6b7280;
        margin-top: 6px;
        text-align: center;
    }

    .camera-error {
        font-size: 11px;
        padding: 6px 10px;
        background: #fee2e2;
        border-radius: 6px;
        margin-top: 6px;
        text-align: center;
    }

    .application-photo-current,
    .application-photo-preview {
        width: 100px;
        height: 120px;
        border-radius: 8px;
        object-fit: cover;
        border: 2px solid #e5e7eb;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }


    .photo-placeholder {
            width: 100%;
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
    }


    .placeholder-content {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 10px;
        color: #6b7280;
    }

    .placeholder-content i {
        font-size: 28px;
        color: #9ca3af;
        margin-bottom: 6px;
    }

    .placeholder-content span {
        font-weight: 600;
        font-size: 13px;
    }

    .placeholder-content small {
        font-size: 11px;
        color: #6b7280;
    }

    .photo-requirements {
        text-align: center;
        padding: 6px;
        background: #f1f5f9;
        border-radius: 6px;
        margin-top: 6px;
    }

    .photo-requirements small {
        font-size: 10px;
        line-height: 1.2;
        color: #64748b;
    }

    .current-photo-display {
        position: relative;
        display: inline-block;
    }

    .photo-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.7);
        color: white;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        border-radius: 8px;
        opacity: 0;
            gap: 4px;
    }


    .photo-overlay i {
        font-size: 16px;
        margin-bottom: 4px;
    }

    .photo-overlay small {
        font-size: 10px;
        font-weight: 500;
    }

    /* Submit button area */
    .submit-buttons {
        margin-top: 24px;
        padding-top: 20px;
        border-top: 1px solid #e5e7eb;
        text-align: center;
    }

    /* Compact Textarea styling */
    textarea.form-control {
        resize: vertical;
        min-height: 60px;
        border: none;
        border-bottom: 1px solid #e5e7eb;
        border-radius: 0;
        background: #fafafa;
        padding: 6px 8px;
    }

    textarea.form-control:focus {
        border-bottom-color: #3b82f6;
        box-shadow: none;
        outline: none;
    }

    /* Error styling */
    .text-danger {
        font-size: 11px !important;
        margin-top: 4px;
        font-weight: 500;
    }

    /* Form group styling */
    .form-group {
        position: relative;
    }

    /* Enhanced User Experience Improvements */
    .form-section {
    }



    /* Enhanced Form Section Headers */
    .form-section h4 {
        position: relative;
        overflow: hidden;
    }

    .form-section h4::after {
        content: '';
        position: absolute;
        bottom: 0;
        left: 0;
        width: 0;
        height: 2px;
        background: #87CEEB;
    }


    /* Interactive Form Controls */
    .form-control, .form-select {
        position: relative;
        overflow: hidden;
    }

    .form-control::before, .form-select::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: transparent;
        pointer-events: none;
    }

    .form-control:focus::before, .form-select:focus::before {
        left: 100%;
    }

    /* Success Animation for Form Validation */
    .form-control.is-valid {
        border-color: #10b981 !important;
    }


    /* Enhanced Photo Section */
    .application-photo-section {
        position: relative;
        overflow: hidden;
    }

    .application-photo-section::before {
        content: '';
        position: absolute;
        top: -50%;
        left: -50%;
        width: 200%;
        height: 200%;
        background: transparent;
        pointer-events: none;
    }


    /* Edit Mode Status Indicator */
    .edit-status-indicator {
        margin: 2rem 0;
    }

    .status-card {
        border: 1px solid #f59e0b;
        border-radius: var(--radius-lg);
        padding: 1.5rem;
        position: relative;
        overflow: hidden;
    }

    .status-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: #87CEEB;
    }

    .status-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 1rem;
        flex-wrap: wrap;
        gap: 1rem;
    }

    .status-info h3 {
        margin: 0;
        font-size: 1.25rem;
        font-weight: 700;
        color: #92400e;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .status-info p {
        margin: 0.25rem 0 0 0;
        color: #a16207;
        font-size: 0.875rem;
        font-weight: 500;
    }

    .status-badges {
        display: flex;
        gap: 0.5rem;
        flex-wrap: wrap;
    }

    .badge {
        padding: 0.375rem 0.75rem;
        border-radius: 5px;
        font-size: 0.75rem;
        font-weight: 600;
        display: inline-flex;
        align-items: center;
        gap: 0.25rem;
    }

    .badge-status-active {
        background: #d1fae5;
        color: #065f46;
        border: 1px solid #10b981;
    }

    .badge-status-inactive {
        background: #fee2e2;
        color: #991b1b;
        border: 1px solid #ef4444;
    }

    .badge-status-terminated {
        border: 1px solid #6b7280;
    }

    .badge-info {
        background: #dbeafe;
        color: #1e40af;
        border: 1px solid #000000;
    }

    .status-details {
        display: flex;
        gap: 2rem;
        flex-wrap: wrap;
    }

    .detail-item {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        color: #a16207;
        font-size: 0.875rem;
        font-weight: 500;
    }

    .detail-item i {
        color: #d97706;
    }

    /* Modern Submit Section */
    .submit-section {
        margin-top: 0.5rem;
        padding: 2rem;
        background: var(--card-bg);
        border-radius: var(--radius-lg);
        border: 1px solid var(--border-color);
        text-align: center;
        position: relative;
    }

    .submit-section::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
    
        border-radius: var(--radius-lg) var(--radius-lg) 0 0;
    }

    .submit-actions {
        display: flex;
        justify-content: center;
        gap: 0.75rem;
        margin-bottom: 1rem;
        flex-wrap: wrap;
        align-items: center;
    }

    .submit-note {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
        color: var(--text-secondary);
        font-size: 0.875rem;
        font-style: italic;
    }

    .submit-note i {
    }

    /* Animation for edit mode status */
    .edit-status-indicator {
    }


    /* Edit mode form enhancements */
    .edit-mode .form-section {
        position: relative;
    }

    .edit-mode .form-section::after {
        content: 'EDITING';
        position: absolute;
        top: 1rem;
        right: 1rem;
        background: rgba(0, 0, 0, 0.1);
        padding: 0.25rem 0.5rem;
        border-radius: var(--radius-sm);
        font-size: 0.625rem;
        font-weight: 700;
        letter-spacing: 0.05em;
        opacity: 0.7;
    }

    /* Enhanced form controls for edit mode */
    .edit-mode .form-control:not(:placeholder-shown),
    .edit-mode .form-select:not([value=""]) {
        border-color: #87CEEB;
        box-shadow: 0 0 0 1px rgba(0, 0, 0, 0.1);
    }

    /* Dark mode styles */
    [data-bs-theme="dark"] .application-header {
        background: #87CEEB;
    }

    [data-bs-theme="dark"] .form-section {
        background-color: #1f2937 !important;
        border-color: #374151 !important;
        color: #e5e7eb !important;
    }

    [data-bs-theme="dark"] .form-section h4 {
        color: #f9fafb !important;
        border-bottom-color: #4f46e5 !important;
    }

    [data-bs-theme="dark"] .form-section h4::before {
        background: #4f46e5 !important;
    }


    [data-bs-theme="dark"] .form-label {
        color: #e5e7eb !important;
    }

    [data-bs-theme="dark"] .form-control,
    [data-bs-theme="dark"] .form-select {
        background-color: #374151 !important;
        border-color: #4b5563 !important;
        color: #e5e7eb !important;
    }

    [data-bs-theme="dark"] .form-control:focus,
    [data-bs-theme="dark"] .form-select:focus {
        border: none !important;
        box-shadow: none !important;
    }

    [data-bs-theme="dark"] .required-field {
        color: #ef4444 !important;
    }

    [data-bs-theme="dark"] .submit-buttons {
        border-top-color: #374151 !important;
    }

    [data-bs-theme="dark"] .btn-primary {
        background: #87CEEB !important;
    }

    [data-bs-theme="dark"] .btn-secondary {
        border-color: #6b7280 !important;
        color: #9ca3af !important;
    }


    /* Enhanced Submit Button Experience */
    .submit-buttons {
        position: relative;
        text-align: center;
        padding: 20px;
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        margin-top: 20px;
    }

    .submit-buttons::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 3px;
        background: #87CEEB;
        border-radius: 12px 12px 0 0;
    }

    /* Loading State for Submit Button */
    .btn-primary-modern.loading {
        position: relative;
        color: transparent;
        pointer-events: none;
    }

    .btn-primary-modern.loading::after {
        content: '';
        position: absolute;
        top: 50%;
        left: 50%;
        width: 16px;
        height: 16px;
        margin: -8px 0 0 -8px;
        border: 2px solid transparent;
        border-top: 2px solid #ffffff;
        border-radius: 50%;
    }


    /* Form Field Focus Indicators */
    .form-group {
        position: relative;
    }

    .form-group::after {
        content: '';
        position: absolute;
        bottom: 0;
        left: 0;
        width: 0;
        height: 2px;
        background: #667eea;
    }

    .form-group:focus-within::after {
        width: 100%;
    }

    /* Tooltip Enhancement */
    .form-label[title] {
        position: relative;
        cursor: help;
    }

    .form-label[title]:hover::after {
        content: attr(title);
        position: absolute;
        bottom: 100%;
        left: 0;
        background: #1f2937;
        color: white;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 10px;
        white-space: nowrap;
        z-index: 1000;
    }


    [data-bs-theme="dark"] .application-photo-section {
        background-color: #374151 !important;
        border-color: #4b5563 !important;
    }

    [data-bs-theme="dark"] .photo-mode-toggle {
        background: #4b5563 !important;
        border-color: #6b7280 !important;
    }

    [data-bs-theme="dark"] .mode-btn {
        color: #9ca3af !important;
    }

    [data-bs-theme="dark"] .mode-btn.active {
        background: #4f46e5 !important;
        color: white !important;
    }


    [data-bs-theme="dark"] .application-photo-upload {
        background-color: #4b5563 !important;
        border-color: #6b7280 !important;
    }


    [data-bs-theme="dark"] .camera-video {
        border-color: #6b7280 !important;
        background: #6b7280 !important;
    }

    [data-bs-theme="dark"] .camera-btn-start {
        background: #4f46e5 !important;
    }


    [data-bs-theme="dark"] .camera-error {
        background: #1f2937 !important;
        color: #ef4444 !important;
        border: 1px solid #7f1d1d !important;
    }

    [data-bs-theme="dark"] .photo-requirements {
        background: #374151 !important;
    }

    [data-bs-theme="dark"] .placeholder-content span {
        color: #e5e7eb !important;
    }

    /* Compact Required Field Indicator */
    .required-field {
        color: #ef4444;
        font-weight: normal;
        font-size: 12px;
    }

    /* Additional Compact Styles */
    .form-group {
        margin-bottom: 8px;
    }

    .back-button-container {
        margin-bottom: 8px;
    }

    .back-button-container .btn {
        padding: 4px 8px;
        font-size: 11px;
    }

    /* Compact input groups */
    .input-group-compact {
        margin-bottom: 6px;
    }

    /* Ultra Compact spacing for all form elements */
    .mb-3,
    .mb-2 {
        margin-bottom: 4px !important;
    }

    .mb-1 {
        margin-bottom: 2px !important;
    }
    
    /* Compact form groups */
    .form-group {
        margin-bottom: 4px !important;
    }
    
    /* Compact rows */
    .row {
        margin-bottom: 4px !important;
    }

    /* Ultra Compact photo upload area */
    .application-photo-upload {
        min-height: 150px !important;
        padding: 6px !important;
    }
    
    .application-photo-section {
        padding: 8px !important;
    }

    /* Compact Submit Section */
    .submit-buttons {
        margin-top: 12px;
        padding: 8px 0;
        text-align: center;
        background: transparent;
    }

    /* Classic Compact Grid */
    .form-grid-compact {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 8px;
    }

    /* Classic Input Groups */
    .input-group-compact {
        margin-bottom: 6px;
    }
    
    /* Global Compact Overrides */
    .container-fluid {
        padding: 8px !important;
    }
    
    /* Remove icons from labels for ultra minimal look */
    .form-label i {
        display: none !important;
    }
    
    /* Compact date picker */
    .date-input-container {
        margin-bottom: 4px !important;
    }
    
    .date-picker-calendar {
        padding: 8px !important;
    }
    
    /* Compact textarea */
    textarea.form-control {
        min-height: 45px !important;
        resize: vertical;
    }

    /* Ultra Compact Add Document Button */
    .add-document-btn {
        background: #d7dadb;
        color: black;
        border: 1px solid #c5c6c7;
        border-radius: 6px;
        padding: 4px 8px;
        font-size: 11px;
        font-weight: 500;
        cursor: pointer;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 3px;
        box-shadow: none;
        text-transform: uppercase;
        letter-spacing: 0.3px;
    }


    .add-document-btn:focus {
        outline: none;
        box-shadow: 0 0 0 2px rgba(107, 114, 128, 0.3);
    }
    
    .add-document-btn:hover {
        background: #c5c6c7;
        transform: none;
    }

    /* Ultra Compact Remove Document Button */
    .remove-document-btn {
        background: #ef4444;
        color: white;
        border: none;
        border-radius: 3px;
        padding: 4px 8px;
        font-size: 9px;
        font-weight: 500;
        cursor: pointer;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 3px;
        text-transform: uppercase;
        letter-spacing: 0.3px;
    }
    
    .remove-document-btn:hover {
        background: #dc2626;
        transform: none;
    }


    /* Document Form Cards - 2 Column Layout */
    .document-form-card {
            overflow: hidden;
    }


    .document-header {
        border-bottom: 1px solid #e2e8f0;
    }

    .document-icon {
        width: 28px;
        height: 28px;
        border-radius: 6px;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 1px 4px rgba(0, 0, 0, 0.1);
    }

    .document-body {
    }

    /* Document Delete Styles */
    .document-delete-section {
        position: relative;
    }

    .delete-confirmation {
        position: absolute;
        top: 100%;
        right: 0;
        z-index: 1000;
        min-width: 250px;
        background: white;
        border: 1px solid #dee2e6;
        border-radius: 6px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        padding: 8px;
    }

    .document-marked-for-deletion {
        border: 2px dashed #ef4444 !important;
    }

    .document-marked-for-deletion .document-header {
        background: #fef2f2 !important;
    }

    /* Notification styles */
    #delete-notification {
        
    }

    /* Document Preview Section (Left Column) */
    .document-preview-section {
        padding: 1rem;
        border-radius: 8px;
        height: 100%;
    }

    .document-preview-section .form-label {
        display: block;
        margin-bottom: 0.5rem;
        font-weight: 600;
        font-size: 0.875rem;
        line-height: 1.25;
    }

    .document-preview-section .form-label.fw-semibold.mb-2 {
        border-bottom: 1px solid #e2e8f0;
        padding-bottom: 0.75rem;
        margin-bottom: 1.5rem;
        font-size: 1rem;
    }

    .current-document-preview img {
            border: 2px solid #e2e8f0;
    }


    .pdf-preview-card {
        }


    .image-preview-card img {
        }


    .no-preview-placeholder {
        background: #f9fafb !important;
        border: 2px dashed #d1d5db !important;
        }


    /* Document Information Section (Right Column) */
    .document-info-section {
        padding: 1rem;
        border-radius: 8px;
        height: 100%;
    }

    /* Improved label and input alignment */
    .document-info-section .form-label {
        display: block;
        margin-bottom: 8px;
        font-weight: 600;
        font-size: 11px;
        line-height: 1.25;
        text-transform: uppercase;
        letter-spacing: 0.3px;
        color: #374151;
    }

    .document-info-section .form-control,
    .document-info-section .form-select {
        font-size: 13px;
        padding: 10px 12px;
        border-radius: 4px;
        border: 1px solid #e5e7eb;
        width: 100%;
        background-color: #ffffff;
        line-height: 1.4;
        min-height: 36px;
        margin-bottom: 16px;
    }

    .document-info-section .form-control:focus,
    .document-info-section .form-select:focus {
        border-color: #87CEEB;
        box-shadow: 0 0 0 2px rgba(135, 206, 235, 0.1);
        outline: none;
    }

    .document-info-section textarea.form-control {
        min-height: 80px;
        resize: vertical;
        padding: 10px 12px;
        line-height: 1.4;
    }

    /* Form group spacing for better alignment */
    .document-info-section .mb-3 {
        margin-bottom: 1.5rem;
    }

    .document-info-section .mb-0 {
        margin-bottom: 0;
    }

    /* Error message styling */
    .document-info-section .text-danger {
        margin-top: 0.25rem;
        font-size: 0.75rem;
        line-height: 1.25;
    }

    /* Row spacing adjustments */
    .document-info-section .row.g-2 {
        --bs-gutter-x: 0.75rem;
        --bs-gutter-y: 0;
    }

    /* Consistent spacing for form elements */
    .document-info-section>*:not(:last-child) {
        margin-bottom: 1.5rem;
    }

    .document-info-section>*:last-child {
        margin-bottom: 0;
    }

    /* Additional alignment improvements */
    .document-info-section .col-md-6 {
        display: flex;
        flex-direction: column;
    }

    .document-info-section .col-md-6 .form-label {
        flex-shrink: 0;
    }

    .document-info-section .col-md-6 .form-control,
    .document-info-section .col-md-6 .form-select {
        flex-grow: 1;
    }

    /* Ensure consistent height for side-by-side inputs */
    .document-info-section .row .col-md-6 {
        align-items: stretch;
    }

    /* Better visual hierarchy */
    .document-info-section>.form-label.fw-semibold.mb-3 {
        border-bottom: 1px solid #e2e8f0;
        padding-bottom: 0.75rem;
        margin-bottom: 1.5rem;
        font-size: 1rem;
    }

    /* Form field grouping */
    .document-info-section .form-group {
        margin-bottom: 1.5rem;
    }

    .document-info-section .form-group:last-child {
        margin-bottom: 0;
    }

    /* Input focus states */
    .document-info-section .form-control:focus,
    .document-info-section .form-select:focus {
        border-color: #3b82f6;
        box-shadow: 0 0 0 3px rgba(0, 0, 0, 0.1);
        background-color: #ffffff;
    }

    /* Placeholder styling */
    .document-info-section .form-control::placeholder {
        color: #9ca3af;
        opacity: 1;
    }

    /* Required field indicator */
    .document-info-section .form-label .required {
        margin-left: 0.25rem;
    }

    /* File Upload Styling */
    .document-preview-section input[type="file"] {
        font-size: 0.875rem;
        padding: 0.5rem;
        border: 2px dashed #d1d5db;
        border-radius: 6px;
        }


    .document-preview-section input[type="file"]:focus {
        outline: none;
        border-color: #3b82f6;
        box-shadow: 0 0 0 3px rgba(0, 0, 0, 0.1);
    }

    /* Document Modal */
    .document-modal {
        display: none;
        position: fixed;
        z-index: 1050;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.8);
        backdrop-filter: blur(4px);
    }

    .document-modal-content {
        position: relative;
        margin: 5% auto;
        padding: 0;
        width: 90%;
        max-width: 800px;
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 25px 50px rgba(0, 0, 0, 0.3);
    }


    .document-modal-header {
        padding: 1.5rem;
        background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
        color: white;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .document-modal-title {
        margin: 0;
        font-size: 1.25rem;
        font-weight: 600;
    }

    .document-modal-close {
        background: none;
        border: none;
        color: white;
        font-size: 1.5rem;
        cursor: pointer;
        padding: 0;
        width: 30px;
        height: 30px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        }


    .document-modal-body {
        padding: 0;
        text-align: center;
        max-height: 70vh;
        overflow: auto;
    }

    .document-modal-image {
        width: 100%;
        height: auto;
        display: block;
    }

    /* Mobile Responsive */
    @media (max-width: 768px) {

        .document-body .col-md-4,
        .document-body .col-md-8 {
            flex: 0 0 100%;
            max-width: 100%;
        }

        .document-form-card {
            margin-bottom: 1rem;
        }

        .document-header {
            padding: 0.375rem 0.5rem;
        }

        .document-preview-section,
        .document-info-section {
            padding: 0.75rem;
            margin-bottom: 1rem;
        }

        /* Mobile adjustments for form elements */
        .document-info-section .form-control,
        .document-info-section .form-select {
            font-size: 16px;
            /* Prevents zoom on iOS */
            padding: 12px 14px;
            border: 1px solid #e5e7eb;
            margin-bottom: 16px;
            min-height: 48px;
        }

        .document-info-section .form-label {
            font-size: 12px;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.3px;
            color: #374151;
        }

        .document-info-section .form-control:focus,
        .document-info-section .form-select:focus {
            border-color: #87CEEB;
            box-shadow: 0 0 0 2px rgba(135, 206, 235, 0.1);
            outline: none;
        }

        .document-modal-content {
            width: 95%;
            margin: 10% auto;
        }

        .document-modal-header {
            padding: 1rem;
        }

        .document-modal-title {
            font-size: 1rem;
        }
    }

    /* Page Title Area */
    .page-title-area {
        border-bottom: 3px solid var(--classic-blue);
        margin-bottom: 16px;
        padding-bottom: 8px;
    }

    /* Print Styles */
    @media print {

        .application-header,
        .form-section {
            break-inside: avoid;
        }

        .btn,
        .camera-section,
        .photo-mode-toggle {
            display: none !important;
        }

        .form-section {
            border: 1px solid #000 !important;
            margin-bottom: 8px !important;
        }

        .form-section h4 {
            background: #f0f0f0 !important;
            color: #000 !important;
            border-bottom: 1px solid #000 !important;
        }
    }

    /* OCR Document Scanner Styles */
    .document-type-tab-compact {
        font-size: 11px;
        padding: 4px 8px;
    }

    .document-type-tab-compact.active {
        background: #667eea;
        color: white;
        border-color: #87CEEB;
    }

    .status-item {
        font-size: 10px;
        color: #9ca3af;
        }

    .status-item.active {
        font-weight: 600;
    }

    .status-item.completed {
        color: #10b981;
        font-weight: 600;
    }

    .field-value {
        font-family: monospace;
        font-size: 11px;
        word-break: break-word;
    }

    #passportDropZone {
            min-height: 120px;
        display: flex;
        align-items: center;
        justify-content: center;
    }


    #passportDropZone.dragover {
        border-color: #667eea !important;
        background-color: #f0f4ff;
    }

    #dropZoneIcon {
        font-size: 2rem;
    }

    #imagePreview img {
        border: 2px solid #e5e7eb;
        border-radius: 8px;
    }

    /* Enhanced Date Picker Styles */
    .date-input-container {
        position: relative;
        display: inline-block;
        width: 100%;
    }

    .date-input-wrapper {
        position: relative;
        display: flex;
        align-items: center;
    }

    .date-input-enhanced {
        width: 100%;
        padding-right: 35px !important;
        cursor: pointer;
    }

    .date-calendar-icon {
        position: absolute;
        right: 10px;
        top: 50%;
        color: #6b7280;
        font-size: 14px;
        pointer-events: none;
        z-index: 2;
    }

    .date-picker-calendar {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: white;
        border: 1px solid #ddd;
        border-radius: 8px;
        z-index: 1000;
        padding: 16px;
        margin-top: 4px;
        display: none;
        min-width: 280px;
    }

    .date-picker-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 16px;
        padding-bottom: 12px;
        border-bottom: 1px solid #f3f4f6;
        gap: 8px;
    }

    .date-picker-nav-btn {
        background: white;
        border: 1px solid #ddd;
        border-radius: 6px;
        width: 32px;
        height: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        font-size: 12px;
    }

    }

    .date-picker-month-year {
        font-weight: 600;
        font-size: 14px;
        display: flex;
        align-items: center;
        gap: 8px;
        flex: 1;
        justify-content: center;
    }

    .date-picker-select {
        background: white;
        border: 1px solid #ddd;
        border-radius: 6px;
        padding: 4px 8px;
        font-size: 12px;
        cursor: pointer;
        min-width: 80px;
    }

    }

    .date-picker-select:focus {
        outline: none;
        border-color: #3b82f6;
        box-shadow: 0 0 0 2px rgba(0, 0, 0, 0.1);
    }

    .date-picker-year-select {
        min-width: 70px;
    }

    .date-picker-month-select {
        min-width: 90px;
    }

    .date-picker-grid {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 4px;
    }

    .date-picker-day-header {
        text-align: center;
        font-size: 11px;
        font-weight: 600;
        color: #6b7280;
        padding: 8px 4px;
        text-transform: uppercase;
    }

    .date-picker-day {
        background: white;
        border: 1px solid #eee;
        width: 32px;
        height: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 12px;
        cursor: pointer;
        border-radius: 6px;
    }

        border-color: #e5e7eb;
    }

    .date-picker-day.selected {
        background: #87CEEB;
        color: white;
        border-color: #2563eb;
    }

    .date-picker-day.today {
        background: #dbeafe;
        border-color: #3b82f6;
        color: #1e40af;
        font-weight: 600;
    }

    .date-picker-day.selected.today {
        background: #2563eb;
        color: white;
    }

    .date-picker-day.other-month {
        color: #d1d5db;
    }

    .date-picker-day.disabled {
        color: #d1d5db;
        cursor: not-allowed;
        background: transparent;
    }

    .date-picker-day.disabled:hover {
        background: transparent;
        border-color: transparent;
    }

    .date-picker-footer {
        margin-top: 12px;
        padding-top: 12px;
        border-top: 1px solid #f3f4f6;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .date-picker-today-btn {
        background: white;
        border: 1px solid #ddd;
        border-radius: 6px;
        padding: 6px 12px;
        font-size: 11px;
        cursor: pointer;
    }

    .date-picker-today-btn:hover {
    }

    .date-picker-clear-btn {
        background: white;
        border: 1px solid #ddd;
        border-radius: 6px;
        padding: 6px 12px;
        font-size: 11px;
        cursor: pointer;
    }

    .date-picker-clear-btn:hover {
    }









today-btn {
        border-color: #4b5563;
        color: #e5e7eb;
    }

today-btn:hover {
        background: #374151;
        border-color: #6b7280;
    }

clear-btn {
        border-color: #ef4444;
        color: #f87171;
    }

clear-btn:hover {
        background: #1f2937;
        border-color: #dc2626;
    }

    /* Mobile responsiveness */
    @media (max-width: 768px) {
        .application-header {
            padding: 16px;
        }

        .application-header h1 {
            font-size: 20px;
        }

        .form-section {
            padding: 12px;
        }

        .progress-indicator {
            padding: 0 10px;
        }

        .progress-step {
            font-size: 0.75rem;
            padding: 0.75rem 0.25rem;
        }

        .progress-step i {
            font-size: 1rem;
        }

        .status-header {
            flex-direction: column;
            align-items: flex-start;
        }

        .status-details {
            flex-direction: column;
            gap: 0.75rem;
        }

        .status-card {
            padding: 1rem;
        }

        .submit-section {
            margin-top: 1rem;
            padding: 1.5rem;
        }

        .submit-actions {
            flex-direction: column;
            gap: 0.75rem;
        }

        .submit-note {
            font-size: 0.75rem;
        }

        .application-photo-section {
            position: static;
            margin-top: 12px;
        }

        .application-photo-upload {
            min-height: 150px !important;
            padding: 12px;
        }

        .application-photo-current,
        .application-photo-preview {
            width: 80px;
            height: 100px;
        }

        .camera-video {
            max-width: 150px;
            height: 120px;
        }

        .camera-controls {
            gap: 6px;
        }

        .camera-btn {
            padding: 4px 8px;
            font-size: 10px;
        }

        .mode-btn {
            padding: 4px 8px;
            font-size: 10px;
        }

        .date-picker-calendar {
            min-width: 260px;
            padding: 12px;
        }

        .date-picker-day {
            width: 28px;
            height: 28px;
            font-size: 11px;
        }

        .date-picker-nav-btn {
            width: 28px;
            height: 28px;
            font-size: 11px;
        }
    }

    /* Additional Form Enhancements */
    .form-group {
        margin-bottom: 1.5rem;
        position: relative;
    }

    .form-group:last-child {
        margin-bottom: 0;
    }

    /* Row spacing improvements */
    .row.g-1 {
        --bs-gutter-x: 1rem;
        --bs-gutter-y: 1rem;
    }

    /* Error message styling */
    .text-danger {
        font-size: 0.75rem;
        margin-top: 0.25rem;
        font-weight: 500;
        display: flex;
        align-items: center;
        gap: 0.25rem;
    }

    .text-danger::before {
        content: '';
    }

    /* Success message styling */
    .alert-success {
        background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
        border: 1px solid #000000;
        color: #065f46;
        border-radius: var(--radius-md);
        padding: 1rem;
        margin-bottom: 1.5rem;
    }

    /* Loading states */
    .btn.loading {
        position: relative;
        color: transparent;
    }

    .btn.loading::after {
        content: '';
        position: absolute;
        width: 16px;
        height: 16px;
        top: 50%;
        left: 50%;
        margin-left: -8px;
        margin-top: -8px;
        border: 2px solid transparent;
        border-top-color: currentColor;
        border-radius: 50%;
    }



    /* Focus ring for accessibility */
    *:focus {
        outline: 2px solid #000000;
        outline-offset: 2px;
    }

    .form-control:focus,
    .form-select:focus,
    .btn:focus {
        outline: none;
    }
</style>
{% endblock %}

{% block content %}

<div class="p-3 w-full">
    <div class="w-full ">

        <div class="mt-3 {% if employee %} edit-mode{% endif %} ">
            <form method="post" enctype="multipart/form-data" novalidate>
                {% csrf_token %}

                <div class="grid grid-cols-3 gap-4 w-full">
                    <!-- Personal Information -->
                    <div class="col-span-2 rounded-lg border border-gray-200 ">
                        <div class="border-b border-gray-200 py-2 px-3 bg-gray-50 rounded-t-lg">
                            <h4 class="text-[16px] font-semibold"><i class="fa fa-user me-2"></i>Personal Information</h4>
                        </div>
                        <div class="p-3">
                            <div class="row g-1">
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="{{ form.first_name.id_for_label }}" class="form-label">
                                            First Name <span class="required-field">*</span>
                                        </label>
                                        {{ form.first_name }}
                                        {% if form.first_name.errors %}
                                        <div class="text-danger">
                                            {% for error in form.first_name.errors %}{{ error }}{% endfor %}
                                        </div>
                                        {% endif %}
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="{{ form.last_name.id_for_label }}" class="form-label">
                                            Last Name <span class="required-field">*</span>
                                        </label>
                                        {{ form.last_name }}
                                        {% if form.last_name.errors %}
                                        <div class="text-danger">
                                            {% for error in form.last_name.errors %}{{ error }}{% endfor %}
                                        </div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                            <div class="row g-1">
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="{{ form.gender.id_for_label }}" class="form-label">
                                            Gender <span class="required-field">*</span>
                                        </label>
                                        {{ form.gender }}
                                        {% if form.gender.errors %}
                                        <div class="text-danger">
                                            {% for error in form.gender.errors %}{{ error }}{% endfor %}
                                        </div>
                                        {% endif %}
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="{{ form.date_of_birth.id_for_label }}" class="form-label">
                                            <i class="bi bi-calendar text-muted me-1"></i>
                                            Date of Birth <span class="required-field">*</span>
                                        </label>
                                        <div class="date-input-container">
                                            <div class="date-input-wrapper">
                                                <input type="text" id="{{ form.date_of_birth.id_for_label }}"
                                                    class="form-control date-input-enhanced"
                                                    placeholder="Select date of birth"
                                                    value="{% if form.date_of_birth.value %}{{ form.date_of_birth.value|date:'j/M/Y' }}{% endif %}"
                                                    readonly>
                                                <i class="bi bi-calendar3 date-calendar-icon -mt-3"></i>
                                            </div>
                                            <div class="date-picker-calendar"
                                                id="date-picker-{{ form.date_of_birth.id_for_label }}">
                                                <div class="date-picker-header">
                                                    <button type="button" class="date-picker-nav-btn"
                                                        onclick="navigateMonth('{{ form.date_of_birth.id_for_label }}', -1)">
                                                        <i class="bi bi-chevron-left"></i>
                                                    </button>
                                                    <div class="date-picker-month-year">
                                                        <select class="date-picker-select date-picker-month-select"
                                                            id="month-select-{{ form.date_of_birth.id_for_label }}"
                                                            onchange="changeMonthYear('{{ form.date_of_birth.id_for_label }}')">
                                                            <!-- Options populated by JavaScript -->
                                                        </select>
                                                        <select class="date-picker-select date-picker-year-select"
                                                            id="year-select-{{ form.date_of_birth.id_for_label }}"
                                                            onchange="changeMonthYear('{{ form.date_of_birth.id_for_label }}')">
                                                            <!-- Options populated by JavaScript -->
                                                        </select>
                                                    </div>
                                                    <button type="button" class="date-picker-nav-btn"
                                                        onclick="navigateMonth('{{ form.date_of_birth.id_for_label }}', 1)">
                                                        <i class="bi bi-chevron-right"></i>
                                                    </button>
                                                </div>
                                                <div class="date-picker-grid"
                                                    id="calendar-grid-{{ form.date_of_birth.id_for_label }}"></div>
                                                <div class="date-picker-footer">
                                                    <button type="button" class="date-picker-today-btn"
                                                        onclick="selectToday('{{ form.date_of_birth.id_for_label }}')">Today</button>
                                                    <button type="button" class="date-picker-clear-btn"
                                                        onclick="clearDate('{{ form.date_of_birth.id_for_label }}')">Clear</button>
                                                </div>
                                            </div>
                                            <!-- Hidden input to store the actual date value for form submission -->
                                            <input type="hidden" id="{{ form.date_of_birth.id_for_label }}_hidden"
                                                name="{{ form.date_of_birth.html_name }}"
                                                value="{% if form.date_of_birth.value %}{{ form.date_of_birth.value|date:'Y-m-d' }}{% endif %}">
                                        </div>
                                        {% if form.date_of_birth.errors %}
                                        <div class="text-danger">
                                            {% for error in form.date_of_birth.errors %}{{ error }}{% endfor %}
                                        </div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>

                            <div class="row g-1">
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="{{ form.nationality.id_for_label }}" class="form-label">
                                            <i class="bi bi-flag text-muted me-1"></i>
                                            Nationality <span class="required-field">*</span>
                                        </label>
                                        {{ form.nationality }}
                                        {% if form.nationality.errors %}
                                        <div class="text-danger">
                                            {% for error in form.nationality.errors %}{{ error }}{% endfor %}
                                        </div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>

                        </div>

                    </div>
                    <!-- Personal Information -->
                    <!-- Camer and Photo -->
                    <div class="col-span-1 rounded-lg border border-gray-200 h-auto relative">
                        <div class="border-b border-gray-200 py-2 px-3 bg-gray-50 rounded-t-lg">
                            <h4 class="text-[16px] font-semibold"><i class="fa fa-camera me-2"></i>Photo</h4>
                        </div>
                        <div class="p-1">
                            <div class="application-photo-section border-none" style="border:none !important;">
                                
                                <!--<div class="photo-mode-toggle">
                                    <button type="button" class="mode-btn" id="file-mode-btn" onclick="switchToFile()">
                                        <i class="bi bi-upload"></i> File
                                    </button>
                                    <button type="button" class="mode-btn active" id="camera-mode-btn"
                                        onclick="switchToCamera()">
                                        <i class="bi bi-camera"></i> Camera
                                    </button>
                                </div>-->

                                <!-- File Upload Mode -->
                                <div class="application-photo-upload" id="file-upload-area"
                                    onclick="document.getElementById('{{ form.photo.id_for_label }}').click();"
                                   >
                                    {% if employee and employee.photo %}
                                    <div class="current-photo-display" id="current-photo-display">
                                        <img src="{{ employee.photo_url }}" alt="Current photo"
                                            class="application-photo-current" id="current-photo-img">
                                        <div class="photo-overlay">
                                            <i class="bi bi-pencil"></i>
                                            <small>Click to change</small>
                                        </div>
                                    </div>
                                    {% else %}
                                    <div class="photo-placeholder" id="photo-placeholder">
                                        <div class="placeholder-content">
                                            <i class="bi bi-person-plus"></i>
                                            <span>Upload Photo</span>
                                            <small>Click here</small>
                                        </div>
                                    </div>
                                    {% endif %}
                                    <div class="photo-preview" id="photo-preview" style="display: none;">
                                        <img id="photo-preview-img" class="application-photo-preview">
                                        <div class="photo-overlay">
                                            <i class="bi bi-check-circle text-success"></i>
                                            <small>Photo selected</small>
                                        </div>
                                    </div>
                                </div>

                                <!-- Camera Mode -->
                                <div class="application-photo-upload" id="camera-upload-area" style="display:none !important;">
                                    <div class="camera-container" id="camera-container">
                                        <video id="camera-video" class="camera-video" autoplay muted playsinline
                                            style="display: none;"></video>
                                        <canvas id="camera-canvas" style="display: none;"></canvas>

                                        <div class="camera-controls" id="camera-controls">
                                            <button type="button" class="camera-btn camera-btn-start"
                                                id="start-camera-btn" onclick="startCamera()">
                                                <i class="bi bi-camera-video"></i> Start Camera
                                            </button>
                                            <button type="button" class="camera-btn camera-btn-capture" id="capture-btn"
                                                onclick="capturePhoto()" style="display: none;">
                                                <i class="bi bi-camera"></i> Capture
                                            </button>
                                            <button type="button" class="camera-btn camera-btn-stop"
                                                id="stop-camera-btn" onclick="stopCamera()" style="display: none;">
                                                <i class="bi bi-camera-video-off"></i> Stop
                                            </button>
                                            <button type="button" class="camera-btn camera-btn-start"
                                                id="retake-camera-btn" onclick="startCamera()" style="display: none;">
                                                <i class="bi bi-arrow-clockwise"></i> Retake Photo
                                            </button>
                                        </div>

                                        <div class="camera-status" id="camera-status">Click "Start Camera" to begin
                                        </div>
                                        <div class="camera-error" id="camera-error" style="display: none;"></div>

                                        <!-- Captured photo preview -->
                                        <div class="photo-preview" id="camera-photo-preview" style="display: none;">
                                            <img id="camera-photo-preview-img" class="application-photo-preview">
                                            <div class="photo-overlay">
                                                <i class="bi bi-check-circle text-success"></i>
                                                <small>Photo captured</small>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="photo-requirements">
                                    <small class="text-muted">
                                        <i class="bi bi-info-circle me-1"></i>
                                        JPG, PNG, GIF, BMP<br>
                                        Max size: 5MB
                                    </small>
                                </div>

                                <!-- Hide the default Django file widget since we have our custom photo display -->
                                <div style="display: none;">
                                    {{ form.photo }}
                                </div>
                                {% if form.photo.errors %}
                                <div class="text-danger mt-1">
                                    {% for error in form.photo.errors %}{{ error }}{% endfor %}
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    <!-- Camer and Photo -->
                </div>

                <!--Contact Information-->
                <div class=" rounded-lg border border-gray-200 mt-4">
                    <div class="border-b border-gray-200 py-2 px-3 bg-gray-50">
                        <h4 class="text-[16px] font-semibold"><i class="fa fa-phone me-2"></i>Contact Information</h4>
                    </div>
                    <div class="p-3">
                        <div class="row g-1">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="{{ form.email.id_for_label }}" class="form-label">
                                        <i class="bi bi-envelope text-muted me-1"></i>
                                        Email Address <span class="required-field">*</span>
                                    </label>
                                    {{ form.email }}
                                    {% if form.email.errors %}
                                    <div class="text-danger">
                                        {% for error in form.email.errors %}{{ error }}{% endfor %}
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="{{ form.phone_number.id_for_label }}" class="form-label">
                                        <i class="bi bi-telephone text-muted me-1"></i>
                                        Phone Number
                                    </label>
                                    {{ form.phone_number }}
                                    {% if form.phone_number.errors %}
                                    <div class="text-danger">
                                        {% for error in form.phone_number.errors %}{{ error }}{% endfor %}
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-md-12">
                                <div class="form-group">
                                    <label for="{{ form.address.id_for_label }}" class="form-label">
                                        <i class="bi bi-geo-alt text-muted me-1"></i>
                                        Address <span class="required-field">*</span>
                                    </label>
                                    {{ form.address }}
                                    {% if form.address.errors %}
                                    <div class="text-danger">
                                        {% for error in form.address.errors %}{{ error }}{% endfor %}
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                 <!--Contact Information-->
                <!--Employment Identification-->
                <div class=" rounded-lg border border-gray-200 mt-4">
                    <div class="border-b border-gray-200 py-2 px-3">
                        <h4 class="text-[16px] font-semibold"><i class="fa fa-credit-card me-2"></i>Identification</h4>
                    </div>
                    <div class="p-3">
                        <div class="row g-1">
                            <div class="col-md-12">
                                <div class="form-group">
                                    <label for="{{ form.employee_id.id_for_label }}" class="form-label">
                                        <i class="bi bi-badge-id text-muted me-1"></i>
                                        Employee ID <small class="text-muted">(auto-generated if blank)</small>
                                    </label>
                                    {{ form.employee_id }}
                                    {% if form.employee_id.errors %}
                                    <div class="text-danger">
                                        {% for error in form.employee_id.errors %}{{ error }}{% endfor %}
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <!--Employment Identification-->

                <!--Employment Information -->
                <div class="rounded-lg border border-gray-200 mt-4">
                    <div class="border-b border-gray-200 py-2 px-3">
                      <h4 class="text-[16px] font-semibold">
                        <i class="fa fa-briefcase me-2"></i>Employment Information
                      </h4>
                    </div>
                    <div class="p-3">
                        
                        <div class="row g-1">
                            <div class="col-md-3">
                                <div class="form-group">
                                    <label for="{{ form.department.id_for_label }}" class="form-label">
                                        Department
                                    </label>
                                    {{ form.department }}
                                    {% if form.department.errors %}
                                    <div class="text-danger">
                                        {% for error in form.department.errors %}{{ error }}{% endfor %}
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="form-group">
                                    <label for="{{ form.position.id_for_label }}" class="form-label">
                                        Position
                                    </label>
                                    {{ form.position }}
                                    {% if form.position.errors %}
                                    <div class="text-danger">
                                        {% for error in form.position.errors %}{{ error }}{% endfor %}
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="form-group">
                                    <label for="{{ form.branch.id_for_label }}" class="form-label">
                                        Branch
                                    </label>
                                    {{ form.branch }}
                                    {% if form.branch.errors %}
                                    <div class="text-danger">
                                        {% for error in form.branch.errors %}{{ error }}{% endfor %}
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="form-group">
                                    <label for="{{ form.employment_status.id_for_label }}" class="form-label">
                                        Employment Status <span class="required-field">*</span>
                                    </label>
                                    {{ form.employment_status }}
                                    {% if form.employment_status.errors %}
                                    <div class="text-danger">
                                        {% for error in form.employment_status.errors %}{{ error }}{% endfor %}
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="form-group">
                                    <label for="{{ form.work_type.id_for_label }}" class="form-label">
                                        Work Type <span class="required-field">*</span>
                                    </label>
                                    {{ form.work_type }}
                                    {% if form.work_type.errors %}
                                    <div class="text-danger">
                                        {% for error in form.work_type.errors %}{{ error }}{% endfor %}
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        <div class="row g-1 mt-3">
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label for="{{ form.hire_date.id_for_label }}" class="form-label">
                                        <i class="bi bi-calendar-plus text-muted me-1"></i>
                                        Hire Date <span class="required-field">*</span>
                                    </label>
                                    <div class="date-input-container">
                                        <div class="date-input-wrapper">
                                            <input type="text" id="{{ form.hire_date.id_for_label }}"
                                                class="form-control date-input-enhanced" placeholder="Select hire date"
                                                value="{% if form.hire_date.value %}{{ form.hire_date.value|date:'j/M/Y' }}{% endif %}"
                                                readonly>
                                            <i class="bi bi-calendar3 date-calendar-icon -mt-3"></i>
                                        </div>
                                        <div class="date-picker-calendar"
                                            id="date-picker-{{ form.hire_date.id_for_label }}">
                                            <div class="date-picker-header">
                                                <button type="button" class="date-picker-nav-btn"
                                                    onclick="navigateMonth('{{ form.hire_date.id_for_label }}', -1)">
                                                    <i class="bi bi-chevron-left"></i>
                                                </button>
                                                <div class="date-picker-month-year">
                                                    <select class="date-picker-select date-picker-month-select"
                                                        id="month-select-{{ form.hire_date.id_for_label }}"
                                                        onchange="changeMonthYear('{{ form.hire_date.id_for_label }}')">
                                                        <!-- Options populated by JavaScript -->
                                                    </select>
                                                    <select class="date-picker-select date-picker-year-select"
                                                        id="year-select-{{ form.hire_date.id_for_label }}"
                                                        onchange="changeMonthYear('{{ form.hire_date.id_for_label }}')">
                                                        <!-- Options populated by JavaScript -->
                                                    </select>
                                                </div>
                                                <button type="button" class="date-picker-nav-btn"
                                                    onclick="navigateMonth('{{ form.hire_date.id_for_label }}', 1)">
                                                    <i class="bi bi-chevron-right"></i>
                                                </button>
                                            </div>
                                            <div class="date-picker-grid"
                                                id="calendar-grid-{{ form.hire_date.id_for_label }}"></div>
                                            <div class="date-picker-footer">
                                                <button type="button" class="date-picker-today-btn"
                                                    onclick="selectToday('{{ form.hire_date.id_for_label }}')">Today</button>
                                                <button type="button" class="date-picker-clear-btn"
                                                    onclick="clearDate('{{ form.hire_date.id_for_label }}')">Clear</button>
                                            </div>
                                        </div>
                                        <!-- Hidden input to store the actual date value for form submission -->
                                        <input type="hidden" id="{{ form.hire_date.id_for_label }}_hidden"
                                            name="{{ form.hire_date.html_name }}" value="{% if form.hire_date.value %}{{ form.hire_date.value|date:'Y-m-d' }}{% endif %}">
                                    </div>
                                    {% if form.hire_date.errors %}
                                    <div class="text-danger">
                                        {% for error in form.hire_date.errors %}{{ error }}{% endfor %}
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label for="{{ form.end_date.id_for_label }}" class="form-label">
                                        <i class="bi bi-calendar-minus text-muted me-1"></i>
                                        End Date
                                    </label>
                                    <div class="date-input-container">
                                        <div class="date-input-wrapper">
                                            <input type="text" id="{{ form.end_date.id_for_label }}"
                                                class="form-control date-input-enhanced"
                                                placeholder="Select end date (optional)"
                                                value="{% if form.end_date.value %}{{ form.end_date.value|date:'j/M/Y' }}{% endif %}"
                                                readonly>
                                            <i class="bi bi-calendar3 date-calendar-icon -mt-3"></i>
                                        </div>
                                        <div class="date-picker-calendar" id="date-picker-{{ form.end_date.id_for_label }}">
                                            <div class="date-picker-header">
                                                <button type="button" class="date-picker-nav-btn"
                                                    onclick="navigateMonth('{{ form.end_date.id_for_label }}', -1)">
                                                    <i class="bi bi-chevron-left"></i>
                                                </button>
                                                <div class="date-picker-month-year">
                                                    <select class="date-picker-select date-picker-month-select"
                                                        id="month-select-{{ form.end_date.id_for_label }}"
                                                        onchange="changeMonthYear('{{ form.end_date.id_for_label }}')">
                                                        <!-- Options populated by JavaScript -->
                                                    </select>
                                                    <select class="date-picker-select date-picker-year-select"
                                                        id="year-select-{{ form.end_date.id_for_label }}"
                                                        onchange="changeMonthYear('{{ form.end_date.id_for_label }}')">
                                                        <!-- Options populated by JavaScript -->
                                                    </select>
                                                </div>
                                                <button type="button" class="date-picker-nav-btn"
                                                    onclick="navigateMonth('{{ form.end_date.id_for_label }}', 1)">
                                                    <i class="bi bi-chevron-right"></i>
                                                </button>
                                            </div>
                                            <div class="date-picker-grid"
                                                id="calendar-grid-{{ form.end_date.id_for_label }}"></div>
                                            <div class="date-picker-footer">
                                                <button type="button" class="date-picker-today-btn"
                                                    onclick="selectToday('{{ form.end_date.id_for_label }}')">Today</button>
                                                <button type="button" class="date-picker-clear-btn"
                                                    onclick="clearDate('{{ form.end_date.id_for_label }}')">Clear</button>
                                            </div>
                                        </div>
                                        <!-- Hidden input to store the actual date value for form submission -->
                                        <input type="hidden" id="{{ form.end_date.id_for_label }}_hidden"
                                            name="{{ form.end_date.html_name }}" value="{% if form.end_date.value %}{{ form.end_date.value|date:'Y-m-d' }}{% endif %}">
                                    </div>
                                    {% if form.end_date.errors %}
                                    <div class="text-danger">
                                        {% for error in form.end_date.errors %}{{ error }}{% endfor %}
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                  <!--Employment Information -->

                <!-- User Account Section -->
                <div class="rounded-lg border border-gray-200 mt-4">
                    <div class="border-b border-gray-200 py-2 px-3 bg-gray-50 rounded-t-lg">
                        <h4 class="text-[16px] font-semibold">
                            <i class="fa fa-user-lock me-2"></i>User Account & Login
                        </h4>
                    </div>
                    <div class="p-3">
                        {% if employee %}
                            {% if employee.user %}
                            <!-- User account exists (Edit Mode) -->
                            <div class="alert alert-info mb-3" style="font-size: 12px; padding: 8px 12px;">
                                <i class="fa fa-info-circle me-1"></i>
                                This employee has a user account and can log in to the system.
                            </div>
                            <div class="row g-1">
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="{{ form.username.id_for_label }}" class="form-label">
                                            <i class="fa fa-user me-1"></i>Username
                                        </label>
                                        {{ form.username }}
                                        <small class="text-muted" style="font-size: 10px;">Username cannot be changed</small>
                                        {% if form.username.errors %}
                                        <div class="text-danger">
                                            {% for error in form.username.errors %}{{ error }}{% endfor %}
                                        </div>
                                        {% endif %}
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="{{ form.new_password.id_for_label }}" class="form-label">
                                            <i class="fa fa-key me-1"></i>New Password
                                        </label>
                                        {{ form.new_password }}
                                        <small class="text-muted" style="font-size: 10px;">Leave blank to keep current password</small>
                                        {% if form.new_password.errors %}
                                        <div class="text-danger">
                                            {% for error in form.new_password.errors %}{{ error }}{% endfor %}
                                        </div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                            <div class="row g-1 mt-2">
                                <div class="col-md-12">
                                    <div class="form-check">
                                        {{ form.is_active_user }}
                                        <label class="form-check-label" for="{{ form.is_active_user.id_for_label }}">
                                            <i class="fa fa-check-circle me-1"></i>Account is active (user can log in)
                                        </label>
                                        {% if form.is_active_user.errors %}
                                        <div class="text-danger">
                                            {% for error in form.is_active_user.errors %}{{ error }}{% endfor %}
                                        </div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                            {% else %}
                            <!-- No user account (Edit Mode) - Show creation fields -->
                            <div class="alert alert-warning mb-3" style="font-size: 12px; padding: 8px 12px;">
                                <i class="fa fa-exclamation-triangle me-1"></i>
                                This employee does not have a user account yet. Create one below to allow system access.
                            </div>
                            <div class="row g-1">
                                <div class="col-md-12">
                                    <div class="form-group">
                                        <label for="{{ form.username.id_for_label }}" class="form-label">
                                            <i class="fa fa-user me-1"></i>Username <span class="required-field">*</span>
                                        </label>
                                        {{ form.username }}
                                        <small class="text-muted" style="font-size: 10px;">{{ form.username.help_text }}</small>
                                        {% if form.username.errors %}
                                        <div class="text-danger" style="font-size: 11px;">
                                            {% for error in form.username.errors %}{{ error }}{% endfor %}
                                        </div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                            <div class="row g-1 mt-2">
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="{{ form.new_password.id_for_label }}" class="form-label">
                                            <i class="fa fa-key me-1"></i>Password <span class="required-field">*</span>
                                        </label>
                                        {{ form.new_password }}
                                        <small class="text-muted" style="font-size: 10px;">Minimum 8 characters</small>
                                        {% if form.new_password.errors %}
                                        <div class="text-danger" style="font-size: 11px;">
                                            {% for error in form.new_password.errors %}{{ error }}{% endfor %}
                                        </div>
                                        {% endif %}
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="{{ form.confirm_password.id_for_label }}" class="form-label">
                                            <i class="fa fa-check-circle me-1"></i>Confirm Password <span class="required-field">*</span>
                                        </label>
                                        {{ form.confirm_password }}
                                        <small class="text-muted" style="font-size: 10px;">Re-enter the same password</small>
                                        {% if form.confirm_password.errors %}
                                        <div class="text-danger" style="font-size: 11px;">
                                            {% for error in form.confirm_password.errors %}{{ error }}{% endfor %}
                                        </div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                            <div class="row g-1 mt-2">
                                <div class="col-md-12">
                                    <div class="form-check">
                                        {{ form.is_active_user }}
                                        <label class="form-check-label" for="{{ form.is_active_user.id_for_label }}">
                                            <i class="fa fa-check-circle me-1"></i>Account is active (user can log in immediately)
                                        </label>
                                        {% if form.is_active_user.errors %}
                                        <div class="text-danger" style="font-size: 11px;">
                                            {% for error in form.is_active_user.errors %}{{ error }}{% endfor %}
                                        </div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                            {% endif %}
                        {% else %}
                            <!-- Create Mode - Show user account input fields -->
                            <div class="alert alert-info mb-3" style="font-size: 12px; padding: 8px 12px;">
                                <i class="fa fa-info-circle me-1"></i>
                                Create login credentials for this employee to access the system.
                            </div>
                            <div class="row g-1">
                                <div class="col-md-12">
                                    <div class="form-group">
                                        <label for="{{ form.username.id_for_label }}" class="form-label">
                                            <i class="fa fa-user me-1"></i>Username <span class="required-field">*</span>
                                        </label>
                                        {{ form.username }}
                                        <small class="text-muted" style="font-size: 10px;">{{ form.username.help_text }}</small>
                                        {% if form.username.errors %}
                                        <div class="text-danger" style="font-size: 11px;">
                                            {% for error in form.username.errors %}{{ error }}{% endfor %}
                                        </div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                            <div class="row g-1 mt-2">
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="{{ form.new_password.id_for_label }}" class="form-label">
                                            <i class="fa fa-key me-1"></i>Password <span class="required-field">*</span>
                                        </label>
                                        {{ form.new_password }}
                                        <small class="text-muted" style="font-size: 10px;">{{ form.new_password.help_text }}</small>
                                        {% if form.new_password.errors %}
                                        <div class="text-danger" style="font-size: 11px;">
                                            {% for error in form.new_password.errors %}{{ error }}{% endfor %}
                                        </div>
                                        {% endif %}
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="{{ form.confirm_password.id_for_label }}" class="form-label">
                                            <i class="fa fa-check-circle me-1"></i>Confirm Password <span class="required-field">*</span>
                                        </label>
                                        {{ form.confirm_password }}
                                        <small class="text-muted" style="font-size: 10px;">{{ form.confirm_password.help_text }}</small>
                                        {% if form.confirm_password.errors %}
                                        <div class="text-danger" style="font-size: 11px;">
                                            {% for error in form.confirm_password.errors %}{{ error }}{% endfor %}
                                        </div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                            <div class="row g-1 mt-2">
                                <div class="col-md-12">
                                    <div class="form-check">
                                        {{ form.is_active_user }}
                                        <label class="form-check-label" for="{{ form.is_active_user.id_for_label }}">
                                            <i class="fa fa-check-circle me-1"></i>Account is active (user can log in immediately)
                                        </label>
                                        {% if form.is_active_user.errors %}
                                        <div class="text-danger" style="font-size: 11px;">
                                            {% for error in form.is_active_user.errors %}{{ error }}{% endfor %}
                                        </div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        {% endif %}
                    </div>
                </div>
                <!-- End User Account Section -->

                <!--Emergency Contact -->
                <div class=" rounded-lg border border-gray-200 mt-4">
                    <div class="border-b border-gray-200 py-2 px-3">
                        <h4 class="text-[16px] font-semibold"><i class="fa fa-phone me-2"></i>Emergency Contact</h4>
                    </div>
                    <div class="p-3">
                        <div class="row g-1">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="{{ form.emergency_contact_name.id_for_label }}" class="form-label">
                                        Contact Name <span class="required-field">*</span>
                                    </label>
                                    {{ form.emergency_contact_name }}
                                    {% if form.emergency_contact_name.errors %}
                                    <div class="text-danger">
                                        {% for error in form.emergency_contact_name.errors %}{{ error }}{% endfor %}
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="{{ form.emergency_contact_phone.id_for_label }}" class="form-label">
                                        Contact Phone <span class="required-field">*</span>
                                    </label>
                                    {{ form.emergency_contact_phone }}
                                    {% if form.emergency_contact_phone.errors %}
                                    <div class="text-danger">
                                        {% for error in form.emergency_contact_phone.errors %}{{ error }}{% endfor %}
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <!--Emergency Contact -->
                <!--Additional  Note -->
                <div class=" rounded-lg border border-gray-200 mt-4">
                    <div class="border-b border-gray-200 py-2 px-3">
                        <h4 class="text-[16px] font-semibold"><i class="fa fa-pencil me-2"></i>Additional Note</h4>
                    </div>
                    <div class="p-3">
                        <div class="row g-1">
                            <div class="col-12">
                                <div class="form-group">
                                    <label for="{{ form.notes.id_for_label }}" class="form-label">
                                        <i class="bi bi-sticky text-muted me-1"></i>
                                        Notes
                                    </label>
                                    {{ form.notes }}
                                    {% if form.notes.errors %}
                                    <div class="text-danger">
                                        {% for error in form.notes.errors %}{{ error }}{% endfor %}
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <!--adition Note -->
                <!--Employee Document-->
                <div class=" rounded-lg border border-gray-200 mt-4">
                    <div class="border-b border-gray-200 py-2 px-3 bg-gray-50 rounded-t-lg flex items-center justify-between">
                        <h4 class="text-[16px] font-semibold"><i class="bi bi-file-earmark-text fs-6"></i> Employee Documents  <small class="text-muted ms-1">(ID Card, Passport, Visa, Work Permit, etc.)</small></h4>
                        <!--<span class="badge bg-blue-500 rounded" id="document-count-badge">
                            <span id="document-count">{{ formset.forms|length }}</span> Doc{{ formset.forms|length|pluralize }}
                        </span>-->
                    </div>
                
                    <div class="py-3">
                        <div id="document-formset" class="px-3 pb-3">
                            {{ formset.management_form }}
                            {% for form_doc in formset %}
                            <div class="document-form-card border rounded-lg shadow-sm mb-3"
                                data-form-index="{{ forloop.counter0 }}">
                                <!-- Document Header -->
                                <div
                                    class="document-header bg-light px-2 py-1 border-bottom d-flex justify-content-between align-items-center">
                                    <div class="d-flex align-items-center">
                                        <div class="document-icon bg-blue-500 text-white me-2">
                                            <i class="bi bi-file-earmark-text text-primary fs-6"></i>
                                        </div>
                                        <div>
                                            <div class="fw-semibold" style="font-size: 0.875rem;">Doc #{{ forloop.counter }}</div>
                                            <small class="text-muted" style="font-size: 0.75rem;">
                                                {% if form_doc.instance.document_type %}
                                                {{ form_doc.instance.get_document_type_display }}
                                                {% else %}
                                                New Document
                                                {% endif %}
                                            </small>
                                        </div>
                                    </div>
                                    <div class="document-actions">
                                        {% if formset.can_delete and form_doc.instance.pk %}
                                        <div class="document-delete-section">
                                            <button type="button" class="btn btn-sm btn-outline-danger document-delete-btn" 
                                                    onclick="toggleDocumentDelete(this, '{{ form_doc.DELETE.id_for_label }}')"
                                                    title="Mark for deletion">
                                                <i class="bi bi-trash"></i> Delete
                                            </button>
                                            <div class="delete-confirmation mt-1" id="confirm-{{ form_doc.DELETE.id_for_label }}" style="display: none;">
                                                <div class="d-flex gap-1">
                                                    <button type="button" class="btn btn-sm btn-danger" 
                                                            onclick="confirmDocumentDelete('{{ form_doc.DELETE.id_for_label }}')">
                                                        <i class="bi bi-check"></i> Confirm
                                                    </button>
                                                    <button type="button" class="btn btn-sm btn-danger" 
                                                            onclick="cancelDocumentDelete('{{ form_doc.DELETE.id_for_label }}')">
                                                        <i class="bi bi-x"></i> Cancel
                                                    </button>
                                                </div>
                                            </div>
                                            <div style="display: none;">{{ form_doc.DELETE }}</div>
                                        </div>
                                        {% else %}
                                        <button type="button" class="btn btn-sm btn-outline-danger"
                                            onclick="confirmRemoveNewDocument(this)" title="Remove Document">
                                            <i class="bi bi-trash"></i> Remove
                                        </button>
                                        {% endif %}
                                    </div>
                                </div>
    
                                <!-- 2-Column Layout: Photo/Preview (Left) + Information (Right) -->
                                <div class="document-body p-3">
                                    <div class="row g-3">
                                        <!-- Left Column: Document Preview/Photo -->
                                        <div class="col-md-6">
                                            <div class="document-preview-section">
                                                <label class="form-label fw-semibold mb-2">
                                                    <i class="bi bi-image me-1"></i>Document Preview
                                                </label>
    
                                                <!-- Current Document Preview -->
                                                {% if form_doc.instance.pk and form_doc.instance.document_file and form_doc.instance.id %}
                                                <div class="current-document-preview mb-3">
                                                    {% if form_doc.instance.document_file.name|slice:"-4:" == ".pdf" %}
                                                    <div class="pdf-preview-card text-center p-4 border rounded bg-light">
                                                        <i class="bi bi-file-earmark-pdf text-danger"
                                                            style="font-size: 4rem;"></i>
                                                        <div class="mt-2">
                                                            <small class="text-muted d-block">PDF Document</small>
                                                            <small class="text-muted">{{ form_doc.instance.document_file.name|slice:"20:" }}</small>
                                                        </div>
                                                        <div class="mt-2">
                                                            {% url 'hr:serve_employee_document' document_id=form_doc.instance.id as document_url %}
                                                            <a href="{{ document_url }}" target="_blank"
                                                                class="btn btn-sm btn-primary">
                                                                <i class="bi bi-eye me-1"></i>View PDF
                                                            </a>
                                                        </div>
                                                    </div>
                                                    {% else %}
                                                    <div class="image-preview-card">
                                                        {% url 'hr:serve_employee_document' document_id=form_doc.instance.id as document_url %}
                                                        <img src="{{ document_url }}" alt="Document Preview"
                                                            class="img-fluid rounded border"
                                                            style="max-height: 200px; width: 100%; object-fit: cover; cursor: pointer;"
                                                            onclick="openDocumentModal('{{ document_url }}', '{{ form_doc.instance.get_document_type_display }}')">
                                                        <div class="mt-2 text-center">
                                                            <small class="text-muted d-block">{{ form_doc.instance.document_file.name|slice:"20:" }}</small>
                                                            <button type="button"
                                                                class="btn btn-sm btn-primary mt-1"
                                                                onclick="openDocumentModal('{{ document_url }}', '{{ form_doc.instance.get_document_type_display }}')">
                                                                <i class="bi bi-zoom-in me-1"></i>Enlarge
                                                            </button>
                                                        </div>
                                                    </div>
                                                    {% endif %}
                                                </div>
                                                {% else %}
                                                <div
                                                    class="no-preview-placeholder text-center p-4 border border-dashed rounded bg-light">
                                                    <i class="bi bi-image text-muted" style="font-size: 3rem;"></i>
                                                    <div class="mt-2">
                                                        <small class="text-muted">No document uploaded</small>
                                                    </div>
                                                </div>
                                                {% endif %}
    
                                                <!-- File Upload Field -->
                                                <div class="mt-3">
                                                    <label for="{{ form_doc.document_file.id_for_label }}"
                                                        class="form-label small fw-semibold">
                                                        <i class="bi bi-cloud-upload me-1"></i>Upload New File
                                                    </label>
                                                    {{ form_doc.document_file }}
                                                    {% if form_doc.document_file.errors %}
                                                    <div class="text-danger small mt-1">{{ form_doc.document_file.errors.0 }}</div>
                                                    {% endif %}
                                                    <small class="text-muted d-block mt-1">Supported: JPG, PNG, PDF (Max
                                                        5MB)</small>
                                                </div>
                                            </div>
                                        </div>
    
                                        <!-- Right Column: Document Information -->
                                        <div class="col-md-6">
                                            <div class="document-info-section">
                                                <label class="form-label fw-semibold mb-3">
                                                    <i class="bi bi-info-circle me-1"></i>Document Information
                                                </label>
    
                                                <!-- Hidden ID field -->
                                                {% if form_doc.instance.pk %}{{ form_doc.id }}{% endif %}
    
                                                <!-- Document Type and Number -->
                                                <div class="row g-2 mb-3">
                                                    <div class="col-md-6">
                                                        <label for="{{ form_doc.document_type.id_for_label }}"
                                                            class="form-label small fw-semibold">Document Type</label>
                                                        {{ form_doc.document_type }}
                                                        {% if form_doc.document_type.errors %}
                                                        <div class="text-danger small">{{ form_doc.document_type.errors.0 }}</div>
                                                        {% endif %}
                                                    </div>
                                                    <div class="col-md-6">
                                                        <label for="{{ form_doc.document_number.id_for_label }}"
                                                            class="form-label small fw-semibold">Document Number</label>
                                                        {{ form_doc.document_number }}
                                                        {% if form_doc.document_number.errors %}
                                                        <div class="text-danger small">{{ form_doc.document_number.errors.0 }}</div>
                                                        {% endif %}
                                                    </div>
                                                </div>
    
                                                <!-- Issuing Authority -->
                                                <div class="mb-3">
                                                    <label for="{{ form_doc.issuing_authority.id_for_label }}"
                                                        class="form-label small fw-semibold">Issuing Authority</label>
                                                    {{ form_doc.issuing_authority }}
                                                    {% if form_doc.issuing_authority.errors %}
                                                    <div class="text-danger small">{{ form_doc.issuing_authority.errors.0 }}</div>
                                                    {% endif %}
                                                </div>
    
                                                <!-- Issue and Expiry Dates -->
                                                <div class="row g-2 mb-3">
                                                    <div class="col-md-6">
                                                        <label for="{{ form_doc.issue_date.id_for_label }}"
                                                            class="form-label small fw-semibold">Issue Date</label>
                                                        {{ form_doc.issue_date }}
                                                        {% if form_doc.issue_date.errors %}
                                                        <div class="text-danger small">{{ form_doc.issue_date.errors.0 }}</div>
                                                        {% endif %}
                                                    </div>
                                                    <div class="col-md-6">
                                                        <label for="{{ form_doc.expiry_date.id_for_label }}"
                                                            class="form-label small fw-semibold">Expiry Date</label>
                                                        {{ form_doc.expiry_date }}
                                                        {% if form_doc.expiry_date.errors %}
                                                        <div class="text-danger small">{{ form_doc.expiry_date.errors.0 }}</div>
                                                        {% endif %}
                                                    </div>
                                                </div>
    
                                                <!-- Notes -->
                                                <div class="mb-0">
                                                    <label for="{{ form_doc.notes.id_for_label }}"
                                                        class="form-label small fw-semibold">Notes</label>
                                                    {{ form_doc.notes }}
                                                    {% if form_doc.notes.errors %}
                                                    <div class="text-danger small">{{ form_doc.notes.errors.0 }}</div>
                                                    {% endif %}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
    
                            <!-- Add Another Document Button -->
                            
                            <div class="text-center mt-4 w-full">
                                <button type="button" class="w-full mt-3 button-min-default " id="add-document-btn">
                                    <div>
                                        <i class="fa fa-plus me-1"></i> Add Another Document
                                    </div>
                                </button>
                            </div>
    
                            {% if formset.non_form_errors %}
                            <div class="alert alert-danger">
                                {% for error in formset.non_form_errors %}
                                <div>{{ error }}</div>
                                {% endfor %}
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                <!--Employee Document-->

                <!-- Submit Buttons -->
                <div class="flex items-center justify-end space-x-3 mb-3">
                    <a href="{% url 'hr:employee_list' %}" class="button-min-danger">
                        Cancel
                    </a>
                    <button type="submit" class="button-min-primary px-4">
                        Save
                    </button>
                </div>


            </form>
        </div>
    </div>
</div>
</div>

<!-- Dynamic Position Loading Script -->
<script>
    // Camera and Photo Upload Functionality
    let currentStream = null;
    let capturedPhotoBlob = null;

    document.addEventListener('DOMContentLoaded', function () {
        
        // Preserve form data in sessionStorage to prevent loss on validation errors
        function preserveFormData() {
            const formData = {};
            const form = document.querySelector('form');
            if (form) {
                // Save all input values
                const inputs = form.querySelectorAll('input, select, textarea');
                inputs.forEach(input => {
                    if (input.name && input.value) {
                        formData[input.name] = input.value;
                    }
                });
                sessionStorage.setItem('employeeFormData', JSON.stringify(formData));
            }
        }

        // Restore form data from sessionStorage
        function restoreFormData() {
            // Check if this is an edit form (has existing data) or a new form
            const isEditMode = document.querySelector('[name="employee_id"]')?.value || 
                              document.querySelector('input[type="hidden"][name*="id"]')?.value ||
                              window.location.pathname.includes('/update/');
            
            // Don't restore sessionStorage data in edit mode to avoid overriding existing data
            if (isEditMode) {
                console.log('Edit mode detected - skipping sessionStorage restoration');
                return;
            }
            
            const savedData = sessionStorage.getItem('employeeFormData');
            if (savedData) {
                try {
                    const formData = JSON.parse(savedData);
                    Object.keys(formData).forEach(name => {
                        const field = document.querySelector(`[name="${name}"]`);
                        if (field && !field.value) { // Only restore if field is empty
                            field.value = formData[name];
                        }
                    });
                } catch (e) {
                    console.log('Error restoring form data:', e);
                }
            }
        }

        // Clear preserved data when form is successfully submitted
        function clearPreservedData() {
            sessionStorage.removeItem('employeeFormData');
        }

        // Check if page loaded without form errors (successful submission or first load)
        const hasFormErrors = document.querySelector('.errorlist, .invalid-feedback, .text-danger');
        if (!hasFormErrors && window.location.search.includes('success')) {
            // Clear preserved data on successful submission
            clearPreservedData();
        } else {
            // Restore data on page load (for validation errors)
            restoreFormData();
        }

        // Form validation feedback
        const form = document.querySelector('form');
        if (form) {
            // Preserve data before form submission
            form.addEventListener('submit', function () {
                preserveFormData();
            });
            
            form.addEventListener('submit', function (e) {
                // Ensure captured photo is maintained in form submission
                const photoInput = document.getElementById('{{ form.photo.id_for_label }}');
                if (capturedPhotoBlob && (!photoInput.files || photoInput.files.length === 0)) {
                    console.log('Re-adding captured photo to form before basic validation');
                    const file = new File([capturedPhotoBlob], 'camera-photo.jpg', { type: 'image/jpeg' });
                    const dataTransfer = new DataTransfer();
                    dataTransfer.items.add(file);
                    photoInput.files = dataTransfer.files;
                }
                
                const requiredFields = form.querySelectorAll('[required]');
                let hasErrors = false;

                requiredFields.forEach(field => {
                    if (!field.value.trim()) {
                        field.classList.add('is-invalid');
                        hasErrors = true;
                    } else {
                        field.classList.remove('is-invalid');
                    }
                });

                if (hasErrors) {
                    e.preventDefault();
                    // Scroll to first error
                    const firstError = form.querySelector('.is-invalid');
                    if (firstError) {
                        firstError.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }
                }
            });
        }

        // Auto-resize textareas
        const textareas = document.querySelectorAll('textarea');
        textareas.forEach(textarea => {
            textarea.addEventListener('input', function () {
                this.style.height = 'auto';
                this.style.height = this.scrollHeight + 'px';
            });
        });

        // File input change handler for preview
        const photoInput = document.getElementById('{{ form.photo.id_for_label }}');
        if (photoInput) {
            photoInput.addEventListener('change', function (e) {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function (e) {
                        const preview = document.getElementById('photo-preview');
                        const previewImg = document.getElementById('photo-preview-img');
                        const placeholder = document.getElementById('photo-placeholder');
                        const currentPhotoDisplay = document.getElementById('current-photo-display');

                        if (preview && previewImg) {
                            previewImg.src = e.target.result;
                            preview.style.display = 'block';
                            
                            // Hide placeholder if it exists (for new employees)
                            if (placeholder) {
                                placeholder.style.display = 'none';
                            }
                            
                            // Hide current photo display when new photo is selected (for existing employees)
                            if (currentPhotoDisplay) {
                                currentPhotoDisplay.style.display = 'none';
                            }
                        }
                    };
                    reader.readAsDataURL(file);
                }
            });
        }

        // Check camera support on page load
        if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
            showError('Camera not supported in this browser');
            // Default to file upload mode if camera not supported
            switchToFile();
        }



        // Initialize enhanced date pickers
        initializeDatePickers();

        // Initialize inline validation
        initializeInlineValidation();

        // Document formset management
        const addDocumentBtn = document.getElementById('add-document-btn');
        const documentFormset = document.getElementById('document-formset');

        if (addDocumentBtn && documentFormset) {
            addDocumentBtn.addEventListener('click', function () {
                const totalForms = document.querySelector('#id_documents-TOTAL_FORMS');
                const formIdx = parseInt(totalForms.value);

                // Create new document form
                const newForm = createNewEmployeeDocumentForm(formIdx);

                // Insert before the add button
                const addButtonDiv = addDocumentBtn.parentElement;
                documentFormset.insertBefore(newForm, addButtonDiv);

                // Update total forms count
                totalForms.value = formIdx + 1;

                // Update document numbers and count
                updateEmployeeDocumentNumbers();
                updateDocumentCount();
            });
        }
    });

    // Switch to camera mode
    function switchToCamera() {
        // Update toggle buttons
        const cameraModeBtn = document.getElementById('camera-mode-btn');
        const fileModeBtn = document.getElementById('file-mode-btn');
        
        if (cameraModeBtn) {
            cameraModeBtn.classList.add('active');
        }
        if (fileModeBtn) {
            fileModeBtn.classList.remove('active');
        }

        // Show/hide appropriate sections
        const cameraUploadArea = document.getElementById('camera-upload-area');
        const fileUploadArea = document.getElementById('file-upload-area');
        
        if (cameraUploadArea) {
            cameraUploadArea.style.display = 'flex';
        }
        if (fileUploadArea) {
            fileUploadArea.style.display = 'none';
        }

        // Clear any file input selection from file mode
        const photoInput = document.getElementById('{{ form.photo.id_for_label }}');
        if (photoInput && !capturedPhotoBlob) {
            photoInput.value = '';
        }

        // Reset camera UI based on whether we have a captured photo
        if (capturedPhotoBlob) {
            document.getElementById('camera-status').textContent = 'Photo captured - Click "Retake Photo" to take a new photo';
            document.getElementById('camera-photo-preview').style.display = 'block';
            document.getElementById('start-camera-btn').style.display = 'none';
            document.getElementById('retake-camera-btn').style.display = 'inline-flex';
        } else {
            document.getElementById('camera-status').textContent = 'Click "Start Camera" to begin';
            document.getElementById('camera-photo-preview').style.display = 'none';
            document.getElementById('start-camera-btn').style.display = 'inline-flex';
            document.getElementById('retake-camera-btn').style.display = 'none';
        }

        // Always hide these buttons when switching to camera mode
        document.getElementById('capture-btn').style.display = 'none';
        document.getElementById('stop-camera-btn').style.display = 'none';

        hideError();
    }

    // Switch to file upload mode
    function switchToFile() {
        // Update toggle buttons
        const fileModeBtn = document.getElementById('file-mode-btn');
        const cameraModeBtn = document.getElementById('camera-mode-btn');
        
        if (fileModeBtn) {
            fileModeBtn.classList.add('active');
        }
        if (cameraModeBtn) {
            cameraModeBtn.classList.remove('active');
        }

        // Show/hide appropriate sections
        const fileUploadArea = document.getElementById('file-upload-area');
        const cameraUploadArea = document.getElementById('camera-upload-area');
        
        if (fileUploadArea) {
            fileUploadArea.style.display = 'flex';
        }
        if (cameraUploadArea) {
            cameraUploadArea.style.display = 'none';
        }

        // Stop camera if running
        stopCamera();

        // Clear captured photo when switching to file mode
        clearCapturedPhoto();

        // Show file preview if there was a file selected
        const photoInput = document.getElementById('{{ form.photo.id_for_label }}');
        if (photoInput && photoInput.files && photoInput.files.length > 0) {
            // Trigger the existing file preview functionality
            photoInput.dispatchEvent(new Event('change', { bubbles: true }));
        }

        hideError();
    }

    // Clear captured photo
    function clearCapturedPhoto() {
        capturedPhotoBlob = null;
        document.getElementById('camera-photo-preview').style.display = 'none';

        // Reset button states
        document.getElementById('start-camera-btn').style.display = 'inline-flex';
        document.getElementById('retake-camera-btn').style.display = 'none';
        document.getElementById('capture-btn').style.display = 'none';
        document.getElementById('stop-camera-btn').style.display = 'none';

        // Clear the photo input if it contains a captured photo
        const photoInput = document.getElementById('{{ form.photo.id_for_label }}');
        if (photoInput) {
            photoInput.value = '';
        }
    }

    // Start camera stream
    async function startCamera() {
        try {
            hideError();
            updateCameraStatus('Requesting camera access...');

            // Hide captured photo preview when starting new session
            document.getElementById('camera-photo-preview').style.display = 'none';

            const constraints = {
                video: {
                    width: { ideal: 640 },
                    height: { ideal: 480 },
                    facingMode: 'user' // Front-facing camera
                }
            };

            currentStream = await navigator.mediaDevices.getUserMedia(constraints);

            const video = document.getElementById('camera-video');
            video.srcObject = currentStream;
            video.style.display = 'block';

            // Update UI
            document.getElementById('start-camera-btn').style.display = 'none';
            document.getElementById('capture-btn').style.display = 'inline-flex';
            document.getElementById('stop-camera-btn').style.display = 'inline-flex';

            updateCameraStatus('Camera ready - Click "Capture" to take photo');

        } catch (error) {
            console.error('Error accessing camera:', error);
            let errorMessage = 'Camera access failed. ';

            if (error.name === 'NotAllowedError') {
                errorMessage += 'Please allow camera access and try again.';
            } else if (error.name === 'NotFoundError') {
                errorMessage += 'No camera found on this device.';
            } else if (error.name === 'NotSupportedError') {
                errorMessage += 'Camera not supported in this browser.';
            } else {
                errorMessage += 'Please check your camera settings.';
            }

            showError(errorMessage);
            updateCameraStatus('Camera unavailable');
        }
    }

    // Stop camera stream
    function stopCamera() {
        if (currentStream) {
            currentStream.getTracks().forEach(track => track.stop());
            currentStream = null;
        }

        const video = document.getElementById('camera-video');
        video.style.display = 'none';
        video.srcObject = null;

        // Update UI based on whether we have a captured photo
        if (!capturedPhotoBlob) {
            // No photo captured - show start button
            document.getElementById('start-camera-btn').style.display = 'inline-flex';
            document.getElementById('retake-camera-btn').style.display = 'none';
            document.getElementById('camera-photo-preview').style.display = 'none';
            updateCameraStatus('Camera stopped - Click "Start Camera" to begin');
        } else {
            // Photo captured - show retake button
            document.getElementById('start-camera-btn').style.display = 'none';
            document.getElementById('retake-camera-btn').style.display = 'inline-flex';
            updateCameraStatus('Photo captured - Click "Retake Photo" to take a new photo');
        }

        // Always hide capture and stop buttons
        document.getElementById('capture-btn').style.display = 'none';
        document.getElementById('stop-camera-btn').style.display = 'none';

        hideError();
    }

    // Capture photo from camera
    function capturePhoto() {
        const video = document.getElementById('camera-video');
        const canvas = document.getElementById('camera-canvas');
        const context = canvas.getContext('2d');

        // Set canvas dimensions to match video
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;

        // Draw video frame to canvas
        context.drawImage(video, 0, 0, canvas.width, canvas.height);

        // Convert canvas to blob
        canvas.toBlob(function (blob) {
            capturedPhotoBlob = blob;

            // Show preview
            const preview = document.getElementById('camera-photo-preview');
            const previewImg = document.getElementById('camera-photo-preview-img');
            const currentPhotoDisplay = document.getElementById('current-photo-display');

            const url = URL.createObjectURL(blob);
            previewImg.src = url;
            preview.style.display = 'block';
            
            // Hide current photo display when camera photo is captured (for existing employees)
            if (currentPhotoDisplay) {
                currentPhotoDisplay.style.display = 'none';
            }

            // Create a file object and set it to the input
            const file = new File([blob], 'camera-photo.jpg', { type: 'image/jpeg' });

            // Create a new FileList with the captured photo
            const dataTransfer = new DataTransfer();
            dataTransfer.items.add(file);

            const photoInput = document.getElementById('{{ form.photo.id_for_label }}');
            photoInput.files = dataTransfer.files;

            // Trigger change event for form validation
            photoInput.dispatchEvent(new Event('change', { bubbles: true }));

            updateCameraStatus('Photo captured successfully!');

            // Stop camera after capture but keep the photo visible
            setTimeout(() => {
                stopCamera();
            }, 1500);

        }, 'image/jpeg', 0.9);
    }

    // Helper functions
    function updateCameraStatus(message) {
        document.getElementById('camera-status').textContent = message;
    }

    function showError(message) {
        const errorElement = document.getElementById('camera-error');
        errorElement.textContent = message;
        errorElement.style.display = 'block';
    }

    function hideError() {
        document.getElementById('camera-error').style.display = 'none';
    }
    
    // Function to refresh the current photo display with cache-busting
    function refreshCurrentPhoto() {
        const currentPhotoImg = document.getElementById('current-photo-img');
        if (currentPhotoImg && currentPhotoImg.src) {
            // Add/update cache-busting parameter
            const baseUrl = currentPhotoImg.src.split('?')[0];
            const timestamp = new Date().getTime();
            currentPhotoImg.src = `${baseUrl}?v=${timestamp}`;
        }
    }



    // Function to remove a document form (for new documents)
    function removeDocumentForm(button) {
        const documentForm = button.closest('.document-form-card');
        if (documentForm) {
            documentForm.remove();

            // Update total forms count
            const totalForms = document.querySelector('#id_documents-TOTAL_FORMS');
            totalForms.value = parseInt(totalForms.value) - 1;

            // Update document numbers for remaining forms
            updateEmployeeDocumentNumbers();
            updateDocumentCount();
        }
    }

    // User-friendly delete functions for existing documents
    function toggleDocumentDelete(button, deleteFieldId) {
        const confirmDiv = document.getElementById(`confirm-${deleteFieldId}`);
        const deleteField = document.getElementById(deleteFieldId);
        
        if (confirmDiv.style.display === 'none') {
            // Show confirmation dialog
            confirmDiv.style.display = 'block';
            button.innerHTML = '<i class="bi bi-arrow-up"></i> Hide';
            button.classList.remove('btn-outline-danger');
            button.classList.add('btn-secondary');
        } else {
            // Hide confirmation dialog
            confirmDiv.style.display = 'none';
            button.innerHTML = '<i class="bi bi-trash"></i> Delete';
            button.classList.remove('btn-secondary');
            button.classList.add('btn-outline-danger');
            // Uncheck if it was checked
            if (deleteField.checked) {
                deleteField.checked = false;
                resetDocumentFormAppearance(button);
            }
        }
    }

    function confirmDocumentDelete(deleteFieldId) {
        const deleteField = document.getElementById(deleteFieldId);
        const documentForm = deleteField.closest('.document-form-card');
        const confirmDiv = document.getElementById(`confirm-${deleteFieldId}`);
        const deleteButton = documentForm.querySelector('.document-delete-btn');
        
        // Mark for deletion
        deleteField.checked = true;
        
        // Update visual appearance
        documentForm.style.opacity = '0.6';
        documentForm.style.background = '#fee2e2';
        documentForm.classList.add('document-marked-for-deletion');
        
        // Hide confirmation and update button
        confirmDiv.style.display = 'none';
        deleteButton.innerHTML = '<i class="bi bi-arrow-counterclockwise"></i> Undo Delete';
        deleteButton.classList.remove('btn-outline-danger');
        deleteButton.classList.add('btn-warning');
        deleteButton.setAttribute('onclick', `undoDocumentDelete('${deleteFieldId}')`);
        
        // Show notification
        showDeleteNotification('Document marked for deletion. Click "Undo Delete" to restore.');
    }

    function undoDocumentDelete(deleteFieldId) {
        const deleteField = document.getElementById(deleteFieldId);
        const documentForm = deleteField.closest('.document-form-card');
        const deleteButton = documentForm.querySelector('.document-delete-btn');
        
        // Unmark for deletion
        deleteField.checked = false;
        
        // Reset visual appearance
        resetDocumentFormAppearance(deleteButton);
        
        // Reset button
        deleteButton.innerHTML = '<i class="bi bi-trash"></i> Delete';
        deleteButton.classList.remove('btn-warning');
        deleteButton.classList.add('btn-outline-danger');
        deleteButton.setAttribute('onclick', `toggleDocumentDelete(this, '${deleteFieldId}')`);
        
        // Hide notification
        hideDeleteNotification();
    }

    function cancelDocumentDelete(deleteFieldId) {
        const confirmDiv = document.getElementById(`confirm-${deleteFieldId}`);
        const deleteField = document.getElementById(deleteFieldId);
        const documentForm = deleteField.closest('.document-form-card');
        const deleteButton = documentForm.querySelector('.document-delete-btn');
        
        // Hide confirmation dialog
        confirmDiv.style.display = 'none';
        deleteButton.innerHTML = '<i class="bi bi-trash"></i> Delete';
        deleteButton.classList.remove('btn-secondary');
        deleteButton.classList.add('btn-outline-danger');
    }

    function resetDocumentFormAppearance(button) {
        const documentForm = button.closest('.document-form-card');
        documentForm.style.opacity = '1';
        documentForm.style.background = '';
        documentForm.classList.remove('document-marked-for-deletion');
    }

    // User-friendly delete for new documents
    function confirmRemoveNewDocument(button) {
        const documentForm = button.closest('.document-form-card');
        const docNumber = documentForm.querySelector('.fw-semibold').textContent;
        
        if (confirm(`Are you sure you want to remove ${docNumber}?\n\nThis action cannot be undone.`)) {
            removeDocumentForm(button);
            showDeleteNotification('Document removed successfully.');
            setTimeout(hideDeleteNotification, 3000); // Auto-hide after 3 seconds
        }
    }

    // Notification functions
    function showDeleteNotification(message) {
        // Remove existing notification if any
        hideDeleteNotification();
        
        const notification = document.createElement('div');
        notification.id = 'delete-notification';
        notification.className = 'alert alert-info position-fixed';
        notification.style.cssText = `
            top: 20px;
            right: 20px;
            z-index: 9999;
            max-width: 300px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        `;
        notification.innerHTML = `
            <div class="d-flex align-items-start">
                <i class="bi bi-info-circle me-2 mt-1"></i>
                <div>
                    <small>${message}</small>
                </div>
                <button type="button" class="btn-close btn-close-sm ms-auto" onclick="hideDeleteNotification()"></button>
            </div>
        `;
        
        document.body.appendChild(notification);
    }

    function hideDeleteNotification() {
        const notification = document.getElementById('delete-notification');
        if (notification) {
            notification.remove();
        }
    }

    // Function to update document numbers
    function updateEmployeeDocumentNumbers() {
        const documentForms = document.querySelectorAll('.document-form-card');
        documentForms.forEach((form, index) => {
            const title = form.querySelector('h5');
            if (title) {
                const iconAndText = title.innerHTML;
                // Replace the number while keeping the icon
                title.innerHTML = iconAndText.replace(/Document #\d+/, `Document #${index + 1}`);
            }

            // Update data-form-index attribute
            form.setAttribute('data-form-index', index);

            // Update form field names and IDs for the new index
            const inputs = form.querySelectorAll('input, select, textarea');
            inputs.forEach(input => {
                if (input.name && input.name.includes('documents-')) {
                    // Update name attribute
                    input.name = input.name.replace(/documents-\d+/, `documents-${index}`);
                }
                if (input.id && input.id.includes('id_documents-')) {
                    // Update id attribute
                    input.id = input.id.replace(/id_documents-\d+/, `id_documents-${index}`);
                }
            });

            // Update labels
            const labels = form.querySelectorAll('label');
            labels.forEach(label => {
                if (label.htmlFor && label.htmlFor.includes('id_documents-')) {
                    label.htmlFor = label.htmlFor.replace(/id_documents-\d+/, `id_documents-${index}`);
                }
            });
        });
    }

    // Function to create a new employee document form from scratch
    function createNewEmployeeDocumentForm(formIdx) {
        const formHtml = `
        <div class="document-form-card border rounded-lg shadow-sm mb-3" data-form-index="${formIdx}">
            <!-- Document Header -->
            <div class="document-header bg-light px-2 py-1 border-bottom d-flex justify-content-between align-items-center">
                <div class="flex items-center py-1">
                    <div class="w-3 h-3 rounded-full bg-blue-400 me-2"></div>
                    <div>
                        <div class="fw-semibold" style="font-size: 0.875rem;">Document #${formIdx + 1}</div>
                        {% comment %} <small class="text-muted" style="font-size: 0.75rem;">New Document</small> {% endcomment %}
                    </div>
                </div>
                <div class="document-actions">
                    <button type="button" class="button-min-danger" onclick="confirmRemoveNewDocument(this)" title="Remove Document">
                        <div>
                        <i class="fa fa-x me-1"></i> Remove
                        </div>
                    </button>
                </div>
            </div>
            
            <!-- 2-Column Layout: Photo/Preview (Left) + Information (Right) -->
            <div class="document-body p-3">
                <div class="row g-3">
                    <!-- Left Column: Document Preview/Photo -->
                    <div class="col-md-4">
                        <div class="document-preview-section">
                            <label class="form-label fw-semibold mb-2">
                                <i class="bi bi-image me-1"></i>Document Preview
                            </label>
                            
                            <!-- No preview placeholder for new documents -->
                            <div class="no-preview-placeholder text-center p-4 border border-dashed rounded bg-light">
                                <i class="bi bi-image text-muted" style="font-size: 3rem;"></i>
                                <div class="mt-2">
                                    <small class="text-muted">No document uploaded</small>
                                </div>
                            </div>
                            
                            <!-- File Upload Field -->
                            <div class="mt-3">
                                <label for="id_documents-${formIdx}-document_file" class="form-label small fw-semibold">
                                    <i class="bi bi-cloud-upload me-1"></i>Upload File
                                </label>
                                <input type="file" name="documents-${formIdx}-document_file" class="form-control" id="id_documents-${formIdx}-document_file" accept="image/*,.pdf">
                                <small class="text-muted d-block mt-1">Supported: JPG, PNG, PDF (Max 5MB)</small>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Right Column: Document Information -->
                    <div class="col-md-8">
                        <div class="document-info-section">
                            <label class="form-label fw-semibold mb-3">
                                <i class="bi bi-info-circle me-1"></i>Document Information
                            </label>
                            
                            <!-- Document Type and Number -->
                            <div class="row g-2 mb-3">
                                <div class="col-md-6">
                                    <label for="id_documents-${formIdx}-document_type" class="form-label small fw-semibold">Document Type</label>
                                    <select name="documents-${formIdx}-document_type" class="form-select" id="id_documents-${formIdx}-document_type">
                                        <option value="">---------</option>
                                        <option value="id_card">ID Card</option>
                                        <option value="certificate">Certificate</option>
                                        <option value="other">Other</option>
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <label for="id_documents-${formIdx}-document_number" class="form-label small fw-semibold">Document Number</label>
                                    <input type="text" name="documents-${formIdx}-document_number" class="form-control" id="id_documents-${formIdx}-document_number">
                                </div>
                            </div>
                            
                            <!-- Issuing Authority -->
                            <div class="mb-3">
                                <label for="id_documents-${formIdx}-issuing_authority" class="form-label small fw-semibold">Issuing Authority</label>
                                <input type="text" name="documents-${formIdx}-issuing_authority" class="form-control" id="id_documents-${formIdx}-issuing_authority">
                            </div>
                            
                            <!-- Issue and Expiry Dates -->
                            <div class="row g-2 mb-3">
                                <div class="col-md-6">
                                    <label for="id_documents-${formIdx}-issue_date" class="form-label small fw-semibold">Issue Date</label>
                                    <input type="date" name="documents-${formIdx}-issue_date" class="form-control" id="id_documents-${formIdx}-issue_date">
                                </div>
                                <div class="col-md-6">
                                    <label for="id_documents-${formIdx}-expiry_date" class="form-label small fw-semibold">Expiry Date</label>
                                    <input type="date" name="documents-${formIdx}-expiry_date" class="form-control" id="id_documents-${formIdx}-expiry_date">
                                </div>
                            </div>
                            
                            <!-- Notes -->
                            <div class="mb-0">
                                <label for="id_documents-${formIdx}-notes" class="form-label small fw-semibold">Notes</label>
                                <textarea name="documents-${formIdx}-notes" rows="3" class="form-control" id="id_documents-${formIdx}-notes"></textarea>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;

        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = formHtml;
        const newFormElement = tempDiv.firstElementChild;

        // Add document type change functionality to update icon
        const documentTypeSelect = newFormElement.querySelector(`#id_documents-${formIdx}-document_type`);
        const documentIcon = newFormElement.querySelector('.document-icon i');

        if (documentTypeSelect && documentIcon) {
            documentTypeSelect.addEventListener('change', function (e) {
                const selectedType = e.target.value;
                let iconClass = 'bi bi-file-earmark-text text-primary fs-4';

                switch (selectedType) {
                    case 'id_card':
                        iconClass = 'bi bi-credit-card text-success fs-4';
                        break;
                    case 'certificate':
                        iconClass = 'bi bi-award text-success fs-4';
                        break;
                    default:
                        iconClass = 'bi bi-file-earmark-text text-primary fs-4';
                }

                documentIcon.className = iconClass;
            });
        }

        // Add file upload preview functionality to the new form
        // Note: This preview is only for newly uploaded files before they're saved and encrypted
        // Existing saved documents use the secure decryption URL: hr:serve_employee_document
        const fileInput = newFormElement.querySelector(`#id_documents-${formIdx}-document_file`);
        const previewPlaceholder = newFormElement.querySelector('.no-preview-placeholder');

        if (fileInput && previewPlaceholder) {
            fileInput.addEventListener('change', function (e) {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function (e) {
                        if (file.type.startsWith('image/')) {
                            // Show image preview
                            previewPlaceholder.innerHTML = `
                                <img src="${e.target.result}" 
                                     alt="Document Preview" 
                                     class="img-fluid rounded border"
                                     style="max-height: 200px; width: 100%; object-fit: cover;">
                                <div class="mt-2 text-center">
                                    <small class="text-muted d-block">${file.name}</small>
                                    <small class="text-success d-block">Ready to upload</small>
                                </div>
                            `;
                        } else if (file.type === 'application/pdf') {
                            // Show PDF preview
                            previewPlaceholder.innerHTML = `
                                <div class="text-center p-4">
                                    <i class="bi bi-file-earmark-pdf text-danger" style="font-size: 4rem;"></i>
                                    <div class="mt-2">
                                        <small class="text-muted d-block">PDF Document</small>
                                        <small class="text-muted d-block">${file.name}</small>
                                        <small class="text-success d-block">Ready to upload</small>
                                    </div>
                                </div>
                            `;
                        }
                    };
                    reader.readAsDataURL(file);
                }
            });
        }

        return newFormElement;
    }

    // Function to update document count badge
    function updateDocumentCount() {
        const documentForms = document.querySelectorAll('.document-form-card');
        const count = documentForms.length;
        const countElement = document.getElementById('document-count');
        const badgeElement = document.getElementById('document-count-badge');

        if (countElement && badgeElement) {
            countElement.textContent = count;
            // Update badge text with proper pluralization
            const pluralText = count === 1 ? 'Document' : 'Documents';
            badgeElement.innerHTML = `<span id="document-count">${count}</span> ${pluralText}`;

            // Update badge color based on count
            badgeElement.className = 'badge ' + (count === 0 ? 'bg-secondary' : count <= 2 ? 'bg-primary' : 'bg-success');
        }
    }

    // Enhanced Date Picker Functionality
    let activeCalendar = null;
    const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
        'July', 'August', 'September', 'October', 'November', 'December'];
    const dayNames = ['Su', 'Mo', 'Tu', 'We', 'Th', 'Fr', 'Sa'];

    function initializeDatePickers() {
        // Initialize date pickers for all date input fields
        const dateInputs = document.querySelectorAll('.date-input-enhanced');

        dateInputs.forEach(input => {
            // Add click event to show calendar
            input.addEventListener('click', function () {
                const fieldId = this.id;
                showCalendar(fieldId);
            });

            // Initialize calendar for this field
            const fieldId = input.id;
            initializeCalendar(fieldId);
        });

        // Close calendar when clicking outside
        document.addEventListener('click', function (e) {
            if (!e.target.closest('.date-input-container')) {
                hideAllCalendars();
            }
        });

        // Handle keyboard navigation
        document.addEventListener('keydown', function (e) {
            if (activeCalendar && (e.key === 'Escape')) {
                hideAllCalendars();
            }
        });
    }

    function initializeCalendar(fieldId) {
        const input = document.getElementById(fieldId);
        const hiddenInput = document.getElementById(fieldId + '_hidden');

        if (!input) return;

        // Set initial date if available
        let initialDate = null;
        if (hiddenInput && hiddenInput.value && hiddenInput.value.trim() !== '') {
            // Parse the date value (should be in YYYY-MM-DD format)
            const dateValue = hiddenInput.value.trim();
            console.log(`Initializing calendar for ${fieldId}: hidden value = '${dateValue}'`);
            
            // Try to parse the date - be more flexible with formats in edit mode
            const isEditMode = window.location.pathname.includes('/update/');
            
            if (dateValue.match(/^\d{4}-\d{2}-\d{2}$/)) {
                // Standard YYYY-MM-DD format
                initialDate = new Date(dateValue + 'T00:00:00');
            } else if (isEditMode && dateValue.match(/^\d{4}-\d{1,2}-\d{1,2}$/)) {
                // Allow single digit months/days in edit mode (e.g., 2023-1-5)
                initialDate = new Date(dateValue + 'T00:00:00');
            } else if (isEditMode) {
                // Try to parse whatever format Django is providing
                initialDate = new Date(dateValue);
                if (!isNaN(initialDate.getTime())) {
                    console.log(`Successfully parsed date in edit mode: ${dateValue} -> ${initialDate}`);
                }
            }
            
            // Validate the parsed date
            if (initialDate && !isNaN(initialDate.getTime())) {
                console.log(`Valid date parsed for ${fieldId}:`, initialDate);
            } else {
                console.log(`Invalid date for ${fieldId}: '${dateValue}'`);
                initialDate = null;
                // Only clear invalid values if not in edit mode
                if (!isEditMode) {
                    hiddenInput.value = '';
                }
            }
        }

        // Store calendar state
        const calendarState = {
            currentDate: new Date(),
            selectedDate: initialDate,
            viewDate: initialDate ? new Date(initialDate) : new Date()
        };

        // Store state on the input element
        input.calendarState = calendarState;

        // Update display input if we have a valid initial date
        if (initialDate) {
            input.value = formatDisplayDate(initialDate);
        } else {
            // Ensure display input is cleared if no valid date
            input.value = '';
        }
        
        // Make sure the calendar renders the current state
        const monthSelect = document.getElementById('month-select-' + fieldId);
        const yearSelect = document.getElementById('year-select-' + fieldId);
        if (monthSelect && yearSelect) {
            const viewDate = calendarState.viewDate;
            populateMonthSelect(monthSelect, viewDate.getMonth());
            populateYearSelect(yearSelect, viewDate.getFullYear(), fieldId);
        }
    }

    function showCalendar(fieldId) {
        try {
            // Hide all other calendars first
            hideAllCalendars();

            const input = document.getElementById(fieldId);
            const calendar = document.getElementById('date-picker-' + fieldId);

            if (!input) {
                console.error('Input field not found:', fieldId);
                return;
            }

            if (!calendar) {
                console.error('Calendar element not found for field:', fieldId);
                return;
            }

            // Initialize calendar if not already initialized
            if (!input.calendarState) {
                initializeCalendar(fieldId);
            }

            calendar.style.display = 'block';
            activeCalendar = fieldId;

            // Render calendar with current state
            renderCalendar(fieldId);
        } catch (error) {
            console.error('Error showing calendar for field:', fieldId, error);
        }
    }

    function hideAllCalendars() {
        const calendars = document.querySelectorAll('.date-picker-calendar');
        calendars.forEach(calendar => {
            calendar.style.display = 'none';
        });
        activeCalendar = null;
    }

    function renderCalendar(fieldId) {
        const input = document.getElementById(fieldId);
        const gridElement = document.getElementById('calendar-grid-' + fieldId);
        const monthSelect = document.getElementById('month-select-' + fieldId);
        const yearSelect = document.getElementById('year-select-' + fieldId);

        if (!input || !input.calendarState || !gridElement || !monthSelect || !yearSelect) {
            console.error('Calendar elements not found for field:', fieldId);
            return;
        }

        const state = input.calendarState;
        const viewDate = state.viewDate;

        // Validate viewDate
        if (!viewDate || isNaN(viewDate.getTime())) {
            console.error('Invalid viewDate for field:', fieldId);
            state.viewDate = new Date(); // Reset to current date
            return;
        }

        // Populate month dropdown
        populateMonthSelect(monthSelect, viewDate.getMonth());

        // Populate year dropdown with appropriate range
        populateYearSelect(yearSelect, viewDate.getFullYear(), fieldId);

        // Clear grid
        gridElement.innerHTML = '';

        // Add day headers
        dayNames.forEach(day => {
            const dayHeader = document.createElement('div');
            dayHeader.className = 'date-picker-day-header';
            dayHeader.textContent = day;
            gridElement.appendChild(dayHeader);
        });

        // Get first day of month and number of days
        const firstDay = new Date(viewDate.getFullYear(), viewDate.getMonth(), 1);
        const lastDay = new Date(viewDate.getFullYear(), viewDate.getMonth() + 1, 0);
        const daysInMonth = lastDay.getDate();
        const startingDayOfWeek = firstDay.getDay();

        // Add previous month's trailing days
        const prevMonth = new Date(viewDate.getFullYear(), viewDate.getMonth() - 1, 0);
        for (let i = startingDayOfWeek - 1; i >= 0; i--) {
            const dayElement = createDayElement(prevMonth.getDate() - i, fieldId, true, false);
            gridElement.appendChild(dayElement);
        }

        // Add current month's days
        const today = new Date();
        for (let day = 1; day <= daysInMonth; day++) {
            const dayDate = new Date(viewDate.getFullYear(), viewDate.getMonth(), day);
            const isToday = (dayDate.toDateString() === today.toDateString());
            const isSelected = state.selectedDate && !isNaN(state.selectedDate.getTime()) && (dayDate.toDateString() === state.selectedDate.toDateString());

            const dayElement = createDayElement(day, fieldId, false, isToday, isSelected);
            gridElement.appendChild(dayElement);
        }

        // Add next month's leading days
        const remainingCells = 42 - (startingDayOfWeek + daysInMonth); // 6 rows * 7 days = 42
        for (let day = 1; day <= remainingCells && remainingCells < 7; day++) {
            const dayElement = createDayElement(day, fieldId, true, false);
            gridElement.appendChild(dayElement);
        }
    }

    function createDayElement(day, fieldId, isOtherMonth, isToday, isSelected) {
        const dayElement = document.createElement('div');
        dayElement.className = 'date-picker-day';
        dayElement.textContent = day;

        if (isOtherMonth) {
            dayElement.classList.add('other-month');
        }
        if (isToday) {
            dayElement.classList.add('today');
        }
        if (isSelected) {
            dayElement.classList.add('selected');
        }

        // Add click event
        if (!isOtherMonth) {
            dayElement.addEventListener('click', function () {
                selectDate(fieldId, day);
            });
        }

        return dayElement;
    }

    function navigateMonth(fieldId, direction) {
        const input = document.getElementById(fieldId);
        if (!input || !input.calendarState) return;

        const state = input.calendarState;
        state.viewDate.setMonth(state.viewDate.getMonth() + direction);

        renderCalendar(fieldId);
    }

    function selectDate(fieldId, day) {
        try {
            const input = document.getElementById(fieldId);
            const hiddenInput = document.getElementById(fieldId + '_hidden');

            if (!input || !input.calendarState) {
                console.error('Input or calendar state not found for field:', fieldId);
                return;
            }

            const state = input.calendarState;

            // Validate viewDate before using it
            if (!state.viewDate || isNaN(state.viewDate.getTime())) {
                console.error('Invalid viewDate in calendar state for field:', fieldId);
                state.viewDate = new Date(); // Reset to current date
            }

            const selectedDate = new Date(state.viewDate.getFullYear(), state.viewDate.getMonth(), day);

            // Validate the created date
            if (isNaN(selectedDate.getTime())) {
                console.error('Invalid date created for field:', fieldId, 'day:', day);
                return;
            }

            // Update state
            state.selectedDate = selectedDate;

            // Format and display date
            const formattedDate = formatDisplayDate(selectedDate);
            input.value = formattedDate;

            // Update hidden input with ISO format for form submission
            if (hiddenInput) {
                hiddenInput.value = selectedDate.toISOString().split('T')[0];
            }

            // Hide calendar
            hideAllCalendars();

            // Trigger change event for form validation
            input.dispatchEvent(new Event('change', { bubbles: true }));
        } catch (error) {
            console.error('Error selecting date for field:', fieldId, error);
        }
    }

    function selectToday(fieldId) {
        const today = new Date();
        const input = document.getElementById(fieldId);

        if (!input || !input.calendarState) return;

        // Update view to current month
        input.calendarState.viewDate = new Date(today);
        renderCalendar(fieldId);

        // Select today's date
        selectDate(fieldId, today.getDate());
    }

    function clearDate(fieldId) {
        const input = document.getElementById(fieldId);
        const hiddenInput = document.getElementById(fieldId + '_hidden');

        if (!input) return;

        // Clear display input
        input.value = '';

        // Clear hidden input
        if (hiddenInput) {
            hiddenInput.value = '';
        }

        // Update state
        if (input.calendarState) {
            input.calendarState.selectedDate = null;
            renderCalendar(fieldId);
        }

        // Hide calendar
        hideAllCalendars();

        // Trigger change event
        input.dispatchEvent(new Event('change', { bubbles: true }));
    }

    function formatDisplayDate(date) {
        // Validate input
        if (!date || isNaN(date.getTime())) {
            return '';
        }

        // Format as "15/Jan/2024"
        const day = date.getDate();
        const month = monthNames[date.getMonth()].substring(0, 3);
        const year = date.getFullYear();
        return `${day}/${month}/${year}`;
    }

    // Inline Validation Functions
    function initializeInlineValidation() {
        // Get form element
        const form = document.querySelector('form');
        if (!form) return;

        // Add validation listeners to all form fields
        const fields = [
            { id: 'id_first_name', name: 'First Name', required: true, minLength: 2 },
            { id: 'id_last_name', name: 'Last Name', required: true, minLength: 2 },
            { id: 'id_email', name: 'Email', required: true, type: 'email' },
            { id: 'id_phone_number', name: 'Phone Number', pattern: /^[\+]?[1-9][\d]{0,15}$/ },
            { id: 'id_address', name: 'Address', required: true, minLength: 5 },
            { id: 'id_emergency_contact_name', name: 'Emergency Contact Name', required: true, minLength: 2 },
            { id: 'id_emergency_contact_phone', name: 'Emergency Contact Phone', required: true, pattern: /^[\+]?[1-9][\d]{0,15}$/ },
            { id: 'id_employment_status', name: 'Employment Status', required: true },
            { id: 'id_work_type', name: 'Work Type', required: true },
            { id: 'id_gender', name: 'Gender', required: true },
            { id: 'id_nationality', name: 'Nationality', required: true },
        ];

        // Date fields (use hidden inputs)
        const dateFields = [
            { id: 'id_date_of_birth_hidden', displayId: 'id_date_of_birth', name: 'Date of Birth', required: true },
            { id: 'id_hire_date_hidden', displayId: 'id_hire_date', name: 'Hire Date', required: true },
            { id: 'id_end_date_hidden', displayId: 'id_end_date', name: 'End Date', required: false }
        ];

        // Add listeners for regular fields
        fields.forEach(fieldConfig => {
            const field = document.getElementById(fieldConfig.id);
            if (field) {
                // Remove existing error styling on focus
                field.addEventListener('focus', function () {
                    clearFieldError(this);
                });

                // Validate on blur
                field.addEventListener('blur', function () {
                    validateField(this, fieldConfig);
                });

                // Real-time validation for some fields
                if (fieldConfig.type === 'email') {
                    field.addEventListener('input', function () {
                        // Debounce validation
                        clearTimeout(this.validationTimeout);
                        this.validationTimeout = setTimeout(() => {
                            validateField(this, fieldConfig);
                        }, 300);
                    });
                }
            }
        });

        // Add listeners for date fields
        dateFields.forEach(fieldConfig => {
            const hiddenField = document.getElementById(fieldConfig.id);
            const displayField = document.getElementById(fieldConfig.displayId);

            if (hiddenField && displayField) {
                // Clear invalid values on page load for optional fields (but not in edit mode)
                if (!fieldConfig.required && fieldConfig.id.includes('end_date')) {
                    const isEditMode = window.location.pathname.includes('/update/');
                    if (!isEditMode) {
                        const currentValue = hiddenField.value;
                        if (currentValue && currentValue.trim()) {
                            const testDate = new Date(currentValue);
                            if (isNaN(testDate.getTime())) {
                                console.log('Clearing invalid end_date value on load:', currentValue);
                                hiddenField.value = '';
                                displayField.value = '';
                            }
                        }
                    }
                }
                
                // Validate when date is selected
                hiddenField.addEventListener('change', function () {
                    validateDateField(hiddenField, displayField, fieldConfig);
                });
            }
        });

        // Form submission validation
        form.addEventListener('submit', function (e) {
            // Debug: Check if captured photo is still in the input
            const photoInput = document.getElementById('{{ form.photo.id_for_label }}');
            if (capturedPhotoBlob) {
                console.log('Captured photo blob exists:', capturedPhotoBlob);
                
                // Ensure the captured photo is still in the input field
                if (!photoInput.files || photoInput.files.length === 0) {
                    console.log('Photo input is empty, re-adding captured photo');
                    // Re-add the captured photo to the input
                    const file = new File([capturedPhotoBlob], 'camera-photo.jpg', { type: 'image/jpeg' });
                    const dataTransfer = new DataTransfer();
                    dataTransfer.items.add(file);
                    photoInput.files = dataTransfer.files;
                    console.log('Photo re-added to input field');
                } else {
                    console.log('Photo input contains file:', photoInput.files[0]);
                }
            }
            
            const isValid = validateAllFields(fields, dateFields);

            if (!isValid) {
                e.preventDefault();

                // Scroll to first error
                const firstError = form.querySelector('.is-invalid');
                if (firstError) {
                    firstError.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }

                // Show summary message
                showValidationSummary();
            } else {
                console.log('Validation passed, allowing submission');
                // Additional check: log final photo state before submission
                if (photoInput.files && photoInput.files.length > 0) {
                    console.log('Final photo file before submission:', photoInput.files[0]);
                } else {
                    console.log('Warning: No photo file found at submission');
                }
            }
        });
    }

    function validateField(field, config) {
        const value = field.value.trim();
        let isValid = true;
        let errorMessage = '';

        // Required field validation
        if (config.required && !value) {
            isValid = false;
            errorMessage = `${config.name} is required.`;
        }
        // Minimum length validation
        else if (config.minLength && value.length < config.minLength) {
            isValid = false;
            errorMessage = `${config.name} must be at least ${config.minLength} characters.`;
        }
        // Email validation
        else if (config.type === 'email' && value) {
            const emailPattern = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailPattern.test(value)) {
                isValid = false;
                errorMessage = 'Please enter a valid email address.';
            }
        }
        // Pattern validation
        else if (config.pattern && value && !config.pattern.test(value)) {
            isValid = false;
            errorMessage = `Please enter a valid ${config.name.toLowerCase()}.`;
        }

        // Apply validation styling
        if (isValid) {
            showFieldSuccess(field);
        } else {
            showFieldError(field, errorMessage);
        }

        return isValid;
    }

    function validateDateField(hiddenField, displayField, config) {
        const value = hiddenField.value;
        let isValid = true;
        let errorMessage = '';

        console.log(`Validating ${config.name}: hidden='${value}', display='${displayField.value}', required=${config.required}`);

        if (config.required && !value) {
            isValid = false;
            errorMessage = `${config.name} is required.`;
            console.log(`Date validation failed for ${config.name}: field is required but empty`);
        } else if (value && value.trim()) {
            // Validate date format and reasonableness only if there's a real value
            const date = new Date(value);
            if (isNaN(date.getTime())) {
                // For optional fields like end_date, don't show error for invalid empty-ish values
                if (config.required) {
                    isValid = false;
                    errorMessage = `Please enter a valid ${config.name.toLowerCase()}.`;
                }
                // For optional fields, just clear the invalid value silently (but not in edit mode)
                else if (config.id.includes('end_date')) {
                    const isEditMode = window.location.pathname.includes('/update/');
                    if (!isEditMode) {
                        hiddenField.value = '';
                        displayField.value = '';
                    }
                }
            } else {
                // Additional date validations
                const today = new Date();
                const currentYear = today.getFullYear();

                if (config.id.includes('date_of_birth')) {
                    if (date > today) {
                        isValid = false;
                        errorMessage = 'Date of birth cannot be in the future.';
                    } else if (date.getFullYear() < 1900) {
                        isValid = false;
                        errorMessage = 'Please enter a valid birth year.';
                    } else {
                        // Calculate age and validate minimum age requirement (18 years)
                        const age = today.getFullYear() - date.getFullYear() -
                            ((today.getMonth() < date.getMonth() ||
                                (today.getMonth() === date.getMonth() && today.getDate() < date.getDate())) ? 1 : 0);

                        if (age < 16) {
                            isValid = false;
                            errorMessage = `Employee must be at least 16 years old (Cambodia legal working age). Current age: ${age} years.`;
                        } else if (age > 100) {
                            isValid = false;
                            errorMessage = `Please verify the date of birth. Age appears to be ${age} years.`;
                        }
                    }
                } else if (config.id.includes('hire_date')) {
                    if (date.getFullYear() < 1990 || date.getFullYear() > currentYear + 1) {
                        isValid = false;
                        errorMessage = 'Please enter a reasonable hire date.';
                    }
                }
            }
        }

        // Apply validation styling to display field
        if (isValid) {
            showFieldSuccess(displayField);
        } else {
            showFieldError(displayField, errorMessage);
        }

        return isValid;
    }

    function validateAllFields(regularFields, dateFields) {
        let allValid = true;
        let failedFields = [];

        // Validate regular fields
        regularFields.forEach(fieldConfig => {
            const field = document.getElementById(fieldConfig.id);
            if (field) {
                const isValid = validateField(field, fieldConfig);
                if (!isValid) {
                    allValid = false;
                    failedFields.push(fieldConfig.id + ' (regular)');
                }
            } else {
                console.log('Field not found:', fieldConfig.id);
            }
        });

        // Validate date fields
        dateFields.forEach(fieldConfig => {
            const hiddenField = document.getElementById(fieldConfig.id);
            const displayField = document.getElementById(fieldConfig.displayId);
            if (hiddenField && displayField) {
                const isValid = validateDateField(hiddenField, displayField, fieldConfig);
                if (!isValid) {
                    allValid = false;
                    failedFields.push(fieldConfig.id + ' (date)');
                }
            } else {
                console.log('Date field not found:', fieldConfig.id, fieldConfig.displayId);
            }
        });

        if (!allValid) {
            console.log('Failed validation fields:', failedFields);
        }

        return allValid;
    }

    function showFieldError(field, message) {
        // Add error class
        field.classList.remove('is-valid');
        field.classList.add('is-invalid');

        // Find or create error message element
        let errorElement = field.parentElement.querySelector('.invalid-feedback');
        if (!errorElement) {
            errorElement = document.createElement('div');
            errorElement.className = 'invalid-feedback';
            field.parentElement.appendChild(errorElement);
        }

        errorElement.textContent = message;
        errorElement.style.display = 'block';
    }

    function showFieldSuccess(field) {
        // Add success class
        field.classList.remove('is-invalid');
        field.classList.add('is-valid');

        // Hide error message
        const errorElement = field.parentElement.querySelector('.invalid-feedback');
        if (errorElement) {
            errorElement.style.display = 'none';
        }
    }

    function clearFieldError(field) {
        // Remove validation classes
        field.classList.remove('is-invalid', 'is-valid');

        // Hide error message
        const errorElement = field.parentElement.querySelector('.invalid-feedback');
        if (errorElement) {
            errorElement.style.display = 'none';
        }
    }

    function showValidationSummary() {
        // Create or update validation summary
        let summaryElement = document.getElementById('validation-summary');
        if (!summaryElement) {
            summaryElement = document.createElement('div');
            summaryElement.id = 'validation-summary';
            summaryElement.className = 'alert alert-danger mt-3';

            // Insert at the top of the form
            const form = document.querySelector('form');
            if (form) {
                form.insertBefore(summaryElement, form.firstChild);
            }
        }

        summaryElement.innerHTML = `
        <h6><i class="bi bi-exclamation-triangle me-2"></i>Please correct the following errors:</h6>
        <p class="mb-0">Please check the highlighted fields and correct any errors before submitting.</p>
    `;

        // Remove summary after a few seconds
        setTimeout(() => {
            if (summaryElement) {
                summaryElement.remove();
            }
        }, 8000);
    }

    // Helper function to populate month dropdown
    function populateMonthSelect(monthSelect, selectedMonth) {
        monthSelect.innerHTML = '';

        monthNames.forEach((month, index) => {
            const option = document.createElement('option');
            option.value = index;
            option.textContent = month;
            option.selected = index === selectedMonth;
            monthSelect.appendChild(option);
        });
    }

    // Helper function to populate year dropdown with smart ranges
    function populateYearSelect(yearSelect, selectedYear, fieldId) {
        yearSelect.innerHTML = '';

        let startYear, endYear;

        // Determine year range based on field type
        if (fieldId.includes('date_of_birth')) {
            // For date of birth: 1900 to current year
            startYear = 1900;
            endYear = new Date().getFullYear();
        } else if (fieldId.includes('hire_date') || fieldId.includes('end_date')) {
            // For employment dates: current year - 10 to current year + 5
            const currentYear = new Date().getFullYear();
            startYear = currentYear - 10;
            endYear = currentYear + 5;
        } else {
            // Default range: current year - 50 to current year + 10
            const currentYear = new Date().getFullYear();
            startYear = currentYear - 50;
            endYear = currentYear + 10;
        }

        // Ensure selected year is included in range
        if (selectedYear < startYear) startYear = selectedYear;
        if (selectedYear > endYear) endYear = selectedYear;

        // Populate dropdown (newest years first for date of birth)
        if (fieldId.includes('date_of_birth')) {
            // For date of birth, show newest years first
            for (let year = endYear; year >= startYear; year--) {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                option.selected = year === selectedYear;
                yearSelect.appendChild(option);
            }
        } else {
            // For other dates, show oldest years first
            for (let year = startYear; year <= endYear; year++) {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                option.selected = year === selectedYear;
                yearSelect.appendChild(option);
            }
        }
    }

    // Handler for month/year dropdown changes
    function changeMonthYear(fieldId) {
        const input = document.getElementById(fieldId);
        const monthSelect = document.getElementById('month-select-' + fieldId);
        const yearSelect = document.getElementById('year-select-' + fieldId);

        if (!input || !input.calendarState || !monthSelect || !yearSelect) return;

        const state = input.calendarState;
        const newMonth = parseInt(monthSelect.value);
        const newYear = parseInt(yearSelect.value);

        // Update view date
        state.viewDate = new Date(newYear, newMonth, 1);

        // Re-render calendar
        renderCalendar(fieldId);
    }

    // Document Modal Functions
    function openDocumentModal(imageUrl, documentType) {
        const modal = document.getElementById('documentModal');
        const modalImage = document.getElementById('documentModalImage');
        const modalTitle = document.getElementById('documentModalTitle');

        modalImage.src = imageUrl;
        modalTitle.textContent = documentType + ' - Document Preview';
        modal.style.display = 'block';

        // Close modal when clicking outside
        modal.onclick = function (event) {
            if (event.target === modal) {
                closeDocumentModal();
            }
        }
    }

    function closeDocumentModal() {
        const modal = document.getElementById('documentModal');
        modal.style.display = 'none';
    }

    // Close modal with Escape key
    document.addEventListener('keydown', function (event) {
        if (event.key === 'Escape') {
            closeDocumentModal();
        }
    });

    // User Account Fields Validation
    document.addEventListener('DOMContentLoaded', function() {
        const usernameField = document.getElementById('{{ form.username.id_for_label }}');
        const passwordField = document.getElementById('{{ form.new_password.id_for_label }}');
        const confirmPasswordField = document.getElementById('{{ form.confirm_password.id_for_label }}');

        if (usernameField) {
            // Username validation
            usernameField.addEventListener('input', function() {
                const value = this.value;
                const parentDiv = this.closest('.form-group');
                let feedback = parentDiv.querySelector('.validation-feedback');

                if (!feedback) {
                    feedback = document.createElement('div');
                    feedback.className = 'validation-feedback';
                    feedback.style.fontSize = '11px';
                    feedback.style.marginTop = '4px';
                    this.parentNode.insertBefore(feedback, this.nextSibling);
                }

                if (value.length > 0 && value.length < 3) {
                    this.classList.add('is-invalid');
                    this.classList.remove('is-valid');
                    feedback.className = 'validation-feedback text-danger';
                    feedback.textContent = 'Username must be at least 3 characters';
                } else if (value.length > 0 && !/^[a-zA-Z0-9_.-]+$/.test(value)) {
                    this.classList.add('is-invalid');
                    this.classList.remove('is-valid');
                    feedback.className = 'validation-feedback text-danger';
                    feedback.textContent = 'Only letters, numbers, dots, hyphens, and underscores allowed';
                } else if (value.length >= 3) {
                    this.classList.remove('is-invalid');
                    this.classList.add('is-valid');
                    feedback.className = 'validation-feedback text-success';
                    feedback.textContent = ' Valid username';
                } else {
                    this.classList.remove('is-invalid', 'is-valid');
                    feedback.textContent = '';
                }
            });
        }

        if (passwordField) {
            // Password validation
            passwordField.addEventListener('input', function() {
                const value = this.value;
                const parentDiv = this.closest('.form-group');
                let feedback = parentDiv.querySelector('.validation-feedback');

                if (!feedback) {
                    feedback = document.createElement('div');
                    feedback.className = 'validation-feedback';
                    feedback.style.fontSize = '11px';
                    feedback.style.marginTop = '4px';
                    this.parentNode.insertBefore(feedback, this.nextSibling);
                }

                if (value.length > 0 && value.length < 8) {
                    this.classList.add('is-invalid');
                    this.classList.remove('is-valid');
                    feedback.className = 'validation-feedback text-danger';
                    feedback.textContent = 'Password must be at least 8 characters';
                } else if (value.length >= 8) {
                    this.classList.remove('is-invalid');
                    this.classList.add('is-valid');
                    feedback.className = 'validation-feedback text-success';
                    feedback.textContent = ' Valid password strength';
                } else {
                    this.classList.remove('is-invalid', 'is-valid');
                    feedback.textContent = '';
                }

                // Re-validate confirm password if it has value
                if (confirmPasswordField && confirmPasswordField.value) {
                    confirmPasswordField.dispatchEvent(new Event('input'));
                }
            });
        }

        if (confirmPasswordField) {
            // Confirm password validation
            confirmPasswordField.addEventListener('input', function() {
                const value = this.value;
                const passwordValue = passwordField ? passwordField.value : '';
                const parentDiv = this.closest('.form-group');
                let feedback = parentDiv.querySelector('.validation-feedback');

                if (!feedback) {
                    feedback = document.createElement('div');
                    feedback.className = 'validation-feedback';
                    feedback.style.fontSize = '11px';
                    feedback.style.marginTop = '4px';
                    this.parentNode.insertBefore(feedback, this.nextSibling);
                }

                if (value.length > 0 && value !== passwordValue) {
                    this.classList.add('is-invalid');
                    this.classList.remove('is-valid');
                    feedback.className = 'validation-feedback text-danger';
                    feedback.textContent = 'Passwords do not match';
                } else if (value.length > 0 && value === passwordValue) {
                    this.classList.remove('is-invalid');
                    this.classList.add('is-valid');
                    feedback.className = 'validation-feedback text-success';
                    feedback.textContent = ' Passwords match';
                } else {
                    this.classList.remove('is-invalid', 'is-valid');
                    feedback.textContent = '';
                }
            });
        }
    });
</script>

<!-- Document Preview Modal -->
<div id="documentModal" class="document-modal">
    <div class="document-modal-content">
        <div class="document-modal-header">
            <h5 class="document-modal-title" id="documentModalTitle">Document Preview</h5>
            <button type="button" class="document-modal-close" onclick="closeDocumentModal()">
                <i class="bi bi-x"></i>
            </button>
        </div>
        <div class="document-modal-body">
            <img id="documentModalImage" class="document-modal-image" src="" alt="Document Preview">
        </div>
    </div>
</div>

{% endblock %}
{% block modals %}
    {% include 'components/delete_modal.html' %}
{% endblock %}
